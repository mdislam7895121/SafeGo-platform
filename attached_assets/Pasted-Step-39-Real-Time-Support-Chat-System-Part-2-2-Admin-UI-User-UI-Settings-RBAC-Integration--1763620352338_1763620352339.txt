Step 39 – Real-Time Support Chat System (Part 2/2 – Admin UI, User UI, Settings, RBAC Integration)

Context:
Part 1 implemented the backend models, APIs, and WebSocket infrastructure for the support chat system. Now, implement all the UI layers, global settings, and final RBAC integration to make the feature production-ready for SafeGo.

Strict constraints:
- Do NOT break existing admin pages or user flows (rides, food, parcels, wallet, KYC, notifications).
- Reuse the existing design system, layout, and navigation patterns.
- No emojis anywhere in labels or UI text.
- All support chat UIs must be responsive and usable on mobile.

1. Admin Support Chat Dashboard

Create a new admin page at:
- Route: /admin/support-chat

Navigation:
- Add a new card or link on the Admin Dashboard under Management or Support section called "Support Chat".
- Only show this link if the logged-in admin has the VIEW_SUPPORT_CONVERSATIONS permission.

Layout:
Divide the page into three main sections in a responsive layout:

1.1 Conversation List (left panel)
- Shows a searchable, filterable list of SupportConversation entries.
- Columns/fields:
  - Subject
  - Channel (Driver / Customer / Restaurant)
  - Status
  - Priority
  - Last message time
  - Country (BD/US)
  - Assigned admin (or "Unassigned")

Filters:
- Status (open, pending, resolved, closed)
- Channel (driver/customer/restaurant)
- Priority (all/low/normal/high/urgent)
- Country (Bangladesh, United States)
- Assigned (only mine / unassigned / all)

Interactions:
- Clicking a conversation loads messages in the middle panel.
- A visible indicator for unread conversations (for example bold text or count).

1.2 Message Panel (center)
- Shows the message history for the selected conversation.
- Use a scrollable list of messages with:
  - Clear separation between user messages and admin messages.
  - Timestamp for each message.
  - Optional file attachment indicators if there are attachments.
- Input area:
  - Text input box for admin reply.
  - Optional attachment upload button that uses SupportAttachment and existing file upload infrastructure.
- Actions:
  - Send message (button).
  - Mark as resolved/closed.
  - Change priority.
  - Assign to self or another admin (dropdown using existing admin list logic if available).

Use WebSocket:
- When the admin sends a message, push it via WebSocket and also update the UI immediately.
- When a new message arrives from the user, show it in real time and update unread counters.

1.3 Conversation Details (right or bottom panel)
- Show read-only metadata:
  - User type and summary (driver/customer/restaurant with email/id).
  - Country.
  - Current status and priority.
  - CreatedAt and lastMessageAt.
- If available, add a quick link to open the user profile (driver, customer, or restaurant) in a new tab (reusing existing admin routes).

2. User Support Chat Interfaces

Provide simple but consistent support chat entry points for:

2.1 Drivers
- A "Support" or "Help" button/entry in the driver app sidebar or profile section.
- When opened:
  - Show a list of existing conversations.
  - Allow the driver to create a new conversation (subject + initial message).
  - Inside a conversation, show messages in a mobile-friendly layout with:
    - Clear separation between driver and admin messages.
    - Real-time updates via WebSocket.
    - Ability to send messages and attachments where allowed.
- Respect unread counts using unreadCountUser from the backend.

2.2 Customers
- Similar "Support" entry in the customer app.
- Same conversation list and chat layout, but channel is "customer".

2.3 Restaurants
- Support entry in the restaurant portal.
- Same pattern with channel "restaurant".

All user-side UIs:
- Must call the user-facing REST endpoints created in Part 1.
- Must subscribe to the correct WebSocket conversation room.
- Must not expose any admin-only data.

3. Global Settings – Support Tab

Extend the existing Global Settings page at /admin/settings:

- Add a new tab: "Support".
- Only visible to admins with MANAGE_SUPPORT_SETTINGS permission.

In the Support tab, add configuration fields such as:

- Max message length (number).
- Max attachment size in MB (number).
- Allowed attachment mime types (comma-separated string or list).
- Default priority for new conversations.
- Auto-assign mode:
  - "manual" – admins assign conversations themselves.
  - "round_robin" – optional future mode (can be stored but not fully implemented now).
- Optional business hours fields for support (stored only, can be used later).

All settings:
- Must be stored using the same settings infrastructure created for earlier steps.
- Must be validated with the existing validation layer.
- Should be loadable by both backend and frontend where needed.

4. RBAC and UI Integration

- Ensure that admin routes and WebSocket events obey the following permissions:
  - VIEW_SUPPORT_CONVERSATIONS – can see the Support Chat page and list conversations.
  - REPLY_SUPPORT_CONVERSATIONS – can send replies in conversations.
  - ASSIGN_SUPPORT_CONVERSATIONS – can assign or reassign conversations.
  - MANAGE_SUPPORT_SETTINGS – can view and update the Support tab in Global Settings.

- In the frontend:
  - Hide Support Chat navigation and buttons if the admin does not have the relevant permission.
  - Use the capabilities object returned from /api/auth/me (already implemented in RBAC step).

5. Audit and Notifications Integration

- Reuse the existing audit logging system:
  - Log when an admin replies to a conversation (without full body).
  - Log when status, priority, or assignment changes.
- Optionally, integrate with the existing notification system:
  - When a new admin reply arrives, send a notification to the user (if there is an existing pattern).
  - When a new user message arrives in an open conversation, optionally send an admin notification.

Keep notification integration simple and non-breaking. If it adds complexity, document a “ready for integration” hook instead of full implementation.

6. Testing Plan (End-to-End)

Execute the following scenarios:

1) Driver scenario:
   - Driver opens a new support conversation and sends messages.
   - Admin sees it in /admin/support-chat, replies in real time.
   - Driver sees replies via WebSocket without reloading the page.

2) Customer and restaurant scenarios:
   - Repeat similar tests for customer and restaurant channels.

3) Admin workflows:
   - Filter conversations by status, channel, country, and assigned admin.
   - Change status and verify it updates everywhere correctly.
   - Update Support settings and verify they are applied (message length, attachment limit).

4) Security:
   - Verify that a driver cannot open another driver’s conversation.
   - Verify that an admin without permissions cannot see or use the Support Chat page.
   - Confirm no sensitive data (passwords, full SSN, full NID, secrets) appears in logs, messages, or audit records.

5) Performance:
   - Ensure conversation and message lists are paginated.
   - Confirm WebSocket connections behave correctly when there are multiple open conversations.

Finally, summarize all UI components, routes, and settings you added. Confirm that:
- The support chat system is production-ready.
- No existing SafeGo features (rides, food, parcels, wallet, KYC, notifications, settings) have been broken.
- Security, RBAC, and audit logging are fully respected end-to-end.
STEP 49 – SAFEGO DRIVER FOOD-DELIVERY WEB APP (FULL UI + DEMO)
Scope: ADD-ONLY. Extend existing SafeGo platform without breaking any routes, schemas, or logic from Steps 42–48.

================================================================
A) SAFEGO MASTER RULES – DO NOT BREAK
================================================================

1) ROLES (strict separation)
   - Customer
   - Driver
   - Restaurant (Merchant)
   - Admin

   Each role must continue to have:
   - Its own signup & onboarding flow
   - Country-specific KYC rules (BD vs US)
   - Dedicated dashboard and navigation
   - Role-specific permissions and status flows
   - NO cross-role data access

2) GLOBAL SERVICES (3 major)
   - Ride-hailing
   - Food delivery (SafeGo Eats)
   - Parcel delivery

   This step focuses on DRIVER FOOD DELIVERY UI, but MUST NOT break ride or parcel flows.

3) COUNTRY-SPECIFIC KYC (must remain intact)

   Bangladesh (BD) – required for all users:
   - father_name
   - date_of_birth
   - present_address
   - permanent_address
   - NID_number
   - NID_front_image
   - NID_back_image
   - emergency_contact_name
   - emergency_contact_phone
   - verification_status ("pending" | "approved" | "rejected")
   - is_verified (boolean)

   United States (US) – required:

   All users:
   - date_of_birth
   - home_address
   - emergency_contact_name
   - emergency_contact_phone
   - government_id_type
   - government_id_last4
   - verification_status
   - is_verified

   Drivers in US (extra):
   - driver_license_number
   - driver_license_image
   - driver_license_expiry
   - ssn_last4 (optional)
   - driver_background_check_status

   Only Admin can approve/reject KYC and set verification_status / is_verified.

4) ADMIN PANEL – REQUIRED POWERS (must keep working)
   - Review and approve/reject KYC for customers, drivers, restaurants with rejection_reason
   - View sensitive documents (NID, license, IDs) – only in admin
   - Update pricing, fees, commissions (including Step 47 commissionConfig)
   - Block/unblock any user and record blocked_reason
   - Manage payouts and settlements
   - View driver_negative_balance and restaurant_negative_balance
   - View audit logs for verification, blocking, pricing, and payouts

5) CORE COLLECTIONS (cannot be renamed/removed)
   - rides
   - food_orders
   - deliveries

   Each collection MUST keep:
   - identity fields:
     - customer_id
     - driver_id (where applicable)
     - restaurant_id (for food_orders)
   - addresses + geolocation (pickup/dropoff lat/lng, address text)
   - financial fields:
     - total_amount_charged_to_customer
     - platform_commission_amount
     - driver_earnings_amount (for rides/deliveries)
     - restaurant_earnings_amount (for food_orders)
     - payment_method (cash, card, wallet, etc.)
     - payment_status
   - timestamps:
     - created_at, updated_at
     - accepted_at, picked_up_at, delivered_at, cancelled_at, etc.
   - rating and feedback fields:
     - rating
     - rating_comment / feedback_text

6) COMMISSION & WALLET RULES (Step 47 – must be respected)

   commissionConfig (already implemented):
   - BD:
     - restaurant_commission_percent = 12
     - driver_commission_percent = 10
   - US:
     - restaurant_commission_percent = 15
     - driver_commission_percent = 10

   Rules:
   - If customer pays CASH for a ride or delivery:
       Driver collects full cash.
       SafeGo’s commission is stored as negative_balance in driver wallet.
   - If food order is CASH:
       Restaurant gets all cash.
       SafeGo commission becomes negative_balance in restaurant wallet.
   - If payment is ONLINE:
       SafeGo keeps platform_commission_amount.
       Driver/restaurant earnings go to wallets.available_balance.
   - Admin can settle balances and record payouts through wallet_transactions with audit trail.

7) SECURITY RULES (must apply to all new driver-delivery UI)
   - Customers cannot see driver documents (NID, license, SSN etc.).
   - Drivers cannot see customer NID or government IDs.
   - Restaurants cannot see other restaurants’ data or wallets.
   - Only Admin can:
     - change pricing/commission
     - change verification_status
     - block/unblock accounts
   - Users may update only their own profile data (non-admin).
   - Government ID fields (government_id_last4, ssn_last4) must be masked in driver views.

8) STATUS FLOWS (must NOT be broken)

   rides.status:
     requested → searching_driver → accepted → driver_arriving → in_progress → completed
     OR cancelled_by_customer / cancelled_by_driver / cancelled_by_admin

   food_orders.status:
     placed → accepted → preparing → ready_for_pickup → picked_up → on_the_way → delivered
     OR cancelled_by_customer / cancelled_by_restaurant / cancelled_by_admin

   deliveries.status:
     requested → searching_driver → accepted → picked_up → on_the_way → delivered
     OR cancelled_by_customer / cancelled_by_driver / cancelled_by_admin

   Existing status transitions must stay valid. We only ADD new UI around them.

9) ONBOARDING (drivers)
   - Multi-step:
     - basic info → address → KYC docs → emergency contact.
   - verification_status = "pending" and is_verified = false by default.
   - Driver cannot go ONLINE for rides/food/parcel until approved by Admin.
   - Blocked drivers cannot go online or accept work.

10) NOTIFICATIONS
   - Drivers must receive notifications (or at least polling updates) for:
     - new ride requests
     - new food delivery tasks
     - new parcel deliveries
   - Users receive:
     - order/parcel status updates
     - verification approval/rejection messages
     - important admin/system notifications

11) IMPLEMENTATION RULES
   - All Step 49 work is ADD-ONLY and fully backward-compatible.
   - Do NOT rename or remove any existing fields, APIs, DB schemas, or UI routes.
   - If in doubt, create new wrapper endpoints or components instead of editing existing core logic.

================================================================
B) STEP 49 – GOAL
================================================================

Build a complete, demo-ready **Driver Food-Delivery Web App UI** integrated with existing delivery APIs, so that DRIVERS can:

1) See and accept/reject food delivery offers.
2) Navigate to restaurant pickup.
3) Mark food as picked up.
4) Navigate to customer dropoff.
5) Mark order as delivered (with optional proof).
6) See their delivery history.
7) See a simple wallet summary (powered by Step 47 wallet engine).

This must work on:
- mobile browser (phone) with list-style layout,
- tablet,
- desktop.

And must NOT break:
- ride driver UI (Step 48),
- customer Eats UI,
- restaurant dashboard,
- parcel delivery flow.

================================================================
C) PHASE 1 – DRIVER DELIVERY NAVIGATION ENTRY
================================================================

1) In the driver web app shell (built in Step 48 – /driver), add a dedicated entry for Food Delivery:

   - In driver navigation (tabs or sidebar), ensure there is a clearly labeled item:
     - "Food Deliveries" or "Eats Deliveries"

   - This should route to:
     - /driver/deliveries or /driver/eats (ADD-ONLY route).

2) Show high-level summary on /driver:

   - When driver role is logged in, on Home show small cards:

     - "Active Food Deliveries" (count)
     - "Completed Today" (count + earning)
     - "Go to Delivery Inbox" (button)

3) Enforce security:

   - If driver is not verified or is blocked, DO NOT allow opening the deliveries section:
     - Show banners:
       - "Your account must be verified to receive delivery orders."
       - "Please contact support; your account is currently blocked."

================================================================
D) PHASE 2 – DRIVER DELIVERY INBOX (NEW UI)
================================================================

Create **DriverDeliveryInboxScreen** (for food deliveries only):

1) Data Source

   - Reuse existing delivery APIs built earlier for Step 46, for example:

     - GET /api/driver/deliveries/active
       → returns:
         - pending delivery offers (for this driver)
         - currently accepted / in-progress deliveries (if any)

   - If there is a distinction between "offers" and "assigned", design accordingly:
     - offers[]: available to accept
     - current[]: accepted / in_progress deliveries

   - If API is different, adapt to current implementation but DO NOT change API names – only add wrappers as needed.

2) UI Layout (list on mobile, more info on desktop)

   For each OFFER card:

   - Restaurant name + small logo
   - Pickup address (short form)
   - Customer dropoff area (neighborhood or short address)
   - Estimated distance / ETA if available
   - Fare summary:
     - total_amount_charged_to_customer
     - driver_earnings_amount
   - Payment type:
     - Cash / Online
   - Order type:
     - "Food Delivery" tag
   - Buttons:
     - "Details"
     - "Accept"
     - "Reject"

   For each ACTIVE delivery card (already accepted):

   - Show progress pill:
     - "Go to Pickup"
     - "Picked Up – Delivering"
   - Button:
     - "Open Active Delivery" → goes to detailed workflow screen.

3) Behavior

   - Polling every N seconds (using config):
     - Check for new offers while driver is ONLINE for deliveries.
   - Ensure accept/reject actions call existing endpoints, e.g.:
     - POST /api/driver/deliveries/:deliveryId/accept
     - POST /api/driver/deliveries/:deliveryId/reject
   - Respect negative_balance rule for CASH deliveries:
     - If driver_negative_balance > threshold for their country, block new CASH deliveries, allow ONLINE only.
     - Show clear message: "You cannot accept cash deliveries until your balance is settled."

================================================================
E) PHASE 3 – DELIVERY REQUEST DETAILS
================================================================

Create **DriverDeliveryRequestDetailScreen**:

1) Show:

   - Restaurant:
     - Name, cuisine, rating (if available)
     - Address
   - Customer (limited info):
     - First name only
     - Area / building (no government ID, no sensitive fields)
   - Map:
     - Restaurant and customer location markers
     - Approx route and distance
   - Time & distance:
     - Distance restaurant → dropoff
     - Estimated total time

2) Fare & Payments:

   - Breakdown:
     - total_amount_charged_to_customer
     - platform_commission_amount
     - driver_earnings_amount
   - Payment type:
     - "Cash – You collect full amount from customer, SafeGo will deduct commission from your wallet."
     - OR
     - "Online – SafeGo will pay you your share automatically."

3) Actions:

   - Accept Delivery
   - Reject Delivery
   - Back to Inbox

4) Security:

   - Enforce the same cash blocking rule here:
     - If driver_negative_balance is over threshold:
       - Disable Accept for cash deliveries
       - Show tooltip / message explaining why.

================================================================
F) PHASE 4 – ACTIVE DELIVERY WORKFLOW
================================================================

Create **DriverActiveDeliveryScreen** for food deliveries.

Delivery stages (tie to both food_orders.status and deliveries.status):

1) Stage 1 – Navigate to Restaurant

   - deliveries.status: accepted
   - food_orders.status: ready_for_pickup OR earlier, depending on integration

   Show:
   - Restaurant name, address
   - Map with driver location + restaurant pin
   - Button: "Open in Maps" (external navigation)
   - Button: "Arrived at Restaurant"

   On "Arrived at Restaurant":
   - Optionally set deliveries.status = accepted or a specific "arrived_at_pickup" if supported.
   - Show next stage.

2) Stage 2 – Pick Up Order

   - Show restaurant pickup instructions:
     - Order ID / code
     - Items count
     - Special notes (no onion, contactless, etc.)
   - Button: "Order Picked Up"

   On "Order Picked Up":
   - Update:
     - deliveries.status = picked_up
     - food_orders.status = picked_up
   - Start live location updates:
     - POST /api/driver/deliveries/location { deliveryId, lat, lng }
     - Frequency: every driverDeliveryConfig.locationUpdateIntervalSeconds (e.g. 10s).
   - Move to Stage 3.

3) Stage 3 – On the Way to Customer

   - deliveries.status = on_the_way
   - Show:
     - Customer dropoff address and map
     - Distance/ETA
     - Payment type:
       - "Cash: collect when delivered."
       - "Online: do NOT collect cash."
   - Buttons:
     - "Call Customer" (if phone number allowed)
     - "View Notes" (leave at door, ring bell, etc.)
     - "Arrived at Customer"

   On "Arrived at Customer":
   - Optionally record arrived_at_dropoff timestamp.
   - Show final confirmation.

4) Stage 4 – Order Delivered

   - Show summary card:
     - Order code
     - Items summary
     - Payment type
   - If payment type is CASH:
     - Checkbox: "Customer paid cash."
     - Prevent completion unless checked, or allow with warning log.

   Optional proof:
   - Allow attaching photo (e.g. leave at door picture), if infrastructure for file upload exists (ADD-ONLY). If not, add TODO notes and leave stub.

   Button: "Mark as Delivered"

   On "Mark as Delivered":
   - Update:
     - deliveries.status = delivered
     - food_orders.status = delivered
   - Trigger wallet/commission logic (Step 47):
     - For CASH:
       - driver collects full cash
       - driver wallet negative_balance += platform_commission_amount (driver_commission 10%)
     - For ONLINE:
       - driver_earnings_amount added to wallet.available_balance.

   - Show Delivery Summary Screen:
     - total fare
     - driver earnings
     - cash/online info
     - link "Back to Delivery Inbox"
     - link "View Delivery History"

================================================================
G) PHASE 5 – DRIVER DELIVERY HISTORY
================================================================

Create **DriverDeliveryHistoryScreen**:

1) API:

   - GET /api/driver/deliveries/history?cursor/limit...
     Returns deliveries where driver_id = current driver.

2) UI:

   - Filter buttons:
     - "Last 7 days"
     - "Last 30 days"
     - "All"
   - Optional filter by payment_type (Cash / Online).

   Each row/card:
   - Date & time
   - Restaurant → Customer area (short text)
   - Status (delivered / cancelled_by_x)
   - Payment_type
   - Driver earnings_amount

   Clicking row → DeliveryDetail popup:

   - Show:
     - Full route info (summary)
     - Commission & earnings breakdown (driver side only)
     - food_orders.status timeline (optional read-only)

3) Security:
   - Only show deliveries for the authenticated driver.
   - No extra customer PII beyond name (first name) + high-level address.

================================================================
H) PHASE 6 – DRIVER WALLET SUMMARY (REUSE STEP 47)
================================================================

Extend the existing **DriverWalletScreen** (from Step 48) to also reflect food delivery earnings:

1) Ensure all deliveries (food) that generate driver_earnings_amount write corresponding wallet_transactions.

2) On the DriverWalletScreen:
   - Show:
     - available_balance
     - negative_balance
     - total_earnings
     - breakdown by category:
       - rides_earnings_total
       - food_delivery_earnings_total
       - parcel_earnings_total (if applicable)

3) Show latest 10 wallet_transactions:
   - Date
   - Type:
     - ride_earning
     - food_delivery_earning
     - cash_commission_debit
     - payout
     - manual_adjustment
   - Amount

4) Driver cannot edit balances or transactions; only view.

================================================================
I) PHASE 7 – RESPONSIVE DESIGN & PWA BEHAVIOR
================================================================

1) Mobile (phones):
   - Delivery inbox must be a single-column list:
     - Each card full width.
     - Big Accept / Reject buttons.
   - Active delivery screen:
     - Top: stage indicator (Pickup → On the Way → Delivered)
     - Middle: map
     - Bottom: actions (arrived, picked up, delivered).

2) Tablets/desktops:
   - Split view:
     - Left: summary / list or steps
     - Right: map + details.

3) PWA:
   - Ensure driver app manifest already added in Step 48 also covers delivery routes:
     - start_url: "/driver"
     - scope includes "/driver/deliveries".
   - All new driver delivery screens must render correctly when launched from home screen shortcut (standalone display).

================================================================
J) PHASE 8 – CONFIG & DEMO MODE
================================================================

Add (ADD-ONLY) configuration object:

driverDeliveryConfig = {
  enableFoodDelivery: true,
  locationUpdateIntervalSeconds: 10,
  maxDeliveryRadiusKm: 8,
  cashNegativeBalanceBlockThreshold: {
    BD: 2000,
    US: 100
  },
  enableProofPhoto: false,
  enableDemoMode: true
}

Behavior:

- enableFoodDelivery:
  - If false, hide delivery navigation from driver UI (for future markets).

- locationUpdateIntervalSeconds:
  - Used by active delivery screen for GPS pings.

- cashNegativeBalanceBlockThreshold:
  - If driver_negative_balance > threshold for country, block new CASH deliveries but still allow ONLINE.

- enableProofPhoto:
  - If true and upload infra exists, show photo capture/upload on delivery completion.
  - If false (default), show no file upload to stay lightweight.

- enableDemoMode:
  - When true, provide a "Demo Deliveries" section where drivers can:
    - simulate receiving fake delivery offers,
    - accept, pick up, deliver them without touching real data or money.
  - Must be clearly marked as "DEMO – Not a real order".

================================================================
K) PHASE 9 – SECURITY & LOGGING
================================================================

1) All driver delivery routes require:
   - authenticated driver session
   - driver.is_verified = true
   - driver is not blocked.

2) For every critical action:
   - Accept / Reject delivery
   - Mark picked_up
   - Mark delivered
   - Cash/online completion

   Log audit events with:
   - driver_id
   - delivery_id
   - previous_status
   - new_status
   - timestamp
   - IP or device info if available.

3) Never expose:
   - customer government IDs
   - restaurant sensitive financial data.

================================================================
L) NON-BREAKING GUARANTEE
================================================================

You MAY:
- Add new driver UI screens/routes/components:
  - /driver/deliveries
  - /driver/deliveries/history
  - /driver/deliveries/:id (active/detail)
- Add new READ/WRITE APIs for driver delivery UX, wrapping existing delivery APIs if needed.
- Add driverDeliveryConfig and hook into existing config system.

You MUST NOT:
- Rename or delete existing models, fields, routes, or collections.
- Change existing ride or parcel behavior.
- Change commissionConfig values or wallet core logic.

Final outcome for STEP 49:
- Driver can fully handle FOOD DELIVERIES from their web-based driver app (mobile/tablet/desktop).
- Experience is demo-ready, responsive, and PWA compatible.
- Commission, wallet, KYC, security, and status flows for rides/food/parcel remain correct and intact.
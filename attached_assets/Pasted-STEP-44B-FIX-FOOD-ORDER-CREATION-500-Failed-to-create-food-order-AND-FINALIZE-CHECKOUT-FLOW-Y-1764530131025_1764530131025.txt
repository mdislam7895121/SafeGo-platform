STEP 44B – FIX FOOD ORDER CREATION (500 "Failed to create food order") AND FINALIZE CHECKOUT FLOW

You must follow ALL SafeGo Master Rules exactly.
This step is a bug-fix + integration step within Step 44. It must be 100% backward-compatible and must NOT break any existing SafeGo functionality.

IMPORTANT CONSTRAINTS:
- Do NOT change SafeGo desktop layout built in Step 43.
- Do NOT change commission, payout, wallet, or admin financial logic.
- Do NOT rename or remove any fields in core collections (rides, food_orders, deliveries, users).
- Only ADD missing integrations, validations, and safe fallbacks needed to make food_order creation succeed.
- This is ONLY about making the food order POST/creation work and flow through correctly with variants/add-ons.

====================================================
A. RECALL MASTER SAFEGO RULES (APPLY, DO NOT MODIFY)
====================================================

You MUST respect all previously established SafeGo rules:

1) Roles: Customer, Driver, Restaurant, Admin – separate dashboards, permissions, and KYC.
2) Core services: rides, food_orders (Eats), deliveries.
3) Country-specific KYC: BD and US separate required fields.
4) Admin powers: verify users, approve/reject KYC, manage pricing/commissions, block/unblock, manage negative balances.
5) Core collections: rides, food_orders, deliveries – identity, location, financials, timestamps, statuses, ratings.
6) Commission rules: cash vs online handling, negative balances for drivers/restaurants, admin settlement.
7) Security: no cross-role access to documents or private data, no PII leaks, masked IDs.
8) Status flows: rides, food_orders, deliveries must follow allowed lifecycle.
9) Onboarding and notifications: must keep working.
10) Non-breaking implementation: add-only, no destructive schema or API changes.

Do NOT restate these rules – just obey them during debugging and fixing.

====================================================
B. BUG DESCRIPTION (FROM USER)
====================================================

Current user-visible symptom during checkout:

- Screen: Customer /customer/food/checkout
- User selects items (e.g., “Margherita Pizza”, “Garlic Bread”) and taps "Place Order".
- UI bottom toast shows:
  - `Order failed`
  - `500: {"error":"Failed to create food order"}`

Interpretation:
- Frontend submits an order request.
- Backend call to create a new food_order fails with HTTP 500 and error message `"Failed to create food order"`.
- This happened after Step 43/44 UI upgrades and menu variants/add-ons feature.

Goal of Step 44B:
- Diagnose and eliminate the server-side failure.
- Ensure food_orders are created correctly with or without variants/add-ons.
- Keep all existing rules and flows intact.

====================================================
C. DIAGNOSTIC TASKS (SERVER-SIDE)
====================================================

1) Identify the exact endpoint used by checkout:
   - e.g. POST /api/customer/food/orders or similar.
   - Inspect the handler in the backend (ReplitBackend project).

2) Enable/inspect detailed logs or stack trace for this endpoint:
   - Find where the generic `"Failed to create food order"` error is thrown.
   - Capture the underlying exception (validation error, DB error, missing field, type mismatch, etc.).

3) Compare request payload vs. model:
   - Log the incoming JSON payload from the frontend.
   - Compare against expected schema for creating a food_order, including Step 44 additions:
     - base fields (restaurant_id, customer_id, items, totals, address, payment_method, etc.)
     - new optional fields: selected_variant_id, selected_add_ons, etc.
   - Look for:
     - required field missing (e.g. delivery_address, restaurant_id)
     - mismatch types (string vs number)
     - null vs not-null DB constraints.

4) Check DB schema/migrations:
   - Ensure food_orders and related tables/collections have all fields required for Step 44 additions.
   - Verify new Step 44 fields (e.g. selected_variant_id, add_ons array) are OPTIONAL and non-breaking (nullable or default).
   - Confirm that existing demo data and new demo fields do not violate NOT NULL constraints.

5) Validate foreign key integrity:
   - Ensure restaurant_id, menu_item_ids, variant_ids, add_on_ids actually exist in DB.
   - Confirm no FKs are failing at insert time.

====================================================
D. FIXING STRATEGY (NON-BREAKING)
====================================================

Implement the following fixes ADDITIVELY:

1) Make Step 44 fields optional with safe defaults:
   - In the server-side order creation model/DTO:
     - Treat selected_variant_id, variants, add_ons as optional.
     - If they are absent, treat as:
       - default variant (if defined) OR
       - base item with no variant.
     - If add_ons not provided, use empty list.

2) Strong server-side validation:
   - Before inserting into DB, validate:
     - restaurant_id is present and corresponds to an active restaurant.
     - items array is non-empty.
     - each item has:
       - menu_item_id
       - quantity > 0
       - price information consistent with backend logic (recalculate server-side if necessary).
     - if selected_variant_id is present:
       - ensure that variant belongs to the menu_item_id and is active.
     - if any add_ons are present:
       - ensure that each add_on_id is linked to that menu_item_id and active.
   - If validation fails, return HTTP 400 with a clear error:
     - e.g. `{ "error": "Invalid variant selected" }`
   - Do NOT use HTTP 500 for validation issues.

3) Handle delivery address and payment safely:
   - Ensure address fields are taken from:
     - BD: present_address (or saved delivery address variant).
     - US: home_address (or saved delivery address).
   - If delivery address is required and missing, respond 400 with user-friendly message.
   - Ensure payment_method uses existing allowed values (cash/card/wallet).

4) Fix any DB insert logic causing 500:
   - If insertion fails due to strict schema:
     - update schema to allow:
       - nullable variant/add-on references
       - or add proper default values
     - without removing or renaming any existing column/field.
   - Wrap DB call with clear try/catch:
     - log exact error internally
     - return safe 500 with `"error": "Internal order error"` only if truly unexpected.

5) Preserve and reuse existing financial calculation:
   - Keep commission, service fee, and payout fields calculated by existing logic.
   - Step 44 additions may influence item-level totals, but final totals must still flow through the same place.
   - Ensure base_price, service_fee, platform_commission_amount, restaurant_earnings_amount, total_amount_charged_to_customer are still set.

====================================================
E. FRONTEND INTEGRATION CHECK (CHECKOUT)
====================================================

On the customer app side:

1) Confirm that the checkout payload matches backend expectations:
   - restaurant_id
   - customer_id (from authenticated session)
   - items: each with menu_item_id, quantity, and selected variant/add-ons if any.
   - totals: client-calculated but re-verified server-side.

2) If new Step 44 fields were named differently between frontend and backend (e.g. selectedVariantId vs selected_variant_id), align them ADDITIVELY:
   - Prefer to map frontend names to backend schema in the API adapter layer.
   - Do NOT rename existing backend fields that might already be used elsewhere.

3) Show friendly error messages:
   - If backend returns 400 with known validation error, show that to the customer in a clean toast.
   - For real 500s (should be rare after this fix), show a generic message and log for internal debugging.

====================================================
F. DEMO & CUSTOMIZATION REQUIREMENT (MUST)
====================================================

You MUST provide:

1) DEMO ORDERS THAT WORK:
   - At least one fully working demo order flow for:
     - 1 US demo restaurant (with variants/add-ons).
     - 1 BD demo restaurant (with variants/add-ons).
   - Flow:
     - Customer selects restaurant → item detail → selects variant/add-ons → add to cart → checkout → place order → order created successfully → status = placed.

2) CUSTOMIZABLE CONFIG:
   - Ensure restaurant dashboard can still edit menu items, variants, add-ons without breaking order creation.
   - Changes to menu must be reflected in the order validation logic.

====================================================
G. RESTAURANT & ADMIN VISIBILITY (MINIMUM)
====================================================

AFTER a food_order is successfully created:

1) Restaurant dashboard:
   - New order should appear in a basic “Orders” list (even if full Step 45 kitchen flow is not ready yet).
   - Show:
     - customer first name
     - items with variants/add-ons
     - total amount
   - This can be a simple list; full status management will be addressed in Step 45.

2) Admin panel:
   - Admin should be able to see the new food_orders entry in its existing order/revenue view (if present).

Do NOT implement the full kitchen flow here; only ensure the newly created orders are visible and consistent.

====================================================
H. TEST PLAN (MANDATORY BEFORE FINISHING STEP 44B)
====================================================

You MUST run and complete the following tests:

1) Customer-side tests:
   - Test 1: Simple order with NO variants and NO add-ons.
   - Test 2: Order with variants only.
   - Test 3: Order with add-ons only.
   - Test 4: Order with variants + multiple add-ons.
   - For each test:
     - Confirm no 500 error.
     - Confirm order appears in DB/restaurant view.

2) Edge tests:
   - Try ordering with an invalid variant or add-on ID (simulated):
     - Expect clean 400 with descriptive error, NOT 500.

3) Country-specific tests:
   - Place a demo order as BD customer.
   - Place a demo order as US customer.
   - Confirm address formatting and basic localization.

When all tests pass and 500 errors are gone, mark Step 44B as complete.

====================================================
FINAL REQUIREMENT
====================================================

Deliver Step 44B as:

- A stable, working food order creation flow.
- No more `"Failed to create food order"` 500 errors under normal conditions.
- Fully compatible with:
  - Step 43 UI
  - Step 44 variants/add-ons structure
  - SafeGo global rules for roles, KYC, status flow, and security.
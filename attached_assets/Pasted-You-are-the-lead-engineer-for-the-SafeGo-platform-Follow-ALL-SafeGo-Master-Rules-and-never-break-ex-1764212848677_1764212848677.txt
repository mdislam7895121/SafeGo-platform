You are the lead engineer for the SafeGo platform. Follow ALL SafeGo Master Rules and never break existing working features.

========================
GLOBAL SAFEGO MASTER RULES (ALWAYS APPLY)
========================
1) Multi-role system:
   - Roles: customer (rider/eater/sender), driver, restaurant/merchant, admin.
   - Core flows: ride, food delivery, parcel delivery – all must share a consistent trip/order model and status system.

2) KYC & compliance:
   - US drivers: DMV + TLC license, SSN, address, age >= 21, background check.
   - US restaurants: EIN or SSN, business address, bank info, food-safety doc.
   - BD region (if present): NID/passport, mobile-OTP, driving license, bank/bKash/Nagad.
   - KYC gating must never be removed; only read/extend what already exists.

3) Admin panels & data models (do NOT break):
   - Required collections: users, drivers, vehicles, restaurants, menus, rides, food_orders, deliveries, payouts, wallets, incentives, ratings, support_tickets, documents, notifications, audit_logs.
   - Admin can: search/filter, soft-ban, reset KYC status, manage payouts, see logs, manage promotions & incentives, adjust fees and commissions.

4) Money & payouts:
   - Platform commission per ride/order; tax/fees where applicable.
   - Driver/restaurant wallets: running balance, locked vs available.
   - Payout methods: bank (checking/savings), card, plus any country-specific methods already implemented.
   - Never change existing commission or payout formulas; only read and extend.

5) Security rules (must stay enabled):
   - Phase 1+2 already in place: HSTS, CSP, CORS, rate limiting on sensitive routes, password verification on payout changes, OTP service, device/session security, tamper-proof audit logs, payout 2FA.
   - Do NOT weaken any security: no public test endpoints, no hard-coded secrets, no disabling auth/guards.
   - Log important events to audit_logs with non-PII summaries.

6) Status & lifecycle consistency:
   - Rides / deliveries share a common lifecycle: requested → accepted → en-route → arriving → arrived → in-progress/started → completed/cancelled.
   - Driver status and trip status must always stay in sync with the backend enums that already exist.

7) UX rules:
   - Keep the current SafeGo look & feel; do not redesign the driver header, side drawer, or wallet pages.
   - Only improve the C-3 Driver Active Trip experience.
   - Must be fully responsive on mobile web.
   - All interactive elements must have stable data-testid attributes.

8) No breaking changes:
   - Re-use existing files, enums, hooks, and components where possible.
   - Do NOT rename or remove existing exports, routes, Prisma enums, or API contracts.
   - If a refactor is unavoidable, keep it backward compatible.

========================
TASK: C-3 DRIVER ACTIVE TRIP SCREEN – UBER-LEVEL MAP + STATUS ENGINE
========================

Goal: Turn the existing C-3 Driver Active Trip Screen into a professional, Uber-level experience with:
- A live animated map (SafeGo Maps wrapper on top of the existing map library).
- Real-time driver position updates.
- Turn-by-turn style route visualisation (polyline, ETA, distance).
- Clean status transitions enforced against the backend.
- Multi-app navigation shortcuts (SafeGo, Google Maps, Apple Maps, Waze).
- Swipe-to-complete + strong validation/fraud-safety.

Important:
- The current C-3 screen is partially implemented with gestures, a simple animated map, and basic statuses.
- DO NOT touch driver headers, drawer, language switcher, or wallet/payout flows.
- Only work in the driver app C-3 area and strictly related backend routes.

------------------------
1. Map architecture – SafeGo Maps wrapper
------------------------
1.1 Create a small “SafeGoMaps” abstraction instead of sprinkling raw map code everywhere:
    - Prefer adding a wrapper component or hook around the existing map library (e.g. Mapbox/Leaflet/Google) rather than introducing a new dependency.
    - Keep it inside a driver-specific folder, e.g.:
      - client/src/components/driver/maps/SafeGoMap.tsx
      - client/src/components/driver/maps/hooks/useDriverTripMap.ts
    - Expose functions such as:
      - showRoute(origin, destination, waypoints?).
      - updateDriverMarker(position).
      - setFocus(mode: "full-route" | "driver" | "pickup" | "dropoff").
      - fitToRouteBounds().

1.2 Use browser geolocation for web:
    - Implement a hook (e.g. useDriverGeolocation) that:
      - Requests permission on first active trip.
      - Polls or subscribes to position updates.
      - Debounces updates to avoid spamming the backend.
    - Handle all geolocation error states gracefully:
      - Permission denied, unavailable, or timeout should show a clear inline warning on the trip screen but must NOT crash.

1.3 Do NOT build your own routing engine:
    - Use the existing or easily accessible directions endpoint / library.
    - If no routing API is configured, fall back to:
      - Straight line polyline between pickup and drop-off.
      - Basic ETA stub with clear “Demo ETA” label.
    - Keep the routing logic encapsulated in useDriverTripMap so it’s replaceable later.

------------------------
2. Trip lifecycle & status engine
------------------------
2.1 Align strictly with the backend driver-trips route:
    - Open server/routes/driver-trips.ts and reuse its status enums/guards.
    - Valid statuses must include (or map to) at least:
      - “arriving”, “arrived”, “started”, “completed”, plus any existing service-specific values.
    - Never introduce new status strings without mapping them through the existing enums.

2.2 Implement a small state machine on the client:
    - In client/src/pages/driver/trip-active.tsx (or the relevant C-3 file), create a thin state layer that:
      - Holds the current trip status from the backend.
      - Controls which action buttons are active:
        - When en-route → allow “Arrived”.
        - When arrived → allow “Start trip”.
        - When started → allow “Complete trip” (via swipe).
      - Prevents impossible transitions (e.g. completing before starting).

2.3 Backend validation:
    - On each status change, call the existing backend endpoint (do NOT invent new ones unless absolutely required).
    - Ensure the backend:
      - Validates current status before applying the new one.
      - Rejects double completion and out-of-order transitions.
      - Writes an audit_log entry with:
        - actor: driver ID.
        - trip ID.
        - old_status → new_status.
        - source: “driver_active_trip_screen”.
    - Return clear error codes/messages for:
      - Invalid transitions.
      - Missing KYC / verification block.
      - Suspended drivers.

------------------------
3. Map UI & controls – Uber-style active trip
------------------------
3.1 Main layout:
    - Keep the existing SafeGo style, but ensure the screen shows:
      - Top: trip header with status pill (Arriving, Arrived, In Trip, Completing…).
      - Middle: map with highlighted route, pickup & drop-off pins, and animated driver marker.
      - Bottom: action panel with:
        - Rider card (name, rating, masked phone).
        - Destination info (address + ETA + distance).
        - Action buttons grid (Call, Message, Navigate, SOS).
        - Swipe-to-complete strip (when in “in-trip/started” state).

3.2 Multi-app navigation:
    - Add a “Navigate” button that opens a small modal or action sheet with options:
      - SafeGo Map (in-app).
      - Google Maps.
      - Apple Maps (only show on iOS / when supported).
      - Waze (if installed/available).
    - Implement deep links using standard URL schemes:
      - google.navigation:q=lat,lng or equivalent.
      - http(s) links for Apple Maps and Waze.
    - All external launches must be logged to audit_logs as “navigation_app_opened”, with only non-PII info (trip id, app name).

3.3 Swipe-to-complete:
    - Keep a dedicated swipe control:
      - Disable swipe until the status is “started”.
      - On swipe:
        - Confirm via dialog: “Confirm trip completion and fare calculation?”
        - Then call backend complete-trip endpoint.
      - Block completion if:
        - Backend says “too short/invalid trip”.
        - Required GPS or time data is missing.
    - Show clear inline errors when completion is rejected.

------------------------
4. Safety & anti-abuse protections
------------------------
4.1 Fraud-resistant completion:
    - If GPS data is available, send a final snapshot on completion:
      - driver location, drop-off location, trip duration & distance (approx).
    - Never store raw precise GPS permanently on the client; only send to backend over HTTPS.
    - The backend should:
      - Sanity-check distance/time vs expected route.
      - Log suspicious cases to audit_logs with a “fraud_suspected” flag (but NO PII in the message field).

4.2 SOS and safety quick actions:
    - Ensure the existing SOS button (or placeholder) is wired to:
      - Either open a configured safety contact screen, or
      - Show the existing safety center with quick dial to 911/local emergency.
    - Do not store emergency phone numbers in the client code; they must come from config or backend.

4.3 Security alignment:
    - All C-3 API calls must:
      - Use the existing auth middleware.
      - Respect existing rate limits – do not create polling loops faster than allowed.
    - Never expose internal IDs or secrets in the UI.

------------------------
5. Testing, data-testids, and non-breaking changes
------------------------
5.1 Add or update data-testid attributes on:
    - Map container, driver marker, pickup marker, drop-off marker.
    - Status pill, action buttons (call/message/navigate/SOS).
    - Swipe-to-complete strip and success state.
    - Error banners (for GPS and status validation).

5.2 Minimal surface area:
    - Files you may edit (names may vary slightly, adapt as needed):
      - client/src/pages/driver/trip-active.tsx
      - client/src/components/driver/maps/** (new wrappers/hooks)
      - server/routes/driver-trips.ts (ONLY to extend validation, not to weaken it)
      - Any small shared type definition used by these endpoints.
    - Do NOT modify:
      - Driver header/drawer layout.
      - Wallet and payout flows.
      - Security hardening middleware (HSTS, CSP, CORS, rate limiting, OTP, 2FA).

------------------------
6. Final checklist to show in your summary
------------------------
When you are done, your summary MUST clearly list:

1) “C-3 Driver Active Trip Screen” updated with:
   - SafeGo map wrapper
   - Live driver location
   - Route polyline + ETA
   - Multi-app navigation options

2) Status engine:
   - Exact list of allowed transitions and their backend validation.

3) Swipe-to-complete:
   - When it is enabled
   - What validation it performs
   - What happens on failure.

4) Security & audit:
   - Which events are written to audit_logs.
   - How GPS and navigation data is handled safely.

5) Tests:
   - Which data-testid attributes you added.
   - Any demo or seed data added to make the C-3 screen easy to preview.

Do NOT start any new features (trip history, analytics, etc.) in this task. Focus only on finishing C-3 to an Uber-level, production-ready implementation without breaking existing Driver or Restaurant flows.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  COUNTRY_ADMIN
  CITY_ADMIN
  COMPLIANCE_ADMIN
  SUPPORT_ADMIN
  FINANCE_ADMIN
  READONLY_ADMIN
}

enum SecurityStatus {
  normal
  under_observation
  needs_review
}

enum DocumentStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  EXPIRING_SOON
  EXPIRED
  REJECTED
  NEEDS_UPDATE
}

enum DriverAssignmentStatus {
  none
  searching_driver
  driver_assigned
  driver_rejected
  no_driver_found
}

enum DeliveryServiceType {
  ride
  food
  parcel
}

model AdminProfile {
  id                           String    @id @default(uuid())
  userId                       String    @unique
  adminRole                    AdminRole @default(SUPER_ADMIN)
  isActive                     Boolean   @default(true)
  createdAt                    DateTime  @default(now())
  twoFactorEnabled             Boolean   @default(false)
  twoFactorSecret_encrypted    String?
  twoFactorRecoveryCodes_encrypted String?
  pending2FASecret_encrypted   String?
  pending2FAExpiresAt          DateTime?
  country                      String?
  countryCode                  String?
  cityCode                     String?
  user                         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminSupportTickets          AdminSupportTicket[] @relation("AdminSupportTickets") // Phase 12 Extension
  adminLiveChatSessions        AdminLiveChatSession[] @relation("AdminLiveChatSessions") // Phase 12 Extension
  adminSupportCallbacks        AdminSupportCallback[] @relation("AdminSupportCallbacks") // Phase 12 Extension

  @@index([countryCode])
  @@index([cityCode])
  @@map("admin_profiles")
}

model CustomerProfile {
  id                    String            @id @default(uuid())
  userId                String            @unique
  cityCode              String?
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  verificationStatus    String            @default("pending")
  rejectionReason       String?
  isVerified            Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  isSuspended           Boolean           @default(false)
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  securityStatus        SecurityStatus    @default(normal)
  securityNotes         String?
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  foodOrders            FoodOrder[]
  rides                 Ride[]
  reviews               Review[]         // Phase 8: Customer reviews
  supportTickets        SupportTicket[]  // Phase 12: Customer support tickets
  customerSupportTickets CustomerSupportTicket[] @relation("CustomerSupportTickets") // Phase 12 Extension
  customerLiveChatSessions CustomerLiveChatSession[] @relation("CustomerLiveChatSessions") // Phase 12 Extension
  customerSupportCallbacks CustomerSupportCallback[] @relation("CustomerSupportCallbacks") // Phase 12 Extension
  favoriteRestaurants   FoodRestaurantFavorite[] // Favorite restaurants for quick access
  savedAddresses        CustomerAddress[]        // Multiple delivery addresses
  blockedRestaurants    CustomerBlockedRestaurant[] // Restaurants blocked by customer
  
  // Phase 1A: Real-Time Dispatch
  dispatchSessions      DispatchSession[]        // Dispatch sessions for this customer

  @@index([cityCode])
  @@map("customer_profiles")
}

model Delivery {
  id               String           @id
  customerId       String
  driverId         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  serviceFare      Decimal          @db.Decimal(10, 2)
  safegoCommission Decimal          @db.Decimal(10, 2)
  driverPayout     Decimal          @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  taxBreakdown     Json?
  totalTaxAmount   Decimal?         @db.Decimal(10, 2)
  isDemo           Boolean          @default(false)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount Int?           @default(0)
  lastSupportStatus  String?        // Latest support ticket status
  // Step 46: Driver Delivery Flow fields (additive only)
  serviceType      DeliveryServiceType @default(parcel)  // ride | food | parcel
  countryCode      String?             // BD | US
  restaurantId     String?             // For food deliveries, link to restaurant
  // Step 46: Driver tracking fields
  driverEtaMinutes      Int?          // Estimated minutes until driver arrives
  driverLastLocationLat Float?        // Driver's last known latitude
  driverLastLocationLng Float?        // Driver's last known longitude
  driverLocationUpdatedAt DateTime?   // When driver location was last updated
  acceptedAt       DateTime?           // When driver accepted
  pickedUpAt       DateTime?           // When driver picked up
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  deliveredAt      DateTime?
  customer         CustomerProfile  @relation(fields: [customerId], references: [id])
  driver           DriverProfile?   @relation(fields: [driverId], references: [id])
  restaurant       RestaurantProfile? @relation(fields: [restaurantId], references: [id]) // Step 46: For food deliveries
  foodOrder        FoodOrder?       // Step 46: Link back from food order

  @@index([isDemo])
  @@index([serviceType])  // Step 46: Index for service type queries
  @@index([status])       // Step 46: Index for status queries
  @@index([driverId])     // Step 46: Index for driver queries
  @@index([restaurantId]) // Step 46: Index for restaurant queries
  @@map("deliveries")
}

model DriverComplaint {
  id         String             @id
  driverId   String?
  customerId String?
  rideId     String?
  reason     String
  description String?
  status     String             @default("open")
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime
  restaurantId String?
  type       String             @default("driver")
  customer   CustomerProfile?   @relation(fields: [customerId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ride       Ride?              @relation(fields: [rideId], references: [id])

  @@map("driver_complaints")
}

model DriverProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  nidImageUrl           String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  driverLicenseNumber   String?
  driverLicenseImageUrl String?
  driverLicenseExpiry   DateTime?
  ssnLast4              String?
  ssnCardImageUrl       String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelationship String?
  verificationStatus    String             @default("pending")
  rejectionReason       String?
  isVerified            Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  isSuspended           Boolean            @default(false)
  lastActive            DateTime?
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  backgroundCheckDate   DateTime?
  backgroundCheckStatus String?            @default("pending")
  licenseStateIssued    String?
  ssnEncrypted          String?
  usaCity               String?
  usaFullLegalName      String?
  usaPhoneNumber        String?
  usaState              String?
  usaStreet             String?
  usaZipCode            String?
  dmvLicenseImageUrl    String?
  dmvLicenseFrontUrl    String?
  dmvLicenseBackUrl     String?
  dmvLicenseExpiry      DateTime?
  dmvLicenseNumber      String?
  dmvLicenseNumber_encrypted String?
  firstName             String?
  lastName              String?
  middleName            String?
  profilePhotoUrl       String?
  tlcLicenseImageUrl    String?
  tlcLicenseFrontUrl    String?
  tlcLicenseBackUrl     String?
  tlcLicenseExpiry      DateTime?
  tlcLicenseNumber      String?
  // D7: Document Status Tracking
  profilePhotoStatus       DocumentStatus    @default(PENDING)
  profilePhotoRejectionReason String?
  driverLicenseStatus      DocumentStatus    @default(PENDING)
  driverLicenseRejectionReason String?
  tlcLicenseDocStatus      DocumentStatus    @default(PENDING)
  tlcLicenseRejectionReason String?
  nidStatus                DocumentStatus    @default(PENDING)
  nidRejectionReason       String?
  taxClassification     String?            // Individual, Sole proprietor, etc.
  w9Status              String?            // pending, submitted, approved
  w9SubmittedAt         DateTime?
  taxCertificationAccepted Boolean?        // W-9 certification checkbox
  taxCertificationDate  DateTime?          // When driver certified tax info
  tripRevenueTotalYtd   Decimal?           @db.Decimal(12, 2) // 1099-K: Trip revenue
  nonTripIncomeTotalYtd Decimal?           @db.Decimal(12, 2) // 1099-NEC: Bonuses, promos
  taxYear               Int?               // Current tax year being tracked
  securityStatus        SecurityStatus     @default(normal)
  securityNotes         String?
  // Driver Preferences
  preferredNavigationApp String?           @default("google") // google, waze, apple, builtin
  autoAcceptRides       Boolean?           @default(false)
  acceptLongTrips       Boolean?           @default(true)
  acceptSharedRides     Boolean?           @default(true)
  shareLocationHistory  Boolean?           @default(true)
  shareUsageAnalytics   Boolean?           @default(false)
  personalizedExperience Boolean?          @default(true)
  notifyRideRequests    Boolean?           @default(true)
  notifyPromotions      Boolean?           @default(true)
  notifyEarnings        Boolean?           @default(true)
  notifySupport         Boolean?           @default(true)
  notifyEmailWeekly     Boolean?           @default(true)
  notifyEmailTips       Boolean?           @default(false)
  preferredLanguage     String?            @default("en") // en, bn, es, fr, ar
  themePreference       String?            @default("system") // light, dark, system
  // D14: Extended Driver Preferences
  notifySms             Boolean?           @default(true)  // SMS notifications enabled
  notifyPush            Boolean?           @default(true)  // Push notifications enabled
  preferShortTrips      Boolean?           @default(false) // Short-trip mode preference
  avoidHighways         Boolean?           @default(false) // Avoid highways in navigation
  weeklyPayoutDay       String?            @default("friday") // monday, tuesday, wednesday, thursday, friday
  instantPayoutEnabled  Boolean?           @default(false) // Instant payout enabled
  shareTripStatus       Boolean?           @default(true)  // Share trip status with emergency contacts
  emergencyShortcutEnabled Boolean?        @default(true)  // Emergency shortcut enabled
  regionPreference      String?            @default("auto") // auto, us, bd, etc.
  // C-3: Real-time driver location for active trips
  currentLat            Float?             // Current driver latitude
  currentLng            Float?             // Current driver longitude
  lastLocationUpdate    DateTime?          // When location was last updated
  
  // Step 4: Active Vehicle Management
  activeVehicleId       String?            // FK to the driver's active/primary vehicle for dispatch
  canGoOnline           Boolean            @default(false) // Driver can only go online if vehicle is approved
  
  // Service Preferences - Controls which services the driver is willing to accept
  // JSON structure: { rideTypes: { safego_go: true, safego_x: true, ... }, foodEnabled: true, parcelEnabled: true }
  servicePreferences    Json?              // Driver's service preference toggles
  servicePreferencesLocked Json?           // Admin-locked service preferences (driver cannot change)
  
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverStats           DriverStats?
  driverWallet          DriverWallet?
  driverPoints          DriverPoints?
  foodOrders            FoodOrder[]
  rides                 Ride[]
  vehicleDocuments      VehicleDocument[]
  vehicles              Vehicle[]         // D1: Changed from Vehicle? to Vehicle[] for 1:N support
  blockedRiders         BlockedRider[]
  supportTickets        SupportTicket[] // Phase 12: Driver support tickets
  financialAdjustments  FinancialAdjustment[] // Phase 12: Financial adjustments
  driverSupportTickets  DriverSupportTicket[] @relation("DriverSupportTickets") // Phase 12 Extension
  driverLiveChatSessions DriverLiveChatSession[] @relation("DriverLiveChatSessions") // Phase 12 Extension
  driverSupportCallbacks DriverSupportCallback[] @relation("DriverSupportCallbacks") // Phase 12 Extension
  promotionProgress     DriverPromotionProgress[] // D5: Driver promotion progress
  promotionPayouts      DriverPromotionPayout[]   // D5: Driver promotion payouts
  onboarding            DriverOnboarding?         // D9: Driver onboarding progress
  incentiveCycles       DriverIncentiveCycle[]    // D19: Driver incentive cycles
  achievements          DriverAchievement[]       // D19: Driver achievements
  rewardLedger          DriverRewardLedger[]      // D19: Driver reward ledger
  safetyIncidents       DriverSafetyIncident[]    // D20: Driver safety incidents
  rideLiveLocations     RideLiveLocation[]        // Phase A: Driver live locations during rides
  
  // Phase 1A: Real-Time Dispatch
  realtimeState         DriverRealtimeState?      // Driver's real-time presence/location
  assignedDispatchSessions DispatchSession[]      @relation("AssignedDriver")
  dispatchOfferEvents   DispatchOfferEvent[]      // Offers received by this driver

  @@map("driver_profiles")
}

// D9: Driver In-App Training & Onboarding System
model DriverOnboarding {
  id                    String        @id @default(uuid())
  driverId              String        @unique
  driver                DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  // Onboarding Steps (6 steps total)
  welcomeCompleted      Boolean       @default(false)
  welcomeCompletedAt    DateTime?
  earningsCompleted     Boolean       @default(false)
  earningsCompletedAt   DateTime?
  payoutsCompleted      Boolean       @default(false)
  payoutsCompletedAt    DateTime?
  safetyCompleted       Boolean       @default(false)
  safetyCompletedAt     DateTime?
  helpCenterCompleted   Boolean       @default(false)
  helpCenterCompletedAt DateTime?
  completionCompleted   Boolean       @default(false)
  completionCompletedAt DateTime?
  
  // Tutorial Progress
  tutorialsViewed       String[]      @default([]) // Array of tutorial IDs viewed
  
  // Overall Status
  isOnboardingComplete  Boolean       @default(false)
  completionPercentage  Int           @default(0)  // 0-100
  startedAt             DateTime      @default(now())
  completedAt           DateTime?
  lastStepViewed        String?       // Last step the driver was on
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([driverId])
  @@map("driver_onboarding")
}

// D20: Driver Safety Center & Incident Reporting System
enum SafetyIncidentCategory {
  RIDER_MISCONDUCT
  VEHICLE_DAMAGE
  PAYMENT_DISPUTE
  LOST_AND_FOUND
  HARASSMENT_THREAT
  UNSAFE_LOCATION
  OTHER
}

enum SafetyIncidentStatus {
  SUBMITTED
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

model DriverSafetyIncident {
  id                String                  @id @default(uuid())
  driverId          String
  driver            DriverProfile           @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  category          SafetyIncidentCategory
  description       String                  @db.Text
  incidentDate      DateTime
  status            SafetyIncidentStatus    @default(SUBMITTED)
  
  // Optional fields
  tripId            String?                 // Associated trip if applicable
  tripType          String?                 // RIDE, FOOD, PARCEL
  locationAddress   String?
  locationLat       Float?
  locationLng       Float?
  attachments       String[]                @default([]) // Array of image URLs
  
  // Resolution
  resolution        String?                 @db.Text
  resolvedAt        DateTime?
  resolvedBy        String?                 // Admin user ID who resolved
  
  // Metadata
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("driver_safety_incidents")
}

model BlockedRider {
  id         String        @id @default(uuid())
  driverId   String
  customerId String
  reason     String?
  blockedAt  DateTime      @default(now())
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, customerId])
  @@index([driverId])
  @@map("blocked_riders")
}

model DriverStats {
  id         String        @id @default(uuid())
  driverId   String        @unique
  rating     Decimal       @default(5.0) @db.Decimal(3, 2)
  totalTrips Int           @default(0)
  
  // D21: Trust Score System (0-100)
  trustScore              Int           @default(75)  // Current trust score (0-100)
  trustScoreBreakdown     Json?         // JSON breakdown of score components
  lastTrustScoreUpdate    DateTime?     // Last time score was recalculated
  
  // D21: Trust Score Input Metrics
  onTimeArrivalRate       Decimal       @default(0.85) @db.Decimal(5, 4) // % of on-time arrivals
  riderRatingAvg          Decimal       @default(5.0) @db.Decimal(3, 2)  // Average rider rating
  cancellationRate        Decimal       @default(0.05) @db.Decimal(5, 4) // % trip cancellations
  safetyViolationCount    Int           @default(0)   // Speeding, harsh braking flags
  supportTicketScore      Int           @default(100) // Based on dispute outcomes (0-100)
  
  // D21: Historical Tracking
  totalOnTimeArrivals     Int           @default(0)
  totalLateArrivals       Int           @default(0)
  totalCancellations      Int           @default(0)
  totalRatingsReceived    Int           @default(0)
  ratingsSum              Decimal       @default(0) @db.Decimal(10, 2) // Sum of all ratings for avg calculation
  
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_stats")
}

model DriverWallet {
  id              String        @id @default(uuid())
  driverId        String        @unique
  balance         Decimal       @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal       @default(0) @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  driver          DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_wallets")
}

model FoodOrder {
  id                 String            @id
  customerId         String
  restaurantId       String
  driverId           String?
  deliveryAddress    String
  deliveryLat        Float?
  deliveryLng        Float?
  pickupAddress      String?           // Restaurant pickup location
  pickupLat          Float?
  pickupLng          Float?
  items              String?           // JSON string of ordered items (nullable for backward compatibility)
  itemsCount         Int?              // Total number of items in order
  serviceFare        Decimal           @db.Decimal(10, 2)
  safegoCommission   Decimal           @db.Decimal(10, 2)
  restaurantPayout   Decimal           @db.Decimal(10, 2)
  driverPayout       Decimal           @db.Decimal(10, 2)
  deliveryPayout     Decimal?          @db.Decimal(10, 2) // Alias for driverPayout for compatibility
  subtotal           Decimal?          @db.Decimal(10, 2) // Items subtotal before fees/taxes
  deliveryFee        Decimal?          @db.Decimal(10, 2) // Delivery fee component
  tipAmount          Decimal?          @db.Decimal(10, 2) // Customer tip for driver
  deliveryInstructions String?         // Special delivery instructions
  paymentMethod      String
  status             String
  customerRating     Int?
  customerFeedback   String?
  restaurantRating   Int?
  restaurantFeedback String?
  taxBreakdown       Json?
  totalTaxAmount     Decimal?          @db.Decimal(10, 2)
  orderCode          String?           // Unique searchable order code (e.g., "ORD-12345")
  whoCancelled       String?           // "customer" | "restaurant" | "driver" | "admin"
  cancellationReason String?           @db.Text
  cancelledAt        DateTime?
  acceptedAt         DateTime?         // When restaurant accepted order
  preparingAt        DateTime?         // When restaurant started preparing
  readyAt            DateTime?         // When order ready for pickup
  pickedUpAt         DateTime?         // When driver picked up
  isDemo               Boolean           @default(false)
  // Step 45: Restaurant Order Management fields (additive only)
  restaurantNotes           String?           @db.Text  // Notes from restaurant (e.g., "item substituted")
  restaurantPrepMinutes     Int?              // Estimated preparation time in minutes
  customerStatusMessage     String?           // Customer-visible status message
  restaurantSeenAt          DateTime?         // When restaurant first viewed order
  // Step 46: Driver Delivery Flow fields (additive only)
  deliveryId                String?           @unique   // Link to deliveries record
  driverAssignmentStatus    DriverAssignmentStatus @default(none)
  driverEtaMinutes          Int?              // Estimated minutes until driver arrives
  driverLastLocationLat     Float?            // Driver's last known latitude
  driverLastLocationLng     Float?            // Driver's last known longitude
  driverLocationUpdatedAt   DateTime?         // When driver location was last updated
  deliveryNotesForDriver    String?           @db.Text  // Instructions for driver from restaurant/customer
  // Phase 7: Promotion & Coupon tracking (additive only)
  appliedPromotionId   String?
  appliedCouponCode    String?
  discountAmount       Decimal?          @db.Decimal(10, 2)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount   Int?              @default(0)
  lastSupportStatus    String?           // Latest support ticket status
  // Refund tracking
  refundStatus         RefundStatus      @default(none)
  refundAmount         Decimal?          @db.Decimal(10, 2)
  refundedAt           DateTime?
  refundReason         String?           @db.Text
  createdAt            DateTime          @default(now())
  updatedAt            DateTime
  deliveredAt          DateTime?
  completedAt          DateTime?
  customer             CustomerProfile   @relation(fields: [customerId], references: [id])
  driver               DriverProfile?    @relation(fields: [driverId], references: [id])
  restaurant           RestaurantProfile @relation(fields: [restaurantId], references: [id])
  appliedPromotion     Promotion?        @relation(fields: [appliedPromotionId], references: [id])
  delivery             Delivery?         @relation(fields: [deliveryId], references: [id]) // Step 46: Link to delivery record
  review               Review?           // Phase 8: One review per order
  earningsTransaction  EarningsTransaction? // R6: Earnings tracking

  @@index([restaurantId, status])
  @@index([restaurantId, createdAt])
  @@index([orderCode])
  @@index([status])
  @@index([isDemo])
  @@index([appliedPromotionId])
  @@index([driverAssignmentStatus]) // Step 46: Index for driver assignment queries
  @@index([driverId])               // Step 46: Index for driver queries
  @@map("food_orders")
}

// Customer favorite restaurants for quick access
model FoodRestaurantFavorite {
  id                String            @id @default(uuid())
  customerProfileId String
  restaurantId      String
  createdAt         DateTime          @default(now())
  customer          CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
  restaurant        RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([customerProfileId, restaurantId])
  @@index([customerProfileId])
  @@index([restaurantId])
  @@map("food_restaurant_favorites")
}

// Customer saved delivery addresses with labels
model CustomerAddress {
  id                String            @id @default(uuid())
  customerProfileId String
  label             AddressLabel      @default(home)
  customLabel       String?           // For "other" type, user-defined label
  address           String
  lat               Float
  lng               Float
  placeId           String?
  apartment         String?           // Apt/Suite/Floor number
  instructions      String?           // Delivery instructions for this address
  isDefault         Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  customer          CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)

  @@index([customerProfileId])
  @@index([isDefault])
  @@map("customer_addresses")
}

// Customer blocked restaurants (customer chose to block)
model CustomerBlockedRestaurant {
  id                String            @id @default(uuid())
  customerProfileId String
  restaurantId      String
  blockReason       String?           @db.Text
  blockedAt         DateTime          @default(now())
  unblockRequestedAt DateTime?
  unblockRequestReason String?        @db.Text
  customer          CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
  restaurant        RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([customerProfileId, restaurantId])
  @@index([customerProfileId])
  @@index([restaurantId])
  @@map("customer_blocked_restaurants")
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model RestaurantProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  restaurantName        String
  address               String
  cuisineType           String?
  description           String?
  cityCode              String?
  countryCode           String?
  averageRating         Float?             @default(0)
  totalRatings          Int?               @default(0)
  verificationStatus    String             @default("pending")
  rejectionReason       String?
  isVerified            Boolean            @default(false)
  isActive              Boolean            @default(true)
  isBusy                Boolean            @default(false)  // C-1: Restaurant busy mode
  isDemo                Boolean            @default(false)
  // Country-specific KYC fields (BD - Bangladesh)
  fatherName            String?            // BD: Owner's father name
  presentAddress        String?            // BD: Current address
  permanentAddress      String?            // BD: Permanent address
  nidNumber             String?            // BD: National ID number
  nidFrontImageUrl      String?            // BD: NID front image
  nidBackImageUrl       String?            // BD: NID back image
  // Country-specific KYC fields (US - United States)
  homeAddress           String?            // US: Owner's home address
  governmentIdType      String?            // US: ID type (SSN, Driver License, etc.)
  governmentIdLast4     String?            // US: Last 4 digits of government ID
  // Common KYC fields
  dateOfBirth           DateTime?          // Owner's date of birth
  emergencyContactName  String?            // Emergency contact full name
  emergencyContactPhone String?            // Emergency contact phone
  // Business details
  businessLicenseNumber String?
  businessLicenseUrl    String?
  healthCertificateUrl  String?
  ownerRole             String?            // OWNER | STAFF
  // Phase 6: Staff Permissions (only applicable when ownerRole = STAFF)
  canEditCategories     Boolean            @default(false)
  canEditItems          Boolean            @default(false)
  canToggleAvailability Boolean            @default(false)
  canUseBulkTools       Boolean            @default(false)
  canViewAnalytics      Boolean            @default(false)
  canViewPayouts        Boolean            @default(false)
  canManageOrders       Boolean            @default(false)
  canReplySupport       Boolean            @default(false) // Phase 12: Can view and reply to support tickets
  canManagePromotions   Boolean            @default(false) // R4: Can create/edit promotions and coupons
  staffActive           Boolean            @default(true)
  managedByOwnerId      String?            // Restaurant ID of the OWNER who manages this STAFF
  lastLoginAt           DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  isSuspended           Boolean            @default(false)
  suspendedAt           DateTime?
  suspensionReason      String?
  securityStatus        SecurityStatus     @default(normal)
  securityNotes         String?
  driverComplaints      DriverComplaint[]
  foodOrders            FoodOrder[]
  deliveries            Delivery[]        // Step 46: Food deliveries linked to restaurant
  menuCategories        MenuCategory[]
  menuItems             MenuItem[]
  promotions            Promotion[]      // Phase 7: Restaurant promotions
  coupons               Coupon[]         // Phase 7: Restaurant coupons
  reviews               Review[]         // Phase 8: Customer reviews
  branding              RestaurantBranding? // Phase 9: Restaurant branding
  media                 RestaurantMedia[] // Phase 9: Restaurant media gallery
  hours                 RestaurantHours[] // Phase 10: Operating hours
  operationalSettings   OperationalSettings? // Phase 10: Delivery & pickup settings
  deliveryZones         DeliveryZone[] // Phase 10: Delivery zones
  surgeSettings         SurgeSettings? // Phase 10: Surge pricing settings
  supportTickets        SupportTicket[] // Phase 12: Restaurant support tickets
  financialAdjustments  FinancialAdjustment[] // Phase 12: Financial adjustments
  restaurantSupportTickets RestaurantSupportTicket[] @relation("RestaurantSupportTickets") // Phase 12.5: Restaurant support center tickets
  liveChatSessions      LiveChatSession[] @relation("LiveChatSessions") // Phase 12.5: Live chat sessions
  supportCallbacks      SupportCallback[] @relation("SupportCallbacks") // Phase 12.5: Support callbacks
  commissionRules       CommissionRule[] // R6: Commission rules
  earningsTransactions  EarningsTransaction[] // R6: Earnings transactions
  earningsSummaries     EarningsSummary[] // R6: Earnings summaries
  favoritedBy           FoodRestaurantFavorite[] // Customers who favorited this restaurant
  blockedByCustomers    CustomerBlockedRestaurant[] // Customers who blocked this restaurant
  upsellGroups          MenuItemUpsellGroup[] // Step 44: Upsell groups for menu item recommendations
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantWallet      RestaurantWallet?

  @@index([cityCode])
  @@index([countryCode])
  @@index([isActive])
  @@index([isDemo])
  @@index([verificationStatus])
  @@map("restaurant_profiles")
}

model RestaurantWallet {
  id              String            @id @default(uuid())
  restaurantId    String            @unique
  balance         Decimal           @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  restaurant      RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_wallets")
}

// Menu system for food ordering
model MenuCategory {
  id            String            @id @default(uuid())
  restaurantId  String
  name          String
  description   String?
  displayOrder  Int               @default(0)
  isActive      Boolean           @default(true)
  isDemo        Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  restaurant    RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems     MenuItem[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_categories")
}

// Phase 12 - Relational Category System
model Category {
  id            String        @id @default(uuid())
  name          String        @unique
  slug          String        @unique
  type          String        @default("FOOD") // FOOD, DRINK, DESSERT, OTHER
  isActive      Boolean       @default(true)
  displayOrder  Int           @default(0)
  isDemo        Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  subCategories SubCategory[]
  menuItems     MenuItem[]    @relation("MenuItemMainCategory")
  commissionRules CommissionRule[] // R6: Category-level commission rules

  @@index([slug])
  @@index([isActive])
  @@index([type])
  @@map("categories")
}

model SubCategory {
  id               String             @id @default(uuid())
  categoryId       String
  name             String
  slug             String
  isActive         Boolean            @default(true)
  displayOrder     Int                @default(0)
  isDemo           Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  category         Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menuItemLinks    MenuItemCategory[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@map("sub_categories")
}

model MenuItemCategory {
  id            String      @id @default(uuid())
  menuItemId    String
  subCategoryId String
  createdAt     DateTime    @default(now())
  menuItem      MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, subCategoryId])
  @@index([menuItemId])
  @@index([subCategoryId])
  @@map("menu_item_categories")
}

model MenuItem {
  id                     String              @id @default(uuid())
  restaurantId           String
  categoryId             String?             // Legacy - kept for backwards compatibility
  mainCategoryId         String?             // Phase 12 - new relational main category
  primaryCategory        String?             // Legacy simple category - kept for migration
  subCategories          String[]            @default([]) // Legacy simple category - kept for migration
  name                   String
  shortDescription       String?
  longDescription        String?
  basePrice              Decimal             @default(0) @db.Decimal(10, 2)
  currency               String              @default("USD")
  preparationTimeMinutes Int?
  availabilityStatus     String              @default("available")
  isFeatured             Boolean             @default(false)
  isVegetarian           Boolean             @default(false)
  isVegan                Boolean             @default(false)
  isHalal                Boolean             @default(false)
  isSpicy                Boolean             @default(false)
  dietaryTags            String[]
  itemImageUrl           String?
  serviceHours           Json?
  totalOrders            Int                 @default(0)
  totalRevenue           Decimal             @default(0) @db.Decimal(10, 2)
  averageRating          Float?              @default(0)
  calories               Int?
  isArchived             Boolean             @default(false)
  displayOrder           Int                 @default(0)
  policyStatus           String              @default("ok")
  policyNote             String?
  isDemo                 Boolean             @default(false)
  stockTrackingEnabled   Boolean             @default(false)
  stockQuantity          Int?                // null means unlimited stock
  lowStockThreshold      Int?                @default(5) // warn when stock drops below this
  // Step 44: Variants, Add-ons, and Upsell support (additive only)
  hasVariants            Boolean             @default(false) // True if item has variant options
  hasAddOns              Boolean             @default(false) // True if item has add-on options
  defaultVariantOptionId String?             // Default selected variant option ID
  upsellGroupId          String?             // Reference to upsell group for recommendations
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  restaurant             RestaurantProfile   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category               MenuCategory?       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  mainCategory           Category?           @relation("MenuItemMainCategory", fields: [mainCategoryId], references: [id], onDelete: SetNull)
  subCategoryLinks       MenuItemCategory[]
  optionGroups           MenuOptionGroup[]
  upsellGroup            MenuItemUpsellGroup? @relation(fields: [upsellGroupId], references: [id], onDelete: SetNull)
  upsellLinksFrom        MenuItemUpsellLink[] @relation("UpsellFromItem")
  upsellLinksTo          MenuItemUpsellLink[] @relation("UpsellToItem")

  @@index([restaurantId])
  @@index([categoryId])
  @@index([mainCategoryId])
  @@index([primaryCategory])
  @@index([availabilityStatus])
  @@index([isFeatured])
  @@index([isArchived])
  @@index([isDemo])
  @@index([upsellGroupId])
  @@map("menu_items")
}

model MenuOptionGroup {
  id            String       @id @default(uuid())
  restaurantId  String
  itemId        String
  name          String
  type          String
  isRequired    Boolean      @default(false)
  minSelect     Int?
  maxSelect     Int?
  isDemo        Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  item          MenuItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  options       MenuOption[]

  @@index([itemId])
  @@index([restaurantId])
  @@index([isDemo])
  @@map("menu_option_groups")
}

model MenuOption {
  id              String           @id @default(uuid())
  optionGroupId   String
  label           String
  priceDelta      Decimal          @default(0) @db.Decimal(10, 2)
  isDefault       Boolean          @default(false)
  isActive        Boolean          @default(true)
  isDemo          Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  optionGroup     MenuOptionGroup  @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@index([optionGroupId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_options")
}

// Step 44: Upsell Groups for menu item recommendations
model MenuItemUpsellGroup {
  id            String       @id @default(uuid())
  restaurantId  String
  name          String       // e.g., "Popular add-ons", "Recommended sides"
  description   String?
  isActive      Boolean      @default(true)
  isDemo        Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  restaurant    RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems     MenuItem[]   // Items that use this upsell group
  upsellLinks   MenuItemUpsellLink[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_item_upsell_groups")
}

// Step 44: Upsell Links - many-to-many relationship between items for recommendations
model MenuItemUpsellLink {
  id              String       @id @default(uuid())
  upsellGroupId   String
  fromMenuItemId  String       // The item being viewed
  toMenuItemId    String       // The recommended item to upsell
  priority        Int          @default(0) // Higher priority = shown first
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  upsellGroup     MenuItemUpsellGroup @relation(fields: [upsellGroupId], references: [id], onDelete: Cascade)
  fromMenuItem    MenuItem     @relation("UpsellFromItem", fields: [fromMenuItemId], references: [id], onDelete: Cascade)
  toMenuItem      MenuItem     @relation("UpsellToItem", fields: [toMenuItemId], references: [id], onDelete: Cascade)

  @@unique([upsellGroupId, fromMenuItemId, toMenuItemId])
  @@index([upsellGroupId])
  @@index([fromMenuItemId])
  @@index([toMenuItemId])
  @@index([priority])
  @@map("menu_item_upsell_links")
}

model Ride {
  id               String            @id @default(uuid())
  customerId       String
  driverId         String?
  countryCode      String?
  cityCode         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  pickupPlaceId    String?           // Google Place ID for pickup (additive)
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  dropoffPlaceId   String?           // Google Place ID for dropoff (additive)
  // Route metrics from Google Directions API (additive fields)
  distanceMiles    Float?            // Calculated distance in miles
  durationMinutes  Int?              // Estimated duration in minutes
  routePolyline    String?           // Encoded polyline for route display
  rawDistanceMeters Int?             // Raw distance from provider in meters
  rawDurationSeconds Int?            // Raw duration from provider in seconds
  routeProviderSource String?        // e.g., "google_maps"
  serviceFare      Decimal           @db.Decimal(10, 2)
  safegoCommission Decimal           @db.Decimal(10, 2)
  driverPayout     Decimal           @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  driverRating     Int?
  driverFeedback   String?
  taxBreakdown     Json?
  totalTaxAmount   Decimal?          @db.Decimal(10, 2)
  isDemo           Boolean           @default(false)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount Int?            @default(0)
  lastSupportStatus  String?         // Latest support ticket status
  
  // Phase A: Enhanced ride lifecycle fields
  currentLeg         String?         // to_pickup, to_dropoff, completed
  trafficEtaSeconds  Int?            // Live ETA with traffic
  surgeMultiplier    Decimal?        @db.Decimal(4, 2) // Surge pricing multiplier
  tollAmount         Decimal?        @db.Decimal(10, 2) // Toll charges
  discountAmount     Decimal?        @db.Decimal(10, 2) // Applied discount
  cancelledAt        DateTime?       // When ride was cancelled
  whoCancelled       String?         // customer, driver, system
  cancellationReason String?         // Reason for cancellation
  cancellationFee    Decimal?        @db.Decimal(10, 2) // Cancel fee charged
  selectedRouteType  String?         // fastest, shortest, highway
  acceptedAt         DateTime?       // When driver accepted
  arrivedAt          DateTime?       // When driver arrived at pickup
  tripStartedAt      DateTime?       // When trip started (customer in car)
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  completedAt      DateTime?
  driverComplaints DriverComplaint[]
  customer         CustomerProfile   @relation(fields: [customerId], references: [id])
  driver           DriverProfile?    @relation(fields: [driverId], references: [id])
  
  // Phase A: Ride lifecycle relations
  statusEvents     RideStatusEvent[]
  liveLocations    RideLiveLocation[]
  chatMessages     RideChatMessage[]
  receipt          RideReceipt?
  stops            RideStop[]
  
  // Phase 1A: Real-Time Dispatch
  dispatchSessionId  String?           @unique // FK to dispatch_sessions
  dispatchStatus     String?           // Mirror of dispatch_sessions.status for fast queries
  requestedAt        DateTime?         // When ride was initially requested
  dispatchSession    DispatchSession?  @relation("RideDispatch", fields: [dispatchSessionId], references: [id])

  @@index([countryCode])
  @@index([cityCode])
  @@index([isDemo])
  @@index([status])
  @@index([dispatchStatus])
  @@map("rides")
}

// Phase A: Track ride status transitions for audit trail
model RideStatusEvent {
  id          String   @id @default(uuid())
  rideId      String
  fromStatus  String?
  toStatus    String
  changedBy   String   // user_id who made the change
  changedByRole String // customer, driver, admin, system
  reason      String?
  metadata    Json?    // Additional event data
  createdAt   DateTime @default(now())
  
  ride        Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@index([createdAt])
  @@map("ride_status_events")
}

// Phase A: Store driver live GPS locations during active ride
model RideLiveLocation {
  id          String   @id @default(uuid())
  rideId      String
  driverId    String
  lat         Float
  lng         Float
  heading     Float?   // Direction in degrees
  speed       Float?   // Speed in km/h
  accuracy    Float?   // GPS accuracy in meters
  createdAt   DateTime @default(now())
  
  ride        Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  driver      DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@index([driverId])
  @@index([createdAt])
  @@map("ride_live_locations")
}

// Phase A: Store in-app chat messages between customer and driver
model RideChatMessage {
  id          String   @id @default(uuid())
  rideId      String
  senderId    String   // user_id of sender
  senderRole  String   // customer or driver
  message     String
  messageType String   @default("text") // text, quick_message, location
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  ride        Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@index([senderId])
  @@index([createdAt])
  @@map("ride_chat_messages")
}

// Phase A: Detailed fare receipt for completed rides
model RideReceipt {
  id              String   @id @default(uuid())
  rideId          String   @unique
  baseFare        Decimal  @db.Decimal(10, 2)
  distanceFare    Decimal  @db.Decimal(10, 2)
  timeFare        Decimal  @db.Decimal(10, 2)
  surgeFare       Decimal? @db.Decimal(10, 2) // Surge pricing extra charge
  tollsFare       Decimal? @db.Decimal(10, 2)
  tipAmount       Decimal? @db.Decimal(10, 2)
  discountAmount  Decimal? @db.Decimal(10, 2)
  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal? @db.Decimal(10, 2)
  totalFare       Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  distanceMiles   Float?
  durationMinutes Int?
  fareBreakdown   Json?    // Detailed breakdown as JSON
  createdAt       DateTime @default(now())
  
  ride            Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@map("ride_receipts")
}

// Phase A: Support for adding stops during ride
model RideStop {
  id          String   @id @default(uuid())
  rideId      String
  address     String
  lat         Float?
  lng         Float?
  placeId     String?
  stopOrder   Int      // Order of stop (1, 2, 3...)
  status      String   @default("pending") // pending, arrived, completed, skipped
  arrivedAt   DateTime?
  departedAt  DateTime?
  createdAt   DateTime @default(now())
  
  ride        Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  @@index([rideId])
  @@index([stopOrder])
  @@map("ride_stops")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  passwordHash      String
  role              String
  countryCode       String
  isBlocked         Boolean            @default(false)
  isDemo            Boolean            @default(false)
  isAccountLocked   Boolean            @default(false)
  accountLockedAt   DateTime?
  failedLoginAttempts Int              @default(0)
  lastFailedLoginAt DateTime?
  temporaryLockUntil DateTime?
  unlockOtpHash     String?
  unlockOtpExpiry   DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  adminProfile      AdminProfile?
  customerProfile   CustomerProfile?
  driverProfile     DriverProfile?
  notifications     Notification[]
  restaurantProfile RestaurantProfile?
  documents         Document[]
  approvalRequestsCreated ApprovalRequest[] @relation("ApprovalRequester")
  approvalRequestsApproved ApprovalRequest[] @relation("ApprovalApprover")
  adminSessions     AdminSession[] @relation("AdminSessions")
  createdAdjustments FinancialAdjustment[] @relation("CreatedAdjustments")
  approvedAdjustments FinancialAdjustment[] @relation("ApprovedAdjustments")
  assignedDriverTickets DriverSupportTicket[] @relation("AssignedDriverTickets")
  driverTicketStatusChanges DriverSupportStatusHistory[] @relation("DriverTicketStatusChanges")

  @@index([isDemo])
  @@index([isAccountLocked])
  @@map("users")
}

enum DmvInspectionStatus {
  VALID
  EXPIRED
  MISSING

  @@map("dmv_inspection_status")
}

model Document {
  id           String    @id @default(uuid())
  userId       String
  documentType String
  fileUrl      String
  fileName     String?
  fileSize     Int?
  mimeType     String?
  category     String
  status       String    @default("pending_review")
  expiresAt    DateTime?
  uploadedAt   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
  @@index([category])
  @@index([status])
  @@map("documents")
}

model VehicleDocument {
  id              String         @id
  driverId        String
  documentType    String
  uploadedAt      DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  description     String?
  expiresAt       DateTime?
  fileUrl         String
  vehicleId       String?
  status          DocumentStatus @default(PENDING)  // D7: Document status tracking
  rejectionReason String?                           // D7: Reason for rejection
  reviewedAt      DateTime?                         // D7: When admin reviewed
  reviewedBy      String?                           // D7: Admin who reviewed
  driver          DriverProfile  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([vehicleId])
  @@index([status])
  @@map("vehicle_documents")
}

model Vehicle {
  id                      String            @id @default(uuid())
  driverId                String            // D1: Changed from @unique to allow 1:N (multi-vehicle support)
  vehicleType             String
  vehicleModel            String
  vehiclePlate            String
  isPrimary               Boolean           @default(false) // D1: Mark primary vehicle
  isActive                Boolean           @default(true)  // D1: Soft delete support
  isOnline                Boolean           @default(false)
  totalEarnings           Decimal           @default(0) @db.Decimal(10, 2)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  notes                   String?
  make                    String?
  year                    Int?
  color                   String?
  licensePlate            String?
  insurancePolicyNumber   String?           // D1: Insurance policy number
  registrationDocumentUrl String?
  registrationExpiry      DateTime?
  registrationStatus      DocumentStatus    @default(PENDING)
  registrationLastUpdated DateTime?
  insuranceDocumentUrl    String?
  insuranceExpiry         DateTime?
  insuranceStatus         DocumentStatus    @default(PENDING)
  insuranceLastUpdated    DateTime?
  dmvInspectionType                String?
  dmvInspectionDate                DateTime?
  dmvInspectionExpiry              DateTime?
  dmvInspectionImageUrl            String?
  dmvInspectionFrontImageUrl       String?
  dmvInspectionBackImageUrl        String?
  dmvInspectionVerificationStatus  String?              @default("pending_review")
  dmvInspectionRejectionReason     String?
  dmvInspectionStatus              DmvInspectionStatus?
  inspectionStatus        DocumentStatus    @default(PENDING)
  inspectionLastUpdated   DateTime?
  plateCountry            String?
  plateState              String?
  plateStatus             DocumentStatus    @default(PENDING)
  licensePlateLastUpdated DateTime?
  licensePlateVerificationStatus String?   @default("pending_review")
  licensePlateRejectionReason    String?
  tlcLicenseNumber        String?
  tlcLicenseStatus        DocumentStatus    @default(PENDING)
  
  // Step 2: Vehicle Category and Dispatch Eligibility
  vehicleCategory         String?           // VehicleCategoryId: SAFEGO_X, SAFEGO_COMFORT, etc.
  vehicleCategoryStatus   DocumentStatus    @default(PENDING) // Admin approval for category
  vehicleCategoryApprovedAt DateTime?
  vehicleCategoryApprovedBy String?
  wheelchairAccessible    Boolean           @default(false) // WAV eligibility flag
  wavCertificationUrl     String?           // WAV certification document
  wavCertificationExpiry  DateTime?
  wavCertificationStatus  DocumentStatus    @default(PENDING)
  exteriorColor           String?           // Required for BLACK/BLACK_SUV
  interiorColor           String?           // Required for BLACK/BLACK_SUV
  seatCapacity            Int?              // Actual seat count for dispatch matching
  
  // Step 3: Vehicle Verification and Category Suggestion
  bodyType                String?           // SEDAN, SUV, MINIVAN, HATCHBACK, WAGON, CROSSOVER, VAN
  luxury                  Boolean           @default(false) // Is this a luxury vehicle
  suggestedCategory       String?           // Auto-suggested category (not authoritative)
  suggestedCategoryReasons String[]         @default([]) // Reasons for suggestion
  vehicleVerificationStatus String          @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, APPROVED, REJECTED, REQUEST_CHANGES
  verificationRejectionReason String?       // Reason if rejected
  verificationRequestChangesNotes String?   // Notes if requesting changes
  verifiedAt              DateTime?         // When vehicle was verified
  verifiedBy              String?           // Admin who verified
  tlcBaseAffiliation      String?           // TLC base affiliation
  hvfhvPermit             String?           // HVFHV permit number
  
  // Category approval tracking
  categoryApprovalNotes   String?           // Admin notes for category decision
  categoryApprovedAt      DateTime?         // Renamed from vehicleCategoryApprovedAt for consistency
  categoryApprovedBy      String?           // Renamed from vehicleCategoryApprovedBy for consistency
  categoryRejectedAt      DateTime?         // When category was rejected
  categoryRejectedBy      String?           // Admin who rejected
  
  // Step 4: Driver Category Preferences (subset of eligibleCategories)
  eligibleCategories      String[]          @default([]) // Categories vehicle qualifies for based on dispatch matrix
  allowedCategories       String[]          @default([]) // Driver's preferred subset of eligible categories
  preferencesLastUpdated  DateTime?         // When driver last updated preferences
  preferencesResetAt      DateTime?         // When admin last reset preferences
  preferencesResetBy      String?           // Admin who reset preferences
  
  vehicleDocuments        VehicleDocument[]
  driver                  DriverProfile     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])           // D1: Index for 1:N queries
  @@index([isPrimary])          // D1: Index for finding primary vehicle
  @@index([vehicleCategory])    // Step 2: Index for category-based dispatch queries
  @@index([wheelchairAccessible]) // Step 2: Index for WAV dispatch queries
  // Note: One-primary-vehicle constraint enforced at application level in driverVehicleService.ts
  @@map("vehicles")
}

// Driver Loyalty Points Tier System
model DriverTier {
  id               String           @id @default(uuid())
  name             String           @unique
  requiredPoints   Int
  color            String
  description      String?
  displayOrder     Int
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  benefits         TierBenefit[]
  drivers          DriverPoints[]

  @@index([requiredPoints])
  @@index([displayOrder])
  @@map("driver_tiers")
}

model TierBenefit {
  id               String           @id @default(uuid())
  tierId           String
  benefitText      String
  displayOrder     Int              @default(0)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  tier             DriverTier       @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@index([tierId])
  @@index([displayOrder])
  @@map("tier_benefits")
}

model DriverPoints {
  id               String             @id @default(uuid())
  driverId         String             @unique
  currentTierId    String?
  totalPoints      Int                @default(0) // 90-day status points for tier calculation
  lifetimePoints   Int                @default(0) // All-time points for analytics
  cycleStartDate   DateTime?          // Current 90-day cycle start
  cycleEndDate     DateTime?          // Current 90-day cycle end
  lastEarnedAt     DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  driver           DriverProfile      @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tier             DriverTier?        @relation(fields: [currentTierId], references: [id])
  transactions     PointsTransaction[]

  @@index([driverId])
  @@index([currentTierId])
  @@index([totalPoints])
  @@index([cycleEndDate]) // For finding cycles needing reset
  @@map("driver_points")
}

model PointsRule {
  id               String           @id @default(uuid())
  ruleName         String           @unique
  description      String?
  basePoints       Int              @default(10)
  multiplier       Decimal          @default(1.0) @db.Decimal(5, 2)
  countryCode      String?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([countryCode])
  @@index([isActive])
  @@map("points_rules")
}

model PointsTransaction {
  id               String           @id @default(uuid())
  driverPointsId   String
  points           Int
  reason           String
  referenceType    String?
  referenceId      String?
  countryCode      String?
  metadata         Json?
  createdAt        DateTime         @default(now())
  driverPoints     DriverPoints     @relation(fields: [driverPointsId], references: [id], onDelete: Cascade)

  @@index([driverPointsId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
  @@map("points_transactions")
}

model AuditLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  actorId     String?
  actorEmail  String
  actorRole   String
  ipAddress   String?
  actionType  String
  entityType  String
  entityId    String?
  description String
  metadata    Json?
  success     Boolean  @default(true)

  @@index([createdAt])
  @@index([actorEmail])
  @@index([actionType])
  @@index([entityType])
  @@index([success])
  @@map("audit_logs")
}

model AdminNotification {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  type        String
  severity    String
  actorId     String?
  actorEmail  String?
  entityType  String
  entityId    String?
  countryCode String?
  title       String
  message     String
  metadata    Json?
  isRead      Boolean   @default(false)

  @@index([createdAt(sort: Desc)])
  @@index([isRead])
  @@index([type])
  @@index([entityType])
  @@index([countryCode])
  @@index([severity])
  @@map("admin_notifications")
}

model PlatformSettings {
  id                String   @id @default(uuid())
  key               String   @unique
  valueJson         Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedByAdminId  String?

  @@index([key])
  @@map("platform_settings")
}

enum PayoutType {
  mobile_wallet
  bank_account
  stripe_connect
  manual
}

enum PayoutAccountStatus {
  pending_verification
  active
  inactive
}

model PayoutAccount {
  id                 String               @id @default(uuid())
  ownerType          String
  ownerId            String
  countryCode        String
  payoutType         PayoutType
  provider           String?
  displayName        String
  accountHolderName  String
  maskedAccount      String
  encryptedDetails   String
  accountNumber_encrypted String?
  routingNumber_encrypted String?
  accountType        String?              // For bank accounts: checking, savings, other
  bankName           String?              // Bank name for display
  isDefault          Boolean              @default(false)
  status             PayoutAccountStatus  @default(pending_verification)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@index([ownerType, ownerId])
  @@index([ownerType, ownerId, isDefault])
  @@map("payout_accounts")
}

enum PaymentMethodStatus {
  active
  inactive
}

model PaymentMethod {
  id                String                @id @default(uuid())
  customerId        String
  provider          String
  providerMethodId  String
  brand             String?
  last4             String
  expMonth          Int?
  expYear           Int?
  isDefault         Boolean               @default(false)
  status            PaymentMethodStatus   @default(active)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@index([customerId])
  @@index([customerId, isDefault])
  @@map("payment_methods")
}

enum SupportSenderType {
  user
  admin
  bot
  system
}

enum SupportMessageType {
  text
  image
  file
}

enum SupportConversationStatus {
  open
  bot
  pending
  assigned
  closed
}

model SupportConversation {
  id                String                      @id @default(uuid())
  userId            String
  userType          String                      // "driver" | "customer" | "restaurant" | "parcel"
  status            SupportConversationStatus   @default(open)
  assignedAdminId   String?                     // Reference to User.id (admin)
  adminLastSeenAt   DateTime?                   // Track when admin last viewed for unread count
  verifiedAt        DateTime?                   // When user confirmed their details
  topic             String?                     // payments | trips | documents | tax | account_settings | other
  entryContext      Json?                       // Device info, channel, etc.
  escalatedAt       DateTime?
  isEscalated       Boolean                     @default(false)
  unresolvedCount   Int                         @default(0) // Track bot failures for auto-escalation
  closedAt          DateTime?                   // When conversation ended
  rating            Int?                        // 1-5 stars rating after end chat
  feedback          String?                     @db.Text // Optional feedback after end chat
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  messages          SupportMessage[]
  attachments       SupportAttachment[]

  @@index([userId, userType, createdAt])
  @@index([assignedAdminId])
  @@index([status, createdAt])
  @@index([userId, userType, status])
  @@index([adminLastSeenAt])
  @@map("support_conversations")
}

model SupportMessage {
  id             String            @id @default(uuid())
  conversationId String
  senderType     SupportSenderType
  messageType    SupportMessageType @default(text)
  body           String?           @db.Text
  attachmentId   String?
  read           Boolean           @default(false)
  createdAt      DateTime          @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("support_messages")
}

model SupportAttachment {
  id             String            @id @default(uuid())
  conversationId String
  fileName       String
  fileType       String
  fileSize       Int
  secureStoragePath String           // Signed document URL path, NOT direct URL
  createdAt      DateTime          @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("support_attachments")
}

enum WalletOwnerType {
  driver
  customer
  restaurant
}

enum WalletTransactionServiceType {
  ride
  food
  parcel
  adjustment
  payout
  commission
  refund
  commission_settlement
  commission_refund
}

enum WalletTransactionDirection {
  credit
  debit
}

enum WalletTransactionReferenceType {
  ride
  food_order
  delivery
  payout
  manual_adjustment
  auto_settlement
  referral_bonus
  promotion_bonus
}

enum PayoutMethod {
  auto_weekly
  manual_request
  manual_admin_settlement
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

model Wallet {
  id               String            @id @default(uuid())
  ownerId          String
  ownerType        WalletOwnerType
  countryCode      String
  availableBalance Decimal           @default(0) @db.Decimal(12, 2)
  holdAmount       Decimal           @default(0) @db.Decimal(12, 2) // D8: Amount on hold (pending payouts)
  negativeBalance  Decimal           @default(0) @db.Decimal(12, 2)
  currency         String
  isDemo           Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  transactions     WalletTransaction[]
  payouts          Payout[]

  @@unique([ownerId, ownerType])
  @@index([ownerType])
  @@index([countryCode])
  @@index([ownerType, countryCode])
  @@index([isDemo])
  @@map("wallets")
}

model WalletTransaction {
  id                      String                           @id @default(uuid())
  walletId                String
  ownerType               WalletOwnerType
  countryCode             String
  serviceType             WalletTransactionServiceType
  direction               WalletTransactionDirection
  amount                  Decimal                          @db.Decimal(12, 2)
  balanceSnapshot         Decimal                          @db.Decimal(12, 2)
  negativeBalanceSnapshot Decimal                          @db.Decimal(12, 2)
  referenceType           WalletTransactionReferenceType
  referenceId             String?
  description             String
  isDemo                  Boolean                          @default(false)
  createdAt               DateTime                         @default(now())
  createdByAdminId        String?
  wallet                  Wallet                           @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([ownerType])
  @@index([serviceType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([walletId, createdAt])
  @@index([isDemo])
  @@map("wallet_transactions")
}

model Payout {
  id                  String        @id @default(uuid())
  walletId            String
  countryCode         String
  ownerType           WalletOwnerType
  ownerId             String
  amount              Decimal       @db.Decimal(12, 2)
  feeAmount           Decimal       @default(0) @db.Decimal(12, 2) // D8: Platform fee charged
  netAmount           Decimal       @default(0) @db.Decimal(12, 2) // D8: Amount after fee (amount - feeAmount)
  method              PayoutMethod
  status              PayoutStatus  @default(pending)
  failureReason       String?
  scheduledAt         DateTime?
  isDemo              Boolean       @default(false)
  createdAt           DateTime      @default(now())
  createdByAdminId    String?
  processedAt         DateTime?
  externalReferenceId String?
  batchId             String?
  payoutMethodId      String?       // D8: Link to driver/restaurant payout method used
  wallet              Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  batch               PayoutBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([ownerType])
  @@index([status])
  @@index([countryCode])
  @@index([createdAt])
  @@index([ownerType, ownerId])
  @@index([batchId])
  @@index([isDemo])
  @@map("payouts")
}

enum PayoutBatchStatus {
  created
  processing
  completed
  partially_failed
  failed
}

model PayoutBatch {
  id                String             @id @default(uuid())
  batchType         WalletOwnerType?
  periodStart       DateTime
  periodEnd         DateTime
  totalPayoutCount  Int                @default(0)
  totalPayoutAmount Decimal            @default(0) @db.Decimal(12, 2)
  status            PayoutBatchStatus  @default(created)
  createdByAdminId  String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payouts           Payout[]

  @@index([status])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("payout_batches")
}

// ===== PAYMENT & PAYOUT CONFIGURATION SYSTEM =====

// Country-aware customer payment method configuration
model CountryPaymentConfig {
  id                   String   @id @default(uuid())
  countryCode          String   // BD, US, etc.
  serviceType          String   // RIDE, FOOD, PARCEL
  methodType           String   // PaymentMethodType enum value
  provider             String   // PaymentProvider enum value
  isEnabled            Boolean  @default(true)
  priority             Int      @default(0)
  minAmount            Decimal? @db.Decimal(12, 2)
  maxAmount            Decimal? @db.Decimal(12, 2)
  supportsRecurring    Boolean  @default(false)
  requiresKycLevel     String   @default("NONE") // NONE, BASIC, FULL
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String?
  lastUpdatedByAdminId String?

  @@unique([countryCode, serviceType, methodType, provider])
  @@index([countryCode, serviceType])
  @@index([isEnabled])
  @@index([createdByAdminId])
  @@map("country_payment_configs")
}

// Country-aware payout rail configuration for restaurants/drivers
model CountryPayoutConfig {
  id                   String   @id @default(uuid())
  countryCode          String   // BD, US, etc.
  actorType            String   // RESTAURANT, DRIVER
  serviceType          String   @default("GLOBAL") // D8: RIDE, FOOD, PARCEL, GLOBAL
  payoutRailType       String   // PayoutRailType enum value
  provider             String   // PayoutProvider enum value
  currency             String   @default("USD") // D8: Currency code
  isEnabled            Boolean  @default(true)
  minPayoutAmount      Decimal  @default(0) @db.Decimal(12, 2)
  maxPayoutAmount      Decimal? @db.Decimal(12, 2) // D8: Maximum single payout
  payoutSchedule       String   @default("WEEKLY") // DAILY, WEEKLY, BIWEEKLY, MONTHLY, ON_DEMAND
  payoutDayOfWeek      Int?     // D8: 0-6 (Sun-Sat) for WEEKLY
  payoutDayOfMonth     Int?     // D8: 1-28 for MONTHLY
  platformFeeType      String   @default("NONE") // D8: NONE, FLAT, PERCENT
  platformFeeValue     Decimal  @default(0) @db.Decimal(10, 4) // D8: Fee amount or percentage
  requiresKycLevel     String   @default("BASIC") // NONE, BASIC, FULL
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String?
  lastUpdatedByAdminId String?

  @@unique([countryCode, actorType, payoutRailType, provider])
  @@index([countryCode, actorType])
  @@index([countryCode, actorType, serviceType])
  @@index([isEnabled])
  @@index([createdByAdminId])
  @@map("country_payout_configs")
}

// Payout method instances for restaurants and drivers
model RestaurantPayoutMethod {
  id                    String   @id @default(uuid())
  actorType             String   // RESTAURANT or DRIVER
  restaurantId          String?
  driverId              String?
  countryCode           String
  payoutRailType        String   // PayoutRailType enum value
  provider              String   // PayoutProvider enum value
  currency              String
  isDefault             Boolean  @default(false)
  status                String   @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, ACTIVE, DISABLED
  maskedDetails         String   // e.g., "Bank ****1234", "bKash ***890"
  metadata              Json?    // PSP-specific IDs, encrypted sensitive data
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdByActorId      String
  lastUpdatedByActorId  String?
  actorRole             String   // Role of the actor who created this

  @@index([actorType, restaurantId])
  @@index([actorType, driverId])
  @@index([countryCode])
  @@index([status])
  @@index([isDefault])
  @@map("restaurant_payout_methods")
}

enum ApprovalRequestStatus {
  pending
  approved
  rejected
  expired
}

model ApprovalRequest {
  id            String                 @id @default(uuid())
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  requesterId   String
  approverId    String?
  actionType    String
  payload       Json
  status        ApprovalRequestStatus  @default(pending)
  reason        String?
  executedAt    DateTime?
  expiresAt     DateTime?

  requester     User                   @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver      User?                  @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([status])
  @@index([requesterId])
  @@index([approverId])
  @@index([actionType])
  @@index([createdAt])
  @@map("approval_requests")
}

model AdminSession {
  id             String    @id @default(uuid())
  adminId        String
  createdAt      DateTime  @default(now())
  lastSeenAt     DateTime  @default(now())
  ipAddress      String?
  userAgentHash  String?
  isActive       Boolean   @default(true)
  revokedAt      DateTime?
  revokedReason  String?

  admin          User      @relation("AdminSessions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([isActive])
  @@index([createdAt])
  @@map("admin_sessions")
}

enum ServiceType {
  RIDE
  FOOD
  PARCEL
}

enum TaxType {
  VAT
  SALES_TAX
  GOVERNMENT_SERVICE_FEE
  MARKETPLACE_FACILITATOR_TAX
  TRIP_FEE
  LOCAL_MUNICIPALITY_FEE
  REGULATORY_FEE
}

model TaxRule {
  id           String      @id @default(cuid())
  countryCode  String
  cityCode     String?
  serviceType  ServiceType
  taxType      TaxType
  percentRate  Decimal?    @db.Decimal(5, 2)
  flatFee      Decimal?    @db.Decimal(10, 2)
  isActive     Boolean     @default(true)
  isDemo       Boolean     @default(false)
  createdAt    DateTime    @default(now())

  @@index([countryCode])
  @@index([cityCode])
  @@index([serviceType])
  @@index([taxType])
  @@index([isActive])
  @@index([isDemo])
  @@map("tax_rules")
}

enum ReferralUserType {
  driver
  rider
}

enum ReferralRewardStatus {
  pending
  paid
}

enum OpportunityBonusType {
  trip_boost
  surge_boost
  peak_hour_boost
  per_ride_bonus
}

enum OpportunityRewardStatus {
  pending
  paid
}

model ReferralSetting {
  id                  String             @id @default(uuid())
  countryCode         String
  userType            ReferralUserType
  currency            String
  baseAmount          Decimal            @db.Decimal(10, 2)
  promoAmount         Decimal?           @db.Decimal(10, 2)
  promoMultiplier     Decimal?           @db.Decimal(5, 2)
  promoLabel          String?
  startAt             DateTime?
  endAt               DateTime?
  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  createdByAdminId    String
  updatedByAdminId    String?
  notes               String?
  isDemo              Boolean            @default(false)
  referralRewards     ReferralReward[]

  @@unique([countryCode, userType, isActive])
  @@index([countryCode])
  @@index([userType])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("referral_settings")
}

model ReferralReward {
  id                  String               @id @default(uuid())
  referrerUserId      String
  referredUserId      String
  referralSettingId   String
  rewardAmount        Decimal              @db.Decimal(10, 2)
  currency            String
  countryCode         String
  status              ReferralRewardStatus @default(pending)
  triggeredAt         DateTime             @default(now())
  paidAt              DateTime?
  walletTransactionId String?
  isDemo              Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  referralSetting     ReferralSetting      @relation(fields: [referralSettingId], references: [id])

  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referralSettingId])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("referral_rewards")
}

model OpportunitySetting {
  id                    String                 @id @default(uuid())
  bonusType             OpportunityBonusType
  countryCode           String
  currency              String
  baseAmount            Decimal                @db.Decimal(10, 2)
  promoAmount           Decimal?               @db.Decimal(10, 2)
  promoMultiplier       Decimal?               @db.Decimal(5, 2)
  zoneId                String?
  startAt               DateTime?
  endAt                 DateTime?
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  createdByAdminId      String
  updatedByAdminId      String?
  notes                 String?
  isDemo                Boolean                @default(false)
  opportunityRewards    OpportunityReward[]

  @@unique([bonusType, countryCode, zoneId, isActive])
  @@index([bonusType])
  @@index([countryCode])
  @@index([zoneId])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("opportunity_settings")
}

model OpportunityReward {
  id                      String                   @id @default(uuid())
  driverId                String
  rideId                  String?
  countryCode             String
  bonusType               OpportunityBonusType
  opportunitySettingId    String
  rewardAmount            Decimal                  @db.Decimal(10, 2)
  currency                String
  status                  OpportunityRewardStatus  @default(pending)
  triggeredAt             DateTime                 @default(now())
  paidAt                  DateTime?
  walletTransactionId     String?
  isDemo                  Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  opportunitySetting      OpportunitySetting       @relation(fields: [opportunitySettingId], references: [id])

  @@index([driverId])
  @@index([rideId])
  @@index([opportunitySettingId])
  @@index([bonusType])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("opportunity_rewards")
}

// ====================================================
// PHASE 7: Restaurant Promotions & Coupons
// ====================================================

model Promotion {
  id                      String           @id @default(uuid())
  restaurantId            String
  title                   String
  description             String?          @db.Text
  promoType               PromotionType
  status                  PromotionStatus  @default(UPCOMING) // R4: Track promotion lifecycle
  discountValue           Decimal?         @db.Decimal(10, 2) // For fixed amount
  discountPercentage      Decimal?         @db.Decimal(5, 2) // For percentage (0-100)
  buyQuantity             Int?             // For BOGO: buy X
  getQuantity             Int?             // For BOGO: get Y
  applicableItems         Json?            // Array of menu item IDs
  applicableCategories    Json?            // Array of category names
  minOrderAmount          Decimal?         @db.Decimal(10, 2)
  maxDiscountCap          Decimal?         @db.Decimal(10, 2)
  usageLimitPerCustomer   Int?
  globalUsageLimit        Int?
  currentUsageCount       Int              @default(0)
  startDate               DateTime
  endDate                 DateTime
  timeWindowStart         String?          // For time-based promos (e.g., "11:00")
  timeWindowEnd           String?          // For time-based promos (e.g., "14:00")
  daysOfWeek              String[]         // R4: Optional days-of-week filter (e.g., ["monday", "friday"])
  isFirstTimeCustomerOnly Boolean          @default(false)
  isActive                Boolean          @default(true)
  isFlagged               Boolean          @default(false)
  flagReason              String?          @db.Text
  flaggedByAdminId        String?
  flaggedAt               DateTime?
  isDemo                  Boolean          @default(false)
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  createdByOwnerId        String
  updatedByOwnerId        String?          // R4: Track who last updated
  restaurant              RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders                  FoodOrder[]
  promotionUsages         PromotionUsage[] // R4: Track each redemption
  coupons                 Coupon[]         // R4: Link coupons to promotions

  @@index([restaurantId])
  @@index([isActive])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([promoType])
  @@index([isFlagged])
  @@index([isDemo])
  @@map("promotions")
}

model Coupon {
  id                    String             @id @default(uuid())
  restaurantId          String
  promotionId           String?            // R4: Link coupon to promotion (optional for standalone coupons)
  code                  String             // Unique coupon code
  discountType          CouponDiscountType
  discountValue         Decimal?           @db.Decimal(10, 2) // For fixed amount
  discountPercentage    Decimal?           @db.Decimal(5, 2) // For percentage (0-100)
  minOrderAmount        Decimal?           @db.Decimal(10, 2)
  maxDiscountCap        Decimal?           @db.Decimal(10, 2)
  usageLimitPerCustomer Int?
  globalUsageLimit      Int?
  currentUsageCount     Int                @default(0)
  startDate             DateTime
  endDate               DateTime
  isActive              Boolean            @default(true)
  isFlagged             Boolean            @default(false)
  flagReason            String?            @db.Text
  flaggedByAdminId      String?
  flaggedAt             DateTime?
  isDemo                Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  createdByOwnerId      String
  restaurant            RestaurantProfile  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  promotion             Promotion?         @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  promotionUsages       PromotionUsage[]   // R4: Track coupon redemptions

  @@unique([restaurantId, code])
  @@index([restaurantId])
  @@index([promotionId])
  @@index([code])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@index([isFlagged])
  @@index([isDemo])
  @@map("coupons")
}

model PromotionUsage {
  id              String    @id @default(uuid())
  promotionId     String
  couponId        String?   // Optional - if coupon was used
  customerId      String
  orderId         String    // Link to FoodOrder
  restaurantId    String
  discountAmount  Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  usedAt          DateTime  @default(now())
  isDemo          Boolean   @default(false)
  promotion       Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  coupon          Coupon?   @relation(fields: [couponId], references: [id], onDelete: SetNull)

  @@index([promotionId])
  @@index([couponId])
  @@index([customerId])
  @@index([orderId])
  @@index([restaurantId])
  @@index([usedAt])
  @@index([isDemo])
  @@map("promotion_usages")
}

enum PromotionType {
  percentage_discount
  fixed_discount
  bogo
  category_discount
  time_window
  first_time_customer
}

enum PromotionStatus {
  UPCOMING
  ACTIVE
  EXPIRED
  PAUSED
}

enum CouponDiscountType {
  percentage
  fixed_amount
  free_delivery
}

enum AddressLabel {
  home
  work
  other
}

enum RefundStatus {
  none
  pending
  processing
  completed
  failed
}

// ====================================================
// PHASE 8: Restaurant Review & Rating System
// ====================================================

model Review {
  id             String   @id @default(uuid())
  orderId        String   @unique // One review per order
  restaurantId   String
  customerId     String
  rating         Int      // 1-5 stars
  reviewText     String?  @db.Text
  images         String[] // Array of image URLs
  isHidden       Boolean  @default(false) // Admin hidden
  hiddenByAdminId String?
  hiddenAt       DateTime?
  hideReason     String?  @db.Text
  isFlagged      Boolean  @default(false) // Admin flagged
  flaggedByAdminId String?
  flaggedAt      DateTime?
  flagReason     String?  @db.Text
  // R5: Restaurant Reply (one reply per review)
  restaurantReplyText String? @db.Text
  restaurantRepliedAt DateTime?
  restaurantRepliedById String?
  isDemo         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  order          FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  restaurant     RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer       CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([customerId])
  @@index([orderId])
  @@index([rating])
  @@index([isHidden])
  @@index([isFlagged])
  @@index([createdAt])
  @@index([isDemo])
  @@map("reviews")
}

// ====================================================
// PHASE 9: Restaurant Media Gallery & Branding System
// ====================================================

model RestaurantBranding {
  id             String   @id @default(uuid())
  restaurantId   String   @unique
  logoUrl        String?  // Restaurant logo
  coverPhotoUrl  String?  // Cover/banner photo
  primaryColor   String?  // Hex color code
  secondaryColor String?  // Hex color code
  themeMode      String   @default("light") // light, dark, auto
  isDemo         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  restaurant     RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isDemo])
  @@map("restaurant_branding")
}

enum MediaCategory {
  food
  ambience
  team
  kitchen
  other
}

model RestaurantMedia {
  id             String        @id @default(uuid())
  restaurantId   String
  filePath       String        // Path to file in storage
  fileUrl        String?       // Signed URL (temporary)
  fileType       String        @default("image") // image, video
  category       MediaCategory @default(other)
  displayOrder   Int           @default(0)
  isHidden       Boolean       @default(false) // Admin hidden
  hiddenByAdminId String?
  hiddenAt       DateTime?
  hideReason     String?       @db.Text
  isFlagged      Boolean       @default(false) // Admin flagged
  flaggedByAdminId String?
  flaggedAt      DateTime?
  flagReason     String?       @db.Text
  isDemo         Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  restaurant     RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([category])
  @@index([isHidden])
  @@index([isFlagged])
  @@index([displayOrder])
  @@index([createdAt])
  @@index([isDemo])
  @@map("restaurant_media")
}

// ============================================================
// PHASE 10: Restaurant Operational Settings System
// ============================================================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model RestaurantHours {
  id             String       @id @default(uuid())
  restaurantId   String
  dayOfWeek      DayOfWeek
  isClosed       Boolean      @default(false) // Closed all day
  openTime1      String?      // Format: "HH:mm" (24-hour)
  closeTime1     String?      // Format: "HH:mm" (24-hour)
  openTime2      String?      // For split shifts
  closeTime2     String?      // For split shifts
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  restaurant     RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@map("restaurant_hours")
}

model OperationalSettings {
  id                      String    @id @default(uuid())
  restaurantId            String    @unique
  
  // Delivery settings
  deliveryEnabled         Boolean   @default(true)
  pickupEnabled           Boolean   @default(true)
  preparationTimeMinutes  Int       @default(30)
  autoAcceptOrders        Boolean   @default(false)
  maxConcurrentOrders     Int?      // For throttling (null = unlimited)
  
  // Order amount settings
  minOrderAmount          Decimal?  @db.Decimal(10, 2)
  freeDeliveryThreshold   Decimal?  @db.Decimal(10, 2)
  
  // Temporary closure
  isTemporarilyClosed     Boolean   @default(false)
  temporaryCloseReason    String?
  temporaryCloseUntil     DateTime?
  
  // Holiday closures (JSON array of dates: ["2025-12-25", "2025-01-01"])
  holidayClosures         Json?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  restaurant              RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("operational_settings")
}

model DeliveryZone {
  id              String    @id @default(uuid())
  restaurantId    String
  zoneName        String
  zoneType        String    @default("radius") // "radius" or "polygon"
  
  // For radius zones
  centerLat       Float?
  centerLng       Float?
  radiusKm        Float?
  
  // For polygon zones (JSON array of {lat, lng} points)
  polygonPoints   Json?
  
  // Delivery fees
  baseFee         Decimal   @default(0) @db.Decimal(10, 2)
  perKmFee        Decimal   @default(0) @db.Decimal(10, 2)
  minimumFee      Decimal   @default(0) @db.Decimal(10, 2)
  
  // ETA adjustments
  estimatedMinutes Int      @default(30)
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  restaurant      RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isActive])
  @@map("delivery_zones")
}

model SurgeSettings {
  id                 String    @id @default(uuid())
  restaurantId       String    @unique
  
  surgeEnabled       Boolean   @default(false)
  surgeMultiplier    Float     @default(1.0) // 1.0 - 2.0
  
  // Peak hours (JSON array of {start: "HH:mm", end: "HH:mm"})
  peakHours          Json?
  
  weekendMultiplier  Float     @default(1.0) // 1.0 - 2.0
  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  restaurant         RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("surge_settings")
}

// Phase 12: Support Ticket System Enums
enum TicketServiceType {
  food_order
  ride
  delivery
}

enum IssueCategory {
  missing_item
  wrong_order
  cold_food
  late_delivery
  driver_behavior
  payment_issue
  unsafe_driving
  rude_behavior
  wrong_route
  overcharge
  damaged_package
  not_delivered
  app_issue
  other
}

enum CustomerVisibleStatus {
  open
  in_review
  awaiting_customer
  resolved
  closed
}

enum InternalStatus {
  new
  assigned_restaurant
  assigned_admin
  refund_pending
  refund_approved
  no_action
  closed
}

enum TicketPriority {
  low
  medium
  high
}

enum MessageType {
  public
  internal
}

enum ActorRole {
  customer
  restaurant_owner
  restaurant_staff
  driver
  admin
}

enum AdjustmentType {
  customer_refund
  restaurant_debit
  driver_debit
  safego_cost
  goodwill_credit
}

// Phase 12: Support Ticket System Models
model SupportTicket {
  id                      String                 @id @default(uuid())
  ticketCode              String                 @unique // e.g., "SG-SUP-2025-000123"
  serviceType             TicketServiceType
  serviceId               String                 // References food_orders.id, rides.id, or deliveries.id
  restaurantId            String?                // Nullable for rides/deliveries without restaurant
  customerId              String
  driverId                String?
  countryCode             String
  cityCode                String?
  
  issueCategory           IssueCategory
  issueDescription        String                 @db.Text
  photoUrls               Json?                  // Array of photo URLs
  
  customerVisibleStatus   CustomerVisibleStatus  @default(open)
  internalStatus          InternalStatus         @default(new)
  priority                TicketPriority         @default(medium)
  originChannel           String                 @default("web") // "app" | "web" | "auto_flag" | "admin_manual"
  
  refundRequestedAmount   Decimal?               @db.Decimal(10, 2)
  refundApprovedAmount    Decimal?               @db.Decimal(10, 2)
  
  proposedResolution      String?                // "remake_order" | "offer_coupon" | "request_partial_refund" | "request_full_refund" | "no_issue_found"
  resolutionNotes         String?                @db.Text
  
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  resolvedAt              DateTime?
  
  customer                CustomerProfile        @relation(fields: [customerId], references: [id])
  restaurant              RestaurantProfile?     @relation(fields: [restaurantId], references: [id])
  driver                  DriverProfile?         @relation(fields: [driverId], references: [id])
  
  messages                SupportTicketMessage[]
  financialAdjustments    FinancialAdjustment[]

  @@index([ticketCode])
  @@index([serviceType])
  @@index([serviceId])
  @@index([restaurantId])
  @@index([customerId])
  @@index([driverId])
  @@index([countryCode])
  @@index([cityCode])
  @@index([customerVisibleStatus])
  @@index([internalStatus])
  @@index([priority])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id              String        @id @default(uuid())
  ticketId        String
  actorId         String        // References user_id, can be customer, restaurant owner, staff, driver, or admin
  actorRole       ActorRole
  messageType     MessageType   @default(public)
  messageBody     String        @db.Text
  attachmentUrls  Json?         // Array of attachment URLs
  
  createdAt       DateTime      @default(now())
  
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([actorId])
  @@index([createdAt])
  @@map("support_ticket_messages")
}

model FinancialAdjustment {
  id              String          @id @default(uuid())
  ticketId        String
  serviceType     TicketServiceType
  serviceId       String
  restaurantId    String?
  driverId        String?
  
  adjustmentType  AdjustmentType
  amount          Decimal         @db.Decimal(10, 2)
  currency        String          @default("USD")
  
  createdByAdminId String
  approvedByAdminId String?
  notes           String?         @db.Text
  
  createdAt       DateTime        @default(now())
  approvedAt      DateTime?
  
  ticket          SupportTicket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdByAdmin  User            @relation("CreatedAdjustments", fields: [createdByAdminId], references: [id])
  approvedByAdmin User?           @relation("ApprovedAdjustments", fields: [approvedByAdminId], references: [id])
  restaurant      RestaurantProfile? @relation(fields: [restaurantId], references: [id])
  driver          DriverProfile?  @relation(fields: [driverId], references: [id])

  @@index([ticketId])
  @@index([serviceType])
  @@index([serviceId])
  @@index([restaurantId])
  @@index([driverId])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("financial_adjustments")
}

// Phase 12.5: Restaurant Support Center Models (separate from customer/driver support)
enum RestaurantSupportCategory {
  orders
  payouts
  menu_pricing
  account_kyc
  technical_issue
  other
}

enum RestaurantSupportPriority {
  low
  normal
  high
  urgent
}

enum RestaurantSupportStatus {
  open
  in_progress
  resolved
  closed
}

enum LiveChatStatus {
  waiting
  active
  ended
}

enum CallbackStatus {
  pending
  completed
  cancelled
}

model RestaurantSupportTicket {
  id              String                      @id @default(uuid())
  ticketCode      String                      @unique // e.g., "RST-2025-000123"
  restaurantId    String
  subject         String
  category        RestaurantSupportCategory
  priority        RestaurantSupportPriority   @default(normal)
  status          RestaurantSupportStatus     @default(open)
  description     String                      @db.Text
  attachmentUrls  Json?                       // Array of attachment URLs
  channel         String                      @default("web") // email, phone, chat
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  resolvedAt      DateTime?
  
  restaurant      RestaurantProfile           @relation("RestaurantSupportTickets", fields: [restaurantId], references: [id], onDelete: Cascade)
  messages        RestaurantSupportMessage[]
  
  @@index([restaurantId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("restaurant_support_tickets")
}

model RestaurantSupportMessage {
  id              String                   @id @default(uuid())
  ticketId        String
  senderRole      String                   // "restaurant" | "support"
  senderName      String                   // Display name of sender
  messageBody     String                   @db.Text
  attachmentUrls  Json?                    // Array of attachment URLs
  createdAt       DateTime                 @default(now())
  
  ticket          RestaurantSupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([createdAt])
  @@map("restaurant_support_messages")
}

// Driver Support Center Models (Phase 12 Extension - D8 Enhanced)
enum DriverSupportCategory {
  account_documents
  trip_issues
  payment_earnings
  incentives_promotions
  safety_emergency
  app_technical
}

model DriverSupportTicket {
  id              String                      @id @default(uuid())
  ticketCode      String                      @unique // e.g., "DST-2025-000123"
  driverId        String
  subject         String
  category        DriverSupportCategory
  subcategory     String?                     // Dynamic subcategory within main category
  tripId          String?                     // Optional: linked ride/delivery ID
  priority        RestaurantSupportPriority   @default(normal)
  status          RestaurantSupportStatus     @default(open)
  description     String                      @db.Text
  attachmentUrls  Json?                       // Array of attachment URLs
  channel         String                      @default("web") // email, phone, chat
  adminNotes      String?                     @db.Text // Internal notes (not visible to driver)
  assignedAdminId String?                     // Admin assigned to this ticket
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  resolvedAt      DateTime?
  
  driver          DriverProfile               @relation("DriverSupportTickets", fields: [driverId], references: [id], onDelete: Cascade)
  assignedAdmin   User?                       @relation("AssignedDriverTickets", fields: [assignedAdminId], references: [id])
  messages        DriverSupportMessage[]
  statusHistory   DriverSupportStatusHistory[]
  
  @@index([driverId])
  @@index([status])
  @@index([category])
  @@index([assignedAdminId])
  @@index([createdAt])
  @@map("driver_support_tickets")
}

model DriverSupportStatusHistory {
  id              String                      @id @default(uuid())
  ticketId        String
  previousStatus  RestaurantSupportStatus?
  newStatus       RestaurantSupportStatus
  changedById     String?                     // User who made the change
  changedByRole   String                      // "driver" | "admin" | "system"
  note            String?                     // Optional note about the status change
  createdAt       DateTime                    @default(now())
  
  ticket          DriverSupportTicket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  changedBy       User?                       @relation("DriverTicketStatusChanges", fields: [changedById], references: [id])
  
  @@index([ticketId])
  @@index([createdAt])
  @@map("driver_support_status_history")
}

model DriverSupportMessage {
  id              String                   @id @default(uuid())
  ticketId        String
  senderRole      String                   // "driver" | "support"
  senderName      String                   // Display name of sender
  messageBody     String                   @db.Text
  attachmentUrls  Json?                    // Array of attachment URLs
  createdAt       DateTime                 @default(now())
  
  ticket          DriverSupportTicket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([createdAt])
  @@map("driver_support_messages")
}

// Customer Support Center Models (Phase 12 Extension)
model CustomerSupportTicket {
  id              String                      @id @default(uuid())
  ticketCode      String                      @unique // e.g., "CST-2025-000123"
  customerId      String
  subject         String
  category        RestaurantSupportCategory
  priority        RestaurantSupportPriority   @default(normal)
  status          RestaurantSupportStatus     @default(open)
  description     String                      @db.Text
  attachmentUrls  Json?                       // Array of attachment URLs
  channel         String                      @default("web") // email, phone, chat
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  resolvedAt      DateTime?
  
  customer        CustomerProfile             @relation("CustomerSupportTickets", fields: [customerId], references: [id], onDelete: Cascade)
  messages        CustomerSupportMessage[]
  
  @@index([customerId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("customer_support_tickets")
}

model CustomerSupportMessage {
  id              String                   @id @default(uuid())
  ticketId        String
  senderRole      String                   // "customer" | "support"
  senderName      String                   // Display name of sender
  messageBody     String                   @db.Text
  attachmentUrls  Json?                    // Array of attachment URLs
  createdAt       DateTime                 @default(now())
  
  ticket          CustomerSupportTicket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([createdAt])
  @@map("customer_support_messages")
}

// Admin Support Center Models (Phase 12 Extension)
model AdminSupportTicket {
  id              String                      @id @default(uuid())
  ticketCode      String                      @unique // e.g., "AST-2025-000123"
  adminId         String
  subject         String
  category        RestaurantSupportCategory
  priority        RestaurantSupportPriority   @default(normal)
  status          RestaurantSupportStatus     @default(open)
  description     String                      @db.Text
  attachmentUrls  Json?                       // Array of attachment URLs
  channel         String                      @default("web") // email, phone, chat
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  resolvedAt      DateTime?
  
  admin           AdminProfile                @relation("AdminSupportTickets", fields: [adminId], references: [id], onDelete: Cascade)
  messages        AdminSupportMessage[]
  
  @@index([adminId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("admin_support_tickets")
}

model AdminSupportMessage {
  id              String                   @id @default(uuid())
  ticketId        String
  senderRole      String                   // "admin" | "support"
  senderName      String                   // Display name of sender
  messageBody     String                   @db.Text
  attachmentUrls  Json?                    // Array of attachment URLs
  createdAt       DateTime                 @default(now())
  
  ticket          AdminSupportTicket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([createdAt])
  @@map("admin_support_messages")
}

// Restaurant Live Chat (existing)
model LiveChatSession {
  id              String           @id @default(uuid())
  restaurantId    String
  agentId         String?
  agentName       String?
  status          LiveChatStatus   @default(waiting)
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  updatedAt       DateTime         @updatedAt
  
  restaurant      RestaurantProfile @relation("LiveChatSessions", fields: [restaurantId], references: [id], onDelete: Cascade)
  messages        LiveChatMessage[]
  
  @@index([restaurantId])
  @@index([status])
  @@index([startedAt])
  @@map("live_chat_sessions")
}

model LiveChatMessage {
  id              String           @id @default(uuid())
  sessionId       String
  senderRole      String           // "restaurant" | "agent"
  senderName      String
  messageBody     String           @db.Text
  attachmentUrls  Json?
  isTyping        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  
  session         LiveChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
  @@map("live_chat_messages")
}

// Driver Live Chat
model DriverLiveChatSession {
  id              String           @id @default(uuid())
  driverId        String
  agentId         String?
  agentName       String?
  status          LiveChatStatus   @default(waiting)
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  updatedAt       DateTime         @updatedAt
  
  driver          DriverProfile    @relation("DriverLiveChatSessions", fields: [driverId], references: [id], onDelete: Cascade)
  messages        DriverLiveChatMessage[]
  
  @@index([driverId])
  @@index([status])
  @@index([startedAt])
  @@map("driver_live_chat_sessions")
}

model DriverLiveChatMessage {
  id              String                 @id @default(uuid())
  sessionId       String
  senderRole      String                 // "driver" | "agent"
  senderName      String
  messageBody     String                 @db.Text
  attachmentUrls  Json?
  isTyping        Boolean                @default(false)
  createdAt       DateTime               @default(now())
  
  session         DriverLiveChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
  @@map("driver_live_chat_messages")
}

// Customer Live Chat
model CustomerLiveChatSession {
  id              String           @id @default(uuid())
  customerId      String
  agentId         String?
  agentName       String?
  status          LiveChatStatus   @default(waiting)
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  updatedAt       DateTime         @updatedAt
  
  customer        CustomerProfile  @relation("CustomerLiveChatSessions", fields: [customerId], references: [id], onDelete: Cascade)
  messages        CustomerLiveChatMessage[]
  
  @@index([customerId])
  @@index([status])
  @@index([startedAt])
  @@map("customer_live_chat_sessions")
}

model CustomerLiveChatMessage {
  id              String                   @id @default(uuid())
  sessionId       String
  senderRole      String                   // "customer" | "agent"
  senderName      String
  messageBody     String                   @db.Text
  attachmentUrls  Json?
  isTyping        Boolean                  @default(false)
  createdAt       DateTime                 @default(now())
  
  session         CustomerLiveChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
  @@map("customer_live_chat_messages")
}

// Admin Live Chat
model AdminLiveChatSession {
  id              String           @id @default(uuid())
  adminId         String
  agentId         String?
  agentName       String?
  status          LiveChatStatus   @default(waiting)
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  updatedAt       DateTime         @updatedAt
  
  admin           AdminProfile     @relation("AdminLiveChatSessions", fields: [adminId], references: [id], onDelete: Cascade)
  messages        AdminLiveChatMessage[]
  
  @@index([adminId])
  @@index([status])
  @@index([startedAt])
  @@map("admin_live_chat_sessions")
}

model AdminLiveChatMessage {
  id              String                 @id @default(uuid())
  sessionId       String
  senderRole      String                 // "admin" | "agent"
  senderName      String
  messageBody     String                 @db.Text
  attachmentUrls  Json?
  isTyping        Boolean                @default(false)
  createdAt       DateTime               @default(now())
  
  session         AdminLiveChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
  @@map("admin_live_chat_messages")
}

// Restaurant Support Callback (existing)
model SupportCallback {
  id              String           @id @default(uuid())
  restaurantId    String
  phoneNumber     String
  preferredTime   String
  timezone        String           @default("UTC")
  reason          String           @db.Text
  status          CallbackStatus   @default(pending)
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
  
  restaurant      RestaurantProfile @relation("SupportCallbacks", fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([restaurantId])
  @@index([status])
  @@index([createdAt])
  @@map("support_callbacks")
}

// Driver Support Callback
model DriverSupportCallback {
  id              String           @id @default(uuid())
  driverId        String
  phoneNumber     String
  preferredTime   String
  timezone        String           @default("UTC")
  reason          String           @db.Text
  status          CallbackStatus   @default(pending)
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
  
  driver          DriverProfile    @relation("DriverSupportCallbacks", fields: [driverId], references: [id], onDelete: Cascade)
  
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("driver_support_callbacks")
}

// Customer Support Callback
model CustomerSupportCallback {
  id              String           @id @default(uuid())
  customerId      String
  phoneNumber     String
  preferredTime   String
  timezone        String           @default("UTC")
  reason          String           @db.Text
  status          CallbackStatus   @default(pending)
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
  
  customer        CustomerProfile  @relation("CustomerSupportCallbacks", fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("customer_support_callbacks")
}

// Admin Support Callback
model AdminSupportCallback {
  id              String           @id @default(uuid())
  adminId         String
  phoneNumber     String
  preferredTime   String
  timezone        String           @default("UTC")
  reason          String           @db.Text
  status          CallbackStatus   @default(pending)
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
  
  admin           AdminProfile     @relation("AdminSupportCallbacks", fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([status])
  @@index([createdAt])
  @@map("admin_support_callbacks")
}

model SupportArticle {
  id              String           @id @default(uuid())
  category        String
  title           String
  slug            String           @unique
  content         String           @db.Text
  isPublished     Boolean          @default(true)
  viewCount       Int              @default(0)
  helpfulCount    Int              @default(0)
  relatedArticles Json?            // Array of article IDs
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([category])
  @@index([isPublished])
  @@index([viewCount])
  @@map("support_articles")
}

// ====================================================
// R6: Restaurant Earnings & Commission Center
// ====================================================

// Commission Rule: Base + category-level commission rates
model CommissionRule {
  id                  String   @id @default(uuid())
  restaurantId        String?  // null = global/default rule
  categoryId          String?  // null = base commission rule
  commissionRate      Decimal  @db.Decimal(5, 2) // Percentage (0-100)
  effectiveFrom       DateTime @default(now())
  effectiveTo         DateTime? // null = indefinite
  isActive            Boolean  @default(true)
  createdByAdminId    String?
  updatedByAdminId    String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  restaurant          RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category            Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, categoryId, effectiveFrom])
  @@index([restaurantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([effectiveFrom])
  @@map("commission_rules")
}

enum EarningsStatus {
  pending    // Order placed, awaiting completion
  cleared    // Order completed, earnings available
  refunded   // Order refunded, earnings reversed
  adjusted   // Manual adjustment by admin
}

// Detailed earnings tracking per order with commission breakdown
model EarningsTransaction {
  id                  String           @id @default(uuid())
  restaurantId        String
  orderId             String           @unique // One earnings record per order
  orderStatus         String           // FoodOrder status snapshot
  grossAmount         Decimal          @db.Decimal(12, 2) // Total order value
  serviceFare         Decimal          @db.Decimal(12, 2) // From FoodOrder
  baseCommission      Decimal          @db.Decimal(12, 2) // Calculated base commission
  categoryCommission  Decimal?         @db.Decimal(12, 2) // Additional category commission
  totalCommission     Decimal          @db.Decimal(12, 2) // Base + category
  netEarnings         Decimal          @db.Decimal(12, 2) // serviceFare - totalCommission
  status              EarningsStatus   @default(pending)
  clearedAt           DateTime?        // When earnings became available
  refundedAt          DateTime?        // When order was refunded
  adjustedAt          DateTime?        // Manual adjustment timestamp
  adjustmentReason    String?          @db.Text
  adjustedByAdminId   String?
  commissionRuleId    String?          // Applied commission rule
  categoryCommissionRuleId String?     // Applied category rule
  countryCode         String
  currency            String
  isDemo              Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  restaurant          RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order               FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([restaurantId])
  @@index([orderId])
  @@index([status])
  @@index([clearedAt])
  @@index([createdAt])
  @@index([countryCode])
  @@index([isDemo])
  @@map("earnings_transactions")
}

// Aggregated daily/monthly earnings summary for performance
model EarningsSummary {
  id                  String   @id @default(uuid())
  restaurantId        String
  periodType          String   // "daily", "weekly", "monthly"
  periodStart         DateTime
  periodEnd           DateTime
  totalOrders         Int      @default(0)
  grossRevenue        Decimal  @default(0) @db.Decimal(12, 2)
  totalCommission     Decimal  @default(0) @db.Decimal(12, 2)
  netEarnings         Decimal  @default(0) @db.Decimal(12, 2)
  pendingEarnings     Decimal  @default(0) @db.Decimal(12, 2)
  clearedEarnings     Decimal  @default(0) @db.Decimal(12, 2)
  refundedAmount      Decimal  @default(0) @db.Decimal(12, 2)
  currency            String
  isDemo              Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  restaurant          RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, periodType, periodStart])
  @@index([restaurantId])
  @@index([periodType])
  @@index([periodStart])
  @@index([isDemo])
  @@map("earnings_summaries")
}

// ====================================================
// D5: DRIVER PROMOTIONS & INCENTIVES SYSTEM
// ====================================================

enum DriverPromotionType {
  PER_TRIP_BONUS       // Fixed bonus per completed trip
  QUEST_TRIPS          // Complete X trips to earn bonus
  EARNINGS_THRESHOLD   // Earn X amount to get bonus
}

enum DriverPromotionStatus {
  DRAFT    // Not yet active, being configured
  ACTIVE   // Currently running
  PAUSED   // Temporarily stopped
  ENDED    // Completed or expired
}

enum DriverPromotionServiceType {
  RIDES    // Ride-hailing trips only
  FOOD     // Food delivery only
  PARCEL   // Parcel delivery only
  ANY      // All service types
}

model DriverPromotion {
  id                   String                    @id @default(uuid())
  name                 String
  description          String?                   @db.Text
  type                 DriverPromotionType
  serviceType          DriverPromotionServiceType @default(ANY)
  countryCode          String?                   // null = all countries
  cityCode             String?                   // null = all cities in country
  minDriverRating      Decimal?                  @db.Decimal(3, 2) // e.g., 4.50
  requireKycApproved   Boolean                   @default(true)
  startAt              DateTime
  endAt                DateTime
  rewardPerUnit        Decimal                   @db.Decimal(10, 2) // Bonus per trip or per threshold
  targetTrips          Int?                      // For QUEST_TRIPS type
  targetEarnings       Decimal?                  @db.Decimal(10, 2) // For EARNINGS_THRESHOLD type
  maxRewardPerDriver   Decimal?                  @db.Decimal(10, 2) // Cap per driver
  globalBudget         Decimal?                  @db.Decimal(12, 2) // Total budget for promotion
  currentSpend         Decimal                   @default(0) @db.Decimal(12, 2) // Track spending
  status               DriverPromotionStatus     @default(DRAFT)
  createdByAdminId     String?
  updatedByAdminId     String?
  isDemo               Boolean                   @default(false)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  
  progress             DriverPromotionProgress[]
  payouts              DriverPromotionPayout[]
  rewardLedger         DriverRewardLedger[]      // D19: Reward ledger entries

  @@index([status])
  @@index([startAt])
  @@index([endAt])
  @@index([countryCode])
  @@index([cityCode])
  @@index([serviceType])
  @@index([type])
  @@index([isDemo])
  @@map("driver_promotions")
}

model DriverPromotionProgress {
  id                   String          @id @default(uuid())
  promotionId          String
  driverId             String          // References driver_profile.id
  currentTrips         Int             @default(0)
  currentEarnings      Decimal         @default(0) @db.Decimal(10, 2)
  totalBonusEarned     Decimal         @default(0) @db.Decimal(10, 2)
  lastUpdatedAt        DateTime        @default(now())
  createdAt            DateTime        @default(now())
  
  promotion            DriverPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  driver               DriverProfile   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([promotionId, driverId])
  @@index([promotionId])
  @@index([driverId])
  @@index([lastUpdatedAt])
  @@map("driver_promotion_progress")
}

model DriverPromotionPayout {
  id                   String          @id @default(uuid())
  promotionId          String
  driverId             String          // References driver_profile.id
  walletTransactionId  String?         // Reference to wallet transaction
  amount               Decimal         @db.Decimal(10, 2)
  tripType             String?         // "ride", "food", "parcel"
  tripId               String?         // Reference to the triggering trip
  createdAt            DateTime        @default(now())
  
  promotion            DriverPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  driver               DriverProfile   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([promotionId])
  @@index([driverId])
  @@index([tripId])
  @@index([createdAt])
  @@map("driver_promotion_payouts")
}

// ====================================================
// D19: Driver Incentives & Milestones Center
// ====================================================

enum IncentiveGoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

enum IncentiveGoalType {
  TRIPS        // Complete X trips
  EARNINGS     // Earn X amount
  RATING       // Maintain X rating
}

enum IncentiveCycleStatus {
  ACTIVE       // Currently in progress
  COMPLETED    // Goal achieved
  EXPIRED      // Period ended without completion
  BONUS_PAID   // Completed and bonus issued
}

enum AchievementType {
  FIVE_STAR_WEEK       // Maintain 5.0 rating for 7 days
  ZERO_CANCEL_STREAK   // 0 cancellations for X trips
  HUNDRED_RIDES        // Complete 100 trips lifetime
  WEEKLY_PRO_DRIVER    // Meet weekly pro criteria
  THOUSAND_TRIPS       // Complete 1000 trips lifetime
  FIRST_TRIP           // Complete first trip ever
  EARLY_BIRD           // Complete 10 trips before 8am
  NIGHT_OWL            // Complete 10 trips after 10pm
  FIVE_STAR_MONTH      // Maintain 4.9+ rating for 30 days
  PERFECT_STREAK_10    // 10 trips with 5-star ratings
  LOYALTY_30_DAYS      // Active for 30 consecutive days
  LOYALTY_90_DAYS      // Active for 90 consecutive days
}

enum RewardType {
  TIER_BONUS           // Bonus for reaching new tier
  PROMO_BONUS          // Bonus from promotion completion
  ACHIEVEMENT_BONUS    // Bonus from achievement unlock
  INCENTIVE_BONUS      // Bonus from incentive goal completion
  REFERRAL_BONUS       // Bonus from referral program
}

enum DriverRewardTier {
  BRONZE   // Entry level: 0-499 points
  SILVER   // Mid level: 500-1499 points
  GOLD     // High level: 1500+ points
}

model DriverIncentiveCycle {
  id                   String               @id @default(uuid())
  driverId             String
  period               IncentiveGoalPeriod
  goalType             IncentiveGoalType
  targetValue          Int                  // Target trips count or earnings amount (in cents)
  currentValue         Int                  @default(0) // Current progress
  periodStart          DateTime
  periodEnd            DateTime
  bonusAmount          Decimal              @db.Decimal(10, 2) // Bonus for completing goal
  currency             String               @default("USD")
  status               IncentiveCycleStatus @default(ACTIVE)
  completedAt          DateTime?
  bonusPaidAt          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  driver               DriverProfile        @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, period, goalType, periodStart])
  @@index([driverId])
  @@index([status])
  @@index([periodEnd])
  @@map("driver_incentive_cycles")
}

model DriverAchievement {
  id                   String            @id @default(uuid())
  driverId             String
  achievementType      AchievementType
  isUnlocked           Boolean           @default(false)
  unlockedAt           DateTime?
  progressCount        Int               @default(0) // Current progress towards unlock
  requiredCount        Int               // Required count to unlock
  streakCount          Int               @default(0) // For streak-based achievements
  streakStartDate      DateTime?         // When current streak started
  bonusAmount          Decimal?          @db.Decimal(10, 2) // Bonus for unlocking
  currency             String            @default("USD")
  bonusPaid            Boolean           @default(false)
  bonusPaidAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  driver               DriverProfile     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, achievementType])
  @@index([driverId])
  @@index([achievementType])
  @@index([isUnlocked])
  @@map("driver_achievements")
}

model DriverRewardLedger {
  id                   String           @id @default(uuid())
  driverId             String
  rewardType           RewardType
  tier                 DriverRewardTier?
  amount               Decimal          @db.Decimal(10, 2)
  currency             String           @default("USD")
  description          String
  promotionId          String?          // Reference to promotion if applicable
  achievementId        String?          // Reference to achievement if applicable
  incentiveCycleId     String?          // Reference to incentive cycle if applicable
  walletTransactionId  String?          // Reference to wallet transaction if paid out
  isPaid               Boolean          @default(false)
  paidAt               DateTime?
  issuedAt             DateTime         @default(now())
  createdAt            DateTime         @default(now())

  driver               DriverProfile    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  promotion            DriverPromotion? @relation(fields: [promotionId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([rewardType])
  @@index([tier])
  @@index([issuedAt])
  @@index([isPaid])
  @@map("driver_reward_ledger")
}

// ========================================
// MULTI-ROUTE FARE ENGINE (USA)
// ========================================

enum RideTypeCode {
  SAVER
  STANDARD
  COMFORT
  XL
  PREMIUM
}

// Ride type configuration with base pricing
model RideType {
  id                  String        @id @default(uuid())
  code                RideTypeCode  @unique
  name                String        // Display name (e.g., "SafeGo X", "SafeGo Comfort")
  description         String?
  iconType            String        @default("economy") // economy, comfort, xl, premium
  capacity            Int           @default(4)
  isActive            Boolean       @default(true)
  sortOrder           Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  fareConfigs         RideFareConfig[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("ride_types")
}

// Per-country/city fare configuration for each ride type
model RideFareConfig {
  id                      String        @id @default(uuid())
  rideTypeId              String
  countryCode             String        @default("US")
  cityCode                String?       // null = country-wide default
  
  // Base fare components (USD)
  baseFare                Decimal       @db.Decimal(10, 2) @default(2.50)
  perMileRate             Decimal       @db.Decimal(10, 4) @default(1.50)
  perMinuteRate           Decimal       @db.Decimal(10, 4) @default(0.30)
  minimumFare             Decimal       @db.Decimal(10, 2) @default(5.00)
  
  // Driver rates (for payout calculation)
  driverPerMileRate       Decimal       @db.Decimal(10, 4) @default(1.20)
  driverPerMinuteRate     Decimal       @db.Decimal(10, 4) @default(0.20)
  
  // Service fee configuration
  serviceFeePercent       Decimal       @db.Decimal(5, 2) @default(15.00) // SafeGo service fee %
  serviceFeeMinimum       Decimal       @db.Decimal(10, 2) @default(1.50)
  serviceFeeMaximum       Decimal       @db.Decimal(10, 2) @default(10.00)
  
  // Surge configuration
  maxSurgeMultiplier      Decimal       @db.Decimal(4, 2) @default(3.00)
  surgeEnabled            Boolean       @default(true)
  
  // Traffic adjustment (multiplier applied based on traffic severity)
  trafficMultiplierLight  Decimal       @db.Decimal(4, 2) @default(1.00)
  trafficMultiplierModerate Decimal     @db.Decimal(4, 2) @default(1.10)
  trafficMultiplierHeavy  Decimal       @db.Decimal(4, 2) @default(1.25)
  
  isActive                Boolean       @default(true)
  version                 Int           @default(1)
  effectiveFrom           DateTime      @default(now())
  effectiveTo             DateTime?     // null = currently active
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  updatedByAdminId        String?

  rideType                RideType      @relation(fields: [rideTypeId], references: [id], onDelete: Cascade)

  @@unique([rideTypeId, countryCode, cityCode, version])
  @@index([countryCode])
  @@index([cityCode])
  @@index([isActive])
  @@index([effectiveFrom])
  @@map("ride_fare_configs")
}

enum RegulatoryZoneType {
  AIRPORT
  CONGESTION
  CITY_BOUNDARY
  BLACK_CAR_FUND
  SPECIAL_TAX
}

// Polygon-based regulatory zones (airports, congestion zones, city boundaries)
model RegulatoryZone {
  id                  String              @id @default(uuid())
  name                String              // e.g., "JFK Airport", "Manhattan Congestion Zone"
  zoneType            RegulatoryZoneType
  countryCode         String              @default("US")
  stateCode           String?             // e.g., "NY"
  cityCode            String?
  
  // Polygon definition (JSON array of {lat, lng} points)
  polygonCoordinates  Json                // [{lat: number, lng: number}, ...]
  
  // Simple bounding box for quick pre-filtering
  boundingBoxMinLat   Float?
  boundingBoxMaxLat   Float?
  boundingBoxMinLng   Float?
  boundingBoxMaxLng   Float?
  
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  feeConfigs          RegulatoryFeeConfig[]

  @@index([zoneType])
  @@index([countryCode])
  @@index([stateCode])
  @@index([isActive])
  @@map("regulatory_zones")
}

enum RegulatoryFeeType {
  BLACK_CAR_FUND          // NY BCF - 2.5% of fare
  CITY_BOUNDARY_LEAVING   // Leaving city fee
  CITY_BOUNDARY_ENTERING  // Entering city fee
  LOCAL_TAX               // Local government ride tax
  AIRPORT_FEE             // Airport pickup/dropoff fee
  CONGESTION_FEE          // Congestion zone surcharge
}

// Fee configurations for regulatory zones
model RegulatoryFeeConfig {
  id                  String              @id @default(uuid())
  zoneId              String
  feeType             RegulatoryFeeType
  
  // Fee can be flat or percentage-based
  flatFeeAmount       Decimal?            @db.Decimal(10, 2)
  percentFeeRate      Decimal?            @db.Decimal(5, 2) // e.g., 2.5 for BCF
  
  // When fee applies
  appliesToPickup     Boolean             @default(true)
  appliesToDropoff    Boolean             @default(true)
  
  // Description for customer display
  displayName         String              // e.g., "Airport Surcharge", "Black Car Fund"
  description         String?
  
  isActive            Boolean             @default(true)
  version             Int                 @default(1)
  effectiveFrom       DateTime            @default(now())
  effectiveTo         DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  updatedByAdminId    String?

  zone                RegulatoryZone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId])
  @@index([feeType])
  @@index([isActive])
  @@map("regulatory_fee_configs")
}

// Toll segment configurations for known toll roads/bridges
model TollConfig {
  id                  String        @id @default(uuid())
  name                String        // e.g., "George Washington Bridge", "Holland Tunnel"
  countryCode         String        @default("US")
  stateCode           String?
  
  // Toll segment identification - can match by road name or coordinates
  segmentIdentifier   String        // Road name or segment ID from mapping provider
  alternateIdentifiers String[]     @default([]) // Alternative names/IDs
  
  // Coordinates for segment (start/end points for matching)
  startLat            Float?
  startLng            Float?
  endLat              Float?
  endLng              Float?
  
  // Toll rates by vehicle type
  tollRateSaver       Decimal       @db.Decimal(10, 2) @default(0)
  tollRateStandard    Decimal       @db.Decimal(10, 2) @default(0)
  tollRateComfort     Decimal       @db.Decimal(10, 2) @default(0)
  tollRateXL          Decimal       @db.Decimal(10, 2) @default(0)
  tollRatePremium     Decimal       @db.Decimal(10, 2) @default(0)
  
  // Driver keeps 100% of tolls
  tollPaidToDriver    Boolean       @default(true)
  
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([countryCode])
  @@index([stateCode])
  @@index([isActive])
  @@map("toll_configs")
}

enum FeeRuleType {
  CANCELLATION_FEE
  WAITING_FEE
  BOOKING_FEE
  SAFETY_FEE
  CLEAN_AIR_FEE
  INSURANCE_SURCHARGE
  ECO_FEE
}

// General configurable fees (cancellation, waiting, safety, eco)
model FeeRule {
  id                  String        @id @default(uuid())
  feeType             FeeRuleType
  countryCode         String        @default("US")
  cityCode            String?
  
  // Fee amount (flat or per-unit)
  flatAmount          Decimal?      @db.Decimal(10, 2)
  perUnitAmount       Decimal?      @db.Decimal(10, 4) // e.g., per minute for waiting
  unitType            String?       // "minute", "mile", "percent"
  
  // Thresholds
  freeUnits           Int?          @default(0) // e.g., 2 free minutes for waiting
  minimumFee          Decimal?      @db.Decimal(10, 2)
  maximumFee          Decimal?      @db.Decimal(10, 2)
  
  // Conditions
  requiresDriverAssigned Boolean    @default(false) // For cancellation fees
  minimumMinutesAfterAccept Int?    // e.g., no cancel fee within 2 mins
  
  displayName         String
  description         String?
  
  isActive            Boolean       @default(true)
  version             Int           @default(1)
  effectiveFrom       DateTime      @default(now())
  effectiveTo         DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  updatedByAdminId    String?

  @@unique([feeType, countryCode, cityCode, version])
  @@index([feeType])
  @@index([countryCode])
  @@index([isActive])
  @@map("fee_rules")
}

// Audit log for fare calculations (security and compliance)
model FareCalculationLog {
  id                      String        @id @default(uuid())
  rideId                  String?       // Reference to ride if booked
  customerId              String?
  
  // Route information
  pickupLat               Float
  pickupLng               Float
  dropoffLat              Float
  dropoffLng              Float
  routeId                 String?       // Geometry-based route identifier
  distanceMiles           Float
  durationMinutes         Int
  trafficDurationMinutes  Int?
  
  // Selected options
  rideTypeCode            String
  selectedRouteType       String?       // fastest, shortest, avoid_highways, avoid_tolls
  
  // Calculated fare breakdown (stored as JSON for flexibility)
  fareBreakdown           Json          // Full breakdown with all components
  
  // Summary amounts for quick queries
  baseFare                Decimal       @db.Decimal(10, 2)
  distanceFare            Decimal       @db.Decimal(10, 2)
  timeFare                Decimal       @db.Decimal(10, 2)
  trafficAdjustment       Decimal       @db.Decimal(10, 2) @default(0)
  surgeAmount             Decimal       @db.Decimal(10, 2) @default(0)
  surgeMultiplier         Decimal       @db.Decimal(4, 2) @default(1.00)
  tollsTotal              Decimal       @db.Decimal(10, 2) @default(0)
  regulatoryFeesTotal     Decimal       @db.Decimal(10, 2) @default(0)
  serviceFee              Decimal       @db.Decimal(10, 2)
  discountAmount          Decimal       @db.Decimal(10, 2) @default(0)
  totalFare               Decimal       @db.Decimal(10, 2)
  
  // Driver payout calculation
  driverPayout            Decimal       @db.Decimal(10, 2)
  safegoCommission        Decimal       @db.Decimal(10, 2)
  
  // Matched zones and fees
  matchedZones            String[]      @default([]) // Zone IDs that matched
  appliedFees             Json?         // Detailed fee application log
  
  // All route alternatives that were calculated
  routeAlternatives       Json?         // All routes with their fares
  
  calculatedAt            DateTime      @default(now())
  ipAddress               String?
  userAgent               String?
  
  @@index([rideId])
  @@index([customerId])
  @@index([calculatedAt])
  @@index([rideTypeCode])
  @@map("fare_calculation_logs")
}

// ============================================
// PROMOTION ENGINE MODELS
// ============================================

enum PromoType {
  ANCHOR_ONLY           // Psychological anchor (0% real discount)
  SAVER                 // Wait longer for discount (2-3%)
  FIRST_RIDE            // First ride only (up to $7 off)
  TIME_BASED            // Off-peak hours discount
  LOCATION_BASED        // Low-demand zone discount
  PAYMENT_METHOD        // Wallet payment bonus
  REWARD_POINTS         // Points accumulation
  DRIVER_ARRIVAL        // Late arrival credit
}

// Promo configuration by type and region
model PromoConfig {
  id                    String        @id @default(uuid())
  promoType             PromoType
  countryCode           String        @default("US")
  cityCode              String?
  
  // Display information
  name                  String        // e.g., "Welcome Discount"
  displayTag            String        // e.g., "First Ride", "Saver"
  description           String?
  
  // Discount parameters
  discountPercent       Decimal?      @db.Decimal(5, 2)  // e.g., 3.00 for 3%
  discountMaxAmount     Decimal?      @db.Decimal(10, 2) // Max absolute discount
  discountMinFare       Decimal?      @db.Decimal(10, 2) // Minimum fare after discount
  
  // Anchor pricing multiplier (default 1.10 = 10% markup for anchor)
  anchorMultiplier      Decimal       @db.Decimal(4, 2) @default(1.10)
  
  // Time-based rules (for TIME_BASED promo)
  validDaysOfWeek       Int[]         @default([])  // 0=Sunday, 6=Saturday
  validStartHour        Int?          // 0-23
  validEndHour          Int?          // 0-23
  
  // Loss protection limits
  maxUsesPerUser        Int?          // Per cooldown period
  cooldownDays          Int?          @default(7)  // Cooldown period in days
  maxUsesPerDay         Int?          // Global daily limit
  
  // Surge blocking
  maxSurgeAllowed       Decimal?      @db.Decimal(4, 2) @default(1.30) // Block promo if surge > this
  
  // Priority for stacking (higher = applied first)
  priority              Int           @default(0)
  stackable             Boolean       @default(false) // Can combine with other promos
  
  // Wallet-only flag
  walletOnly            Boolean       @default(false)
  
  isActive              Boolean       @default(true)
  effectiveFrom         DateTime      @default(now())
  effectiveTo           DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  @@unique([promoType, countryCode, cityCode])
  @@index([promoType])
  @@index([countryCode])
  @@index([isActive])
  @@map("promo_configs")
}

// Low-demand zones for location-based promos
model LowDemandZone {
  id                    String        @id @default(uuid())
  name                  String        // e.g., "Staten Island Outer"
  countryCode           String        @default("US")
  cityCode              String?
  
  // Polygon coordinates [[lat, lng], ...]
  polygonCoordinates    Json
  
  // Bounding box for quick filtering
  boundingBoxMinLat     Float?
  boundingBoxMaxLat     Float?
  boundingBoxMinLng     Float?
  boundingBoxMaxLng     Float?
  
  // Zone-specific discount
  discountPercent       Decimal       @db.Decimal(5, 2) @default(2.00)
  
  // Demand level (0-100, lower = less demand)
  demandLevel           Int           @default(50)
  
  isActive              Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  @@index([countryCode])
  @@index([cityCode])
  @@index([isActive])
  @@map("low_demand_zones")
}

// User promo usage tracking
model UserPromoUsage {
  id                    String        @id @default(uuid())
  userId                String
  
  // First ride tracking
  firstRideUsed         Boolean       @default(false)
  firstRideUsedAt       DateTime?
  firstRideRideId       String?
  
  // Weekly usage counters (reset every 7 days)
  weeklyPromoCount      Int           @default(0)
  weeklyResetAt         DateTime      @default(now())
  
  // Reward points balance
  rewardPointsBalance   Int           @default(0)
  rewardPointsLifetime  Int           @default(0)
  
  // Total savings
  totalSavingsAmount    Decimal       @db.Decimal(12, 2) @default(0)
  totalAnchorSavings    Decimal       @db.Decimal(12, 2) @default(0) // Perceived savings
  
  // Driver arrival credits
  arrivalCreditsBalance Decimal       @db.Decimal(10, 2) @default(0)
  
  // Last promo usage
  lastPromoType         PromoType?
  lastPromoUsedAt       DateTime?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  @@unique([userId])
  @@index([userId])
  @@map("user_promo_usage")
}

// Promo application log (audit trail)
model PromoLog {
  id                    String        @id @default(uuid())
  userId                String?
  rideId                String?
  fareCalculationLogId  String?
  
  // Promo details
  promoType             PromoType
  promoConfigId         String?
  
  // Fare information
  originalFare          Decimal       @db.Decimal(10, 2)
  anchorFare            Decimal       @db.Decimal(10, 2)
  finalFare             Decimal       @db.Decimal(10, 2)
  
  // Discount breakdown
  actualDiscountAmount  Decimal       @db.Decimal(10, 2) @default(0)
  perceivedSavings      Decimal       @db.Decimal(10, 2) @default(0) // anchor - final
  companyLoss           Decimal       @db.Decimal(10, 2) @default(0) // original - final
  
  // Rules applied
  discountPercentApplied Decimal?     @db.Decimal(5, 2)
  lossCapApplied        Boolean       @default(false)
  minimumFareApplied    Boolean       @default(false)
  
  // Blocking reasons (if promo was blocked)
  wasBlocked            Boolean       @default(false)
  blockReason           String?       // e.g., "surge_too_high", "cooldown_active"
  
  // Context
  surgeMultiplier       Decimal?      @db.Decimal(4, 2)
  paymentMethod         String?
  isWalletPayment       Boolean       @default(false)
  
  // Abuse detection flags
  suspiciousActivity    Boolean       @default(false)
  suspiciousReason      String?
  
  // Metadata
  ipAddress             String?
  userAgent             String?
  deviceFingerprint     String?
  
  appliedAt             DateTime      @default(now())
  
  @@index([userId])
  @@index([rideId])
  @@index([promoType])
  @@index([appliedAt])
  @@index([wasBlocked])
  @@map("promo_logs")
}

// ============================================
// GLOBAL RIDE PROMOTION ENGINE (C6)
// ============================================

enum RidePromoUserRule {
  ALL_RIDES         // Applied to every ride
  FIRST_RIDE        // Only for user's first ride
  N_RIDES           // Applied to first N rides
}

enum RidePromoAppliesTo {
  ALL               // All rides globally
  CITY              // Specific cities only
  CATEGORY          // Specific vehicle categories
  USER_SEGMENT      // Specific user segments
}

enum RidePromoDiscountMode {
  PERCENT           // Percentage discount
  FLAT              // Fixed amount discount
}

// Global ride promotions (auto-applied, admin-managed)
model RidePromotion {
  id                    String                @id @default(uuid())
  
  // Basic info
  name                  String                // e.g., "SafeGo Everyday Saver"
  description           String?               @db.Text
  
  // Discount configuration
  discountType          RidePromoDiscountMode @default(PERCENT)
  value                 Decimal               @db.Decimal(10, 2) // Percentage (0-100) or flat amount
  maxDiscountAmount     Decimal?              @db.Decimal(10, 2) // Cap for percentage discounts
  
  // Targeting
  appliesTo             RidePromoAppliesTo    @default(ALL)
  targetCities          String[]              @default([]) // City codes (if CITY)
  targetCategories      String[]              @default([]) // Vehicle categories (if CATEGORY)
  targetUserSegments    String[]              @default([]) // User segments (if USER_SEGMENT)
  
  // User eligibility rules
  userRule              RidePromoUserRule     @default(ALL_RIDES)
  rideCountLimit        Int?                  // For N_RIDES: apply to first N rides
  
  // Surge control
  maxSurgeAllowed       Decimal?              @db.Decimal(4, 2) // Block promo if surge > this
  
  // Validity period
  startAt               DateTime              @default(now())
  endAt                 DateTime?             // null = no expiry
  
  // Usage limits
  globalUsageLimit      Int?                  // Max total uses
  currentUsageCount     Int                   @default(0)
  usagePerUserLimit     Int?                  // Max uses per user
  
  // Status
  isActive              Boolean               @default(true)
  isDefault             Boolean               @default(false) // Default promo (e.g., Everyday Saver)
  priority              Int                   @default(0)     // Higher = applied first
  
  // Metadata
  createdBy             String?               // Admin user ID
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  usages                RidePromotionUsage[]
  
  @@index([isActive])
  @@index([isDefault])
  @@index([startAt, endAt])
  @@index([appliesTo])
  @@index([priority])
  @@map("ride_promotions")
}

// Track ride promotion usage per user
model RidePromotionUsage {
  id                    String          @id @default(uuid())
  promotionId           String
  userId                String
  rideId                String?         // Set when ride is completed
  
  discountApplied       Decimal         @db.Decimal(10, 2)
  originalFare          Decimal         @db.Decimal(10, 2)
  finalFare             Decimal         @db.Decimal(10, 2)
  
  vehicleCategory       String?
  cityCode              String?
  
  appliedAt             DateTime        @default(now())
  
  promotion             RidePromotion   @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([promotionId])
  @@index([rideId])
  @@index([appliedAt])
  @@map("ride_promotion_usages")
}

// User-entered promo codes for rides
model RidePromoCode {
  id                    String        @id @default(uuid())
  code                  String        @unique // e.g., "WELCOME10", "SUMMER2024"
  
  // Discount configuration
  discountType          RidePromoDiscountType @default(PERCENTAGE)
  discountValue         Decimal       @db.Decimal(10, 2) // Percentage or fixed amount
  maxDiscountAmount     Decimal?      @db.Decimal(10, 2) // Cap for percentage discounts
  minFareAmount         Decimal?      @db.Decimal(10, 2) // Minimum fare required
  
  // Targeting
  countryCode           String?       // null = all countries
  cityCode              String?       // null = all cities
  rideTypes             String[]      @default([]) // Empty = all ride types
  
  // Usage limits
  maxTotalUses          Int?          // null = unlimited
  maxUsesPerUser        Int?          @default(1)
  currentUsageCount     Int           @default(0)
  
  // Validity period
  validFrom             DateTime      @default(now())
  validTo               DateTime?     // null = no expiry
  
  // Conditions
  firstRideOnly         Boolean       @default(false)
  newUsersOnly          Boolean       @default(false) // Registered within last 7 days
  walletPaymentOnly     Boolean       @default(false)
  
  // Status
  isActive              Boolean       @default(true)
  
  // Metadata
  description           String?       @db.Text
  internalNotes         String?       @db.Text
  createdBy             String?       // Admin user ID
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  // Usage tracking relation
  usages                RidePromoCodeUsage[]
  
  @@index([code])
  @@index([isActive])
  @@index([validFrom, validTo])
  @@index([countryCode])
  @@map("ride_promo_codes")
}

enum RidePromoDiscountType {
  PERCENTAGE        // Percentage off fare
  FIXED_AMOUNT      // Fixed dollar amount off
  CAPPED_PERCENTAGE // Percentage with max cap
}

// Track promo code usage per user
model RidePromoCodeUsage {
  id                    String        @id @default(uuid())
  promoCodeId           String
  userId                String
  rideId                String?       // Set when ride is completed
  
  discountApplied       Decimal       @db.Decimal(10, 2)
  originalFare          Decimal?      @db.Decimal(10, 2)
  finalFare             Decimal?      @db.Decimal(10, 2)
  
  appliedAt             DateTime      @default(now())
  
  promoCode             RidePromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  
  @@unique([promoCodeId, userId, rideId])
  @@index([userId])
  @@index([promoCodeId])
  @@index([appliedAt])
  @@map("ride_promo_code_usages")
}

// ============================================================
// Phase 1A: Real-Time Dispatch Core
// ============================================================

enum DispatchServiceMode {
  ride
  food
  parcel
  offline
}

enum DispatchSessionStatus {
  requested
  searching_driver
  offer_pending
  driver_accepted
  no_driver_found
  cancelled_by_customer
  cancelled_by_admin
  expired
}

// Driver real-time presence and location state
model DriverRealtimeState {
  id                    String              @id @default(uuid())
  driverId              String              @unique
  isOnline              Boolean             @default(false)
  isAvailable           Boolean             @default(false)
  currentServiceMode    DispatchServiceMode @default(offline)
  lastKnownLat          Float?
  lastKnownLng          Float?
  lastUpdateAt          DateTime            @default(now())
  countryCode           String?
  cityCode              String?
  currentAssignmentId   String?             // FK to DispatchSession
  connectedAt           DateTime?           // When driver connected to WebSocket
  disconnectedAt        DateTime?           // When driver disconnected
  
  driver                DriverProfile       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  currentAssignment     DispatchSession?    @relation("CurrentAssignment", fields: [currentAssignmentId], references: [id])
  
  @@index([isOnline, isAvailable])
  @@index([countryCode, cityCode])
  @@index([currentServiceMode])
  @@index([lastKnownLat, lastKnownLng])
  @@map("driver_realtime_states")
}

// Dispatch session for ride/food/parcel assignment
model DispatchSession {
  id                    String                @id @default(uuid())
  serviceType           DeliveryServiceType   @default(ride)
  entityId              String                // FK to rides.id OR food_orders.id OR deliveries.id
  customerId            String
  assignedDriverId      String?
  candidateDriverIds    String[]              @default([])
  rejectedDriverIds     String[]              @default([])
  expiredDriverIds      String[]              @default([])
  status                DispatchSessionStatus @default(requested)
  
  // Location data (denormalized for fast queries)
  pickupLat             Float?
  pickupLng             Float?
  dropoffLat            Float?
  dropoffLng            Float?
  pickupAddress         String?
  dropoffAddress        String?
  
  // Timing
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  expiresAt             DateTime?             // When entire session expires
  acceptedAt            DateTime?
  
  // Jurisdiction (denormalized)
  countryCode           String?
  cityCode              String?
  
  // Dispatch metadata
  maxRadiusKm           Float?
  offerTimeoutSeconds   Int?                  @default(30)
  currentOfferDriverId  String?               // Driver currently being offered
  currentOfferExpiresAt DateTime?
  searchRound           Int                   @default(1)
  
  // Audit logs
  logs                  Json?                 // JSON array of status changes
  
  // Relations
  customer              CustomerProfile       @relation(fields: [customerId], references: [id])
  assignedDriver        DriverProfile?        @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  ride                  Ride?                 @relation("RideDispatch")
  driversWithAssignment DriverRealtimeState[] @relation("CurrentAssignment")
  offerEvents           DispatchOfferEvent[]
  
  @@index([serviceType, status])
  @@index([countryCode, cityCode])
  @@index([entityId])
  @@index([customerId])
  @@index([assignedDriverId])
  @@index([status])
  @@map("dispatch_sessions")
}

// Track individual offer events to drivers
model DispatchOfferEvent {
  id                    String            @id @default(uuid())
  dispatchSessionId     String
  driverId              String
  
  offeredAt             DateTime          @default(now())
  expiresAt             DateTime
  respondedAt           DateTime?
  response              String?           // accept, reject, expired
  
  // Driver location at time of offer
  driverLat             Float?
  driverLng             Float?
  distanceKm            Float?
  
  dispatchSession       DispatchSession   @relation(fields: [dispatchSessionId], references: [id], onDelete: Cascade)
  driver                DriverProfile     @relation(fields: [driverId], references: [id])
  
  @@index([dispatchSessionId])
  @@index([driverId])
  @@index([response])
  @@map("dispatch_offer_events")
}

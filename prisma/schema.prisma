generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  COUNTRY_ADMIN
  CITY_ADMIN
  COMPLIANCE_ADMIN
  SUPPORT_ADMIN
  FINANCE_ADMIN
  RISK_ADMIN
  READONLY_ADMIN
}

enum SecurityStatus {
  normal
  under_observation
  needs_review
}

enum DocumentStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  EXPIRING_SOON
  EXPIRED
  REJECTED
  NEEDS_UPDATE
}

enum DriverAssignmentStatus {
  none
  searching_driver
  driver_assigned
  driver_rejected
  no_driver_found
}

enum DeliveryServiceType {
  ride
  food
  parcel
}

// Phase 2A: Settlement status for trips/orders
enum SettlementStatus {
  pending // Not yet settled
  settled // Successfully auto-credited/debited
  failed // Settlement attempt failed
  manual_review // Requires manual intervention
}

// Phase 2A: Incentive bonus types
enum IncentiveBonusType {
  per_trip // Flat bonus per completed trip
  streak // Bonus for completing X trips in Y hours
  target // Bonus for hitting daily/weekly target
  peak_hour // Bonus during surge/peak times
  first_trip // First trip of the day bonus
}

// Phase 2A: Incentive award status
enum IncentiveAwardStatus {
  pending // Awaiting wallet credit
  granted // Successfully granted and credited to wallet
  credited // Successfully credited to wallet (alias for granted)
  failed // Credit attempt failed
  expired // Award expired before crediting
}

// Phase 2A: Cancellation fee type
enum CancellationFeeType {
  customer_cancel // Customer cancelled after driver accepted
  no_show // Customer no-show at pickup
  driver_cancel // Driver cancelled (may incur penalty)
}

// Phase 2B: Payment status lifecycle
enum PaymentStatus {
  created // Payment intent created
  requires_payment_method // Waiting for payment method
  requires_confirmation // Payment method attached, awaiting confirmation
  processing // Payment is processing
  authorized // Payment authorized but not captured
  captured // Payment successfully captured
  succeeded // Payment fully completed
  failed // Payment failed
  cancelled // Payment cancelled
  refunded // Payment refunded
  partially_refunded // Partial refund issued
}

// Phase 2B: Payment provider types
enum PaymentProvider {
  mock // Demo/test provider
  stripe // Stripe payment gateway
  bkash // bKash mobile payment (Bangladesh)
  nagad // Nagad mobile payment (Bangladesh)
  paypal // PayPal
  braintree // Braintree
}

// Phase 2B: Device platform types
enum DevicePlatform {
  ios
  android
  web
}

// Phase 2B: Notification types
enum NotificationType {
  // Driver notifications
  NEW_RIDE_OFFER
  RIDE_ASSIGNED
  RIDE_CANCELLED
  RIDE_COMPLETED_SUMMARY
  NEW_FOOD_ORDER_ASSIGNMENT
  NEW_PARCEL_ASSIGNMENT
  WALLET_NEGATIVE_BALANCE_REMINDER
  INCENTIVE_AWARDED
  PAYOUT_PROCESSED
  EARNINGS_SETTLED

  // Phase 3: Driver food/parcel notifications
  FOOD_ORDER_READY_FOR_PICKUP
  PARCEL_SCHEDULED_ASSIGNMENT
  PARCEL_PICKUP_REMINDER
  POD_REQUIRED_REMINDER

  // Customer notifications
  DRIVER_ASSIGNED
  DRIVER_ARRIVING
  DRIVER_ARRIVED
  TRIP_STARTED
  TRIP_COMPLETED_RECEIPT
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  ORDER_STATUS_UPDATE
  PARCEL_STATUS_UPDATE
  ORDER_PICKED_UP
  ORDER_DELIVERED

  // Phase 3: Customer notifications
  PROFILE_UPDATED
  FOOD_ORDER_STATUS_CHANGED
  PARCEL_SCHEDULED_CONFIRMATION
  PARCEL_PICKUP_REMINDER_CUSTOMER
  PARCEL_DELIVERED_WITH_POD

  // Restaurant notifications
  NEW_ORDER_RECEIVED
  ORDER_CANCELLED
  ORDER_READY_REMINDER

  // Phase 3: Restaurant notifications
  RESTAURANT_DRIVER_ASSIGNED
  RESTAURANT_ORDER_PICKED_UP

  // Admin notifications
  HIGH_FAILURE_RATE
  ABNORMAL_BALANCE
  SYSTEM_ALERT
}

// ============================================================
// Phase 3: Customer Experience, Restaurant Flow & Parcel Features
// ============================================================

// Phase 3: Kitchen ticket status
enum KitchenTicketStatus {
  queued
  preparing
  ready
  handed_to_driver
  cancelled
}

// Phase 3: Parcel size categories
enum ParcelSizeCategory {
  small
  medium
  large
  oversized
}

// Phase 3: Parcel pickup type
enum ParcelPickupType {
  immediate
  scheduled
}

// SafeGo Parcel System: Domestic delivery zones (BD)
enum ParcelDomesticZoneType {
  same_city
  inside_division
  outside_division
  remote
}

// SafeGo Parcel System: International destination zones
enum ParcelInternationalZoneType {
  zone1_south_asia       // India, Nepal, Bhutan
  zone3_middle_east      // UAE, KSA, Qatar, Oman
  zone5_europe           // UK, EU
  zone6_north_america    // USA, Canada
}

// SafeGo Parcel System: Delivery speed tiers
enum ParcelDeliverySpeed {
  regular              // +0
  quick                // +30 tk
  express              // +60 tk
  super_express        // +120 tk
}

// Phase 3: Address label types (for saved places)
enum SavedPlaceLabel {
  home
  work
  other
}

// Phase 3: Music preference
enum MusicPreference {
  no_preference
  quiet
  loud_ok
}

// Phase 3: AC preference
enum AcPreference {
  no_preference
  ac_on
  ac_off
}

// Phase 3: Communication preference
enum CommunicationPreference {
  no_preference
  minimal_talk
  friendly
}

// Phase 3: Restaurant kitchen status
enum KitchenStatus {
  open
  busy
  closed
}

// Phase 2B: Notification status
enum NotificationStatus {
  pending // Not yet sent
  sent // Successfully sent to FCM
  delivered // Confirmed delivered to device
  failed // Failed to send
  expired // Message expired before delivery
}

model AdminProfile {
  id                               String                 @id @default(uuid())
  userId                           String                 @unique
  adminRole                        AdminRole              @default(SUPER_ADMIN)
  isActive                         Boolean                @default(true)
  createdAt                        DateTime               @default(now())
  twoFactorEnabled                 Boolean                @default(false)
  twoFactorSecret_encrypted        String?
  twoFactorRecoveryCodes_encrypted String?
  pending2FASecret_encrypted       String?
  pending2FAExpiresAt              DateTime?
  country                          String?
  countryCode                      String?
  cityCode                         String?
  user                             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminSupportTickets              AdminSupportTicket[]   @relation("AdminSupportTickets") // Phase 12 Extension
  adminLiveChatSessions            AdminLiveChatSession[] @relation("AdminLiveChatSessions") // Phase 12 Extension
  adminSupportCallbacks            AdminSupportCallback[] @relation("AdminSupportCallbacks") // Phase 12 Extension

  // Phase 6B: Admin Security relations
  totpSecret        AdminTotpSecret?       @relation("AdminTotpSecret")
  activityAnomalies AdminActivityAnomaly[] @relation("AdminAnomalies")
  payoutAuditLogs   PayoutAuditLog[]       @relation("PayoutAuditLogs")

  // Profile Picture System (additive only)
  profilePhotoUrl         String?   // Main profile photo URL (512x512)
  profilePhotoThumbnail   String?   // Thumbnail URL (128x128)
  profilePhotoLastUpdated DateTime? // When photo was last updated

  @@index([countryCode])
  @@index([cityCode])
  @@map("admin_profiles")
}

model CustomerProfile {
  id                       String                      @id @default(uuid())
  userId                   String                      @unique
  cityCode                 String?
  fatherName               String?
  presentAddress           String?
  permanentAddress         String?
  nidNumber                String?
  nidFrontImageUrl         String?
  nidBackImageUrl          String?
  homeAddress              String?
  governmentIdType         String?
  governmentIdLast4        String?
  dateOfBirth              DateTime?
  emergencyContactName     String?
  emergencyContactPhone    String?
  verificationStatus       String                      @default("pending")
  rejectionReason          String?
  isVerified               Boolean                     @default(false)
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt
  isSuspended              Boolean                     @default(false)
  suspendedAt              DateTime?
  suspensionReason         String?
  district                 String?
  fullName                 String?
  nidEncrypted             String?
  phoneNumber              String?
  postOffice               String?
  postalCode               String?
  thana                    String?
  village                  String?
  securityStatus           SecurityStatus              @default(normal)
  securityNotes            String?
  user                     User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries               Delivery[]
  driverComplaints         DriverComplaint[]
  foodOrders               FoodOrder[]
  rides                    Ride[]
  reviews                  Review[] // Phase 8: Customer reviews
  supportTickets           SupportTicket[] // Phase 12: Customer support tickets
  customerSupportTickets   CustomerSupportTicket[]     @relation("CustomerSupportTickets") // Phase 12 Extension
  customerLiveChatSessions CustomerLiveChatSession[]   @relation("CustomerLiveChatSessions") // Phase 12 Extension
  customerSupportCallbacks CustomerSupportCallback[]   @relation("CustomerSupportCallbacks") // Phase 12 Extension
  favoriteRestaurants      FoodRestaurantFavorite[] // Favorite restaurants for quick access
  savedAddresses           CustomerAddress[] // Multiple delivery addresses
  blockedRestaurants       CustomerBlockedRestaurant[] // Restaurants blocked by customer

  // Phase 1A: Real-Time Dispatch
  dispatchSessions DispatchSession[] // Dispatch sessions for this customer

  // Phase 1B: Trip conversations
  tripConversations TripConversation[]

  // Phase 2B: Payment methods and payments
  paymentMethods PaymentMethod[]
  payments       Payment[]

  // Phase 3: Customer profile enhancements (additive only)
  firstName               String? // First name (separate from fullName)
  lastName                String? // Last name
  avatarUrl               String? // Profile picture URL
  languagePreference      String? @default("en") // en, bn, es, fr, ar
  notificationPreferences Json? // { ride_updates, food_updates, parcel_updates, marketing }

  // Profile Picture System (additive only)
  profilePhotoUrl         String?   // Main profile photo URL (512x512)
  profilePhotoThumbnail   String?   // Thumbnail URL (128x128)
  profilePhotoLastUpdated DateTime? // When photo was last updated

  // Phase 3: Saved places and ride preferences (relations)
  savedPlaces     CustomerSavedPlace[]
  ridePreferences CustomerRidePreferences?

  // Bangladesh Expansion: BD-only service relations
  productOrders  ProductOrder[] // Shop orders placed by customer
  ticketBookings TicketBooking[] // Ticket bookings
  rentalBookings RentalBooking[] // Rental bookings
  mobileWallets  CustomerMobileWallet[] // BD mobile wallet payment methods (bKash, Nagad)

  // Phase 4: Enterprise Admin relations
  complaints     Complaint[]

  @@index([cityCode])
  @@map("customer_profiles")
}

model Delivery {
  id                      String              @id
  customerId              String
  driverId                String?
  pickupAddress           String
  pickupLat               Float?
  pickupLng               Float?
  dropoffAddress          String
  dropoffLat              Float?
  dropoffLng              Float?
  serviceFare             Decimal             @db.Decimal(10, 2)
  safegoCommission        Decimal             @db.Decimal(10, 2)
  driverPayout            Decimal             @db.Decimal(10, 2)
  paymentMethod           String
  status                  String
  customerRating          Int?
  customerFeedback        String?
  taxBreakdown            Json?
  totalTaxAmount          Decimal?            @db.Decimal(10, 2)
  isDemo                  Boolean             @default(false)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount      Int?                @default(0)
  lastSupportStatus       String? // Latest support ticket status
  // Step 46: Driver Delivery Flow fields (additive only)
  serviceType             DeliveryServiceType @default(parcel) // ride | food | parcel
  countryCode             String? // BD | US
  restaurantId            String? // For food deliveries, link to restaurant
  // Step 46: Driver tracking fields
  driverEtaMinutes        Int? // Estimated minutes until driver arrives
  driverLastLocationLat   Float? // Driver's last known latitude
  driverLastLocationLng   Float? // Driver's last known longitude
  driverLocationUpdatedAt DateTime? // When driver location was last updated
  acceptedAt              DateTime? // When driver accepted
  pickedUpAt              DateTime? // When driver picked up
  createdAt               DateTime            @default(now())
  updatedAt               DateTime
  deliveredAt             DateTime?

  // Phase 1B: Real-Time Dispatch for parcel deliveries
  dispatchSessionId   String?   @unique // FK to dispatch_sessions
  statusHistory       Json?     @default("[]") // Array of {status, timestamp, actor}
  etaToPickupSeconds  Int? // ETA from driver to pickup
  etaToDropoffSeconds Int? // ETA from pickup to dropoff
  etaLastUpdatedAt    DateTime? // When ETA was last recalculated

  // Phase 2A: Settlement & Financial tracking (additive only)
  settlementStatus       SettlementStatus     @default(pending) // Settlement lifecycle status
  settledAt              DateTime? // When wallet transactions were posted
  tipAmount              Decimal?             @db.Decimal(10, 2) // Customer tip for driver
  tipPaymentMethod       String? // cash | online (how tip was paid)
  tipSettledAt           DateTime? // When tip was credited to driver
  cancellationFeeApplied Decimal?             @db.Decimal(10, 2) // Actual fee charged
  cancellationFeeRuleId  String? // FK to cancellation_fee_rules
  cancellationFeeRule    CancellationFeeRule? @relation("DeliveryCancellationFeeRule", fields: [cancellationFeeRuleId], references: [id], onDelete: SetNull)
  incentiveAwards        IncentiveAward[]     @relation("DeliveryIncentiveAwards") // Phase 2A: Proper relation to incentive awards

  // Phase 2B: Online payment integration (additive only)
  paymentId     String? // FK to payments table (for online payments)
  paymentStatus String? // mirrors payments.status for fast queries (paid, failed, pending)

  // Phase 3: Parcel size/weight pricing (Task 26) - additive only
  parcelSizeCategory ParcelSizeCategory? // small, medium, large, oversized
  parcelWeightKg     Decimal?            @db.Decimal(6, 2) // Weight in kg
  pricingConfigId    String? // FK to parcel_pricing_configs
  pricingBreakdown   Json? // Detailed pricing breakdown (like rides/fare_breakdown)

  // Phase 3: Scheduled pickup (Task 28) - additive only
  pickupType              ParcelPickupType @default(immediate) // immediate, scheduled
  scheduledPickupAt       DateTime? // Scheduled pickup time
  scheduledWindowMinutes  Int? // Pickup window (e.g., 30, 60)
  scheduledDispatchAt     DateTime? // When to start driver search (scheduledPickupAt - lead_time)
  scheduledDispatchStatus String? // pending, dispatched, cancelled

  // ============================================================
  // SafeGo Parcel System: BD Domestic + International (additive only)
  // ============================================================
  
  // Parcel details
  parcelType              String? // documents, electronics, clothing, food, fragile, other
  actualWeightKg          Decimal?            @db.Decimal(6, 2) // Actual weight in kg
  volumetricWeightKg      Decimal?            @db.Decimal(6, 2) // Volumetric weight (L*W*H/5000)
  chargeableWeightKg      Decimal?            @db.Decimal(6, 2) // max(actual, volumetric)
  lengthCm                Decimal?            @db.Decimal(6, 2) // Length in cm
  widthCm                 Decimal?            @db.Decimal(6, 2) // Width in cm
  heightCm                Decimal?            @db.Decimal(6, 2) // Height in cm
  isFragile               Boolean?            // Fragile item surcharge applies (nullable for backward compat)
  
  // Delivery zone (domestic)
  domesticZoneType        ParcelDomesticZoneType? // same_city, inside_division, outside_division, remote
  
  // International delivery
  isInternational         Boolean?            // Is international delivery (nullable for backward compat)
  destinationCountry      String? // Destination country code (ISO 3166-1 alpha-2)
  destinationCity         String? // Destination city
  internationalZoneType   ParcelInternationalZoneType? // zone1_south_asia, zone3_middle_east, etc.
  customsDeclaration      Json? // { declared_value, contents_description, hs_code }
  
  // Speed and COD
  deliverySpeed           ParcelDeliverySpeed? // regular, quick, express, super_express
  codEnabled              Boolean?            // Cash on delivery (nullable for backward compat)
  codAmount               Decimal?            @db.Decimal(10, 2) // Amount to collect
  codCollected            Boolean?            // Whether COD was collected (nullable for backward compat)
  codCollectedAt          DateTime? // When COD was collected
  
  // Pricing breakdown (BD parcel system)
  baseDeliveryCharge      Decimal?            @db.Decimal(10, 2) // Base zone charge
  speedSurcharge          Decimal?            @db.Decimal(10, 2) // Speed add-on
  fragileSurcharge        Decimal?            @db.Decimal(10, 2) // Fragile handling
  remoteSurcharge         Decimal?            @db.Decimal(10, 2) // Remote area fee
  fuelSurchargePercent    Decimal?            @db.Decimal(5, 2)  // Fuel surcharge %
  fuelSurchargeAmount     Decimal?            @db.Decimal(10, 2) // Calculated fuel surcharge
  codFee                  Decimal?            @db.Decimal(10, 2) // COD collection fee
  securitySurcharge       Decimal?            @db.Decimal(10, 2) // International security fee
  totalDeliveryCharge     Decimal?            @db.Decimal(10, 2) // Final calculated charge
  
  // Commission & settlement (parcel-specific)
  commissionAmount        Decimal?            @db.Decimal(10, 2) // SafeGo commission
  driverPayoutAmount      Decimal?            @db.Decimal(10, 2) // Driver earnings
  negativeBalanceApplied  Boolean?            // If CASH, commission applied as negative (nullable for backward compat)
  
  // Sender/Receiver info
  senderName              String?
  senderPhone             String?
  receiverName            String?
  receiverPhone           String?
  parcelDescription       String? // User description of contents
  specialInstructions     String? // Delivery instructions
  
  // Driver pickup scheduling (for scheduled parcels)
  scheduledPickupTime     DateTime? // Legacy field for compatibility
  
  // FK to zone configs
  domesticZoneId          String? // FK to parcel_domestic_zones
  internationalZoneId     String? // FK to parcel_international_zones
  domesticZone            ParcelDomesticZone?      @relation(fields: [domesticZoneId], references: [id], onDelete: SetNull)
  internationalZone       ParcelInternationalZone? @relation(fields: [internationalZoneId], references: [id], onDelete: SetNull)

  // Phase 3: Proof of delivery (Task 27) - relation
  proofPhotos   DeliveryProofPhoto[]
  pricingConfig ParcelPricingConfig? @relation(fields: [pricingConfigId], references: [id], onDelete: SetNull)

  customer   CustomerProfile    @relation(fields: [customerId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id])
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id]) // Step 46: For food deliveries
  foodOrder  FoodOrder? // Step 46: Link back from food order

  // Bangladesh Expansion: Optional BD service references (additive only)
  shopPartnerId    String? // For shop product delivery orders
  ticketOperatorId String? // For ticket-related deliveries  
  rentalOperatorId String? // For rental-related deliveries

  // Bangladesh Tax System (additive only, BD-only fields)
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  @@index([isDemo])
  @@index([serviceType]) // Step 46: Index for service type queries
  @@index([status]) // Step 46: Index for status queries
  @@index([driverId]) // Step 46: Index for driver queries
  @@index([restaurantId]) // Step 46: Index for restaurant queries
  @@index([dispatchSessionId])
  @@index([settlementStatus]) // Phase 2A: Fast settlement query
  @@index([isInternational]) // SafeGo Parcel: International query
  @@index([domesticZoneType]) // SafeGo Parcel: Domestic zone query
  @@index([codEnabled]) // SafeGo Parcel: COD query
  @@index([domesticZoneId]) // SafeGo Parcel: Domestic zone FK
  @@index([internationalZoneId]) // SafeGo Parcel: International zone FK
  @@map("deliveries")
}

model DriverComplaint {
  id           String             @id
  driverId     String?
  customerId   String?
  rideId       String?
  reason       String
  description  String?
  status       String             @default("open")
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime
  restaurantId String?
  type         String             @default("driver")
  customer     CustomerProfile?   @relation(fields: [customerId], references: [id])
  driver       DriverProfile?     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  restaurant   RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ride         Ride?              @relation(fields: [rideId], references: [id])

  @@map("driver_complaints")
}

model DriverProfile {
  id                           String         @id @default(uuid())
  userId                       String         @unique
  fatherName                   String?
  presentAddress               String?
  permanentAddress             String?
  nidNumber                    String?
  nidFrontImageUrl             String?
  nidBackImageUrl              String?
  nidImageUrl                  String?
  homeAddress                  String?
  governmentIdType             String?
  governmentIdLast4            String?
  driverLicenseNumber          String?
  driverLicenseImageUrl        String?
  driverLicenseExpiry          DateTime?
  ssnLast4                     String?
  ssnCardImageUrl              String?
  dateOfBirth                  DateTime?
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  verificationStatus           String         @default("pending")
  rejectionReason              String?
  isVerified                   Boolean        @default(false)
  createdAt                    DateTime       @default(now())
  updatedAt                    DateTime       @updatedAt
  isSuspended                  Boolean        @default(false)
  lastActive                   DateTime?
  suspendedAt                  DateTime?
  suspensionReason             String?
  district                     String?
  fullName                     String?
  nidEncrypted                 String?
  phoneNumber                  String?
  postOffice                   String?
  postalCode                   String?
  thana                        String?
  village                      String?
  backgroundCheckDate          DateTime?
  backgroundCheckStatus        String?        @default("pending")
  licenseStateIssued           String?
  ssnEncrypted                 String?
  usaCity                      String?
  usaFullLegalName             String?
  usaPhoneNumber               String?
  usaState                     String?
  usaStreet                    String?
  usaZipCode                   String?
  dmvLicenseImageUrl           String?
  dmvLicenseFrontUrl           String?
  dmvLicenseBackUrl            String?
  dmvLicenseExpiry             DateTime?
  dmvLicenseNumber             String?
  dmvLicenseNumber_encrypted   String?
  firstName                    String?
  lastName                     String?
  middleName                   String?
  profilePhotoUrl              String?
  tlcLicenseImageUrl           String?
  tlcLicenseFrontUrl           String?
  tlcLicenseBackUrl            String?
  tlcLicenseExpiry             DateTime?
  tlcLicenseNumber             String?
  // D7: Document Status Tracking
  profilePhotoStatus           DocumentStatus @default(PENDING)
  profilePhotoRejectionReason  String?
  // Profile Picture System (additive only)
  profilePhotoThumbnail        String?   // Thumbnail URL (128x128)
  profilePhotoLastUpdated      DateTime? // When photo was last updated
  driverLicenseStatus          DocumentStatus @default(PENDING)
  driverLicenseRejectionReason String?
  tlcLicenseDocStatus          DocumentStatus @default(PENDING)
  tlcLicenseRejectionReason    String?
  nidStatus                    DocumentStatus @default(PENDING)
  nidRejectionReason           String?
  taxClassification            String? // Individual, Sole proprietor, etc.
  w9Status                     String? // pending, submitted, approved
  w9SubmittedAt                DateTime?
  taxCertificationAccepted     Boolean? // W-9 certification checkbox
  taxCertificationDate         DateTime? // When driver certified tax info
  tripRevenueTotalYtd          Decimal?       @db.Decimal(12, 2) // 1099-K: Trip revenue
  nonTripIncomeTotalYtd        Decimal?       @db.Decimal(12, 2) // 1099-NEC: Bonuses, promos
  taxYear                      Int? // Current tax year being tracked

  // Phase 4 Part 2: Background Check consent and verification
  backgroundCheckConsent      Boolean   @default(false) // Driver authorized background check
  backgroundCheckConsentAt    DateTime? // When consent was given
  latestBackgroundCheckId     String? // Most recent background check ID
  faceVerificationRequired    Boolean   @default(false)
  faceVerificationCompleted   Boolean   @default(false)
  faceVerificationCompletedAt DateTime?

  // Relations
  backgroundChecks         DriverBackgroundCheck[]
  securityStatus           SecurityStatus          @default(normal)
  securityNotes            String?
  // Driver Preferences
  preferredNavigationApp   String?                 @default("google") // google, waze, apple, builtin
  autoAcceptRides          Boolean?                @default(false)
  acceptLongTrips          Boolean?                @default(true)
  acceptSharedRides        Boolean?                @default(true)
  shareLocationHistory     Boolean?                @default(true)
  shareUsageAnalytics      Boolean?                @default(false)
  personalizedExperience   Boolean?                @default(true)
  notifyRideRequests       Boolean?                @default(true)
  notifyPromotions         Boolean?                @default(true)
  notifyEarnings           Boolean?                @default(true)
  notifySupport            Boolean?                @default(true)
  notifyEmailWeekly        Boolean?                @default(true)
  notifyEmailTips          Boolean?                @default(false)
  preferredLanguage        String?                 @default("en") // en, bn, es, fr, ar
  themePreference          String?                 @default("system") // light, dark, system
  // D14: Extended Driver Preferences
  notifySms                Boolean?                @default(true) // SMS notifications enabled
  notifyPush               Boolean?                @default(true) // Push notifications enabled
  preferShortTrips         Boolean?                @default(false) // Short-trip mode preference
  avoidHighways            Boolean?                @default(false) // Avoid highways in navigation
  weeklyPayoutDay          String?                 @default("friday") // monday, tuesday, wednesday, thursday, friday
  instantPayoutEnabled     Boolean?                @default(false) // Instant payout enabled
  shareTripStatus          Boolean?                @default(true) // Share trip status with emergency contacts
  emergencyShortcutEnabled Boolean?                @default(true) // Emergency shortcut enabled
  regionPreference         String?                 @default("auto") // auto, us, bd, etc.
  // C-3: Real-time driver location for active trips
  currentLat               Float? // Current driver latitude
  currentLng               Float? // Current driver longitude
  lastLocationUpdate       DateTime? // When location was last updated

  // Step 4: Active Vehicle Management
  activeVehicleId String? // FK to the driver's active/primary vehicle for dispatch
  canGoOnline     Boolean @default(false) // Driver can only go online if vehicle is approved

  // Service Preferences - Controls which services the driver is willing to accept
  // JSON structure: { rideTypes: { safego_go: true, safego_x: true, ... }, foodEnabled: true, parcelEnabled: true }
  servicePreferences       Json? // Driver's service preference toggles
  servicePreferencesLocked Json? // Admin-locked service preferences (driver cannot change)

  deliveries             Delivery[]
  driverComplaints       DriverComplaint[]
  user                   User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverStats            DriverStats?
  driverWallet           DriverWallet?
  driverPoints           DriverPoints?
  foodOrders             FoodOrder[]
  rides                  Ride[]
  vehicleDocuments       VehicleDocument[]
  vehicles               Vehicle[] // D1: Changed from Vehicle? to Vehicle[] for 1:N support
  blockedRiders          BlockedRider[]
  supportTickets         SupportTicket[] // Phase 12: Driver support tickets
  financialAdjustments   FinancialAdjustment[] // Phase 12: Financial adjustments
  driverSupportTickets   DriverSupportTicket[]     @relation("DriverSupportTickets") // Phase 12 Extension
  driverLiveChatSessions DriverLiveChatSession[]   @relation("DriverLiveChatSessions") // Phase 12 Extension
  driverSupportCallbacks DriverSupportCallback[]   @relation("DriverSupportCallbacks") // Phase 12 Extension
  promotionProgress      DriverPromotionProgress[] // D5: Driver promotion progress
  promotionPayouts       DriverPromotionPayout[] // D5: Driver promotion payouts
  onboarding             DriverOnboarding? // D9: Driver onboarding progress
  incentiveCycles        DriverIncentiveCycle[] // D19: Driver incentive cycles
  achievements           DriverAchievement[] // D19: Driver achievements
  rewardLedger           DriverRewardLedger[] // D19: Driver reward ledger
  safetyIncidents        DriverSafetyIncident[] // D20: Driver safety incidents
  rideLiveLocations      RideLiveLocation[] // Phase A: Driver live locations during rides

  // Phase 1A: Real-Time Dispatch
  realtimeState            DriverRealtimeState? // Driver's real-time presence/location
  assignedDispatchSessions DispatchSession[]    @relation("AssignedDriver")
  dispatchOfferEvents      DispatchOfferEvent[] // Offers received by this driver

  // Phase 1B: Trip conversations and telemetry
  tripConversations  TripConversation[]
  telemetryLocations RideTelemetryLocation[]

  // Bangladesh Expansion: Shop delivery orders
  productOrders ProductOrder[] // Shop orders delivered by driver

  // Phase 4: Enterprise Admin relations
  complaints                Complaint[]
  enterpriseSafetyIncidents SafetyIncident[] @relation("SafetyIncidentDriver")

  @@map("driver_profiles")
}

// D9: Driver In-App Training & Onboarding System
model DriverOnboarding {
  id       String        @id @default(uuid())
  driverId String        @unique
  driver   DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Onboarding Steps (6 steps total)
  welcomeCompleted      Boolean   @default(false)
  welcomeCompletedAt    DateTime?
  earningsCompleted     Boolean   @default(false)
  earningsCompletedAt   DateTime?
  payoutsCompleted      Boolean   @default(false)
  payoutsCompletedAt    DateTime?
  safetyCompleted       Boolean   @default(false)
  safetyCompletedAt     DateTime?
  helpCenterCompleted   Boolean   @default(false)
  helpCenterCompletedAt DateTime?
  completionCompleted   Boolean   @default(false)
  completionCompletedAt DateTime?

  // Tutorial Progress
  tutorialsViewed String[] @default([]) // Array of tutorial IDs viewed

  // Overall Status
  isOnboardingComplete Boolean   @default(false)
  completionPercentage Int       @default(0) // 0-100
  startedAt            DateTime  @default(now())
  completedAt          DateTime?
  lastStepViewed       String? // Last step the driver was on

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@map("driver_onboarding")
}

// D20: Driver Safety Center & Incident Reporting System
enum SafetyIncidentCategory {
  RIDER_MISCONDUCT
  VEHICLE_DAMAGE
  PAYMENT_DISPUTE
  LOST_AND_FOUND
  HARASSMENT_THREAT
  UNSAFE_LOCATION
  OTHER
}

enum SafetyIncidentStatus {
  SUBMITTED
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

model DriverSafetyIncident {
  id       String        @id @default(uuid())
  driverId String
  driver   DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  category     SafetyIncidentCategory
  description  String                 @db.Text
  incidentDate DateTime
  status       SafetyIncidentStatus   @default(SUBMITTED)

  // Optional fields
  tripId          String? // Associated trip if applicable
  tripType        String? // RIDE, FOOD, PARCEL
  locationAddress String?
  locationLat     Float?
  locationLng     Float?
  attachments     String[] @default([]) // Array of image URLs

  // Resolution
  resolution String?   @db.Text
  resolvedAt DateTime?
  resolvedBy String? // Admin user ID who resolved

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("driver_safety_incidents")
}

model BlockedRider {
  id         String        @id @default(uuid())
  driverId   String
  customerId String
  reason     String?
  blockedAt  DateTime      @default(now())
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, customerId])
  @@index([driverId])
  @@map("blocked_riders")
}

model DriverStats {
  id         String  @id @default(uuid())
  driverId   String  @unique
  rating     Decimal @default(5.0) @db.Decimal(3, 2)
  totalTrips Int     @default(0)

  // D21: Trust Score System (0-100)
  trustScore           Int       @default(75) // Current trust score (0-100)
  trustScoreBreakdown  Json? // JSON breakdown of score components
  lastTrustScoreUpdate DateTime? // Last time score was recalculated

  // D21: Trust Score Input Metrics
  onTimeArrivalRate    Decimal @default(0.85) @db.Decimal(5, 4) // % of on-time arrivals
  riderRatingAvg       Decimal @default(5.0) @db.Decimal(3, 2) // Average rider rating
  cancellationRate     Decimal @default(0.05) @db.Decimal(5, 4) // % trip cancellations
  safetyViolationCount Int     @default(0) // Speeding, harsh braking flags
  supportTicketScore   Int     @default(100) // Based on dispute outcomes (0-100)

  // D21: Historical Tracking
  totalOnTimeArrivals  Int     @default(0)
  totalLateArrivals    Int     @default(0)
  totalCancellations   Int     @default(0)
  totalRatingsReceived Int     @default(0)
  ratingsSum           Decimal @default(0) @db.Decimal(10, 2) // Sum of all ratings for avg calculation

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  driver    DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_stats")
}

model DriverWallet {
  id              String        @id @default(uuid())
  driverId        String        @unique
  balance         Decimal       @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal       @default(0) @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  driver          DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_wallets")
}

model FoodOrder {
  id                      String                 @id
  customerId              String
  restaurantId            String
  driverId                String?
  deliveryAddress         String
  deliveryLat             Float?
  deliveryLng             Float?
  pickupAddress           String? // Restaurant pickup location
  pickupLat               Float?
  pickupLng               Float?
  items                   String? // JSON string of ordered items (nullable for backward compatibility)
  itemsCount              Int? // Total number of items in order
  serviceFare             Decimal                @db.Decimal(10, 2)
  safegoCommission        Decimal                @db.Decimal(10, 2)
  restaurantPayout        Decimal                @db.Decimal(10, 2)
  driverPayout            Decimal                @db.Decimal(10, 2)
  deliveryPayout          Decimal?               @db.Decimal(10, 2) // Alias for driverPayout for compatibility
  subtotal                Decimal?               @db.Decimal(10, 2) // Items subtotal before fees/taxes
  deliveryFee             Decimal?               @db.Decimal(10, 2) // Delivery fee component
  tipAmount               Decimal?               @db.Decimal(10, 2) // Customer tip for driver
  deliveryInstructions    String? // Special delivery instructions
  paymentMethod           String
  status                  String
  customerRating          Int?
  customerFeedback        String?
  restaurantRating        Int?
  restaurantFeedback      String?
  taxBreakdown            Json?
  totalTaxAmount          Decimal?               @db.Decimal(10, 2)
  orderCode               String? // Unique searchable order code (e.g., "ORD-12345")
  whoCancelled            String? // "customer" | "restaurant" | "driver" | "admin"
  cancellationReason      String?                @db.Text
  cancelledAt             DateTime?
  acceptedAt              DateTime? // When restaurant accepted order
  preparingAt             DateTime? // When restaurant started preparing
  readyAt                 DateTime? // When order ready for pickup
  pickedUpAt              DateTime? // When driver picked up
  isDemo                  Boolean                @default(false)
  // Step 45: Restaurant Order Management fields (additive only)
  restaurantNotes         String?                @db.Text // Notes from restaurant (e.g., "item substituted")
  restaurantPrepMinutes   Int? // Estimated preparation time in minutes
  customerStatusMessage   String? // Customer-visible status message
  restaurantSeenAt        DateTime? // When restaurant first viewed order
  // Step 46: Driver Delivery Flow fields (additive only)
  deliveryId              String?                @unique // Link to deliveries record
  driverAssignmentStatus  DriverAssignmentStatus @default(none)
  driverEtaMinutes        Int? // Estimated minutes until driver arrives
  driverLastLocationLat   Float? // Driver's last known latitude
  driverLastLocationLng   Float? // Driver's last known longitude
  driverLocationUpdatedAt DateTime? // When driver location was last updated
  deliveryNotesForDriver  String?                @db.Text // Instructions for driver from restaurant/customer
  // Phase 7: Promotion & Coupon tracking (additive only)
  appliedPromotionId      String?
  appliedCouponCode       String?
  discountAmount          Decimal?               @db.Decimal(10, 2)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount      Int?                   @default(0)
  lastSupportStatus       String? // Latest support ticket status
  // Refund tracking
  refundStatus            RefundStatus           @default(none)

  // Phase 1B: Real-Time Dispatch for food orders
  dispatchSessionId      String?   @unique // FK to dispatch_sessions
  statusHistory          Json?     @default("[]") // Array of {status, timestamp, actor}
  etaToRestaurantSeconds Int? // ETA from driver to restaurant
  etaToCustomerSeconds   Int? // ETA from restaurant to customer
  etaLastUpdatedAt       DateTime? // When ETA was last recalculated
  refundAmount           Decimal?  @db.Decimal(10, 2)
  refundedAt             DateTime?
  refundReason           String?   @db.Text

  // Phase 2A: Settlement & Financial tracking (additive only)
  settlementStatus       SettlementStatus     @default(pending) // Settlement lifecycle status
  settledAt              DateTime? // When wallet transactions were posted
  tipPaymentMethod       String? // cash | online (how tip was paid)
  tipSettledAt           DateTime? // When tip was credited to driver
  cancellationFeeApplied Decimal?             @db.Decimal(10, 2) // Actual fee charged
  cancellationFeeRuleId  String? // FK to cancellation_fee_rules
  cancellationFeeRule    CancellationFeeRule? @relation("FoodOrderCancellationFeeRule", fields: [cancellationFeeRuleId], references: [id], onDelete: SetNull)
  driverIncentiveAwards  IncentiveAward[]     @relation("FoodOrderIncentiveAwards") // Phase 2A: Proper relation to driver incentive awards

  // Phase 2B: Online payment integration (additive only)
  paymentId     String? // FK to payments table (for online payments)
  paymentStatus String? // mirrors payments.status for fast queries (paid, failed, pending)

  // Phase 3: Kitchen system (Task 25) - additive only
  prepTimeMinutes Int? // Calculated prep time for this order
  kitchenNotes    String? @db.Text // Internal kitchen notes

  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  deliveredAt         DateTime?
  completedAt         DateTime?
  customer            CustomerProfile      @relation(fields: [customerId], references: [id])
  driver              DriverProfile?       @relation(fields: [driverId], references: [id])
  restaurant          RestaurantProfile    @relation(fields: [restaurantId], references: [id])
  appliedPromotion    Promotion?           @relation(fields: [appliedPromotionId], references: [id])
  delivery            Delivery?            @relation(fields: [deliveryId], references: [id]) // Step 46: Link to delivery record
  review              Review? // Phase 8: One review per order
  earningsTransaction EarningsTransaction? // R6: Earnings tracking
  kitchenTicket       KitchenTicket? // Phase 3: Kitchen ticket for this order

  // Phase 6B: Safety & Security relations
  sosAlerts SOSAlert[] @relation("FoodOrderSOSAlerts")

  // Bangladesh Tax System (additive only, BD-only fields)
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  @@index([restaurantId, status])
  @@index([restaurantId, createdAt])
  @@index([orderCode])
  @@index([status])
  @@index([isDemo])
  @@index([appliedPromotionId])
  @@index([driverAssignmentStatus]) // Step 46: Index for driver assignment queries
  @@index([driverId]) // Step 46: Index for driver queries
  @@index([settlementStatus]) // Phase 2A: Fast settlement query
  @@map("food_orders")
}

// Customer favorite restaurants for quick access
model FoodRestaurantFavorite {
  id                String            @id @default(uuid())
  customerProfileId String
  restaurantId      String
  createdAt         DateTime          @default(now())
  customer          CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
  restaurant        RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([customerProfileId, restaurantId])
  @@index([customerProfileId])
  @@index([restaurantId])
  @@map("food_restaurant_favorites")
}

// Customer saved delivery addresses with labels
model CustomerAddress {
  id                String          @id @default(uuid())
  customerProfileId String
  label             AddressLabel    @default(home)
  customLabel       String? // For "other" type, user-defined label
  address           String
  lat               Float
  lng               Float
  placeId           String?
  apartment         String? // Apt/Suite/Floor number
  instructions      String? // Delivery instructions for this address
  isDefault         Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  customer          CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)

  @@index([customerProfileId])
  @@index([isDefault])
  @@map("customer_addresses")
}

// Customer blocked restaurants (customer chose to block)
model CustomerBlockedRestaurant {
  id                   String            @id @default(uuid())
  customerProfileId    String
  restaurantId         String
  blockReason          String?           @db.Text
  blockedAt            DateTime          @default(now())
  unblockRequestedAt   DateTime?
  unblockRequestReason String?           @db.Text
  customer             CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
  restaurant           RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([customerProfileId, restaurantId])
  @@index([customerProfileId])
  @@index([restaurantId])
  @@map("customer_blocked_restaurants")
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model RestaurantProfile {
  id                       String                      @id @default(uuid())
  userId                   String                      @unique
  restaurantName           String
  address                  String
  phone                    String? // Restaurant contact phone number
  cuisineType              String?
  description              String?
  cityCode                 String?
  countryCode              String?
  averageRating            Float?                      @default(0)
  totalRatings             Int?                        @default(0)
  verificationStatus       String                      @default("pending")
  rejectionReason          String?
  isVerified               Boolean                     @default(false)
  isActive                 Boolean                     @default(true)
  isBusy                   Boolean                     @default(false) // C-1: Restaurant busy mode
  isDemo                   Boolean                     @default(false)
  // Country-specific KYC fields (BD - Bangladesh)
  fatherName               String? // BD: Owner's father name
  presentAddress           String? // BD: Current address
  permanentAddress         String? // BD: Permanent address
  nidNumber                String? // BD: National ID number
  nidFrontImageUrl         String? // BD: NID front image
  nidBackImageUrl          String? // BD: NID back image
  // Country-specific KYC fields (US - United States)
  homeAddress              String? // US: Owner's home address
  governmentIdType         String? // US: ID type (SSN, Driver License, etc.)
  governmentIdLast4        String? // US: Last 4 digits of government ID
  // Common KYC fields
  dateOfBirth              DateTime? // Owner's date of birth
  emergencyContactName     String? // Emergency contact full name
  emergencyContactPhone    String? // Emergency contact phone
  // Business details
  businessLicenseNumber    String?
  businessLicenseUrl       String?
  healthCertificateUrl     String?
  ownerRole                String? // OWNER | STAFF
  // Phase 6: Staff Permissions (only applicable when ownerRole = STAFF)
  canEditCategories        Boolean                     @default(false)
  canEditItems             Boolean                     @default(false)
  canToggleAvailability    Boolean                     @default(false)
  canUseBulkTools          Boolean                     @default(false)
  canViewAnalytics         Boolean                     @default(false)
  canViewPayouts           Boolean                     @default(false)
  canManageOrders          Boolean                     @default(false)
  canReplySupport          Boolean                     @default(false) // Phase 12: Can view and reply to support tickets
  canManagePromotions      Boolean                     @default(false) // R4: Can create/edit promotions and coupons
  staffActive              Boolean                     @default(true)
  managedByOwnerId         String? // Restaurant ID of the OWNER who manages this STAFF
  lastLoginAt              DateTime?
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt
  isSuspended              Boolean                     @default(false)
  suspendedAt              DateTime?
  suspensionReason         String?
  securityStatus           SecurityStatus              @default(normal)
  securityNotes            String?
  driverComplaints         DriverComplaint[]
  foodOrders               FoodOrder[]
  deliveries               Delivery[] // Step 46: Food deliveries linked to restaurant
  menuCategories           MenuCategory[]
  menuItems                MenuItem[]
  promotions               Promotion[] // Phase 7: Restaurant promotions
  coupons                  Coupon[] // Phase 7: Restaurant coupons
  reviews                  Review[] // Phase 8: Customer reviews
  branding                 RestaurantBranding? // Phase 9: Restaurant branding
  media                    RestaurantMedia[] // Phase 9: Restaurant media gallery
  hours                    RestaurantHours[] // Phase 10: Operating hours
  operationalSettings      OperationalSettings? // Phase 10: Delivery & pickup settings
  deliveryZones            DeliveryZone[] // Phase 10: Delivery zones
  surgeSettings            SurgeSettings? // Phase 10: Surge pricing settings
  supportTickets           SupportTicket[] // Phase 12: Restaurant support tickets
  financialAdjustments     FinancialAdjustment[] // Phase 12: Financial adjustments
  restaurantSupportTickets RestaurantSupportTicket[]   @relation("RestaurantSupportTickets") // Phase 12.5: Restaurant support center tickets
  liveChatSessions         LiveChatSession[]           @relation("LiveChatSessions") // Phase 12.5: Live chat sessions
  supportCallbacks         SupportCallback[]           @relation("SupportCallbacks") // Phase 12.5: Support callbacks
  commissionRules          CommissionRule[] // R6: Commission rules
  earningsTransactions     EarningsTransaction[] // R6: Earnings transactions
  earningsSummaries        EarningsSummary[] // R6: Earnings summaries
  favoritedBy              FoodRestaurantFavorite[] // Customers who favorited this restaurant
  blockedByCustomers       CustomerBlockedRestaurant[] // Customers who blocked this restaurant
  upsellGroups             MenuItemUpsellGroup[] // Step 44: Upsell groups for menu item recommendations
  user                     User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantWallet         RestaurantWallet?

  // Phase 1B: Trip conversations for food orders
  tripConversations TripConversation[]

  // Phase 3: Kitchen system (Task 25) - additive only
  prepTimeDefaultMinutes Int?            @default(15) // Default prep time in minutes
  isAcceptingOrders      Boolean         @default(true) // Can receive new orders
  kitchenStatus          KitchenStatus   @default(open) // open, busy, closed
  kitchenTickets         KitchenTicket[] // Kitchen tickets for orders

  // Profile Picture System (additive only)
  profilePhotoUrl         String?   // Main profile photo URL (512x512)
  profilePhotoThumbnail   String?   // Thumbnail URL (128x128)
  profilePhotoLastUpdated DateTime? // When photo was last updated

  @@index([cityCode])
  @@index([countryCode])
  @@index([isActive])
  @@index([isDemo])
  @@index([verificationStatus])
  @@index([kitchenStatus])
  @@map("restaurant_profiles")
}

model RestaurantWallet {
  id              String            @id @default(uuid())
  restaurantId    String            @unique
  balance         Decimal           @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  restaurant      RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_wallets")
}

// Menu system for food ordering
model MenuCategory {
  id           String            @id @default(uuid())
  restaurantId String
  name         String
  description  String?
  displayOrder Int               @default(0)
  isActive     Boolean           @default(true)
  isDemo       Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  restaurant   RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_categories")
}

// Phase 12 - Relational Category System
model Category {
  id              String           @id @default(uuid())
  name            String           @unique
  slug            String           @unique
  type            String           @default("FOOD") // FOOD, DRINK, DESSERT, OTHER
  isActive        Boolean          @default(true)
  displayOrder    Int              @default(0)
  isDemo          Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  subCategories   SubCategory[]
  menuItems       MenuItem[]       @relation("MenuItemMainCategory")
  commissionRules CommissionRule[] // R6: Category-level commission rules

  @@index([slug])
  @@index([isActive])
  @@index([type])
  @@map("categories")
}

model SubCategory {
  id            String             @id @default(uuid())
  categoryId    String
  name          String
  slug          String
  isActive      Boolean            @default(true)
  displayOrder  Int                @default(0)
  isDemo        Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  category      Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menuItemLinks MenuItemCategory[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@map("sub_categories")
}

model MenuItemCategory {
  id            String      @id @default(uuid())
  menuItemId    String
  subCategoryId String
  createdAt     DateTime    @default(now())
  menuItem      MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, subCategoryId])
  @@index([menuItemId])
  @@index([subCategoryId])
  @@map("menu_item_categories")
}

model MenuItem {
  id                     String               @id @default(uuid())
  restaurantId           String
  categoryId             String? // Legacy - kept for backwards compatibility
  mainCategoryId         String? // Phase 12 - new relational main category
  primaryCategory        String? // Legacy simple category - kept for migration
  subCategories          String[]             @default([]) // Legacy simple category - kept for migration
  name                   String
  shortDescription       String?
  longDescription        String?
  basePrice              Decimal              @default(0) @db.Decimal(10, 2)
  currency               String               @default("USD")
  preparationTimeMinutes Int?
  availabilityStatus     String               @default("available")
  isFeatured             Boolean              @default(false)
  isVegetarian           Boolean              @default(false)
  isVegan                Boolean              @default(false)
  isHalal                Boolean              @default(false)
  isSpicy                Boolean              @default(false)
  dietaryTags            String[]
  itemImageUrl           String?
  serviceHours           Json?
  totalOrders            Int                  @default(0)
  totalRevenue           Decimal              @default(0) @db.Decimal(10, 2)
  averageRating          Float?               @default(0)
  calories               Int?
  isArchived             Boolean              @default(false)
  displayOrder           Int                  @default(0)
  policyStatus           String               @default("ok")
  policyNote             String?
  isDemo                 Boolean              @default(false)
  stockTrackingEnabled   Boolean              @default(false)
  stockQuantity          Int? // null means unlimited stock
  lowStockThreshold      Int?                 @default(5) // warn when stock drops below this
  // Step 44: Variants, Add-ons, and Upsell support (additive only)
  hasVariants            Boolean              @default(false) // True if item has variant options
  hasAddOns              Boolean              @default(false) // True if item has add-on options
  defaultVariantOptionId String? // Default selected variant option ID
  upsellGroupId          String? // Reference to upsell group for recommendations
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  restaurant             RestaurantProfile    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category               MenuCategory?        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  mainCategory           Category?            @relation("MenuItemMainCategory", fields: [mainCategoryId], references: [id], onDelete: SetNull)
  subCategoryLinks       MenuItemCategory[]
  optionGroups           MenuOptionGroup[]
  upsellGroup            MenuItemUpsellGroup? @relation(fields: [upsellGroupId], references: [id], onDelete: SetNull)
  upsellLinksFrom        MenuItemUpsellLink[] @relation("UpsellFromItem")
  upsellLinksTo          MenuItemUpsellLink[] @relation("UpsellToItem")

  @@index([restaurantId])
  @@index([categoryId])
  @@index([mainCategoryId])
  @@index([primaryCategory])
  @@index([availabilityStatus])
  @@index([isFeatured])
  @@index([isArchived])
  @@index([isDemo])
  @@index([upsellGroupId])
  @@map("menu_items")
}

model MenuOptionGroup {
  id           String       @id @default(uuid())
  restaurantId String
  itemId       String
  name         String
  type         String
  isRequired   Boolean      @default(false)
  minSelect    Int?
  maxSelect    Int?
  isDemo       Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  item         MenuItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  options      MenuOption[]

  @@index([itemId])
  @@index([restaurantId])
  @@index([isDemo])
  @@map("menu_option_groups")
}

model MenuOption {
  id            String          @id @default(uuid())
  optionGroupId String
  label         String
  priceDelta    Decimal         @default(0) @db.Decimal(10, 2)
  isDefault     Boolean         @default(false)
  isActive      Boolean         @default(true)
  isDemo        Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  optionGroup   MenuOptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@index([optionGroupId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_options")
}

// Step 44: Upsell Groups for menu item recommendations
model MenuItemUpsellGroup {
  id           String               @id @default(uuid())
  restaurantId String
  name         String // e.g., "Popular add-ons", "Recommended sides"
  description  String?
  isActive     Boolean              @default(true)
  isDemo       Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  restaurant   RestaurantProfile    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[] // Items that use this upsell group
  upsellLinks  MenuItemUpsellLink[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_item_upsell_groups")
}

// Step 44: Upsell Links - many-to-many relationship between items for recommendations
model MenuItemUpsellLink {
  id             String              @id @default(uuid())
  upsellGroupId  String
  fromMenuItemId String // The item being viewed
  toMenuItemId   String // The recommended item to upsell
  priority       Int                 @default(0) // Higher priority = shown first
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  upsellGroup    MenuItemUpsellGroup @relation(fields: [upsellGroupId], references: [id], onDelete: Cascade)
  fromMenuItem   MenuItem            @relation("UpsellFromItem", fields: [fromMenuItemId], references: [id], onDelete: Cascade)
  toMenuItem     MenuItem            @relation("UpsellToItem", fields: [toMenuItemId], references: [id], onDelete: Cascade)

  @@unique([upsellGroupId, fromMenuItemId, toMenuItemId])
  @@index([upsellGroupId])
  @@index([fromMenuItemId])
  @@index([toMenuItemId])
  @@index([priority])
  @@map("menu_item_upsell_links")
}

model Ride {
  id                  String   @id @default(uuid())
  customerId          String
  driverId            String?
  countryCode         String?
  cityCode            String?
  pickupAddress       String
  pickupLat           Float?
  pickupLng           Float?
  pickupPlaceId       String? // Google Place ID for pickup (additive)
  dropoffAddress      String
  dropoffLat          Float?
  dropoffLng          Float?
  dropoffPlaceId      String? // Google Place ID for dropoff (additive)
  // Route metrics from Google Directions API (additive fields)
  distanceMiles       Float? // Calculated distance in miles
  durationMinutes     Int? // Estimated duration in minutes
  routePolyline       String? // Encoded polyline for route display
  rawDistanceMeters   Int? // Raw distance from provider in meters
  rawDurationSeconds  Int? // Raw duration from provider in seconds
  routeProviderSource String? // e.g., "google_maps"
  serviceFare         Decimal  @db.Decimal(10, 2)
  safegoCommission    Decimal  @db.Decimal(10, 2)
  driverPayout        Decimal  @db.Decimal(10, 2)
  paymentMethod       String
  status              String
  customerRating      Int?
  customerFeedback    String?
  driverRating        Int?
  driverFeedback      String?
  taxBreakdown        Json?
  totalTaxAmount      Decimal? @db.Decimal(10, 2)
  isDemo              Boolean  @default(false)
  // Phase 12: Support ticket tracking (additive only)
  supportTicketCount  Int?     @default(0)
  lastSupportStatus   String? // Latest support ticket status

  // Phase A: Enhanced ride lifecycle fields
  currentLeg         String? // to_pickup, to_dropoff, completed
  trafficEtaSeconds  Int? // Live ETA with traffic
  surgeMultiplier    Decimal?  @db.Decimal(4, 2) // Surge pricing multiplier
  tollAmount         Decimal?  @db.Decimal(10, 2) // Toll charges
  discountAmount     Decimal?  @db.Decimal(10, 2) // Applied discount
  cancelledAt        DateTime? // When ride was cancelled
  whoCancelled       String? // customer, driver, system
  cancellationReason String? // Reason for cancellation
  cancellationFee    Decimal?  @db.Decimal(10, 2) // Cancel fee charged
  selectedRouteType  String? // fastest, shortest, highway
  acceptedAt         DateTime? // When driver accepted
  arrivedAt          DateTime? // When driver arrived at pickup
  tripStartedAt      DateTime? // When trip started (customer in car)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  completedAt      DateTime?
  driverComplaints DriverComplaint[]
  customer         CustomerProfile   @relation(fields: [customerId], references: [id])
  driver           DriverProfile?    @relation(fields: [driverId], references: [id])

  // Phase A: Ride lifecycle relations
  statusEvents  RideStatusEvent[]
  liveLocations RideLiveLocation[]
  chatMessages  RideChatMessage[]
  receipt       RideReceipt?
  stops         RideStop[]

  // Phase 1A: Real-Time Dispatch
  dispatchSessionId String?          @unique // FK to dispatch_sessions
  dispatchStatus    String? // Mirror of dispatch_sessions.status for fast queries
  requestedAt       DateTime? // When ride was initially requested
  dispatchSession   DispatchSession? @relation("RideDispatch", fields: [dispatchSessionId], references: [id])

  // Phase 1B: Status history and ETA tracking
  statusHistory       Json?     @default("[]") // Array of {status, timestamp, actor}
  etaToPickupSeconds  Int? // ETA from driver to pickup in seconds
  etaToDropoffSeconds Int? // ETA from pickup to dropoff in seconds
  etaLastUpdatedAt    DateTime? // When ETA was last recalculated

  // Phase 1B: Fare recalculation for actual distance/time
  actualDistanceMeters  Int? // Actual distance traveled (from telemetry)
  actualDurationSeconds Int? // Actual trip duration (from telemetry)
  finalFareAmount       Decimal? @db.Decimal(10, 2) // Final calculated fare
  fareBreakdown         Json? // Detailed fare breakdown JSON
  fareRecalculated      Boolean  @default(false)
  fareAdjustmentReason  String? // Reason for fare adjustment

  // Phase 1B: Telemetry relation
  telemetryLocations RideTelemetryLocation[] @relation("RideTelemetry")

  // Phase 2A: Settlement & Financial tracking (additive only)
  settlementStatus       SettlementStatus     @default(pending) // Settlement lifecycle status
  settledAt              DateTime? // When wallet transactions were posted
  tipAmount              Decimal?             @db.Decimal(10, 2) // Customer tip for driver
  tipPaymentMethod       String? // cash | online (how tip was paid)
  tipSettledAt           DateTime? // When tip was credited to driver
  cancellationFeeApplied Decimal?             @db.Decimal(10, 2) // Actual fee charged
  cancellationFeeRuleId  String? // FK to cancellation_fee_rules
  cancellationFeeRule    CancellationFeeRule? @relation("RideCancellationFeeRule", fields: [cancellationFeeRuleId], references: [id], onDelete: SetNull)
  incentiveAwards        IncentiveAward[]     @relation("RideIncentiveAwards") // Phase 2A: Proper relation to incentive awards

  // Phase 2B: Online payment integration (additive only)
  paymentId     String? // FK to payments table (for online payments)
  paymentStatus String? // mirrors payments.status for fast queries (paid, failed, pending)

  // Phase 6B: Safety & Security relations
  sosAlerts       SOSAlert[]              @relation("RideSOSAlerts")
  routeMonitoring RouteMonitoringSession? @relation("RideRouteMonitoring")

  // Phase 4: Enterprise Admin relations
  complaints      Complaint[]
  safetyIncidents SafetyIncident[]

  // BD Ride Pricing Engine fields (additive only, non-breaking)
  vehicleType      String?  // bike, cng, car_economy, car_premium
  cityZone         String?  // core_city, suburb, remote
  distanceKm       Float?   // Calculated distance in km
  baseFareAmount   Decimal? @db.Decimal(10, 2) // Base fare component
  distanceFareAmount Decimal? @db.Decimal(10, 2) // Distance-based fare
  timeFareAmount   Decimal? @db.Decimal(10, 2) // Time-based fare
  bookingFee       Decimal? @db.Decimal(10, 2) // Platform booking fee
  nightMultiplier  Decimal? @db.Decimal(4, 2) @default(1.0) // Night surcharge multiplier
  peakMultiplier   Decimal? @db.Decimal(4, 2) @default(1.0) // Peak hour multiplier
  fareCurrency     String?  // BDT, USD
  speedOption      String?  // normal, priority
  driverEarnings   Decimal? @db.Decimal(10, 2) // Net driver earnings
  pricingRuleId    String?  // FK to ride_pricing_rules
  pricingRule      RidePricingRule? @relation(fields: [pricingRuleId], references: [id], onDelete: SetNull)

  // Bangladesh Tax System (additive only, BD-only fields)
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  @@index([countryCode])
  @@index([cityCode])
  @@index([isDemo])
  @@index([status])
  @@index([dispatchStatus])
  @@index([settlementStatus]) // Phase 2A: Fast settlement query
  @@map("rides")
}

// Phase A: Track ride status transitions for audit trail
model RideStatusEvent {
  id            String   @id @default(uuid())
  rideId        String
  fromStatus    String?
  toStatus      String
  changedBy     String // user_id who made the change
  changedByRole String // customer, driver, admin, system
  reason        String?
  metadata      Json? // Additional event data
  createdAt     DateTime @default(now())

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([createdAt])
  @@map("ride_status_events")
}

// Phase A: Store driver live GPS locations during active ride
model RideLiveLocation {
  id        String   @id @default(uuid())
  rideId    String
  driverId  String
  lat       Float
  lng       Float
  heading   Float? // Direction in degrees
  speed     Float? // Speed in km/h
  accuracy  Float? // GPS accuracy in meters
  createdAt DateTime @default(now())

  ride   Ride          @relation(fields: [rideId], references: [id], onDelete: Cascade)
  driver DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([driverId])
  @@index([createdAt])
  @@map("ride_live_locations")
}

// Phase A: Store in-app chat messages between customer and driver
model RideChatMessage {
  id          String   @id @default(uuid())
  rideId      String
  senderId    String // user_id of sender
  senderRole  String // customer or driver
  message     String
  messageType String   @default("text") // text, quick_message, location
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([senderId])
  @@index([createdAt])
  @@map("ride_chat_messages")
}

// Phase A: Detailed fare receipt for completed rides
model RideReceipt {
  id              String   @id @default(uuid())
  rideId          String   @unique
  baseFare        Decimal  @db.Decimal(10, 2)
  distanceFare    Decimal  @db.Decimal(10, 2)
  timeFare        Decimal  @db.Decimal(10, 2)
  surgeFare       Decimal? @db.Decimal(10, 2) // Surge pricing extra charge
  tollsFare       Decimal? @db.Decimal(10, 2)
  tipAmount       Decimal? @db.Decimal(10, 2)
  discountAmount  Decimal? @db.Decimal(10, 2)
  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal? @db.Decimal(10, 2)
  totalFare       Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  distanceMiles   Float?
  durationMinutes Int?
  fareBreakdown   Json? // Detailed breakdown as JSON
  createdAt       DateTime @default(now())

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@map("ride_receipts")
}

// Phase A: Support for adding stops during ride
model RideStop {
  id         String    @id @default(uuid())
  rideId     String
  address    String
  lat        Float?
  lng        Float?
  placeId    String?
  stopOrder  Int // Order of stop (1, 2, 3...)
  status     String    @default("pending") // pending, arrived, completed, skipped
  arrivedAt  DateTime?
  departedAt DateTime?
  createdAt  DateTime  @default(now())

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([stopOrder])
  @@map("ride_stops")
}

// BD Ride Pricing Engine: Configurable pricing rules by country/city/vehicle
model RidePricingRule {
  id              String   @id @default(uuid())
  countryCode     String   // BD, US
  cityCode        String   // DHK, CTG, KHL, SYL, NYC, etc.
  vehicleType     String   // bike, cng, car_economy, car_premium
  
  // Core pricing components
  baseFare        Decimal  @db.Decimal(10, 2) // Minimum starting charge
  perKmRate       Decimal  @db.Decimal(10, 2) // Rate per kilometer
  perMinRate      Decimal  @db.Decimal(10, 2) // Rate per minute
  minimumFare     Decimal  @db.Decimal(10, 2) // Absolute minimum fare
  bookingFee      Decimal  @db.Decimal(10, 2) // Platform booking fee
  
  // Time-based multipliers
  nightStartHour  Int      @default(22) // Night surcharge start (e.g., 22 = 10PM)
  nightEndHour    Int      @default(6)  // Night surcharge end (e.g., 6 = 6AM)
  nightMultiplier Decimal  @db.Decimal(4, 2) @default(1.0) // Night pricing multiplier
  peakMultiplier  Decimal  @db.Decimal(4, 2) @default(1.0) // Peak hour multiplier
  peakTimeRanges  Json?    // JSON array of peak time windows [{start: 7, end: 9}, {start: 17, end: 20}]
  
  // Commission settings
  commissionRate  Decimal  @db.Decimal(5, 2) @default(20.0) // SafeGo commission percentage
  
  // Currency and payment
  currency        String   @default("BDT") // BDT, USD
  allowCash       Boolean  @default(true)  // Allow cash payment (false for US)
  allowOnline     Boolean  @default(true)  // Allow online payment
  
  // Status and metadata
  isActive        Boolean  @default(true)
  displayName     String?  // User-friendly name (e.g., "Dhaka Bike")
  description     String?  // Description for admin panel
  version         Int      @default(1)     // Version tracking for updates
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Rides using this pricing rule
  rides           Ride[]

  @@unique([countryCode, cityCode, vehicleType])
  @@index([countryCode])
  @@index([cityCode])
  @@index([vehicleType])
  @@index([isActive])
  @@map("ride_pricing_rules")
}

model User {
  id                        String                       @id @default(uuid())
  email                     String                       @unique
  passwordHash              String
  role                      String
  countryCode               String
  isBlocked                 Boolean                      @default(false)
  isDemo                    Boolean                      @default(false)
  isAccountLocked           Boolean                      @default(false)
  accountLockedAt           DateTime?
  failedLoginAttempts       Int                          @default(0)
  lastFailedLoginAt         DateTime?
  temporaryLockUntil        DateTime?
  unlockOtpHash             String?
  unlockOtpExpiry           DateTime?
  createdAt                 DateTime                     @default(now())
  updatedAt                 DateTime                     @updatedAt
  adminProfile              AdminProfile?
  customerProfile           CustomerProfile?
  driverProfile             DriverProfile?
  notifications             Notification[]
  restaurantProfile         RestaurantProfile?
  documents                 Document[]
  approvalRequestsCreated   ApprovalRequest[]            @relation("ApprovalRequester")
  approvalRequestsApproved  ApprovalRequest[]            @relation("ApprovalApprover")
  adminSessions             AdminSession[]               @relation("AdminSessions")
  createdAdjustments        FinancialAdjustment[]        @relation("CreatedAdjustments")
  approvedAdjustments       FinancialAdjustment[]        @relation("ApprovedAdjustments")
  assignedDriverTickets     DriverSupportTicket[]        @relation("AssignedDriverTickets")
  driverTicketStatusChanges DriverSupportStatusHistory[] @relation("DriverTicketStatusChanges")

  // Phase 2B: Device tokens and notification logs
  devices          UserDevice[]
  notificationLogs NotificationLog[]

  // Phase 6B: Security relations
  sosAlerts       SOSAlert[]       @relation("UserSOSAlerts")
  deviceBindings  DeviceBinding[]  @relation("UserDeviceBindings")
  privacyRequests PrivacyRequest[] @relation("UserPrivacyRequests")
  consents        UserConsent[]    @relation("UserConsents")

  // Bangladesh Expansion: BD-only roles
  shopPartner    ShopPartner?
  ticketOperator TicketOperator?

  // SafePilot: AI Admin Assistant
  safePilotInteractions SafePilotInteraction[] @relation("SafePilotInteractions")
  safePilotConfigUpdates SafePilotConfig[] @relation("SafePilotConfigUpdates")

  @@index([isDemo])
  @@index([isAccountLocked])
  @@map("users")
}

enum DmvInspectionStatus {
  VALID
  EXPIRED
  MISSING

  @@map("dmv_inspection_status")
}

model Document {
  id           String    @id @default(uuid())
  userId       String
  documentType String
  fileUrl      String
  fileName     String?
  fileSize     Int?
  mimeType     String?
  category     String
  status       String    @default("pending_review")
  expiresAt    DateTime?
  uploadedAt   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
  @@index([category])
  @@index([status])
  @@map("documents")
}

model VehicleDocument {
  id              String         @id
  driverId        String
  documentType    String
  uploadedAt      DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  description     String?
  expiresAt       DateTime?
  fileUrl         String
  vehicleId       String?
  status          DocumentStatus @default(PENDING) // D7: Document status tracking
  rejectionReason String? // D7: Reason for rejection
  reviewedAt      DateTime? // D7: When admin reviewed
  reviewedBy      String? // D7: Admin who reviewed
  driver          DriverProfile  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([vehicleId])
  @@index([status])
  @@map("vehicle_documents")
}

model Vehicle {
  id                              String               @id @default(uuid())
  driverId                        String // D1: Changed from @unique to allow 1:N (multi-vehicle support)
  vehicleType                     String
  vehicleModel                    String
  vehiclePlate                    String
  isPrimary                       Boolean              @default(false) // D1: Mark primary vehicle
  isActive                        Boolean              @default(true) // D1: Soft delete support
  isOnline                        Boolean              @default(false)
  totalEarnings                   Decimal              @default(0) @db.Decimal(10, 2)
  createdAt                       DateTime             @default(now())
  updatedAt                       DateTime
  notes                           String?
  make                            String?
  year                            Int?
  color                           String?
  licensePlate                    String?
  insurancePolicyNumber           String? // D1: Insurance policy number
  registrationDocumentUrl         String?
  registrationExpiry              DateTime?
  registrationStatus              DocumentStatus       @default(PENDING)
  registrationLastUpdated         DateTime?
  insuranceDocumentUrl            String?
  insuranceExpiry                 DateTime?
  insuranceStatus                 DocumentStatus       @default(PENDING)
  insuranceLastUpdated            DateTime?
  dmvInspectionType               String?
  dmvInspectionDate               DateTime?
  dmvInspectionExpiry             DateTime?
  dmvInspectionImageUrl           String?
  dmvInspectionFrontImageUrl      String?
  dmvInspectionBackImageUrl       String?
  dmvInspectionVerificationStatus String?              @default("pending_review")
  dmvInspectionRejectionReason    String?
  dmvInspectionStatus             DmvInspectionStatus?
  inspectionStatus                DocumentStatus       @default(PENDING)
  inspectionLastUpdated           DateTime?
  plateCountry                    String?
  plateState                      String?
  plateStatus                     DocumentStatus       @default(PENDING)
  licensePlateLastUpdated         DateTime?
  licensePlateVerificationStatus  String?              @default("pending_review")
  licensePlateRejectionReason     String?
  tlcLicenseNumber                String?
  tlcLicenseStatus                DocumentStatus       @default(PENDING)

  // Step 2: Vehicle Category and Dispatch Eligibility
  vehicleCategory           String? // VehicleCategoryId: SAFEGO_X, SAFEGO_COMFORT, etc.
  vehicleCategoryStatus     DocumentStatus @default(PENDING) // Admin approval for category
  vehicleCategoryApprovedAt DateTime?
  vehicleCategoryApprovedBy String?
  wheelchairAccessible      Boolean        @default(false) // WAV eligibility flag
  wavCertificationUrl       String? // WAV certification document
  wavCertificationExpiry    DateTime?
  wavCertificationStatus    DocumentStatus @default(PENDING)
  exteriorColor             String? // Required for BLACK/BLACK_SUV
  interiorColor             String? // Required for BLACK/BLACK_SUV
  seatCapacity              Int? // Actual seat count for dispatch matching

  // Step 3: Vehicle Verification and Category Suggestion
  bodyType                        String? // SEDAN, SUV, MINIVAN, HATCHBACK, WAGON, CROSSOVER, VAN
  luxury                          Boolean   @default(false) // Is this a luxury vehicle
  suggestedCategory               String? // Auto-suggested category (not authoritative)
  suggestedCategoryReasons        String[]  @default([]) // Reasons for suggestion
  vehicleVerificationStatus       String    @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, APPROVED, REJECTED, REQUEST_CHANGES
  verificationRejectionReason     String? // Reason if rejected
  verificationRequestChangesNotes String? // Notes if requesting changes
  verifiedAt                      DateTime? // When vehicle was verified
  verifiedBy                      String? // Admin who verified
  tlcBaseAffiliation              String? // TLC base affiliation
  hvfhvPermit                     String? // HVFHV permit number

  // Category approval tracking
  categoryApprovalNotes String? // Admin notes for category decision
  categoryApprovedAt    DateTime? // Renamed from vehicleCategoryApprovedAt for consistency
  categoryApprovedBy    String? // Renamed from vehicleCategoryApprovedBy for consistency
  categoryRejectedAt    DateTime? // When category was rejected
  categoryRejectedBy    String? // Admin who rejected

  // Step 4: Driver Category Preferences (subset of eligibleCategories)
  eligibleCategories     String[]  @default([]) // Categories vehicle qualifies for based on dispatch matrix
  allowedCategories      String[]  @default([]) // Driver's preferred subset of eligible categories
  preferencesLastUpdated DateTime? // When driver last updated preferences
  preferencesResetAt     DateTime? // When admin last reset preferences
  preferencesResetBy     String? // Admin who reset preferences

  vehicleDocuments VehicleDocument[]
  driver           DriverProfile     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId]) // D1: Index for 1:N queries
  @@index([isPrimary]) // D1: Index for finding primary vehicle
  @@index([vehicleCategory]) // Step 2: Index for category-based dispatch queries
  @@index([wheelchairAccessible]) // Step 2: Index for WAV dispatch queries
  // Note: One-primary-vehicle constraint enforced at application level in driverVehicleService.ts
  @@map("vehicles")
}

// Driver Loyalty Points Tier System
model DriverTier {
  id             String         @id @default(uuid())
  name           String         @unique
  requiredPoints Int
  color          String
  description    String?
  displayOrder   Int
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  benefits       TierBenefit[]
  drivers        DriverPoints[]

  @@index([requiredPoints])
  @@index([displayOrder])
  @@map("driver_tiers")
}

model TierBenefit {
  id           String     @id @default(uuid())
  tierId       String
  benefitText  String
  displayOrder Int        @default(0)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  tier         DriverTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@index([tierId])
  @@index([displayOrder])
  @@map("tier_benefits")
}

model DriverPoints {
  id             String              @id @default(uuid())
  driverId       String              @unique
  currentTierId  String?
  totalPoints    Int                 @default(0) // 90-day status points for tier calculation
  lifetimePoints Int                 @default(0) // All-time points for analytics
  cycleStartDate DateTime? // Current 90-day cycle start
  cycleEndDate   DateTime? // Current 90-day cycle end
  lastEarnedAt   DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  driver         DriverProfile       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tier           DriverTier?         @relation(fields: [currentTierId], references: [id])
  transactions   PointsTransaction[]

  @@index([driverId])
  @@index([currentTierId])
  @@index([totalPoints])
  @@index([cycleEndDate]) // For finding cycles needing reset
  @@map("driver_points")
}

model PointsRule {
  id          String   @id @default(uuid())
  ruleName    String   @unique
  description String?
  basePoints  Int      @default(10)
  multiplier  Decimal  @default(1.0) @db.Decimal(5, 2)
  countryCode String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([countryCode])
  @@index([isActive])
  @@map("points_rules")
}

model PointsTransaction {
  id             String       @id @default(uuid())
  driverPointsId String
  points         Int
  reason         String
  referenceType  String?
  referenceId    String?
  countryCode    String?
  metadata       Json?
  createdAt      DateTime     @default(now())
  driverPoints   DriverPoints @relation(fields: [driverPointsId], references: [id], onDelete: Cascade)

  @@index([driverPointsId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
  @@map("points_transactions")
}

model AuditLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  actorId     String?
  actorEmail  String
  actorRole   String
  ipAddress   String?
  userAgent   String?
  countryCode String?
  actionType  String
  entityType  String
  entityId    String?
  description String
  metadata    Json?
  success     Boolean  @default(true)
  environment String   @default("development")

  @@index([createdAt])
  @@index([actorEmail])
  @@index([actionType])
  @@index([entityType])
  @@index([success])
  @@index([countryCode])
  @@index([environment])
  @@map("audit_logs")
}

model AdminNotification {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  type        String
  severity    String
  actorId     String?
  actorEmail  String?
  entityType  String
  entityId    String?
  countryCode String?
  title       String
  message     String
  metadata    Json?
  isRead      Boolean   @default(false)

  @@index([createdAt(sort: Desc)])
  @@index([isRead])
  @@index([type])
  @@index([entityType])
  @@index([countryCode])
  @@index([severity])
  @@map("admin_notifications")
}

model PlatformSettings {
  id               String   @id @default(uuid())
  key              String   @unique
  valueJson        Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  updatedByAdminId String?

  @@index([key])
  @@map("platform_settings")
}

// Global Admin Settings with Safety Locks
enum AdminSettingScope {
  GLOBAL
  BD_ONLY
  US_ONLY
}

enum AdminSettingCategory {
  PLATFORM_ECONOMICS
  SECURITY_ABUSE
  CONTACTS_SUPPORT
  OPERATIONAL
}

model AdminSetting {
  id               String               @id @default(uuid())
  key              String               @unique
  value            Json
  description      String
  isSensitive      Boolean              @default(false)
  countryScope     AdminSettingScope    @default(GLOBAL)
  category         AdminSettingCategory @default(OPERATIONAL)
  validationRules  Json?
  updatedByAdminId String?
  updatedAt        DateTime             @updatedAt
  createdAt        DateTime             @default(now())

  changes AdminSettingChange[]

  @@index([key])
  @@index([category])
  @@index([countryScope])
  @@index([isSensitive])
  @@map("admin_settings")
}

model AdminSettingChange {
  id          String   @id @default(uuid())
  settingId   String
  settingKey  String
  oldValue    Json?
  newValue    Json
  changedById String
  changedByEmail String
  ipAddress   String?
  userAgent   String?
  reason      String?
  createdAt   DateTime @default(now())

  setting AdminSetting @relation(fields: [settingId], references: [id], onDelete: Cascade)

  @@index([settingId])
  @@index([settingKey])
  @@index([changedById])
  @@index([createdAt(sort: Desc)])
  @@map("admin_setting_changes")
}

enum PayoutType {
  mobile_wallet
  bank_account
  stripe_connect
  manual
}

enum PayoutAccountStatus {
  pending_verification
  active
  inactive
}

model PayoutAccount {
  id                      String              @id @default(uuid())
  ownerType               String
  ownerId                 String
  countryCode             String
  payoutType              PayoutType
  provider                String?
  displayName             String
  accountHolderName       String
  maskedAccount           String
  encryptedDetails        String
  accountNumber_encrypted String?
  routingNumber_encrypted String?
  accountType             String? // For bank accounts: checking, savings, other
  bankName                String? // Bank name for display
  isDefault               Boolean             @default(false)
  status                  PayoutAccountStatus @default(pending_verification)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@index([ownerType, ownerId])
  @@index([ownerType, ownerId, isDefault])
  @@map("payout_accounts")
}

enum PaymentMethodStatus {
  active
  inactive
}

model PaymentMethod {
  id               String              @id @default(uuid())
  customerId       String
  provider         String
  providerMethodId String
  brand            String?
  last4            String
  expMonth         Int?
  expYear          Int?
  isDefault        Boolean             @default(false)
  status           PaymentMethodStatus @default(active)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Phase 2B: Additional fields for payment integration
  providerCustomerId String? // Stripe cus_xxx, etc.
  type               String    @default("card") // card, bank_account, mobile_money
  billingName        String?
  billingCountry     String?
  billingPostalCode  String?
  fingerprint        String? // Card fingerprint for duplicate detection
  lastVerifiedAt     DateTime?

  // Phase 4 Part 2: BD Mobile Wallet fields
  providerType      String?   @default("card") // card | mobile_wallet | bank_transfer
  walletBrand       String? // bkash | nagad | null
  walletPhoneMasked String? // Last 4 digits of phone: ****1234
  walletVerified    Boolean   @default(false)
  walletVerifiedAt  DateTime?

  // Relations
  customer CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([customerId])
  @@index([customerId, isDefault])
  @@index([providerType])
  @@map("payment_methods")
}

enum SupportSenderType {
  user
  admin
  bot
  system
}

enum SupportMessageType {
  text
  image
  file
}

enum SupportConversationStatus {
  open
  bot
  pending
  assigned
  closed
}

model SupportConversation {
  id              String                    @id @default(uuid())
  userId          String
  userType        String // "driver" | "customer" | "restaurant" | "parcel"
  status          SupportConversationStatus @default(open)
  assignedAdminId String? // Reference to User.id (admin)
  adminLastSeenAt DateTime? // Track when admin last viewed for unread count
  verifiedAt      DateTime? // When user confirmed their details
  topic           String? // payments | trips | documents | tax | account_settings | other
  entryContext    Json? // Device info, channel, etc.
  escalatedAt     DateTime?
  isEscalated     Boolean                   @default(false)
  unresolvedCount Int                       @default(0) // Track bot failures for auto-escalation
  closedAt        DateTime? // When conversation ended
  rating          Int? // 1-5 stars rating after end chat
  feedback        String?                   @db.Text // Optional feedback after end chat
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  messages        SupportMessage[]
  attachments     SupportAttachment[]

  @@index([userId, userType, createdAt])
  @@index([assignedAdminId])
  @@index([status, createdAt])
  @@index([userId, userType, status])
  @@index([adminLastSeenAt])
  @@map("support_conversations")
}

model SupportMessage {
  id             String              @id @default(uuid())
  conversationId String
  senderType     SupportSenderType
  messageType    SupportMessageType  @default(text)
  body           String?             @db.Text
  attachmentId   String?
  read           Boolean             @default(false)
  createdAt      DateTime            @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("support_messages")
}

model SupportAttachment {
  id                String              @id @default(uuid())
  conversationId    String
  fileName          String
  fileType          String
  fileSize          Int
  secureStoragePath String // Signed document URL path, NOT direct URL
  createdAt         DateTime            @default(now())
  conversation      SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("support_attachments")
}

enum WalletOwnerType {
  driver
  customer
  restaurant
  shop
  ticket_operator
}

enum WalletTransactionServiceType {
  ride
  food
  parcel
  ticket // BD Expansion: Ticket booking commission
  rental // BD Expansion: Rental booking commission
  adjustment
  payout
  commission
  refund
  commission_settlement
  commission_refund
  tip // Phase 2A: Driver tips from customers
  cancellation_fee // Phase 2A: Cancellation fee credits
  incentive // Phase 2A: Bonus/incentive awards
}

enum WalletTransactionDirection {
  credit
  debit
}

enum WalletTransactionReferenceType {
  ride
  food_order
  delivery
  payout
  manual_adjustment
  auto_settlement
  referral_bonus
  promotion_bonus
}

enum PayoutMethod {
  auto_weekly
  manual_request
  manual_admin_settlement
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

model Wallet {
  id               String              @id @default(uuid())
  ownerId          String
  ownerType        WalletOwnerType
  countryCode      String
  availableBalance Decimal             @default(0) @db.Decimal(12, 2)
  holdAmount       Decimal             @default(0) @db.Decimal(12, 2) // D8: Amount on hold (pending payouts)
  negativeBalance  Decimal             @default(0) @db.Decimal(12, 2)
  currency         String
  isDemo           Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  transactions     WalletTransaction[]
  payouts          Payout[]

  @@unique([ownerId, ownerType])
  @@index([ownerType])
  @@index([countryCode])
  @@index([ownerType, countryCode])
  @@index([isDemo])
  @@map("wallets")
}

model WalletTransaction {
  id                      String                         @id @default(uuid())
  walletId                String
  ownerType               WalletOwnerType
  countryCode             String
  serviceType             WalletTransactionServiceType
  direction               WalletTransactionDirection
  amount                  Decimal                        @db.Decimal(12, 2)
  balanceSnapshot         Decimal                        @db.Decimal(12, 2)
  negativeBalanceSnapshot Decimal                        @db.Decimal(12, 2)
  referenceType           WalletTransactionReferenceType
  referenceId             String?
  description             String
  isDemo                  Boolean                        @default(false)
  createdAt               DateTime                       @default(now())
  createdByAdminId        String?
  wallet                  Wallet                         @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([ownerType])
  @@index([serviceType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([walletId, createdAt])
  @@index([isDemo])
  @@map("wallet_transactions")
}

model Payout {
  id                  String          @id @default(uuid())
  walletId            String
  countryCode         String
  ownerType           WalletOwnerType
  ownerId             String
  amount              Decimal         @db.Decimal(12, 2)
  feeAmount           Decimal         @default(0) @db.Decimal(12, 2) // D8: Platform fee charged
  netAmount           Decimal         @default(0) @db.Decimal(12, 2) // D8: Amount after fee (amount - feeAmount)
  method              PayoutMethod
  status              PayoutStatus    @default(pending)
  failureReason       String?
  scheduledAt         DateTime?
  isDemo              Boolean         @default(false)
  createdAt           DateTime        @default(now())
  createdByAdminId    String?
  processedAt         DateTime?
  externalReferenceId String?
  batchId             String?
  payoutMethodId      String? // D8: Link to driver/restaurant payout method used
  wallet              Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  batch               PayoutBatch?    @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([ownerType])
  @@index([status])
  @@index([countryCode])
  @@index([createdAt])
  @@index([ownerType, ownerId])
  @@index([batchId])
  @@index([isDemo])
  @@map("payouts")
}

enum PayoutBatchStatus {
  created
  processing
  completed
  partially_failed
  failed
}

model PayoutBatch {
  id                String            @id @default(uuid())
  batchType         WalletOwnerType?
  periodStart       DateTime
  periodEnd         DateTime
  totalPayoutCount  Int               @default(0)
  totalPayoutAmount Decimal           @default(0) @db.Decimal(12, 2)
  status            PayoutBatchStatus @default(created)
  createdByAdminId  String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  payouts           Payout[]

  @@index([status])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("payout_batches")
}

// ===== PAYMENT & PAYOUT CONFIGURATION SYSTEM =====

// Country-aware customer payment method configuration
model CountryPaymentConfig {
  id                   String   @id @default(uuid())
  countryCode          String // BD, US, etc.
  serviceType          String // RIDE, FOOD, PARCEL
  methodType           String // PaymentMethodType enum value
  provider             String // PaymentProvider enum value
  isEnabled            Boolean  @default(true)
  priority             Int      @default(0)
  minAmount            Decimal? @db.Decimal(12, 2)
  maxAmount            Decimal? @db.Decimal(12, 2)
  supportsRecurring    Boolean  @default(false)
  requiresKycLevel     String   @default("NONE") // NONE, BASIC, FULL
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String?
  lastUpdatedByAdminId String?

  @@unique([countryCode, serviceType, methodType, provider])
  @@index([countryCode, serviceType])
  @@index([isEnabled])
  @@index([createdByAdminId])
  @@map("country_payment_configs")
}

// Country-aware payout rail configuration for restaurants/drivers
model CountryPayoutConfig {
  id                   String   @id @default(uuid())
  countryCode          String // BD, US, etc.
  actorType            String // RESTAURANT, DRIVER
  serviceType          String   @default("GLOBAL") // D8: RIDE, FOOD, PARCEL, GLOBAL
  payoutRailType       String // PayoutRailType enum value
  provider             String // PayoutProvider enum value
  currency             String   @default("USD") // D8: Currency code
  isEnabled            Boolean  @default(true)
  minPayoutAmount      Decimal  @default(0) @db.Decimal(12, 2)
  maxPayoutAmount      Decimal? @db.Decimal(12, 2) // D8: Maximum single payout
  payoutSchedule       String   @default("WEEKLY") // DAILY, WEEKLY, BIWEEKLY, MONTHLY, ON_DEMAND
  payoutDayOfWeek      Int? // D8: 0-6 (Sun-Sat) for WEEKLY
  payoutDayOfMonth     Int? // D8: 1-28 for MONTHLY
  platformFeeType      String   @default("NONE") // D8: NONE, FLAT, PERCENT
  platformFeeValue     Decimal  @default(0) @db.Decimal(10, 4) // D8: Fee amount or percentage
  requiresKycLevel     String   @default("BASIC") // NONE, BASIC, FULL
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String?
  lastUpdatedByAdminId String?

  @@unique([countryCode, actorType, payoutRailType, provider])
  @@index([countryCode, actorType])
  @@index([countryCode, actorType, serviceType])
  @@index([isEnabled])
  @@index([createdByAdminId])
  @@map("country_payout_configs")
}

// Payout method instances for restaurants and drivers
model RestaurantPayoutMethod {
  id                   String   @id @default(uuid())
  actorType            String // RESTAURANT or DRIVER
  restaurantId         String?
  driverId             String?
  countryCode          String
  payoutRailType       String // PayoutRailType enum value
  provider             String // PayoutProvider enum value
  currency             String
  isDefault            Boolean  @default(false)
  status               String   @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, ACTIVE, DISABLED
  maskedDetails        String // e.g., "Bank ****1234", "bKash ***890"
  metadata             Json? // PSP-specific IDs, encrypted sensitive data
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByActorId     String
  lastUpdatedByActorId String?
  actorRole            String // Role of the actor who created this

  @@index([actorType, restaurantId])
  @@index([actorType, driverId])
  @@index([countryCode])
  @@index([status])
  @@index([isDefault])
  @@map("restaurant_payout_methods")
}

enum ApprovalRequestStatus {
  pending
  approved
  rejected
  expired
}

model ApprovalRequest {
  id          String                @id @default(uuid())
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  requesterId String
  approverId  String?
  actionType  String
  payload     Json
  status      ApprovalRequestStatus @default(pending)
  reason      String?
  executedAt  DateTime?
  expiresAt   DateTime?

  requester User  @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver  User? @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([status])
  @@index([requesterId])
  @@index([approverId])
  @@index([actionType])
  @@index([createdAt])
  @@map("approval_requests")
}

model AdminSession {
  id            String    @id @default(uuid())
  adminId       String
  createdAt     DateTime  @default(now())
  lastSeenAt    DateTime  @default(now())
  ipAddress     String?
  userAgentHash String?
  isActive      Boolean   @default(true)
  revokedAt     DateTime?
  revokedReason String?

  admin User @relation("AdminSessions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([isActive])
  @@index([createdAt])
  @@map("admin_sessions")
}

enum ServiceType {
  RIDE
  FOOD
  PARCEL
}

enum BdServiceType {
  ride
  food
  parcel
  shop
  ticket
  rental
}

enum BdTaxType {
  vat
}

model BdTaxRule {
  id                   String        @id @default(uuid())
  serviceType          BdServiceType // ride, food, parcel, shop, ticket, rental
  bdTaxType            BdTaxType     @default(vat)
  bdTaxRatePercentage  Decimal       @db.Decimal(5, 2) @default(15.00) // 15% VAT default
  isActive             Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  createdByAdminId     String?
  updatedByAdminId     String?

  @@unique([serviceType]) // One rule per service type
  @@index([serviceType])
  @@index([isActive])
  @@map("bd_tax_rules")
}

enum TaxType {
  VAT
  SALES_TAX
  GOVERNMENT_SERVICE_FEE
  MARKETPLACE_FACILITATOR_TAX
  TRIP_FEE
  LOCAL_MUNICIPALITY_FEE
  REGULATORY_FEE
}

model TaxRule {
  id          String      @id @default(cuid())
  countryCode String
  cityCode    String?
  serviceType ServiceType
  taxType     TaxType
  percentRate Decimal?    @db.Decimal(5, 2)
  flatFee     Decimal?    @db.Decimal(10, 2)
  isActive    Boolean     @default(true)
  isDemo      Boolean     @default(false)
  createdAt   DateTime    @default(now())

  @@index([countryCode])
  @@index([cityCode])
  @@index([serviceType])
  @@index([taxType])
  @@index([isActive])
  @@index([isDemo])
  @@map("tax_rules")
}

enum ReferralUserType {
  driver
  rider
}

enum ReferralRewardStatus {
  pending
  paid
}

enum OpportunityBonusType {
  trip_boost
  surge_boost
  peak_hour_boost
  per_ride_bonus
}

enum OpportunityRewardStatus {
  pending
  paid
}

model ReferralSetting {
  id               String           @id @default(uuid())
  countryCode      String
  userType         ReferralUserType
  currency         String
  baseAmount       Decimal          @db.Decimal(10, 2)
  promoAmount      Decimal?         @db.Decimal(10, 2)
  promoMultiplier  Decimal?         @db.Decimal(5, 2)
  promoLabel       String?
  startAt          DateTime?
  endAt            DateTime?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdByAdminId String
  updatedByAdminId String?
  notes            String?
  isDemo           Boolean          @default(false)
  referralRewards  ReferralReward[]

  @@unique([countryCode, userType, isActive])
  @@index([countryCode])
  @@index([userType])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("referral_settings")
}

model ReferralReward {
  id                  String               @id @default(uuid())
  referrerUserId      String
  referredUserId      String
  referralSettingId   String
  rewardAmount        Decimal              @db.Decimal(10, 2)
  currency            String
  countryCode         String
  status              ReferralRewardStatus @default(pending)
  triggeredAt         DateTime             @default(now())
  paidAt              DateTime?
  walletTransactionId String?
  isDemo              Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  referralSetting     ReferralSetting      @relation(fields: [referralSettingId], references: [id])

  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referralSettingId])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("referral_rewards")
}

model OpportunitySetting {
  id                 String               @id @default(uuid())
  bonusType          OpportunityBonusType
  countryCode        String
  currency           String
  baseAmount         Decimal              @db.Decimal(10, 2)
  promoAmount        Decimal?             @db.Decimal(10, 2)
  promoMultiplier    Decimal?             @db.Decimal(5, 2)
  zoneId             String?
  startAt            DateTime?
  endAt              DateTime?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  createdByAdminId   String
  updatedByAdminId   String?
  notes              String?
  isDemo             Boolean              @default(false)
  opportunityRewards OpportunityReward[]

  @@unique([bonusType, countryCode, zoneId, isActive])
  @@index([bonusType])
  @@index([countryCode])
  @@index([zoneId])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("opportunity_settings")
}

model OpportunityReward {
  id                   String                  @id @default(uuid())
  driverId             String
  rideId               String?
  countryCode          String
  bonusType            OpportunityBonusType
  opportunitySettingId String
  rewardAmount         Decimal                 @db.Decimal(10, 2)
  currency             String
  status               OpportunityRewardStatus @default(pending)
  triggeredAt          DateTime                @default(now())
  paidAt               DateTime?
  walletTransactionId  String?
  isDemo               Boolean                 @default(false)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  opportunitySetting   OpportunitySetting      @relation(fields: [opportunitySettingId], references: [id])

  @@index([driverId])
  @@index([rideId])
  @@index([opportunitySettingId])
  @@index([bonusType])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("opportunity_rewards")
}

// ====================================================
// PHASE 7: Restaurant Promotions & Coupons
// ====================================================

model Promotion {
  id                      String            @id @default(uuid())
  restaurantId            String
  title                   String
  description             String?           @db.Text
  promoType               PromotionType
  status                  PromotionStatus   @default(UPCOMING) // R4: Track promotion lifecycle
  discountValue           Decimal?          @db.Decimal(10, 2) // For fixed amount
  discountPercentage      Decimal?          @db.Decimal(5, 2) // For percentage (0-100)
  buyQuantity             Int? // For BOGO: buy X
  getQuantity             Int? // For BOGO: get Y
  applicableItems         Json? // Array of menu item IDs
  applicableCategories    Json? // Array of category names
  minOrderAmount          Decimal?          @db.Decimal(10, 2)
  maxDiscountCap          Decimal?          @db.Decimal(10, 2)
  usageLimitPerCustomer   Int?
  globalUsageLimit        Int?
  currentUsageCount       Int               @default(0)
  startDate               DateTime
  endDate                 DateTime
  timeWindowStart         String? // For time-based promos (e.g., "11:00")
  timeWindowEnd           String? // For time-based promos (e.g., "14:00")
  daysOfWeek              String[] // R4: Optional days-of-week filter (e.g., ["monday", "friday"])
  isFirstTimeCustomerOnly Boolean           @default(false)
  isActive                Boolean           @default(true)
  isFlagged               Boolean           @default(false)
  flagReason              String?           @db.Text
  flaggedByAdminId        String?
  flaggedAt               DateTime?
  isDemo                  Boolean           @default(false)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  createdByOwnerId        String
  updatedByOwnerId        String? // R4: Track who last updated
  restaurant              RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders                  FoodOrder[]
  promotionUsages         PromotionUsage[] // R4: Track each redemption
  coupons                 Coupon[] // R4: Link coupons to promotions

  @@index([restaurantId])
  @@index([isActive])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([promoType])
  @@index([isFlagged])
  @@index([isDemo])
  @@map("promotions")
}

model Coupon {
  id                    String             @id @default(uuid())
  restaurantId          String
  promotionId           String? // R4: Link coupon to promotion (optional for standalone coupons)
  code                  String // Unique coupon code
  discountType          CouponDiscountType
  discountValue         Decimal?           @db.Decimal(10, 2) // For fixed amount
  discountPercentage    Decimal?           @db.Decimal(5, 2) // For percentage (0-100)
  minOrderAmount        Decimal?           @db.Decimal(10, 2)
  maxDiscountCap        Decimal?           @db.Decimal(10, 2)
  usageLimitPerCustomer Int?
  globalUsageLimit      Int?
  currentUsageCount     Int                @default(0)
  startDate             DateTime
  endDate               DateTime
  isActive              Boolean            @default(true)
  isFlagged             Boolean            @default(false)
  flagReason            String?            @db.Text
  flaggedByAdminId      String?
  flaggedAt             DateTime?
  isDemo                Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  createdByOwnerId      String
  restaurant            RestaurantProfile  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  promotion             Promotion?         @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  promotionUsages       PromotionUsage[] // R4: Track coupon redemptions

  @@unique([restaurantId, code])
  @@index([restaurantId])
  @@index([promotionId])
  @@index([code])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@index([isFlagged])
  @@index([isDemo])
  @@map("coupons")
}

model PromotionUsage {
  id             String    @id @default(uuid())
  promotionId    String
  couponId       String? // Optional - if coupon was used
  customerId     String
  orderId        String // Link to FoodOrder
  restaurantId   String
  discountAmount Decimal   @db.Decimal(10, 2)
  currency       String    @default("USD")
  usedAt         DateTime  @default(now())
  isDemo         Boolean   @default(false)
  promotion      Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  coupon         Coupon?   @relation(fields: [couponId], references: [id], onDelete: SetNull)

  @@index([promotionId])
  @@index([couponId])
  @@index([customerId])
  @@index([orderId])
  @@index([restaurantId])
  @@index([usedAt])
  @@index([isDemo])
  @@map("promotion_usages")
}

enum PromotionType {
  percentage_discount
  fixed_discount
  bogo
  category_discount
  time_window
  first_time_customer
}

enum PromotionStatus {
  UPCOMING
  ACTIVE
  EXPIRED
  PAUSED
}

enum CouponDiscountType {
  percentage
  fixed_amount
  free_delivery
}

enum AddressLabel {
  home
  work
  other
}

enum RefundStatus {
  none
  pending
  processing
  completed
  failed
}

// ====================================================
// PHASE 8: Restaurant Review & Rating System
// ====================================================

model Review {
  id                    String    @id @default(uuid())
  orderId               String    @unique // One review per order
  restaurantId          String
  customerId            String
  rating                Int // 1-5 stars
  reviewText            String?   @db.Text
  images                String[] // Array of image URLs
  isHidden              Boolean   @default(false) // Admin hidden
  hiddenByAdminId       String?
  hiddenAt              DateTime?
  hideReason            String?   @db.Text
  isFlagged             Boolean   @default(false) // Admin flagged
  flaggedByAdminId      String?
  flaggedAt             DateTime?
  flagReason            String?   @db.Text
  // R5: Restaurant Reply (one reply per review)
  restaurantReplyText   String?   @db.Text
  restaurantRepliedAt   DateTime?
  restaurantRepliedById String?
  isDemo                Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  order      FoodOrder         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   CustomerProfile   @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([customerId])
  @@index([orderId])
  @@index([rating])
  @@index([isHidden])
  @@index([isFlagged])
  @@index([createdAt])
  @@index([isDemo])
  @@map("reviews")
}

// ====================================================
// PHASE 9: Restaurant Media Gallery & Branding System
// ====================================================

model RestaurantBranding {
  id             String   @id @default(uuid())
  restaurantId   String   @unique
  logoUrl        String? // Restaurant logo
  coverPhotoUrl  String? // Cover/banner photo
  primaryColor   String? // Hex color code
  secondaryColor String? // Hex color code
  themeMode      String   @default("light") // light, dark, auto
  isDemo         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isDemo])
  @@map("restaurant_branding")
}

enum MediaCategory {
  food
  ambience
  team
  kitchen
  other
}

model RestaurantMedia {
  id               String        @id @default(uuid())
  restaurantId     String
  filePath         String // Path to file in storage
  fileUrl          String? // Signed URL (temporary)
  fileType         String        @default("image") // image, video
  category         MediaCategory @default(other)
  displayOrder     Int           @default(0)
  isHidden         Boolean       @default(false) // Admin hidden
  hiddenByAdminId  String?
  hiddenAt         DateTime?
  hideReason       String?       @db.Text
  isFlagged        Boolean       @default(false) // Admin flagged
  flaggedByAdminId String?
  flaggedAt        DateTime?
  flagReason       String?       @db.Text
  isDemo           Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([category])
  @@index([isHidden])
  @@index([isFlagged])
  @@index([displayOrder])
  @@index([createdAt])
  @@index([isDemo])
  @@map("restaurant_media")
}

// ============================================================
// PHASE 10: Restaurant Operational Settings System
// ============================================================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model RestaurantHours {
  id           String    @id @default(uuid())
  restaurantId String
  dayOfWeek    DayOfWeek
  isClosed     Boolean   @default(false) // Closed all day
  openTime1    String? // Format: "HH:mm" (24-hour)
  closeTime1   String? // Format: "HH:mm" (24-hour)
  openTime2    String? // For split shifts
  closeTime2   String? // For split shifts
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@map("restaurant_hours")
}

model OperationalSettings {
  id           String @id @default(uuid())
  restaurantId String @unique

  // Delivery settings
  deliveryEnabled        Boolean @default(true)
  pickupEnabled          Boolean @default(true)
  preparationTimeMinutes Int     @default(30)
  autoAcceptOrders       Boolean @default(false)
  maxConcurrentOrders    Int? // For throttling (null = unlimited)

  // Order amount settings
  minOrderAmount        Decimal? @db.Decimal(10, 2)
  freeDeliveryThreshold Decimal? @db.Decimal(10, 2)

  // Temporary closure
  isTemporarilyClosed  Boolean   @default(false)
  temporaryCloseReason String?
  temporaryCloseUntil  DateTime?

  // Holiday closures (JSON array of dates: ["2025-12-25", "2025-01-01"])
  holidayClosures Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("operational_settings")
}

model DeliveryZone {
  id           String @id @default(uuid())
  restaurantId String
  zoneName     String
  zoneType     String @default("radius") // "radius" or "polygon"

  // For radius zones
  centerLat Float?
  centerLng Float?
  radiusKm  Float?

  // For polygon zones (JSON array of {lat, lng} points)
  polygonPoints Json?

  // Delivery fees
  baseFee    Decimal @default(0) @db.Decimal(10, 2)
  perKmFee   Decimal @default(0) @db.Decimal(10, 2)
  minimumFee Decimal @default(0) @db.Decimal(10, 2)

  // ETA adjustments
  estimatedMinutes Int @default(30)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isActive])
  @@map("delivery_zones")
}

model SurgeSettings {
  id           String @id @default(uuid())
  restaurantId String @unique

  surgeEnabled    Boolean @default(false)
  surgeMultiplier Float   @default(1.0) // 1.0 - 2.0

  // Peak hours (JSON array of {start: "HH:mm", end: "HH:mm"})
  peakHours Json?

  weekendMultiplier Float @default(1.0) // 1.0 - 2.0

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("surge_settings")
}

// Phase 12: Support Ticket System Enums
enum TicketServiceType {
  food_order
  ride
  delivery
}

enum IssueCategory {
  missing_item
  wrong_order
  cold_food
  late_delivery
  driver_behavior
  payment_issue
  unsafe_driving
  rude_behavior
  wrong_route
  overcharge
  damaged_package
  not_delivered
  app_issue
  other
}

enum CustomerVisibleStatus {
  open
  in_review
  awaiting_customer
  resolved
  closed
}

enum InternalStatus {
  new
  assigned_restaurant
  assigned_admin
  refund_pending
  refund_approved
  no_action
  closed
}

enum TicketPriority {
  low
  medium
  high
}

enum MessageType {
  public
  internal
}

enum ActorRole {
  customer
  restaurant_owner
  restaurant_staff
  driver
  admin
}

enum AdjustmentType {
  customer_refund
  restaurant_debit
  driver_debit
  safego_cost
  goodwill_credit
}

// Phase 12: Support Ticket System Models
model SupportTicket {
  id           String            @id @default(uuid())
  ticketCode   String            @unique // e.g., "SG-SUP-2025-000123"
  serviceType  TicketServiceType
  serviceId    String // References food_orders.id, rides.id, or deliveries.id
  restaurantId String? // Nullable for rides/deliveries without restaurant
  customerId   String
  driverId     String?
  countryCode  String
  cityCode     String?

  issueCategory    IssueCategory
  issueDescription String        @db.Text
  photoUrls        Json? // Array of photo URLs

  customerVisibleStatus CustomerVisibleStatus @default(open)
  internalStatus        InternalStatus        @default(new)
  priority              TicketPriority        @default(medium)
  originChannel         String                @default("web") // "app" | "web" | "auto_flag" | "admin_manual"

  refundRequestedAmount Decimal? @db.Decimal(10, 2)
  refundApprovedAmount  Decimal? @db.Decimal(10, 2)

  proposedResolution String? // "remake_order" | "offer_coupon" | "request_partial_refund" | "request_full_refund" | "no_issue_found"
  resolutionNotes    String? @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  customer   CustomerProfile    @relation(fields: [customerId], references: [id])
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id])

  messages             SupportTicketMessage[]
  financialAdjustments FinancialAdjustment[]

  @@index([ticketCode])
  @@index([serviceType])
  @@index([serviceId])
  @@index([restaurantId])
  @@index([customerId])
  @@index([driverId])
  @@index([countryCode])
  @@index([cityCode])
  @@index([customerVisibleStatus])
  @@index([internalStatus])
  @@index([priority])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id             String      @id @default(uuid())
  ticketId       String
  actorId        String // References user_id, can be customer, restaurant owner, staff, driver, or admin
  actorRole      ActorRole
  messageType    MessageType @default(public)
  messageBody    String      @db.Text
  attachmentUrls Json? // Array of attachment URLs

  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([actorId])
  @@index([createdAt])
  @@map("support_ticket_messages")
}

model FinancialAdjustment {
  id           String            @id @default(uuid())
  ticketId     String
  serviceType  TicketServiceType
  serviceId    String
  restaurantId String?
  driverId     String?

  adjustmentType AdjustmentType
  amount         Decimal        @db.Decimal(10, 2)
  currency       String         @default("USD")

  createdByAdminId  String
  approvedByAdminId String?
  notes             String? @db.Text

  createdAt  DateTime  @default(now())
  approvedAt DateTime?

  ticket          SupportTicket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdByAdmin  User               @relation("CreatedAdjustments", fields: [createdByAdminId], references: [id])
  approvedByAdmin User?              @relation("ApprovedAdjustments", fields: [approvedByAdminId], references: [id])
  restaurant      RestaurantProfile? @relation(fields: [restaurantId], references: [id])
  driver          DriverProfile?     @relation(fields: [driverId], references: [id])

  @@index([ticketId])
  @@index([serviceType])
  @@index([serviceId])
  @@index([restaurantId])
  @@index([driverId])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("financial_adjustments")
}

// Phase 12.5: Restaurant Support Center Models (separate from customer/driver support)
enum RestaurantSupportCategory {
  orders
  payouts
  menu_pricing
  account_kyc
  technical_issue
  other
}

enum RestaurantSupportPriority {
  low
  normal
  high
  urgent
}

enum RestaurantSupportStatus {
  open
  in_progress
  resolved
  closed
}

enum LiveChatStatus {
  waiting
  active
  ended
}

enum CallbackStatus {
  pending
  completed
  cancelled
}

model RestaurantSupportTicket {
  id             String                    @id @default(uuid())
  ticketCode     String                    @unique // e.g., "RST-2025-000123"
  restaurantId   String
  subject        String
  category       RestaurantSupportCategory
  priority       RestaurantSupportPriority @default(normal)
  status         RestaurantSupportStatus   @default(open)
  description    String                    @db.Text
  attachmentUrls Json? // Array of attachment URLs
  channel        String                    @default("web") // email, phone, chat
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  resolvedAt     DateTime?

  restaurant RestaurantProfile          @relation("RestaurantSupportTickets", fields: [restaurantId], references: [id], onDelete: Cascade)
  messages   RestaurantSupportMessage[]

  @@index([restaurantId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("restaurant_support_tickets")
}

model RestaurantSupportMessage {
  id             String   @id @default(uuid())
  ticketId       String
  senderRole     String // "restaurant" | "support"
  senderName     String // Display name of sender
  messageBody    String   @db.Text
  attachmentUrls Json? // Array of attachment URLs
  createdAt      DateTime @default(now())

  ticket RestaurantSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
  @@map("restaurant_support_messages")
}

// Driver Support Center Models (Phase 12 Extension - D8 Enhanced)
enum DriverSupportCategory {
  account_documents
  trip_issues
  payment_earnings
  incentives_promotions
  safety_emergency
  app_technical
}

model DriverSupportTicket {
  id              String                    @id @default(uuid())
  ticketCode      String                    @unique // e.g., "DST-2025-000123"
  driverId        String
  subject         String
  category        DriverSupportCategory
  subcategory     String? // Dynamic subcategory within main category
  tripId          String? // Optional: linked ride/delivery ID
  priority        RestaurantSupportPriority @default(normal)
  status          RestaurantSupportStatus   @default(open)
  description     String                    @db.Text
  attachmentUrls  Json? // Array of attachment URLs
  channel         String                    @default("web") // email, phone, chat
  adminNotes      String?                   @db.Text // Internal notes (not visible to driver)
  assignedAdminId String? // Admin assigned to this ticket
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  resolvedAt      DateTime?

  driver        DriverProfile                @relation("DriverSupportTickets", fields: [driverId], references: [id], onDelete: Cascade)
  assignedAdmin User?                        @relation("AssignedDriverTickets", fields: [assignedAdminId], references: [id])
  messages      DriverSupportMessage[]
  statusHistory DriverSupportStatusHistory[]

  @@index([driverId])
  @@index([status])
  @@index([category])
  @@index([assignedAdminId])
  @@index([createdAt])
  @@map("driver_support_tickets")
}

model DriverSupportStatusHistory {
  id             String                   @id @default(uuid())
  ticketId       String
  previousStatus RestaurantSupportStatus?
  newStatus      RestaurantSupportStatus
  changedById    String? // User who made the change
  changedByRole  String // "driver" | "admin" | "system"
  note           String? // Optional note about the status change
  createdAt      DateTime                 @default(now())

  ticket    DriverSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  changedBy User?               @relation("DriverTicketStatusChanges", fields: [changedById], references: [id])

  @@index([ticketId])
  @@index([createdAt])
  @@map("driver_support_status_history")
}

model DriverSupportMessage {
  id             String   @id @default(uuid())
  ticketId       String
  senderRole     String // "driver" | "support"
  senderName     String // Display name of sender
  messageBody    String   @db.Text
  attachmentUrls Json? // Array of attachment URLs
  createdAt      DateTime @default(now())

  ticket DriverSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
  @@map("driver_support_messages")
}

// Customer Support Center Models (Phase 12 Extension)
model CustomerSupportTicket {
  id             String                    @id @default(uuid())
  ticketCode     String                    @unique // e.g., "CST-2025-000123"
  customerId     String
  subject        String
  category       RestaurantSupportCategory
  priority       RestaurantSupportPriority @default(normal)
  status         RestaurantSupportStatus   @default(open)
  description    String                    @db.Text
  attachmentUrls Json? // Array of attachment URLs
  channel        String                    @default("web") // email, phone, chat
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  resolvedAt     DateTime?

  customer CustomerProfile          @relation("CustomerSupportTickets", fields: [customerId], references: [id], onDelete: Cascade)
  messages CustomerSupportMessage[]

  @@index([customerId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("customer_support_tickets")
}

model CustomerSupportMessage {
  id             String   @id @default(uuid())
  ticketId       String
  senderRole     String // "customer" | "support"
  senderName     String // Display name of sender
  messageBody    String   @db.Text
  attachmentUrls Json? // Array of attachment URLs
  createdAt      DateTime @default(now())

  ticket CustomerSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
  @@map("customer_support_messages")
}

// Admin Support Center Models (Phase 12 Extension)
model AdminSupportTicket {
  id             String                    @id @default(uuid())
  ticketCode     String                    @unique // e.g., "AST-2025-000123"
  adminId        String
  subject        String
  category       RestaurantSupportCategory
  priority       RestaurantSupportPriority @default(normal)
  status         RestaurantSupportStatus   @default(open)
  description    String                    @db.Text
  attachmentUrls Json? // Array of attachment URLs
  channel        String                    @default("web") // email, phone, chat
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  resolvedAt     DateTime?

  admin    AdminProfile          @relation("AdminSupportTickets", fields: [adminId], references: [id], onDelete: Cascade)
  messages AdminSupportMessage[]

  @@index([adminId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("admin_support_tickets")
}

model AdminSupportMessage {
  id             String   @id @default(uuid())
  ticketId       String
  senderRole     String // "admin" | "support"
  senderName     String // Display name of sender
  messageBody    String   @db.Text
  attachmentUrls Json? // Array of attachment URLs
  createdAt      DateTime @default(now())

  ticket AdminSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
  @@map("admin_support_messages")
}

// Restaurant Live Chat (existing)
model LiveChatSession {
  id           String         @id @default(uuid())
  restaurantId String
  agentId      String?
  agentName    String?
  status       LiveChatStatus @default(waiting)
  startedAt    DateTime       @default(now())
  endedAt      DateTime?
  updatedAt    DateTime       @updatedAt

  restaurant RestaurantProfile @relation("LiveChatSessions", fields: [restaurantId], references: [id], onDelete: Cascade)
  messages   LiveChatMessage[]

  @@index([restaurantId])
  @@index([status])
  @@index([startedAt])
  @@map("live_chat_sessions")
}

model LiveChatMessage {
  id             String   @id @default(uuid())
  sessionId      String
  senderRole     String // "restaurant" | "agent"
  senderName     String
  messageBody    String   @db.Text
  attachmentUrls Json?
  isTyping       Boolean  @default(false)
  createdAt      DateTime @default(now())

  session LiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("live_chat_messages")
}

// Driver Live Chat
model DriverLiveChatSession {
  id        String         @id @default(uuid())
  driverId  String
  agentId   String?
  agentName String?
  status    LiveChatStatus @default(waiting)
  startedAt DateTime       @default(now())
  endedAt   DateTime?
  updatedAt DateTime       @updatedAt

  driver   DriverProfile           @relation("DriverLiveChatSessions", fields: [driverId], references: [id], onDelete: Cascade)
  messages DriverLiveChatMessage[]

  @@index([driverId])
  @@index([status])
  @@index([startedAt])
  @@map("driver_live_chat_sessions")
}

model DriverLiveChatMessage {
  id             String   @id @default(uuid())
  sessionId      String
  senderRole     String // "driver" | "agent"
  senderName     String
  messageBody    String   @db.Text
  attachmentUrls Json?
  isTyping       Boolean  @default(false)
  createdAt      DateTime @default(now())

  session DriverLiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("driver_live_chat_messages")
}

// Customer Live Chat
model CustomerLiveChatSession {
  id         String         @id @default(uuid())
  customerId String
  agentId    String?
  agentName  String?
  status     LiveChatStatus @default(waiting)
  startedAt  DateTime       @default(now())
  endedAt    DateTime?
  updatedAt  DateTime       @updatedAt

  customer CustomerProfile           @relation("CustomerLiveChatSessions", fields: [customerId], references: [id], onDelete: Cascade)
  messages CustomerLiveChatMessage[]

  @@index([customerId])
  @@index([status])
  @@index([startedAt])
  @@map("customer_live_chat_sessions")
}

model CustomerLiveChatMessage {
  id             String   @id @default(uuid())
  sessionId      String
  senderRole     String // "customer" | "agent"
  senderName     String
  messageBody    String   @db.Text
  attachmentUrls Json?
  isTyping       Boolean  @default(false)
  createdAt      DateTime @default(now())

  session CustomerLiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("customer_live_chat_messages")
}

// Admin Live Chat
model AdminLiveChatSession {
  id        String         @id @default(uuid())
  adminId   String
  agentId   String?
  agentName String?
  status    LiveChatStatus @default(waiting)
  startedAt DateTime       @default(now())
  endedAt   DateTime?
  updatedAt DateTime       @updatedAt

  admin    AdminProfile           @relation("AdminLiveChatSessions", fields: [adminId], references: [id], onDelete: Cascade)
  messages AdminLiveChatMessage[]

  @@index([adminId])
  @@index([status])
  @@index([startedAt])
  @@map("admin_live_chat_sessions")
}

model AdminLiveChatMessage {
  id             String   @id @default(uuid())
  sessionId      String
  senderRole     String // "admin" | "agent"
  senderName     String
  messageBody    String   @db.Text
  attachmentUrls Json?
  isTyping       Boolean  @default(false)
  createdAt      DateTime @default(now())

  session AdminLiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("admin_live_chat_messages")
}

// Restaurant Support Callback (existing)
model SupportCallback {
  id            String         @id @default(uuid())
  restaurantId  String
  phoneNumber   String
  preferredTime String
  timezone      String         @default("UTC")
  reason        String         @db.Text
  status        CallbackStatus @default(pending)
  createdAt     DateTime       @default(now())
  completedAt   DateTime?

  restaurant RestaurantProfile @relation("SupportCallbacks", fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([status])
  @@index([createdAt])
  @@map("support_callbacks")
}

// Driver Support Callback
model DriverSupportCallback {
  id            String         @id @default(uuid())
  driverId      String
  phoneNumber   String
  preferredTime String
  timezone      String         @default("UTC")
  reason        String         @db.Text
  status        CallbackStatus @default(pending)
  createdAt     DateTime       @default(now())
  completedAt   DateTime?

  driver DriverProfile @relation("DriverSupportCallbacks", fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("driver_support_callbacks")
}

// Customer Support Callback
model CustomerSupportCallback {
  id            String         @id @default(uuid())
  customerId    String
  phoneNumber   String
  preferredTime String
  timezone      String         @default("UTC")
  reason        String         @db.Text
  status        CallbackStatus @default(pending)
  createdAt     DateTime       @default(now())
  completedAt   DateTime?

  customer CustomerProfile @relation("CustomerSupportCallbacks", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("customer_support_callbacks")
}

// Admin Support Callback
model AdminSupportCallback {
  id            String         @id @default(uuid())
  adminId       String
  phoneNumber   String
  preferredTime String
  timezone      String         @default("UTC")
  reason        String         @db.Text
  status        CallbackStatus @default(pending)
  createdAt     DateTime       @default(now())
  completedAt   DateTime?

  admin AdminProfile @relation("AdminSupportCallbacks", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([status])
  @@index([createdAt])
  @@map("admin_support_callbacks")
}

model SupportArticle {
  id              String   @id @default(uuid())
  category        String
  title           String
  slug            String   @unique
  content         String   @db.Text
  isPublished     Boolean  @default(true)
  viewCount       Int      @default(0)
  helpfulCount    Int      @default(0)
  relatedArticles Json? // Array of article IDs
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
  @@index([viewCount])
  @@map("support_articles")
}

// ====================================================
// R6: Restaurant Earnings & Commission Center
// ====================================================

// Commission Rule: Base + category-level commission rates
model CommissionRule {
  id               String    @id @default(uuid())
  restaurantId     String? // null = global/default rule
  categoryId       String? // null = base commission rule
  commissionRate   Decimal   @db.Decimal(5, 2) // Percentage (0-100)
  effectiveFrom    DateTime  @default(now())
  effectiveTo      DateTime? // null = indefinite
  isActive         Boolean   @default(true)
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category   Category?          @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, categoryId, effectiveFrom])
  @@index([restaurantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([effectiveFrom])
  @@map("commission_rules")
}

enum EarningsStatus {
  pending // Order placed, awaiting completion
  cleared // Order completed, earnings available
  refunded // Order refunded, earnings reversed
  adjusted // Manual adjustment by admin
}

// Detailed earnings tracking per order with commission breakdown
model EarningsTransaction {
  id                       String         @id @default(uuid())
  restaurantId             String
  orderId                  String         @unique // One earnings record per order
  orderStatus              String // FoodOrder status snapshot
  grossAmount              Decimal        @db.Decimal(12, 2) // Total order value
  serviceFare              Decimal        @db.Decimal(12, 2) // From FoodOrder
  baseCommission           Decimal        @db.Decimal(12, 2) // Calculated base commission
  categoryCommission       Decimal?       @db.Decimal(12, 2) // Additional category commission
  totalCommission          Decimal        @db.Decimal(12, 2) // Base + category
  netEarnings              Decimal        @db.Decimal(12, 2) // serviceFare - totalCommission
  status                   EarningsStatus @default(pending)
  clearedAt                DateTime? // When earnings became available
  refundedAt               DateTime? // When order was refunded
  adjustedAt               DateTime? // Manual adjustment timestamp
  adjustmentReason         String?        @db.Text
  adjustedByAdminId        String?
  commissionRuleId         String? // Applied commission rule
  categoryCommissionRuleId String? // Applied category rule
  countryCode              String
  currency                 String
  isDemo                   Boolean        @default(false)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order      FoodOrder         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([orderId])
  @@index([status])
  @@index([clearedAt])
  @@index([createdAt])
  @@index([countryCode])
  @@index([isDemo])
  @@map("earnings_transactions")
}

// Aggregated daily/monthly earnings summary for performance
model EarningsSummary {
  id              String   @id @default(uuid())
  restaurantId    String
  periodType      String // "daily", "weekly", "monthly"
  periodStart     DateTime
  periodEnd       DateTime
  totalOrders     Int      @default(0)
  grossRevenue    Decimal  @default(0) @db.Decimal(12, 2)
  totalCommission Decimal  @default(0) @db.Decimal(12, 2)
  netEarnings     Decimal  @default(0) @db.Decimal(12, 2)
  pendingEarnings Decimal  @default(0) @db.Decimal(12, 2)
  clearedEarnings Decimal  @default(0) @db.Decimal(12, 2)
  refundedAmount  Decimal  @default(0) @db.Decimal(12, 2)
  currency        String
  isDemo          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, periodType, periodStart])
  @@index([restaurantId])
  @@index([periodType])
  @@index([periodStart])
  @@index([isDemo])
  @@map("earnings_summaries")
}

// ====================================================
// D5: DRIVER PROMOTIONS & INCENTIVES SYSTEM
// ====================================================

enum DriverPromotionType {
  PER_TRIP_BONUS // Fixed bonus per completed trip
  QUEST_TRIPS // Complete X trips to earn bonus
  EARNINGS_THRESHOLD // Earn X amount to get bonus
}

enum DriverPromotionStatus {
  DRAFT // Not yet active, being configured
  ACTIVE // Currently running
  PAUSED // Temporarily stopped
  ENDED // Completed or expired
}

enum DriverPromotionServiceType {
  RIDES // Ride-hailing trips only
  FOOD // Food delivery only
  PARCEL // Parcel delivery only
  ANY // All service types
}

model DriverPromotion {
  id                 String                     @id @default(uuid())
  name               String
  description        String?                    @db.Text
  type               DriverPromotionType
  serviceType        DriverPromotionServiceType @default(ANY)
  countryCode        String? // null = all countries
  cityCode           String? // null = all cities in country
  minDriverRating    Decimal?                   @db.Decimal(3, 2) // e.g., 4.50
  requireKycApproved Boolean                    @default(true)
  startAt            DateTime
  endAt              DateTime
  rewardPerUnit      Decimal                    @db.Decimal(10, 2) // Bonus per trip or per threshold
  targetTrips        Int? // For QUEST_TRIPS type
  targetEarnings     Decimal?                   @db.Decimal(10, 2) // For EARNINGS_THRESHOLD type
  maxRewardPerDriver Decimal?                   @db.Decimal(10, 2) // Cap per driver
  globalBudget       Decimal?                   @db.Decimal(12, 2) // Total budget for promotion
  currentSpend       Decimal                    @default(0) @db.Decimal(12, 2) // Track spending
  status             DriverPromotionStatus      @default(DRAFT)
  createdByAdminId   String?
  updatedByAdminId   String?
  isDemo             Boolean                    @default(false)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  progress     DriverPromotionProgress[]
  payouts      DriverPromotionPayout[]
  rewardLedger DriverRewardLedger[] // D19: Reward ledger entries

  @@index([status])
  @@index([startAt])
  @@index([endAt])
  @@index([countryCode])
  @@index([cityCode])
  @@index([serviceType])
  @@index([type])
  @@index([isDemo])
  @@map("driver_promotions")
}

model DriverPromotionProgress {
  id               String   @id @default(uuid())
  promotionId      String
  driverId         String // References driver_profile.id
  currentTrips     Int      @default(0)
  currentEarnings  Decimal  @default(0) @db.Decimal(10, 2)
  totalBonusEarned Decimal  @default(0) @db.Decimal(10, 2)
  lastUpdatedAt    DateTime @default(now())
  createdAt        DateTime @default(now())

  promotion DriverPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  driver    DriverProfile   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([promotionId, driverId])
  @@index([promotionId])
  @@index([driverId])
  @@index([lastUpdatedAt])
  @@map("driver_promotion_progress")
}

model DriverPromotionPayout {
  id                  String   @id @default(uuid())
  promotionId         String
  driverId            String // References driver_profile.id
  walletTransactionId String? // Reference to wallet transaction
  amount              Decimal  @db.Decimal(10, 2)
  tripType            String? // "ride", "food", "parcel"
  tripId              String? // Reference to the triggering trip
  createdAt           DateTime @default(now())

  promotion DriverPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  driver    DriverProfile   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([promotionId])
  @@index([driverId])
  @@index([tripId])
  @@index([createdAt])
  @@map("driver_promotion_payouts")
}

// ====================================================
// D19: Driver Incentives & Milestones Center
// ====================================================

enum IncentiveGoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

enum IncentiveGoalType {
  TRIPS // Complete X trips
  EARNINGS // Earn X amount
  RATING // Maintain X rating
}

enum IncentiveCycleStatus {
  ACTIVE // Currently in progress
  COMPLETED // Goal achieved
  EXPIRED // Period ended without completion
  BONUS_PAID // Completed and bonus issued
}

enum AchievementType {
  FIVE_STAR_WEEK // Maintain 5.0 rating for 7 days
  ZERO_CANCEL_STREAK // 0 cancellations for X trips
  HUNDRED_RIDES // Complete 100 trips lifetime
  WEEKLY_PRO_DRIVER // Meet weekly pro criteria
  THOUSAND_TRIPS // Complete 1000 trips lifetime
  FIRST_TRIP // Complete first trip ever
  EARLY_BIRD // Complete 10 trips before 8am
  NIGHT_OWL // Complete 10 trips after 10pm
  FIVE_STAR_MONTH // Maintain 4.9+ rating for 30 days
  PERFECT_STREAK_10 // 10 trips with 5-star ratings
  LOYALTY_30_DAYS // Active for 30 consecutive days
  LOYALTY_90_DAYS // Active for 90 consecutive days
}

enum RewardType {
  TIER_BONUS // Bonus for reaching new tier
  PROMO_BONUS // Bonus from promotion completion
  ACHIEVEMENT_BONUS // Bonus from achievement unlock
  INCENTIVE_BONUS // Bonus from incentive goal completion
  REFERRAL_BONUS // Bonus from referral program
}

enum DriverRewardTier {
  BRONZE // Entry level: 0-499 points
  SILVER // Mid level: 500-1499 points
  GOLD // High level: 1500+ points
}

model DriverIncentiveCycle {
  id           String               @id @default(uuid())
  driverId     String
  period       IncentiveGoalPeriod
  goalType     IncentiveGoalType
  targetValue  Int // Target trips count or earnings amount (in cents)
  currentValue Int                  @default(0) // Current progress
  periodStart  DateTime
  periodEnd    DateTime
  bonusAmount  Decimal              @db.Decimal(10, 2) // Bonus for completing goal
  currency     String               @default("USD")
  status       IncentiveCycleStatus @default(ACTIVE)
  completedAt  DateTime?
  bonusPaidAt  DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  driver DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, period, goalType, periodStart])
  @@index([driverId])
  @@index([status])
  @@index([periodEnd])
  @@map("driver_incentive_cycles")
}

model DriverAchievement {
  id              String          @id @default(uuid())
  driverId        String
  achievementType AchievementType
  isUnlocked      Boolean         @default(false)
  unlockedAt      DateTime?
  progressCount   Int             @default(0) // Current progress towards unlock
  requiredCount   Int // Required count to unlock
  streakCount     Int             @default(0) // For streak-based achievements
  streakStartDate DateTime? // When current streak started
  bonusAmount     Decimal?        @db.Decimal(10, 2) // Bonus for unlocking
  currency        String          @default("USD")
  bonusPaid       Boolean         @default(false)
  bonusPaidAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  driver DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, achievementType])
  @@index([driverId])
  @@index([achievementType])
  @@index([isUnlocked])
  @@map("driver_achievements")
}

model DriverRewardLedger {
  id                  String            @id @default(uuid())
  driverId            String
  rewardType          RewardType
  tier                DriverRewardTier?
  amount              Decimal           @db.Decimal(10, 2)
  currency            String            @default("USD")
  description         String
  promotionId         String? // Reference to promotion if applicable
  achievementId       String? // Reference to achievement if applicable
  incentiveCycleId    String? // Reference to incentive cycle if applicable
  walletTransactionId String? // Reference to wallet transaction if paid out
  isPaid              Boolean           @default(false)
  paidAt              DateTime?
  issuedAt            DateTime          @default(now())
  createdAt           DateTime          @default(now())

  driver    DriverProfile    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  promotion DriverPromotion? @relation(fields: [promotionId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([rewardType])
  @@index([tier])
  @@index([issuedAt])
  @@index([isPaid])
  @@map("driver_reward_ledger")
}

// ========================================
// MULTI-ROUTE FARE ENGINE (USA)
// ========================================

enum RideTypeCode {
  SAVER
  STANDARD
  COMFORT
  XL
  PREMIUM
}

// Ride type configuration with base pricing
model RideType {
  id          String       @id @default(uuid())
  code        RideTypeCode @unique
  name        String // Display name (e.g., "SafeGo X", "SafeGo Comfort")
  description String?
  iconType    String       @default("economy") // economy, comfort, xl, premium
  capacity    Int          @default(4)
  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  fareConfigs RideFareConfig[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("ride_types")
}

// Per-country/city fare configuration for each ride type
model RideFareConfig {
  id          String  @id @default(uuid())
  rideTypeId  String
  countryCode String  @default("US")
  cityCode    String? // null = country-wide default

  // Base fare components (USD)
  baseFare      Decimal @default(2.50) @db.Decimal(10, 2)
  perMileRate   Decimal @default(1.50) @db.Decimal(10, 4)
  perMinuteRate Decimal @default(0.30) @db.Decimal(10, 4)
  minimumFare   Decimal @default(5.00) @db.Decimal(10, 2)

  // Driver rates (for payout calculation)
  driverPerMileRate   Decimal @default(1.20) @db.Decimal(10, 4)
  driverPerMinuteRate Decimal @default(0.20) @db.Decimal(10, 4)

  // Service fee configuration
  serviceFeePercent Decimal @default(15.00) @db.Decimal(5, 2) // SafeGo service fee %
  serviceFeeMinimum Decimal @default(1.50) @db.Decimal(10, 2)
  serviceFeeMaximum Decimal @default(10.00) @db.Decimal(10, 2)

  // Surge configuration
  maxSurgeMultiplier Decimal @default(3.00) @db.Decimal(4, 2)
  surgeEnabled       Boolean @default(true)

  // Traffic adjustment (multiplier applied based on traffic severity)
  trafficMultiplierLight    Decimal @default(1.00) @db.Decimal(4, 2)
  trafficMultiplierModerate Decimal @default(1.10) @db.Decimal(4, 2)
  trafficMultiplierHeavy    Decimal @default(1.25) @db.Decimal(4, 2)

  isActive         Boolean   @default(true)
  version          Int       @default(1)
  effectiveFrom    DateTime  @default(now())
  effectiveTo      DateTime? // null = currently active
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  updatedByAdminId String?

  rideType RideType @relation(fields: [rideTypeId], references: [id], onDelete: Cascade)

  @@unique([rideTypeId, countryCode, cityCode, version])
  @@index([countryCode])
  @@index([cityCode])
  @@index([isActive])
  @@index([effectiveFrom])
  @@map("ride_fare_configs")
}

enum RegulatoryZoneType {
  AIRPORT
  CONGESTION
  CITY_BOUNDARY
  BLACK_CAR_FUND
  SPECIAL_TAX
}

// Polygon-based regulatory zones (airports, congestion zones, city boundaries)
model RegulatoryZone {
  id          String             @id @default(uuid())
  name        String // e.g., "JFK Airport", "Manhattan Congestion Zone"
  zoneType    RegulatoryZoneType
  countryCode String             @default("US")
  stateCode   String? // e.g., "NY"
  cityCode    String?

  // Polygon definition (JSON array of {lat, lng} points)
  polygonCoordinates Json // [{lat: number, lng: number}, ...]

  // Simple bounding box for quick pre-filtering
  boundingBoxMinLat Float?
  boundingBoxMaxLat Float?
  boundingBoxMinLng Float?
  boundingBoxMaxLng Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  feeConfigs RegulatoryFeeConfig[]

  @@index([zoneType])
  @@index([countryCode])
  @@index([stateCode])
  @@index([isActive])
  @@map("regulatory_zones")
}

enum RegulatoryFeeType {
  BLACK_CAR_FUND // NY BCF - 2.5% of fare
  CITY_BOUNDARY_LEAVING // Leaving city fee
  CITY_BOUNDARY_ENTERING // Entering city fee
  LOCAL_TAX // Local government ride tax
  AIRPORT_FEE // Airport pickup/dropoff fee
  CONGESTION_FEE // Congestion zone surcharge
}

// Fee configurations for regulatory zones
model RegulatoryFeeConfig {
  id      String            @id @default(uuid())
  zoneId  String
  feeType RegulatoryFeeType

  // Fee can be flat or percentage-based
  flatFeeAmount  Decimal? @db.Decimal(10, 2)
  percentFeeRate Decimal? @db.Decimal(5, 2) // e.g., 2.5 for BCF

  // When fee applies
  appliesToPickup  Boolean @default(true)
  appliesToDropoff Boolean @default(true)

  // Description for customer display
  displayName String // e.g., "Airport Surcharge", "Black Car Fund"
  description String?

  isActive         Boolean   @default(true)
  version          Int       @default(1)
  effectiveFrom    DateTime  @default(now())
  effectiveTo      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  updatedByAdminId String?

  zone RegulatoryZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId])
  @@index([feeType])
  @@index([isActive])
  @@map("regulatory_fee_configs")
}

// Toll segment configurations for known toll roads/bridges
model TollConfig {
  id          String  @id @default(uuid())
  name        String // e.g., "George Washington Bridge", "Holland Tunnel"
  countryCode String  @default("US")
  stateCode   String?

  // Toll segment identification - can match by road name or coordinates
  segmentIdentifier    String // Road name or segment ID from mapping provider
  alternateIdentifiers String[] @default([]) // Alternative names/IDs

  // Coordinates for segment (start/end points for matching)
  startLat Float?
  startLng Float?
  endLat   Float?
  endLng   Float?

  // Toll rates by vehicle type
  tollRateSaver    Decimal @default(0) @db.Decimal(10, 2)
  tollRateStandard Decimal @default(0) @db.Decimal(10, 2)
  tollRateComfort  Decimal @default(0) @db.Decimal(10, 2)
  tollRateXL       Decimal @default(0) @db.Decimal(10, 2)
  tollRatePremium  Decimal @default(0) @db.Decimal(10, 2)

  // Driver keeps 100% of tolls
  tollPaidToDriver Boolean @default(true)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  @@index([stateCode])
  @@index([isActive])
  @@map("toll_configs")
}

enum FeeRuleType {
  CANCELLATION_FEE
  WAITING_FEE
  BOOKING_FEE
  SAFETY_FEE
  CLEAN_AIR_FEE
  INSURANCE_SURCHARGE
  ECO_FEE
}

// General configurable fees (cancellation, waiting, safety, eco)
model FeeRule {
  id          String      @id @default(uuid())
  feeType     FeeRuleType
  countryCode String      @default("US")
  cityCode    String?

  // Fee amount (flat or per-unit)
  flatAmount    Decimal? @db.Decimal(10, 2)
  perUnitAmount Decimal? @db.Decimal(10, 4) // e.g., per minute for waiting
  unitType      String? // "minute", "mile", "percent"

  // Thresholds
  freeUnits  Int?     @default(0) // e.g., 2 free minutes for waiting
  minimumFee Decimal? @db.Decimal(10, 2)
  maximumFee Decimal? @db.Decimal(10, 2)

  // Conditions
  requiresDriverAssigned    Boolean @default(false) // For cancellation fees
  minimumMinutesAfterAccept Int? // e.g., no cancel fee within 2 mins

  displayName String
  description String?

  isActive         Boolean   @default(true)
  version          Int       @default(1)
  effectiveFrom    DateTime  @default(now())
  effectiveTo      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  updatedByAdminId String?

  @@unique([feeType, countryCode, cityCode, version])
  @@index([feeType])
  @@index([countryCode])
  @@index([isActive])
  @@map("fee_rules")
}

// Audit log for fare calculations (security and compliance)
model FareCalculationLog {
  id         String  @id @default(uuid())
  rideId     String? // Reference to ride if booked
  customerId String?

  // Route information
  pickupLat              Float
  pickupLng              Float
  dropoffLat             Float
  dropoffLng             Float
  routeId                String? // Geometry-based route identifier
  distanceMiles          Float
  durationMinutes        Int
  trafficDurationMinutes Int?

  // Selected options
  rideTypeCode      String
  selectedRouteType String? // fastest, shortest, avoid_highways, avoid_tolls

  // Calculated fare breakdown (stored as JSON for flexibility)
  fareBreakdown Json // Full breakdown with all components

  // Summary amounts for quick queries
  baseFare            Decimal @db.Decimal(10, 2)
  distanceFare        Decimal @db.Decimal(10, 2)
  timeFare            Decimal @db.Decimal(10, 2)
  trafficAdjustment   Decimal @default(0) @db.Decimal(10, 2)
  surgeAmount         Decimal @default(0) @db.Decimal(10, 2)
  surgeMultiplier     Decimal @default(1.00) @db.Decimal(4, 2)
  tollsTotal          Decimal @default(0) @db.Decimal(10, 2)
  regulatoryFeesTotal Decimal @default(0) @db.Decimal(10, 2)
  serviceFee          Decimal @db.Decimal(10, 2)
  discountAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalFare           Decimal @db.Decimal(10, 2)

  // Driver payout calculation
  driverPayout     Decimal @db.Decimal(10, 2)
  safegoCommission Decimal @db.Decimal(10, 2)

  // Matched zones and fees
  matchedZones String[] @default([]) // Zone IDs that matched
  appliedFees  Json? // Detailed fee application log

  // All route alternatives that were calculated
  routeAlternatives Json? // All routes with their fares

  calculatedAt DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  @@index([rideId])
  @@index([customerId])
  @@index([calculatedAt])
  @@index([rideTypeCode])
  @@map("fare_calculation_logs")
}

// ============================================
// PROMOTION ENGINE MODELS
// ============================================

enum PromoType {
  ANCHOR_ONLY // Psychological anchor (0% real discount)
  SAVER // Wait longer for discount (2-3%)
  FIRST_RIDE // First ride only (up to $7 off)
  TIME_BASED // Off-peak hours discount
  LOCATION_BASED // Low-demand zone discount
  PAYMENT_METHOD // Wallet payment bonus
  REWARD_POINTS // Points accumulation
  DRIVER_ARRIVAL // Late arrival credit
}

// Promo configuration by type and region
model PromoConfig {
  id          String    @id @default(uuid())
  promoType   PromoType
  countryCode String    @default("US")
  cityCode    String?

  // Display information
  name        String // e.g., "Welcome Discount"
  displayTag  String // e.g., "First Ride", "Saver"
  description String?

  // Discount parameters
  discountPercent   Decimal? @db.Decimal(5, 2) // e.g., 3.00 for 3%
  discountMaxAmount Decimal? @db.Decimal(10, 2) // Max absolute discount
  discountMinFare   Decimal? @db.Decimal(10, 2) // Minimum fare after discount

  // Anchor pricing multiplier (default 1.10 = 10% markup for anchor)
  anchorMultiplier Decimal @default(1.10) @db.Decimal(4, 2)

  // Time-based rules (for TIME_BASED promo)
  validDaysOfWeek Int[] @default([]) // 0=Sunday, 6=Saturday
  validStartHour  Int? // 0-23
  validEndHour    Int? // 0-23

  // Loss protection limits
  maxUsesPerUser Int? // Per cooldown period
  cooldownDays   Int? @default(7) // Cooldown period in days
  maxUsesPerDay  Int? // Global daily limit

  // Surge blocking
  maxSurgeAllowed Decimal? @default(1.30) @db.Decimal(4, 2) // Block promo if surge > this

  // Priority for stacking (higher = applied first)
  priority  Int     @default(0)
  stackable Boolean @default(false) // Can combine with other promos

  // Wallet-only flag
  walletOnly Boolean @default(false)

  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([promoType, countryCode, cityCode])
  @@index([promoType])
  @@index([countryCode])
  @@index([isActive])
  @@map("promo_configs")
}

// Low-demand zones for location-based promos
model LowDemandZone {
  id          String  @id @default(uuid())
  name        String // e.g., "Staten Island Outer"
  countryCode String  @default("US")
  cityCode    String?

  // Polygon coordinates [[lat, lng], ...]
  polygonCoordinates Json

  // Bounding box for quick filtering
  boundingBoxMinLat Float?
  boundingBoxMaxLat Float?
  boundingBoxMinLng Float?
  boundingBoxMaxLng Float?

  // Zone-specific discount
  discountPercent Decimal @default(2.00) @db.Decimal(5, 2)

  // Demand level (0-100, lower = less demand)
  demandLevel Int @default(50)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  @@index([cityCode])
  @@index([isActive])
  @@map("low_demand_zones")
}

// User promo usage tracking
model UserPromoUsage {
  id     String @id @default(uuid())
  userId String

  // First ride tracking
  firstRideUsed   Boolean   @default(false)
  firstRideUsedAt DateTime?
  firstRideRideId String?

  // Weekly usage counters (reset every 7 days)
  weeklyPromoCount Int      @default(0)
  weeklyResetAt    DateTime @default(now())

  // Reward points balance
  rewardPointsBalance  Int @default(0)
  rewardPointsLifetime Int @default(0)

  // Total savings
  totalSavingsAmount Decimal @default(0) @db.Decimal(12, 2)
  totalAnchorSavings Decimal @default(0) @db.Decimal(12, 2) // Perceived savings

  // Driver arrival credits
  arrivalCreditsBalance Decimal @default(0) @db.Decimal(10, 2)

  // Last promo usage
  lastPromoType   PromoType?
  lastPromoUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([userId])
  @@map("user_promo_usage")
}

// Promo application log (audit trail)
model PromoLog {
  id                   String  @id @default(uuid())
  userId               String?
  rideId               String?
  fareCalculationLogId String?

  // Promo details
  promoType     PromoType
  promoConfigId String?

  // Fare information
  originalFare Decimal @db.Decimal(10, 2)
  anchorFare   Decimal @db.Decimal(10, 2)
  finalFare    Decimal @db.Decimal(10, 2)

  // Discount breakdown
  actualDiscountAmount Decimal @default(0) @db.Decimal(10, 2)
  perceivedSavings     Decimal @default(0) @db.Decimal(10, 2) // anchor - final
  companyLoss          Decimal @default(0) @db.Decimal(10, 2) // original - final

  // Rules applied
  discountPercentApplied Decimal? @db.Decimal(5, 2)
  lossCapApplied         Boolean  @default(false)
  minimumFareApplied     Boolean  @default(false)

  // Blocking reasons (if promo was blocked)
  wasBlocked  Boolean @default(false)
  blockReason String? // e.g., "surge_too_high", "cooldown_active"

  // Context
  surgeMultiplier Decimal? @db.Decimal(4, 2)
  paymentMethod   String?
  isWalletPayment Boolean  @default(false)

  // Abuse detection flags
  suspiciousActivity Boolean @default(false)
  suspiciousReason   String?

  // Metadata
  ipAddress         String?
  userAgent         String?
  deviceFingerprint String?

  appliedAt DateTime @default(now())

  @@index([userId])
  @@index([rideId])
  @@index([promoType])
  @@index([appliedAt])
  @@index([wasBlocked])
  @@map("promo_logs")
}

// ============================================
// GLOBAL RIDE PROMOTION ENGINE (C6)
// ============================================

enum RidePromoUserRule {
  ALL_RIDES // Applied to every ride
  FIRST_RIDE // Only for user's first ride
  N_RIDES // Applied to first N rides
}

enum RidePromoAppliesTo {
  ALL // All rides globally
  CITY // Specific cities only
  CATEGORY // Specific vehicle categories
  USER_SEGMENT // Specific user segments
}

enum RidePromoDiscountMode {
  PERCENT // Percentage discount
  FLAT // Fixed amount discount
}

// Global ride promotions (auto-applied, admin-managed)
model RidePromotion {
  id String @id @default(uuid())

  // Basic info
  name        String // e.g., "SafeGo Everyday Saver"
  description String? @db.Text

  // Discount configuration
  discountType      RidePromoDiscountMode @default(PERCENT)
  value             Decimal               @db.Decimal(10, 2) // Percentage (0-100) or flat amount
  maxDiscountAmount Decimal?              @db.Decimal(10, 2) // Cap for percentage discounts

  // Targeting
  appliesTo          RidePromoAppliesTo @default(ALL)
  targetCities       String[]           @default([]) // City codes (if CITY)
  targetCategories   String[]           @default([]) // Vehicle categories (if CATEGORY)
  targetUserSegments String[]           @default([]) // User segments (if USER_SEGMENT)

  // User eligibility rules
  userRule       RidePromoUserRule @default(ALL_RIDES)
  rideCountLimit Int? // For N_RIDES: apply to first N rides

  // Surge control
  maxSurgeAllowed Decimal? @db.Decimal(4, 2) // Block promo if surge > this

  // Validity period
  startAt DateTime  @default(now())
  endAt   DateTime? // null = no expiry

  // Usage limits
  globalUsageLimit  Int? // Max total uses
  currentUsageCount Int  @default(0)
  usagePerUserLimit Int? // Max uses per user

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Default promo (e.g., Everyday Saver)
  priority  Int     @default(0) // Higher = applied first

  // Metadata
  createdBy String? // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages RidePromotionUsage[]

  @@index([isActive])
  @@index([isDefault])
  @@index([startAt, endAt])
  @@index([appliesTo])
  @@index([priority])
  @@map("ride_promotions")
}

// Track ride promotion usage per user
model RidePromotionUsage {
  id          String  @id @default(uuid())
  promotionId String
  userId      String
  rideId      String? // Set when ride is completed

  discountApplied Decimal @db.Decimal(10, 2)
  originalFare    Decimal @db.Decimal(10, 2)
  finalFare       Decimal @db.Decimal(10, 2)

  vehicleCategory String?
  cityCode        String?

  appliedAt DateTime @default(now())

  promotion RidePromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([promotionId])
  @@index([rideId])
  @@index([appliedAt])
  @@map("ride_promotion_usages")
}

// User-entered promo codes for rides
model RidePromoCode {
  id   String @id @default(uuid())
  code String @unique // e.g., "WELCOME10", "SUMMER2024"

  // Discount configuration
  discountType      RidePromoDiscountType @default(PERCENTAGE)
  discountValue     Decimal               @db.Decimal(10, 2) // Percentage or fixed amount
  maxDiscountAmount Decimal?              @db.Decimal(10, 2) // Cap for percentage discounts
  minFareAmount     Decimal?              @db.Decimal(10, 2) // Minimum fare required

  // Targeting
  countryCode String? // null = all countries
  cityCode    String? // null = all cities
  rideTypes   String[] @default([]) // Empty = all ride types

  // Usage limits
  maxTotalUses      Int? // null = unlimited
  maxUsesPerUser    Int? @default(1)
  currentUsageCount Int  @default(0)

  // Validity period
  validFrom DateTime  @default(now())
  validTo   DateTime? // null = no expiry

  // Conditions
  firstRideOnly     Boolean @default(false)
  newUsersOnly      Boolean @default(false) // Registered within last 7 days
  walletPaymentOnly Boolean @default(false)

  // Status
  isActive Boolean @default(true)

  // Metadata
  description   String?  @db.Text
  internalNotes String?  @db.Text
  createdBy     String? // Admin user ID
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Usage tracking relation
  usages RidePromoCodeUsage[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validTo])
  @@index([countryCode])
  @@map("ride_promo_codes")
}

enum RidePromoDiscountType {
  PERCENTAGE // Percentage off fare
  FIXED_AMOUNT // Fixed dollar amount off
  CAPPED_PERCENTAGE // Percentage with max cap
}

// Track promo code usage per user
model RidePromoCodeUsage {
  id          String  @id @default(uuid())
  promoCodeId String
  userId      String
  rideId      String? // Set when ride is completed

  discountApplied Decimal  @db.Decimal(10, 2)
  originalFare    Decimal? @db.Decimal(10, 2)
  finalFare       Decimal? @db.Decimal(10, 2)

  appliedAt DateTime @default(now())

  promoCode RidePromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([promoCodeId, userId, rideId])
  @@index([userId])
  @@index([promoCodeId])
  @@index([appliedAt])
  @@map("ride_promo_code_usages")
}

// ============================================================
// Phase 1A: Real-Time Dispatch Core
// ============================================================

enum DispatchServiceMode {
  ride
  food
  parcel
  offline
}

enum DispatchSessionStatus {
  requested
  searching_driver
  offer_pending
  driver_accepted
  driver_arriving
  in_progress
  completed
  no_driver_found
  cancelled_by_customer
  cancelled_by_driver
  cancelled_by_admin
  expired
}

// Driver real-time presence and location state
model DriverRealtimeState {
  id                  String              @id @default(uuid())
  driverId            String              @unique
  isOnline            Boolean             @default(false)
  isAvailable         Boolean             @default(false)
  currentServiceMode  DispatchServiceMode @default(offline)
  lastKnownLat        Float?
  lastKnownLng        Float?
  lastUpdateAt        DateTime            @default(now())
  countryCode         String?
  cityCode            String?
  currentAssignmentId String? // FK to DispatchSession
  connectedAt         DateTime? // When driver connected to WebSocket
  disconnectedAt      DateTime? // When driver disconnected

  driver            DriverProfile    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  currentAssignment DispatchSession? @relation("CurrentAssignment", fields: [currentAssignmentId], references: [id])

  @@index([isOnline, isAvailable])
  @@index([countryCode, cityCode])
  @@index([currentServiceMode])
  @@index([lastKnownLat, lastKnownLng])
  @@map("driver_realtime_states")
}

// Dispatch session for ride/food/parcel assignment
model DispatchSession {
  id                 String                @id @default(uuid())
  serviceType        DeliveryServiceType   @default(ride)
  entityId           String // FK to rides.id OR food_orders.id OR deliveries.id
  customerId         String
  assignedDriverId   String?
  candidateDriverIds String[]              @default([])
  rejectedDriverIds  String[]              @default([])
  expiredDriverIds   String[]              @default([])
  status             DispatchSessionStatus @default(requested)

  // Location data (denormalized for fast queries)
  pickupLat      Float?
  pickupLng      Float?
  dropoffLat     Float?
  dropoffLng     Float?
  pickupAddress  String?
  dropoffAddress String?

  // Timing
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  expiresAt  DateTime? // When entire session expires
  acceptedAt DateTime?

  // Jurisdiction (denormalized)
  countryCode String?
  cityCode    String?

  // Dispatch metadata
  maxRadiusKm           Float?
  offerTimeoutSeconds   Int?      @default(30)
  currentOfferDriverId  String? // Driver currently being offered
  currentOfferExpiresAt DateTime?
  searchRound           Int       @default(1)

  // Audit logs
  logs Json? // JSON array of status changes

  // Relations
  customer              CustomerProfile       @relation(fields: [customerId], references: [id])
  assignedDriver        DriverProfile?        @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  ride                  Ride?                 @relation("RideDispatch")
  driversWithAssignment DriverRealtimeState[] @relation("CurrentAssignment")
  offerEvents           DispatchOfferEvent[]

  @@index([serviceType, status])
  @@index([countryCode, cityCode])
  @@index([entityId])
  @@index([customerId])
  @@index([assignedDriverId])
  @@index([status])
  @@map("dispatch_sessions")
}

// Track individual offer events to drivers
model DispatchOfferEvent {
  id                String @id @default(uuid())
  dispatchSessionId String
  driverId          String

  offeredAt   DateTime  @default(now())
  expiresAt   DateTime
  respondedAt DateTime?
  response    String? // accept, reject, expired

  // Driver location at time of offer
  driverLat  Float?
  driverLng  Float?
  distanceKm Float?

  dispatchSession DispatchSession @relation(fields: [dispatchSessionId], references: [id], onDelete: Cascade)
  driver          DriverProfile   @relation(fields: [driverId], references: [id])

  @@index([dispatchSessionId])
  @@index([driverId])
  @@index([response])
  @@map("dispatch_offer_events")
}

// Phase 1B: Ride location telemetry for live tracking and fare recalculation
model RideTelemetryLocation {
  id       String @id @default(uuid())
  rideId   String
  driverId String

  lat      Float
  lng      Float
  heading  Float? // Compass heading in degrees
  speed    Float? // Speed in meters per second
  accuracy Float? // GPS accuracy in meters

  recordedAt DateTime @default(now())

  // Incremental distance tracking
  distanceFromPrevious Float? // Meters from previous point
  cumulativeDistance   Float? // Total meters traveled so far

  ride   Ride          @relation("RideTelemetry", fields: [rideId], references: [id], onDelete: Cascade)
  driver DriverProfile @relation(fields: [driverId], references: [id])

  @@index([rideId])
  @@index([driverId])
  @@index([recordedAt])
  @@map("ride_telemetry_locations")
}

// Phase 1B: In-trip messaging conversations
model TripConversation {
  id          String              @id @default(uuid())
  serviceType DeliveryServiceType @default(ride)
  entityId    String // FK to ride/food_order/delivery id

  customerId   String
  driverId     String?
  restaurantId String? // For food orders

  isActive Boolean   @default(true)
  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages   TripMessage[]
  customer   CustomerProfile    @relation(fields: [customerId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id])
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id])

  @@unique([serviceType, entityId])
  @@index([customerId])
  @@index([driverId])
  @@index([restaurantId])
  @@index([isActive])
  @@map("trip_conversations")
}

// Phase 1B: Individual messages in trip conversations
model TripMessage {
  id             String @id @default(uuid())
  conversationId String

  senderRole String // customer, driver, restaurant, admin
  senderId   String // ID of the sender profile

  text String @db.Text

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  conversation TripConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("trip_messages")
}

// ===== PHASE 2A: FINANCIAL INTEGRITY & WALLET SYSTEM =====

// Platform Revenue Ledger - Immutable record of all platform revenue
model PlatformRevenueLedger {
  id String @id @default(uuid())

  // Revenue source identification
  sourceType    String // commission | cancellation_fee | tip_fee | adjustment
  serviceType   DeliveryServiceType // ride | food | parcel
  referenceType String // ride | food_order | delivery | manual_adjustment
  referenceId   String // ID of the source entity

  // Actor involved
  actorType String // driver | restaurant
  actorId   String // ID of driver/restaurant profile

  // Financial details
  countryCode String // BD | US
  currency    String // BDT | USD
  grossAmount Decimal @db.Decimal(12, 2) // Total before any deductions
  netAmount   Decimal @db.Decimal(12, 2) // Amount credited to platform

  // Metadata
  description String @db.Text
  metadata    Json? // Additional context (e.g., fare breakdown)

  // Audit trail
  createdAt        DateTime @default(now())
  createdBySystem  Boolean  @default(true) // true = automated, false = manual
  createdByAdminId String? // Admin who created (if manual)

  // Idempotency
  idempotencyKey String? @unique // Prevents duplicate entries

  @@index([sourceType])
  @@index([serviceType])
  @@index([referenceType, referenceId])
  @@index([actorType, actorId])
  @@index([countryCode])
  @@index([createdAt])
  @@map("platform_revenue_ledger")
}

// Incentive Rules - Admin-defined bonus rules for drivers
model IncentiveRule {
  id String @id @default(uuid())

  // Targeting
  countryCode String // BD | US | * (all)
  cityCode    String? // Specific city or null for country-wide
  serviceType DeliveryServiceType // ride | food | parcel

  // Rule configuration
  bonusType   IncentiveBonusType // per_trip | streak | target | peak_hour | first_trip
  name        String // Display name (e.g., "Peak Hour Bonus")
  description String?            @db.Text

  // Bonus amount
  currency        String   @default("USD")
  bonusAmount     Decimal  @db.Decimal(10, 2) // Fixed bonus amount
  bonusPercentage Decimal? @db.Decimal(5, 2) // Alternative: % of trip fare
  maxBonusAmount  Decimal? @db.Decimal(10, 2) // Cap for percentage-based

  // Trigger conditions (JSON for flexibility)
  triggerConditions Json // { minTrips: 5, timeWindowHours: 4, peakHours: [17,18,19,20] }

  // Validity period
  startDate DateTime  @default(now())
  endDate   DateTime? // null = no end date
  isActive  Boolean   @default(true)

  // Budget controls
  dailyBudget       Decimal? @db.Decimal(12, 2) // Max daily spend
  totalBudget       Decimal? @db.Decimal(12, 2) // Lifetime cap
  currentDailySpend Decimal  @default(0) @db.Decimal(12, 2)
  totalSpend        Decimal  @default(0) @db.Decimal(12, 2)
  lastResetDate     DateTime @default(now()) // For daily budget reset

  // Metadata
  priority  Int     @default(0) // Higher = evaluated first
  stackable Boolean @default(false) // Can combine with other bonuses

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String
  lastUpdatedByAdminId String?

  // Relations
  awards IncentiveAward[]

  @@index([countryCode, serviceType, isActive])
  @@index([countryCode, cityCode, serviceType])
  @@index([bonusType])
  @@index([isActive, startDate, endDate])
  @@map("incentive_rules")
}

// Incentive Awards - Actual bonuses awarded to drivers
model IncentiveAward {
  id String @id @default(uuid())

  // Links
  ruleId   String // FK to incentive_rules
  driverId String // FK to driver_profiles

  // Trip association - proper foreign keys with relations
  serviceType DeliveryServiceType // ride | food | parcel
  rideId      String? // FK to rides (for ride incentives)
  foodOrderId String? // FK to food_orders (for food delivery incentives)
  deliveryId  String? // FK to deliveries (for parcel delivery incentives)

  // Award details
  countryCode String
  currency    String
  awardAmount Decimal @db.Decimal(10, 2)

  // Status tracking
  status              IncentiveAwardStatus @default(pending)
  creditedAt          DateTime? // When credited to wallet
  walletTransactionId String? // FK to wallet_transactions

  // Metadata
  triggerDetails Json? // Details of how rule was triggered

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rule      IncentiveRule @relation(fields: [ruleId], references: [id])
  ride      Ride?         @relation("RideIncentiveAwards", fields: [rideId], references: [id], onDelete: SetNull)
  foodOrder FoodOrder?    @relation("FoodOrderIncentiveAwards", fields: [foodOrderId], references: [id], onDelete: SetNull)
  delivery  Delivery?     @relation("DeliveryIncentiveAwards", fields: [deliveryId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([ruleId])
  @@index([rideId])
  @@index([foodOrderId])
  @@index([deliveryId])
  @@index([status])
  @@index([createdAt])
  @@map("incentive_awards")
}

// Cancellation Fee Rules - Country/service-specific cancellation policies
model CancellationFeeRule {
  id String @id @default(uuid())

  // Targeting
  countryCode String // BD | US
  serviceType DeliveryServiceType // ride | food | parcel

  // Fee type and triggers
  feeType CancellationFeeType // customer_cancel | no_show | driver_cancel

  // Time-based triggers
  gracePeriodSeconds Int  @default(60) // Time before fee applies
  noShowWaitMinutes  Int? // Minutes driver waits before no-show (rides only)

  // Fee calculation
  currency      String   @default("USD")
  flatFee       Decimal? @db.Decimal(10, 2) // Fixed fee amount
  percentageFee Decimal? @db.Decimal(5, 2) // % of estimated fare
  minFee        Decimal? @db.Decimal(10, 2) // Minimum fee
  maxFee        Decimal? @db.Decimal(10, 2) // Maximum fee cap

  // Distribution
  driverSharePercentage   Decimal @default(100) @db.Decimal(5, 2) // % to driver
  platformSharePercentage Decimal @default(0) @db.Decimal(5, 2) // % to platform

  // Conditions
  requiresDriverArrival Boolean @default(true) // Driver must have arrived

  // Validity
  isActive Boolean @default(true)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdByAdminId     String
  lastUpdatedByAdminId String?

  // Reverse relations
  rides      Ride[]      @relation("RideCancellationFeeRule")
  foodOrders FoodOrder[] @relation("FoodOrderCancellationFeeRule")
  deliveries Delivery[]  @relation("DeliveryCancellationFeeRule")

  @@unique([countryCode, serviceType, feeType])
  @@index([countryCode, serviceType, isActive])
  @@index([feeType])
  @@map("cancellation_fee_rules")
}

// ============================================================
// Phase 2B: Payment Gateway Integration
// ============================================================

// Payment - Tracks individual payment transactions
model Payment {
  id String @id @default(uuid())

  // Service association (polymorphic)
  serviceType DeliveryServiceType // ride | food | parcel
  entityId    String // FK to rides/food_orders/deliveries

  // Customer
  customerId String

  // Payment details
  amount      Decimal @db.Decimal(10, 2)
  currency    String  @default("USD")
  countryCode String

  // Provider information
  provider           PaymentProvider @default(mock)
  providerPaymentId  String? // External payment intent ID (e.g., Stripe pi_xxx)
  providerCustomerId String? // External customer ID if applicable
  clientSecret       String? // Client secret for frontend confirmation (not stored long-term)

  // Status tracking
  status PaymentStatus @default(created)

  // Payment method info (masked)
  paymentMethodId    String? // FK to payment_methods (if using saved method)
  paymentMethodType  String? // card, mobile_money, wallet, etc.
  paymentMethodLast4 String? // Last 4 digits of card/account
  paymentMethodBrand String? // visa, mastercard, bkash, etc.

  // Phase 4 Part 2: BD Mobile Wallet fields
  providerChannel       String? // card | mobile_wallet
  mobileWalletReference String? // Transaction ID from bKash/Nagad
  mobileWalletPhone     String? // Masked phone number used

  // Error handling
  errorCode    String?
  errorMessage String?
  declineCode  String? // Provider-specific decline code

  // Timestamps
  authorizedAt DateTime?
  capturedAt   DateTime?
  cancelledAt  DateTime?
  refundedAt   DateTime?

  // Metadata
  metadata       Json? // Additional provider-specific data
  webhookPayload Json? // Last webhook payload received
  idempotencyKey String? @unique // Prevent duplicate payments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer      CustomerProfile @relation(fields: [customerId], references: [id])
  paymentMethod PaymentMethod?  @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  refunds       PaymentRefund[]

  @@index([customerId])
  @@index([serviceType, entityId])
  @@index([provider, providerPaymentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// PaymentRefund - Tracks refunds for payments
model PaymentRefund {
  id        String @id @default(uuid())
  paymentId String

  amount   Decimal @db.Decimal(10, 2)
  currency String
  reason   String? // Refund reason

  // Provider info
  providerRefundId String? // External refund ID
  status           String  @default("pending") // pending, succeeded, failed

  // Error handling
  errorCode    String?
  errorMessage String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("payment_refunds")
}

// PaymentProviderConfig - Admin configuration for payment providers per country
model PaymentProviderConfig {
  id String @id @default(uuid())

  countryCode String
  provider    PaymentProvider
  serviceType DeliveryServiceType? // null = applies to all services

  // Configuration
  isEnabled Boolean @default(true)
  isDefault Boolean @default(false)
  priority  Int     @default(0) // Higher = preferred

  // Fees (platform may charge on top of provider fees)
  platformFeePercentage Decimal? @db.Decimal(5, 2)
  platformFeeFixed      Decimal? @db.Decimal(10, 2)

  // Provider-specific settings (encrypted or env-referenced)
  configJson Json? // Non-sensitive config

  // Supported payment types
  supportedMethods String[] @default([]) // ["card", "mobile_money", "bank"]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdByAdminId String?

  @@unique([countryCode, provider, serviceType])
  @@index([countryCode, isEnabled])
  @@index([provider])
  @@map("payment_provider_configs")
}

// ============================================================
// Phase 2B: FCM Notification System
// ============================================================

// UserDevice - FCM tokens for push notifications
model UserDevice {
  id     String @id @default(uuid())
  userId String // FK to users table
  role   String // customer | driver | restaurant | admin

  // Device info
  platform    DevicePlatform
  fcmToken    String // Firebase Cloud Messaging token
  deviceId    String? // Unique device identifier
  deviceModel String? // Device model info
  osVersion   String? // OS version
  appVersion  String? // App version
  locale      String? // User's locale (e.g., "en-US", "bn-BD")

  // Status
  isActive     Boolean   @default(true)
  revokedAt    DateTime? // When token was revoked
  revokeReason String? // Why token was revoked

  // Activity tracking
  lastSeenAt        DateTime @default(now())
  notificationCount Int      @default(0) // Total notifications sent
  failureCount      Int      @default(0) // Failed sends (for cleanup)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationLogs NotificationLog[]

  @@unique([userId, fcmToken])
  @@index([userId, role])
  @@index([fcmToken])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("user_devices")
}

// NotificationLog - Track all sent notifications
model NotificationLog {
  id String @id @default(uuid())

  // Target
  userId   String
  role     String // customer | driver | restaurant | admin
  deviceId String? // FK to user_devices (null if sent to all devices)

  // Notification content
  type  NotificationType
  title String
  body  String
  data  Json? // Additional payload data

  // Service association (optional)
  serviceType DeliveryServiceType?
  entityId    String? // ride_id, food_order_id, delivery_id

  // Delivery status
  status      NotificationStatus @default(pending)
  sentAt      DateTime?
  deliveredAt DateTime?

  // Error tracking
  errorCode    String?
  errorMessage String?
  fcmMessageId String? // FCM message ID for tracking

  // Metadata
  priority    String  @default("normal") // normal, high
  ttlSeconds  Int? // Time-to-live for message
  collapseKey String? // Collapse key for grouping

  createdAt DateTime @default(now())

  // Relations
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device UserDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([userId, role])
  @@index([type])
  @@index([serviceType, entityId])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}

// ============================================================
// Phase 3: Customer Experience, Restaurant Flow & Parcel Features
// ============================================================

// Task 21: Customer saved places for ride pickup/dropoff
model CustomerSavedPlace {
  id         String @id @default(uuid())
  customerId String // FK to customer_profiles

  // Place details
  label       SavedPlaceLabel @default(other) // home, work, other
  customLabel String? // For "other" type, user-defined label
  iconType    String?         @default("star") // home, work, star, etc.
  addressText String // Full address text
  latitude    Float
  longitude   Float
  placeId     String? // Google Place ID (optional)

  // Default flags
  isDefaultPickup  Boolean @default(false)
  isDefaultDropoff Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([customerId, label])
  @@map("customer_saved_places")
}

// Task 22: Customer ride preferences
model CustomerRidePreferences {
  id         String @id @default(uuid())
  customerId String @unique // One preferences record per customer

  // Service & vehicle preferences
  preferredServiceTypes String[] @default(["ride"]) // ride, food, parcel
  preferredVehicleTypes String[] @default([]) // car, bike, cng, premium

  // Comfort preferences
  musicPreference         MusicPreference         @default(no_preference)
  airConditioning         AcPreference            @default(no_preference)
  communicationPreference CommunicationPreference @default(no_preference)

  // Accessibility & safety
  accessibilityOptions Json? // { wheelchair_support: true, ... }
  safetyPreferences    Json? // { share_trip_automatically_with_contacts: true, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_ride_preferences")
}

// Task 25: Kitchen tickets for restaurant order management
model KitchenTicket {
  id           String @id @default(uuid())
  foodOrderId  String @unique // One ticket per order
  restaurantId String // FK to restaurant_profiles

  // Ticket status
  status                  KitchenTicketStatus @default(queued)
  prepTimeEstimateMinutes Int? // Estimated prep time for this ticket

  // Timestamps
  startedAt        DateTime? // When prep started
  completedAt      DateTime? // When marked ready
  handedToDriverAt DateTime? // When handed to driver

  // Notes
  notes    String? @db.Text // Kitchen notes
  priority Int     @default(0) // Higher = more urgent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  foodOrder  FoodOrder         @relation(fields: [foodOrderId], references: [id], onDelete: Cascade)
  restaurant RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId, status])
  @@index([restaurantId, createdAt])
  @@index([status])
  @@map("kitchen_tickets")
}

// Task 26: Parcel pricing configuration
model ParcelPricingConfig {
  id          String  @id @default(uuid())
  countryCode String // BD, US
  baseZone    String? // City/region code

  // Size category config
  sizeCategory ParcelSizeCategory
  maxWeightKg  Decimal            @db.Decimal(6, 2) // Max weight for this size

  // Pricing
  baseFare       Decimal  @db.Decimal(10, 2)
  perKmRate      Decimal  @db.Decimal(10, 2)
  perKgSurcharge Decimal? @db.Decimal(10, 2) // Optional weight surcharge

  // Validity
  activeFrom DateTime?
  activeTo   DateTime?
  isActive   Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deliveries Delivery[]

  @@unique([countryCode, baseZone, sizeCategory])
  @@index([countryCode, isActive])
  @@index([sizeCategory])
  @@map("parcel_pricing_configs")
}

// ============================================================
// SafeGo Parcel System: Domestic Zone Configuration (BD)
// ============================================================
model ParcelDomesticZone {
  id          String                   @id @default(uuid())
  countryCode String                   @default("BD") // BD only for now
  zoneType    ParcelDomesticZoneType // same_city, inside_division, outside_division, remote
  zoneName    String // Display name (e.g., "Dhaka City", "Chittagong Division")
  zoneCode    String // Unique code for this zone (e.g., "DHK", "CTG")
  
  // Coverage (can be JSON array of cities/areas or radius-based)
  coverageCities  String[] // List of city codes covered
  coverageRadius  Float? // Optional radius in km from a central point
  centerLat       Float?
  centerLng       Float?
  
  // Pricing by weight slab (in BDT)
  // Weight slabs: 0-1kg, 1-2kg, 2-5kg, 5-10kg
  rate0to1kg      Decimal  @db.Decimal(10, 2) // Rate for 0-1kg
  rate1to2kg      Decimal  @db.Decimal(10, 2) // Rate for 1-2kg
  rate2to5kg      Decimal  @db.Decimal(10, 2) // Rate for 2-5kg
  rate5to10kg     Decimal  @db.Decimal(10, 2) // Rate for 5-10kg
  rateAbove10kg   Decimal  @db.Decimal(10, 2) // Per-kg rate above 10kg
  
  // Surcharges
  remoteSurcharge Decimal? @db.Decimal(10, 2) // Extra charge for remote areas
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  deliveries Delivery[]
  
  @@unique([countryCode, zoneCode])
  @@index([countryCode, isActive])
  @@index([zoneType])
  @@map("parcel_domestic_zones")
}

// ============================================================
// SafeGo Parcel System: International Zone Configuration
// ============================================================
model ParcelInternationalZone {
  id          String                       @id @default(uuid())
  originCountry String                     @default("BD") // Origin country
  zoneType    ParcelInternationalZoneType // zone1_south_asia, zone3_middle_east, etc.
  zoneName    String // Display name (e.g., "South Asia", "Middle East")
  
  // Countries covered by this zone
  destinationCountries String[] // ISO country codes (e.g., ["IN", "NP", "BT"])
  
  // Pricing by weight slab (in BDT)
  rate0to0_5kg    Decimal  @db.Decimal(10, 2) // 0-0.5kg
  rate0_5to1kg    Decimal  @db.Decimal(10, 2) // 0.5-1kg
  rate1to2kg      Decimal  @db.Decimal(10, 2) // 1-2kg
  rate2to5kg      Decimal  @db.Decimal(10, 2) // 2-5kg
  rate5to10kg     Decimal  @db.Decimal(10, 2) // 5-10kg
  rateAbove10kg   Decimal  @db.Decimal(10, 2) // Per-kg rate above 10kg
  
  // Mandatory surcharges
  fuelSurchargePercent  Decimal @db.Decimal(5, 2) @default(0) // Fuel surcharge %
  securitySurcharge     Decimal @db.Decimal(10, 2) @default(0) // Security fee (300-600 tk)
  remoteAreaSurcharge   Decimal @db.Decimal(10, 2) @default(0) // Remote area (800-1500 tk)
  
  // Commission rate for international
  commissionPercent     Decimal @db.Decimal(5, 2) @default(20) // SafeGo commission %
  
  // Customs requirements
  customsRequired       Boolean @default(true) // Require customs declaration
  maxDeclaredValueBDT   Decimal? @db.Decimal(12, 2) // Max declared value
  
  // Estimated delivery days
  estimatedDaysMin      Int @default(3)
  estimatedDaysMax      Int @default(7)
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  deliveries Delivery[]
  
  @@unique([originCountry, zoneType])
  @@index([originCountry, isActive])
  @@index([zoneType])
  @@map("parcel_international_zones")
}

// ============================================================
// SafeGo Parcel System: Speed & Surcharge Rules
// ============================================================
model ParcelSurchargeRule {
  id          String  @id @default(uuid())
  countryCode String  @default("BD")
  ruleType    String // speed_quick, speed_express, speed_super_express, fragile_domestic, fragile_international, cod_fee
  
  // Surcharge configuration
  flatAmount      Decimal? @db.Decimal(10, 2) // Flat surcharge (e.g., +30 tk for quick)
  percentAmount   Decimal? @db.Decimal(5, 2)  // Percentage surcharge (e.g., 10% for fragile international)
  minAmount       Decimal? @db.Decimal(10, 2) // Minimum amount (e.g., min 10 tk for COD)
  
  // Description
  displayName     String // "Quick Delivery (+30)"
  description     String? // Full description
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([countryCode, ruleType])
  @@index([countryCode, isActive])
  @@map("parcel_surcharge_rules")
}

// Task 27: Proof-of-delivery photos
model DeliveryProofPhoto {
  id         String @id @default(uuid())
  deliveryId String // FK to deliveries
  driverId   String // FK to driver who captured

  // Photo details
  photoUrl   String // Uploaded photo URL
  capturedAt DateTime @default(now())

  // Metadata
  meta Json? // { gps_lat, gps_lng, device, ... }

  createdAt DateTime @default(now())

  // Relations
  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId])
  @@index([driverId])
  @@map("delivery_proof_photos")
}

// Phase 3 Feature Flags Configuration
model Phase3FeatureConfig {
  id          String @id @default(uuid())
  countryCode String @unique // BD, US, or "*" for global

  // Feature toggles
  savedPlacesEnabled      Boolean @default(true)
  ridePreferencesEnabled  Boolean @default(true)
  kitchenSystemEnabled    Boolean @default(true)
  parcelSchedulingEnabled Boolean @default(true)
  podPhotosRequired       Boolean @default(false) // Proof-of-delivery photos required

  // Limits
  maxSavedPlaces              Int @default(10) // Max saved places per customer
  parcelScheduleLeadMinutes   Int @default(30) // Lead time for scheduled dispatch
  parcelScheduleMinHoursAhead Int @default(2) // Min hours to schedule in advance
  parcelScheduleMaxDaysAhead  Int @default(7) // Max days to schedule in advance

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("phase3_feature_configs")
}

// ============================================================
// Phase 4: Admin Monitoring, Revenue Analytics, Fraud Detection
// ============================================================

// Phase 4: Fraud alert severity levels
enum FraudAlertSeverity {
  low
  medium
  high
  critical
}

// Phase 4: Fraud alert status
enum FraudAlertStatus {
  open
  investigating
  resolved_confirmed
  resolved_false_positive
  escalated
}

// Phase 4: Fraud alert entity types
enum FraudAlertEntityType {
  ride
  food
  parcel
  wallet
  payment
  customer
  driver
  restaurant
}

// Task 30: Analytics Daily Revenue - aggregated revenue data by day
model AnalyticsDailyRevenue {
  id           String              @id @default(uuid())
  date         DateTime            @db.Date // The date for this aggregation
  serviceType  DeliveryServiceType // ride, food, parcel
  countryCode  String // BD, US, etc.
  currencyCode String              @default("USD") // USD, BDT

  // Revenue metrics
  totalFare           Decimal @default(0) @db.Decimal(15, 2)
  totalCommission     Decimal @default(0) @db.Decimal(15, 2)
  totalPartnerPayout  Decimal @default(0) @db.Decimal(15, 2) // Driver/restaurant earnings
  totalOnlinePayments Decimal @default(0) @db.Decimal(15, 2)
  totalCashCollected  Decimal @default(0) @db.Decimal(15, 2)

  // Volume metrics
  totalTrips     Int @default(0) // Rides, orders, or deliveries
  completedTrips Int @default(0)
  cancelledTrips Int @default(0)

  // Additional breakdown
  totalTips           Decimal @default(0) @db.Decimal(15, 2)
  totalRefunds        Decimal @default(0) @db.Decimal(15, 2)
  totalIncentivesPaid Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, serviceType, countryCode])
  @@index([date])
  @@index([serviceType])
  @@index([countryCode])
  @@map("analytics_daily_revenue")
}

// Task 31: Fraud Alerts - suspicious activity detection
model FraudAlert {
  id String @id @default(uuid())

  // Entity reference
  entityType FraudAlertEntityType
  entityId   String // UUID of the related entity

  // Alert details
  alertType String // cancellation_abuse, wallet_anomaly, payment_fraud, gps_spoof, etc.
  severity  FraudAlertSeverity @default(medium)
  status    FraudAlertStatus   @default(open)

  // Detection details
  detectedReason  String @db.Text // Human-readable explanation
  detectedMetrics Json? // { cancel_count: 5, time_window_minutes: 10, ... }

  // Resolution
  resolvedByAdminId String? // Admin who resolved
  resolvedAt        DateTime?
  resolutionNotes   String?   @db.Text

  // Timestamps
  detectedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([detectedAt])
  @@index([alertType])
  @@map("fraud_alerts")
}

// Phase 4: Admin monitoring snapshots (for historical reference)
model AdminMonitoringSnapshot {
  id          String   @id @default(uuid())
  snapshotAt  DateTime @default(now())
  countryCode String? // Optional country filter

  // Driver metrics
  totalActiveDrivers      Int @default(0)
  totalOnlineDrivers      Int @default(0)
  driversOnRide           Int @default(0)
  driversOnFoodDelivery   Int @default(0)
  driversOnParcelDelivery Int @default(0)

  // Customer metrics
  totalActiveCustomers Int @default(0) // Active in last 24h

  // Trip metrics
  ridesInProgress         Int @default(0)
  foodOrdersInProgress    Int @default(0)
  parcelsInProgress       Int @default(0)
  scheduledParcelsPending Int @default(0)

  // Financial metrics (today's running totals)
  revenueTodayAmount    Decimal @default(0) @db.Decimal(15, 2)
  commissionTodayAmount Decimal @default(0) @db.Decimal(15, 2)

  // Pending settlements
  pendingDriverSettlements     Int @default(0)
  pendingRestaurantSettlements Int @default(0)

  // Alerts
  openFraudAlerts Int @default(0)

  createdAt DateTime @default(now())

  @@index([snapshotAt])
  @@index([countryCode])
  @@map("admin_monitoring_snapshots")
}

// ============================================================
// Phase 4 Part 2: Identity Verification, Background Checks, Face Verification
// ============================================================

// Phase 4: KYC Verification status types
enum KycVerificationStatus {
  pending
  in_progress
  match
  mismatch
  error
  manual_review
}

// Phase 4: KYC document types for verification
enum KycDocumentType {
  nid
  passport
  driver_license
  ssn_last4_check
  government_id
}

// Phase 4: Background check status
enum BackgroundCheckStatus {
  not_started
  pending
  in_progress
  completed
  failed
  expired
}

// Phase 4: Background check result
enum BackgroundCheckResult {
  clear
  consider
  review
  not_applicable
}

// Phase 4: Face verification status
enum FaceMatchStatus {
  pending
  match
  mismatch
  inconclusive
  failed
  liveness_failed
}

// Phase 4: Payment provider type (card vs mobile wallet)
enum PaymentProviderType {
  card
  mobile_wallet
  bank_transfer
}

// Phase 4: Mobile wallet brand
enum MobileWalletBrand {
  bkash
  nagad
  other
}

// ============================================================
// Phase 4 Part 2: KYC Verification Logs
// ============================================================

model KycVerificationLog {
  id String @id @default(uuid())

  // User reference
  userType    String // customer | driver | restaurant
  userId      String
  countryCode String

  // Provider info
  provider     String // bd_nid_provider, us_kyc_provider, etc.
  documentType KycDocumentType

  // Request/response (no raw sensitive data)
  requestPayloadHash String? // SHA-256 hash of request payload
  responseCode       String?
  responseStatus     KycVerificationStatus @default(pending)
  responseMessage    String?               @db.Text // Non-sensitive message
  matchScore         Decimal?              @db.Decimal(5, 2) // 0-100 match confidence

  // Admin fields
  triggeredByAdminId String? // Admin who triggered the verification
  adminViewNotes     String? @db.Text

  // Auto or manual
  autoTriggered Boolean @default(false)

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId, userType])
  @@index([countryCode])
  @@index([responseStatus])
  @@index([createdAt])
  @@index([triggeredByAdminId])
  @@map("kyc_verification_logs")
}

// ============================================================
// Phase 4 Part 2: Driver Background Checks
// ============================================================

model DriverBackgroundCheck {
  id       String @id @default(uuid())
  driverId String

  // Provider info
  provider         String // background check provider name
  countryCode      String
  requestReference String? // Provider's reference/case ID

  // Status tracking
  status BackgroundCheckStatus  @default(not_started)
  result BackgroundCheckResult?

  // Report access (admin only)
  reportUrl     String? @db.Text // Secure link to provider portal
  reportSummary String? @db.Text // Brief summary of findings

  // Admin notes
  initiatedByAdminId String?
  adminNotes         String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Background checks may expire

  // Audit
  consentRecordedAt DateTime? // When driver gave consent

  // Relations
  driver DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([status])
  @@index([countryCode])
  @@index([createdAt])
  @@map("driver_background_checks")
}

// ============================================================
// Phase 4 Part 2: Face Verification Sessions
// ============================================================

model FaceVerificationSession {
  id String @id @default(uuid())

  // User reference
  userType    String // customer | driver
  userId      String
  countryCode String

  // Document being matched against
  documentType KycDocumentType
  idPhotoRef   String? // Reference to ID photo in secure storage
  selfieRef    String? // Reference to selfie/liveness capture

  // Provider info
  provider String

  // Results
  status           FaceMatchStatus @default(pending)
  matchScore       Decimal?        @db.Decimal(5, 2) // 0-100 match score
  livenessScore    Decimal?        @db.Decimal(5, 2) // 0-100 liveness score
  livenessRequired Boolean         @default(true)
  livenessPassed   Boolean?

  // Decision
  decision String? // match | mismatch | inconclusive

  // Admin review
  reviewedByAdminId String?
  adminNotes        String? @db.Text

  // Metadata (non-sensitive)
  metadata Json? // { liveness_checks: [...], device_info: {...} }

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId, userType])
  @@index([countryCode])
  @@index([status])
  @@index([createdAt])
  @@map("face_verification_sessions")
}

// ============================================================
// Phase 4 Part 2: BD Mobile Wallet Configuration
// ============================================================

model MobileWalletConfig {
  id String @id @default(uuid())

  countryCode  String // BD, etc.
  provider     MobileWalletBrand
  providerName String // bKash, Nagad, etc.

  // Status
  isEnabled Boolean @default(false)
  isDefault Boolean @default(false)

  // Service availability
  enabledForRides   Boolean @default(true)
  enabledForFood    Boolean @default(true)
  enabledForParcels Boolean @default(true)

  // Configuration (non-sensitive)
  merchantId    String?
  merchantName  String?
  callbackUrl   String?
  webhookSecret String? // For webhook validation
  sandboxMode   Boolean @default(true)

  // Display
  displayName String?
  logoUrl     String?

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastVerifiedAt   DateTime?
  createdByAdminId String?

  @@unique([countryCode, provider])
  @@index([countryCode, isEnabled])
  @@map("mobile_wallet_configs")
}

// ============================================================
// Phase 4 Part 2B: Customer Mobile Wallet (BD only)
// ============================================================

model CustomerMobileWallet {
  id String @id @default(uuid())

  customerId String
  customer   CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  brand                MobileWalletBrand // bkash, nagad, upay, rocket
  walletPhoneMasked    String // Masked phone for display: 018****5678
  walletPhoneEncrypted String // AES-256-GCM encrypted full phone
  accountName          String?

  isDefault  Boolean @default(false)
  isVerified Boolean @default(false)
  status     String  @default("active") // active, inactive, removed

  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([customerId, brand, walletPhoneMasked])
  @@index([customerId, status])
  @@index([brand])
  @@map("customer_mobile_wallets")
}

// ============================================================
// Phase 5: Navigation Sessions
// ============================================================

enum NavigationStatus {
  active
  paused
  completed
  cancelled
  rerouting
}

enum NavigationProvider {
  openrouteservice
  mapbox
  google_maps
  internal
}

model NavigationSession {
  id       String @id @default(uuid())
  driverId String

  tripType String
  tripId   String

  status   NavigationStatus   @default(active)
  provider NavigationProvider @default(internal)

  originLat      Decimal @db.Decimal(10, 7)
  originLng      Decimal @db.Decimal(10, 7)
  destinationLat Decimal @db.Decimal(10, 7)
  destinationLng Decimal @db.Decimal(10, 7)

  currentLat     Decimal? @db.Decimal(10, 7)
  currentLng     Decimal? @db.Decimal(10, 7)
  currentHeading Decimal? @db.Decimal(5, 2)
  currentSpeed   Decimal? @db.Decimal(6, 2)

  polyline             String? @db.Text
  totalDistanceMeters  Int?
  totalDurationSeconds Int?
  remainingDistanceM   Int?
  remainingDurationSec Int?

  currentStepIndex Int @default(0)

  rerouteCount  Int       @default(0)
  lastRerouteAt DateTime?

  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  lastUpdateAt DateTime  @default(now())

  waypoints NavigationWaypoint[]

  @@index([driverId])
  @@index([tripType, tripId])
  @@index([status])
  @@map("navigation_sessions")
}

model NavigationWaypoint {
  id        String @id @default(uuid())
  sessionId String
  stepIndex Int

  lat Decimal @db.Decimal(10, 7)
  lng Decimal @db.Decimal(10, 7)

  instruction String  @db.Text
  maneuver    String?

  distanceMeters  Int?
  durationSeconds Int?

  roadName String?

  passed   Boolean   @default(false)
  passedAt DateTime?

  session NavigationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([stepIndex])
  @@map("navigation_waypoints")
}

// ============================================================
// Phase 5: Safety Events
// ============================================================

enum SafetyEventType {
  sos_triggered
  sos_resolved
  sos_false_alarm
  trip_shared
  emergency_contact_notified
  safety_check_in
  driver_behavior_alert
  route_deviation
  long_stop_detected
}

enum SafetyEventStatus {
  active
  acknowledged
  resolved
  escalated
}

model SafetyEvent {
  id String @id @default(uuid())

  eventType SafetyEventType
  status    SafetyEventStatus @default(active)

  tripType   String?
  tripId     String?
  customerId String?
  driverId   String?

  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)

  description String? @db.Text
  metadata    Json?

  resolvedByAdminId String?
  resolutionNotes   String?   @db.Text
  resolvedAt        DateTime?

  escalatedAt     DateTime?
  escalationLevel Int       @default(0)

  emergencyContactNotified   Boolean   @default(false)
  emergencyContactNotifiedAt DateTime?

  createdAt      DateTime  @default(now())
  acknowledgedAt DateTime?

  @@index([eventType])
  @@index([status])
  @@index([customerId])
  @@index([driverId])
  @@index([tripType, tripId])
  @@index([createdAt])
  @@map("safety_events")
}

// ============================================================
// Phase 5: Notification Intelligence
// ============================================================

enum NotificationPriority {
  low
  normal
  high
  urgent
}

model NotificationSchedule {
  id String @id @default(uuid())

  userId   String
  userType String

  notificationType String
  title            String
  body             String               @db.Text
  data             Json?
  priority         NotificationPriority @default(normal)

  scheduledFor DateTime
  expiresAt    DateTime?

  groupKey    String?
  throttleKey String?

  sent          Boolean   @default(false)
  sentAt        DateTime?
  failed        Boolean   @default(false)
  failureReason String?
  cancelled     Boolean   @default(false)

  createdAt DateTime @default(now())

  @@index([userId, userType])
  @@index([scheduledFor])
  @@index([sent])
  @@index([groupKey])
  @@index([throttleKey])
  @@map("notification_schedules")
}

model NotificationPreference {
  id       String @id @default(uuid())
  userId   String
  userType String

  pushEnabled  Boolean @default(true)
  smsEnabled   Boolean @default(false)
  emailEnabled Boolean @default(true)

  rideUpdatesEnabled   Boolean @default(true)
  foodUpdatesEnabled   Boolean @default(true)
  parcelUpdatesEnabled Boolean @default(true)
  promotionsEnabled    Boolean @default(true)
  earningsEnabled      Boolean @default(true)
  safetyAlertsEnabled  Boolean @default(true)

  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?

  minIntervalMinutes Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, userType])
  @@map("notification_preferences")
}

// ============================================================
// Phase 5: Routing Optimization
// ============================================================

model RoutingConfig {
  id          String  @id @default(uuid())
  countryCode String
  cityCode    String?

  provider NavigationProvider @default(internal)

  distanceWeight Int @default(40)
  timeWeight     Int @default(40)
  trafficWeight  Int @default(10)
  safetyWeight   Int @default(10)

  maxRerouteAttempts    Int @default(3)
  rerouteTriggerMeters  Int @default(100)
  updateIntervalSeconds Int @default(10)

  tollAvoidance     Boolean @default(false)
  highwayPreference Boolean @default(true)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countryCode, cityCode])
  @@map("routing_configs")
}

model RouteOptimizationRun {
  id String @id @default(uuid())

  tripType String
  tripId   String
  driverId String

  originLat      Decimal @db.Decimal(10, 7)
  originLng      Decimal @db.Decimal(10, 7)
  destinationLat Decimal @db.Decimal(10, 7)
  destinationLng Decimal @db.Decimal(10, 7)

  trafficLevel     Int?
  weatherCondition String?
  timeOfDay        String?

  selectedRouteIndex   Int     @default(0)
  routeCount           Int     @default(1)
  optimizedDistanceM   Int?
  optimizedDurationSec Int?
  optimizedPolyline    String? @db.Text

  distanceScore Decimal? @db.Decimal(5, 2)
  timeScore     Decimal? @db.Decimal(5, 2)
  safetyScore   Decimal? @db.Decimal(5, 2)
  overallScore  Decimal? @db.Decimal(5, 2)

  provider           NavigationProvider
  providerResponseMs Int?

  createdAt DateTime @default(now())

  @@index([tripType, tripId])
  @@index([driverId])
  @@index([createdAt])
  @@map("route_optimization_runs")
}

// ============================================================
// Phase 5: ETA Profiles
// ============================================================

model DriverEtaProfile {
  id       String @id @default(uuid())
  driverId String @unique

  avgSpeedCity    Decimal @default(25) @db.Decimal(5, 2)
  avgSpeedHighway Decimal @default(80) @db.Decimal(5, 2)
  avgSpeedRush    Decimal @default(15) @db.Decimal(5, 2)

  etaAccuracyPercent Decimal @default(80) @db.Decimal(5, 2)
  totalTripsAnalyzed Int     @default(0)

  morningRushFactor Decimal @default(1.3) @db.Decimal(3, 2)
  eveningRushFactor Decimal @default(1.4) @db.Decimal(3, 2)
  nightFactor       Decimal @default(0.9) @db.Decimal(3, 2)

  last7DaysAvgSpeed Decimal? @db.Decimal(5, 2)
  last7DaysTrips    Int      @default(0)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastCalculatedAt DateTime?

  @@map("driver_eta_profiles")
}

// ============================================================
// Phase 5: Incentive Optimization
// ============================================================

enum IncentiveRecommendationType {
  surge_pricing
  bonus_tier
  target_zone
  peak_hour_bonus
  completion_bonus
  rating_bonus
}

enum IncentiveRecommendationStatus {
  pending
  approved
  activated
  rejected
  expired
}

model IncentiveRecommendation {
  id String @id @default(uuid())

  countryCode String
  cityCode    String?
  zoneId      String?

  type   IncentiveRecommendationType
  status IncentiveRecommendationStatus @default(pending)

  title       String
  description String @db.Text

  suggestedMultiplier Decimal?  @db.Decimal(4, 2)
  suggestedAmount     Decimal?  @db.Decimal(10, 2)
  suggestedStartTime  DateTime?
  suggestedEndTime    DateTime?

  demandForecast       Decimal? @db.Decimal(5, 2)
  supplyForecast       Decimal? @db.Decimal(5, 2)
  historicalConversion Decimal? @db.Decimal(5, 2)
  confidenceScore      Decimal? @db.Decimal(5, 2)

  modelVersion String?
  analysisData Json?

  reviewedByAdminId String?
  reviewedAt        DateTime?
  adminNotes        String?   @db.Text

  activatedAt        DateTime?
  activatedByAdminId String?

  actualPerformance Json?

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([countryCode])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("incentive_recommendations")
}

model DriverEngagementMetric {
  id       String   @id @default(uuid())
  driverId String
  date     DateTime @db.Date

  tripsCompleted Int     @default(0)
  tripsCancelled Int     @default(0)
  hoursOnline    Decimal @default(0) @db.Decimal(4, 2)

  avgRating        Decimal? @db.Decimal(3, 2)
  onTimePickupRate Decimal? @db.Decimal(5, 2)
  acceptanceRate   Decimal? @db.Decimal(5, 2)

  grossEarnings Decimal @default(0) @db.Decimal(12, 2)
  bonusEarnings Decimal @default(0) @db.Decimal(12, 2)
  tipsEarnings  Decimal @default(0) @db.Decimal(12, 2)

  peakHoursWorked Decimal @default(0) @db.Decimal(4, 2)
  targetZoneTrips Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([driverId, date])
  @@index([driverId])
  @@index([date])
  @@map("driver_engagement_metrics")
}

// ============================================================
// Phase 5: Quick Actions & Smart Search
// ============================================================

model CustomerQuickAction {
  id         String @id @default(uuid())
  customerId String

  actionType String

  referenceType String?
  referenceId   String?

  title    String
  subtitle String?
  iconName String?

  priority   Int @default(0)
  usageCount Int @default(0)

  actionData Json?

  isActive Boolean @default(true)

  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?

  @@index([customerId])
  @@index([actionType])
  @@map("customer_quick_actions")
}

model SearchHistory {
  id       String @id @default(uuid())
  userId   String
  userType String

  query      String
  searchType String

  selectedResultId    String?
  selectedResultType  String?
  selectedResultLabel String?

  searchLat Decimal? @db.Decimal(10, 7)
  searchLng Decimal? @db.Decimal(10, 7)

  selectCount Int @default(1)

  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([userId, userType])
  @@index([searchType])
  @@index([query])
  @@map("search_history")
}

// ============================================================
// Phase 6: Security Hardening & Deployment Readiness
// ============================================================

enum AttackType {
  replay_attack
  signature_mismatch
  amount_mismatch
  rate_limit_exceeded
  idor_attempt
  unauthorized_access
  injection_attempt
  xss_attempt
  csrf_attempt
  brute_force
  session_hijack
  gps_spoofing
  device_anomaly
  suspicious_pattern
}

enum KycAccessAction {
  view
  download
  decrypt
  share
  verify
  reject
}

enum SecurityFindingSeverity {
  info
  low
  medium
  high
  critical
}

enum SecurityFindingStatus {
  open
  acknowledged
  resolved
  false_positive
}

model AttackLog {
  id       String     @id @default(uuid())
  type     AttackType
  sourceIp String

  userId   String?
  userType String?

  requestPath        String?
  requestMethod      String?
  requestPayloadHash String?

  detectionReason  String
  detectionDetails Json?

  webhookProvider String?
  transactionId   String?

  blocked Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([type])
  @@index([sourceIp])
  @@index([userId])
  @@index([createdAt])
  @@map("attack_logs")
}

model KycAccessLog {
  id      String @id @default(uuid())
  adminId String

  targetUserType String
  targetUserId   String

  action       KycAccessAction
  documentType String?
  documentId   String?

  ipAddress String
  userAgent String?

  accessGranted      Boolean @default(true)
  accessDeniedReason String?

  timestamp DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([timestamp])
  @@map("kyc_access_logs")
}

model SecurityAuditFinding {
  id String @id @default(uuid())

  category    String
  subcategory String?

  severity SecurityFindingSeverity
  status   SecurityFindingStatus   @default(open)

  title            String
  description      String
  affectedResource String?

  routePath  String?
  httpMethod String?

  recommendation String?
  evidence       Json?

  detectedAt DateTime  @default(now())
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?

  @@index([severity])
  @@index([status])
  @@index([category])
  @@index([detectedAt])
  @@map("security_audit_findings")
}

model WebhookNonce {
  id        String   @id @default(uuid())
  provider  String
  nonce     String
  timestamp DateTime

  transactionId String?
  amount        Decimal? @db.Decimal(12, 2)

  processedAt DateTime @default(now())

  @@unique([provider, nonce])
  @@index([provider])
  @@index([timestamp])
  @@map("webhook_nonces")
}

model SystemHealthMetric {
  id String @id @default(uuid())

  metricType String
  metricName String
  value      Decimal @db.Decimal(18, 6)
  unit       String?

  tags Json?

  timestamp DateTime @default(now())

  @@index([metricType])
  @@index([metricName])
  @@index([timestamp])
  @@map("system_health_metrics")
}

model SlowQueryLog {
  id String @id @default(uuid())

  query     String
  queryHash String
  duration  Int

  tableName     String?
  operationType String?

  connectionId String?
  userId       String?

  timestamp DateTime @default(now())

  @@index([queryHash])
  @@index([duration])
  @@index([timestamp])
  @@map("slow_query_logs")
}

model DeploymentCheck {
  id String @id @default(uuid())

  checkName String
  category  String

  passed  Boolean
  message String?
  details Json?

  environment String @default("development")

  runAt DateTime @default(now())

  @@index([category])
  @@index([passed])
  @@index([runAt])
  @@map("deployment_checks")
}

// =====================================================
// PHASE 6B: EXTENDED SECURITY TABLES
// Customer Security, Company Security, Platform Hardening
// ADD-ONLY: No modifications to existing tables
// =====================================================

// =====================================================
// A. CUSTOMER SECURITY TABLES
// =====================================================

// SOS Alert System - Enhanced emergency escalation
enum SOSEscalationLevel {
  L1_INITIAL // Initial alert, notify safety team
  L2_ESCALATED // Escalated to supervisor, possible police contact
  L3_EMERGENCY // Full emergency, authorities contacted
}

enum SOSAlertStatus {
  active // SOS is active
  escalated // Escalated to higher level
  resolved // Resolved by customer/driver/support
  false_alarm // Marked as false alarm
  cancelled // Cancelled by customer
}

model SOSAlert {
  id String @id @default(uuid())

  userId String
  user   User   @relation("UserSOSAlerts", fields: [userId], references: [id])

  rideId String?
  ride   Ride?   @relation("RideSOSAlerts", fields: [rideId], references: [id])

  foodOrderId String?
  foodOrder   FoodOrder? @relation("FoodOrderSOSAlerts", fields: [foodOrderId], references: [id])

  escalationLevel SOSEscalationLevel @default(L1_INITIAL)
  status          SOSAlertStatus     @default(active)

  triggerLocation    Json // {lat, lng, accuracy, timestamp}
  encryptedGpsStream String? // AES-256-GCM encrypted live GPS data
  gpsStreamKey       String? // Encrypted key for GPS stream decryption

  highRiskZone   Boolean @default(false)
  highRiskZoneId String?

  triggerReason  String? // "button_press", "voice_command", "auto_detected"
  additionalInfo String?

  respondedBy   String? // Admin/support user who responded
  responseNotes String?

  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  escalations SOSEscalationEvent[]

  @@index([userId])
  @@index([rideId])
  @@index([status])
  @@index([escalationLevel])
  @@index([createdAt])
  @@map("sos_alerts")
}

model SOSEscalationEvent {
  id String @id @default(uuid())

  sosAlertId String
  sosAlert   SOSAlert @relation(fields: [sosAlertId], references: [id])

  fromLevel SOSEscalationLevel
  toLevel   SOSEscalationLevel

  escalatedBy String? // "system", "support_agent_id", "auto"
  reason      String?

  notificationsSent Json? // List of notifications sent during escalation

  createdAt DateTime @default(now())

  @@index([sosAlertId])
  @@index([createdAt])
  @@map("sos_escalation_events")
}

// High-Risk Zone Configuration
model HighRiskZone {
  id String @id @default(uuid())

  name        String
  description String?

  countryCode String
  cityCode    String?

  // GeoJSON polygon defining the zone
  boundary Json // GeoJSON Polygon

  riskLevel      Int     @default(1) // 1-5 scale
  warningMessage String?

  isActive Boolean @default(true)

  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  @@index([isActive])
  @@map("high_risk_zones")
}

// Proxy Call System - Virtual number pool and sessions
model ProxyNumberPool {
  id String @id @default(uuid())

  virtualNumber String @unique
  provider      String // "twilio", "nexmo", etc.

  countryCode String

  status String @default("available") // "available", "in_use", "reserved", "disabled"

  lastUsedAt DateTime?
  usageCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions ProxyCallSession[]

  @@index([countryCode])
  @@index([status])
  @@map("proxy_number_pool")
}

model ProxyCallSession {
  id String @id @default(uuid())

  proxyNumberId String
  proxyNumber   ProxyNumberPool @relation(fields: [proxyNumberId], references: [id])

  callerId   String // User ID of caller
  receiverId String // User ID of receiver

  rideId      String?
  foodOrderId String?

  // Real numbers are never exposed
  callerMaskedNumber   String // Masked display number for caller
  receiverMaskedNumber String // Masked display number for receiver

  sessionType String @default("ride") // "ride", "food", "parcel"

  status String @default("active") // "active", "ended", "expired"

  startedAt DateTime  @default(now())
  expiresAt DateTime
  endedAt   DateTime?

  callCount Int @default(0)

  @@index([callerId])
  @@index([receiverId])
  @@index([rideId])
  @@index([status])
  @@map("proxy_call_sessions")
}

// Route Deviation Detection
model RouteMonitoringSession {
  id String @id @default(uuid())

  rideId String @unique
  ride   Ride   @relation("RideRouteMonitoring", fields: [rideId], references: [id])

  driverId   String
  customerId String

  expectedRoute    Json // Array of expected route coordinates
  expectedDistance Decimal @db.Decimal(10, 2) // In meters

  deviationThreshold Decimal @default(500) @db.Decimal(10, 2) // Meters before alert

  isMonitoring Boolean @default(true)
  alertsSent   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deviations RouteDeviationEvent[]

  @@index([driverId])
  @@index([isMonitoring])
  @@map("route_monitoring_sessions")
}

model RouteDeviationEvent {
  id String @id @default(uuid())

  sessionId String
  session   RouteMonitoringSession @relation(fields: [sessionId], references: [id])

  deviationLocation Json // {lat, lng}
  deviationDistance Decimal @db.Decimal(10, 2) // Distance from expected route

  severity String @default("low") // "low", "medium", "high", "critical"

  alertSentToCustomer Boolean @default(false)
  alertSentToSupport  Boolean @default(false)

  driverExplanation String?
  resolved          Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([severity])
  @@index([createdAt])
  @@map("route_deviation_events")
}

// Device Binding and Login Audit
model DeviceBinding {
  id String @id @default(uuid())

  userId String
  user   User   @relation("UserDeviceBindings", fields: [userId], references: [id])

  deviceFingerprint String
  deviceName        String?
  deviceModel       String?
  osVersion         String?
  appVersion        String?

  platform DevicePlatform?

  ipAddress String?
  location  Json? // Approximate location from IP

  isTrusted   Boolean @default(false)
  isBlocked   Boolean @default(false)
  blockReason String?

  riskScore Int @default(0) // 0-100

  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  loginEvents DeviceLoginEvent[]

  @@unique([userId, deviceFingerprint])
  @@index([userId])
  @@index([deviceFingerprint])
  @@index([isBlocked])
  @@index([riskScore])
  @@map("device_bindings")
}

model DeviceLoginEvent {
  id String @id @default(uuid())

  deviceBindingId String
  deviceBinding   DeviceBinding @relation(fields: [deviceBindingId], references: [id])

  userId String

  eventType String // "login_success", "login_failed", "logout", "session_refresh"

  ipAddress String?
  userAgent String?

  isNewDevice      Boolean @default(false)
  notificationSent Boolean @default(false)

  riskFlags Json? // Any risk indicators

  createdAt DateTime @default(now())

  @@index([deviceBindingId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("device_login_events")
}

// =====================================================
// B. COMPANY SECURITY TABLES
// =====================================================

// Admin Two-Factor Authentication (TOTP)
model AdminTotpSecret {
  id String @id @default(uuid())

  adminId String       @unique
  admin   AdminProfile @relation("AdminTotpSecret", fields: [adminId], references: [id])

  encryptedSecret String // AES-256-GCM encrypted TOTP secret
  secretIv        String // IV for decryption

  isEnabled Boolean @default(false)

  backupCodes     Json? // Encrypted backup codes
  backupCodesUsed Int   @default(0)

  lastVerifiedAt DateTime?
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([adminId])
  @@map("admin_totp_secrets")
}

// Admin IP Whitelist
model AdminIpWhitelist {
  id String @id @default(uuid())

  ipAddress String? // Single IP
  ipRange   String? // CIDR notation

  description String?

  isActive Boolean @default(true)

  allowedRoles Json? // Array of admin roles this applies to

  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ipAddress])
  @@index([isActive])
  @@map("admin_ip_whitelist")
}

// Admin Activity Anomaly Detection
enum AdminAnomalyType {
  unusual_kyc_access
  payout_tampering
  mass_block_unblock
  rapid_pricing_changes
  bulk_data_export
  sensitive_config_change
  unusual_login_pattern
  privilege_escalation_attempt
}

enum AdminAnomalyStatus {
  detected
  investigating
  confirmed_threat
  false_positive
  resolved
}

model AdminActivityAnomaly {
  id String @id @default(uuid())

  adminId String
  admin   AdminProfile @relation("AdminAnomalies", fields: [adminId], references: [id])

  anomalyType AdminAnomalyType
  status      AdminAnomalyStatus @default(detected)

  severity String @default("medium") // "low", "medium", "high", "critical"

  description String
  details     Json? // Detailed anomaly data

  affectedResources Json? // List of affected resources (users, payouts, etc.)

  detectedAt DateTime @default(now())

  investigatedBy     String?
  investigationNotes String?
  resolvedAt         DateTime?

  @@index([adminId])
  @@index([anomalyType])
  @@index([status])
  @@index([severity])
  @@index([detectedAt])
  @@map("admin_activity_anomalies")
}

// Developer Access Control - Protected Routes
model DeveloperRoutePolicy {
  id String @id @default(uuid())

  routePattern String // e.g., "/api/admin/kyc/*", "/api/admin/payout/*"

  policyType String @default("NO_DEV_ACCESS") // "NO_DEV_ACCESS", "SIGNED_ACCESS", "AUDIT_REQUIRED"

  description String?

  requiresSignedAccess Boolean @default(false)
  requiresAuditLog     Boolean @default(true)

  allowedEnvironments Json? // ["production", "staging"]

  isActive Boolean @default(true)

  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([routePattern])
  @@index([policyType])
  @@index([isActive])
  @@map("developer_route_policies")
}

// Financial Audit Trails - Immutable Payout Logs
model PayoutAuditLog {
  id String @id @default(uuid())

  adminId String
  admin   AdminProfile @relation("PayoutAuditLogs", fields: [adminId], references: [id])

  targetUserId   String
  targetUserType String // "driver", "restaurant"

  actionType String // "payout_initiated", "payout_approved", "payout_cancelled", "balance_adjustment"

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD")

  beforeBalance Decimal @db.Decimal(12, 2)
  afterBalance  Decimal @db.Decimal(12, 2)

  payoutMethod    String?
  payoutReference String?

  reason String?
  notes  String?

  ipAddress  String?
  deviceInfo String?

  // Tamper-proof chain
  previousLogId String?
  logHash       String // SHA-256 hash of log content + previousLogId

  createdAt DateTime @default(now())

  // Immutable - no updatedAt, no soft delete
  @@index([adminId])
  @@index([targetUserId])
  @@index([actionType])
  @@index([createdAt])
  @@map("payout_audit_logs")
}

// =====================================================
// C. PLATFORM HARDENING TABLES
// =====================================================

// Bot Protection - Challenge Logs
model BotChallengeLog {
  id String @id @default(uuid())

  ipAddress String
  userAgent String?

  challengeType String @default("invisible_captcha") // "invisible_captcha", "recaptcha_v3", "hcaptcha"

  endpoint String // The endpoint being protected

  challengeToken String?
  score          Decimal? @db.Decimal(3, 2) // 0.00 - 1.00

  passed        Boolean
  failureReason String?

  riskSignals Json? // Additional risk indicators

  userId    String? // If user was identified
  sessionId String?

  createdAt DateTime @default(now())

  @@index([ipAddress])
  @@index([passed])
  @@index([endpoint])
  @@index([createdAt])
  @@map("bot_challenge_logs")
}

// API Abuse Firewall
model ApiThreatSignal {
  id String @id @default(uuid())

  ipAddress String

  signalType String // "tor_exit", "vpn", "proxy", "datacenter", "bad_reputation"

  reputationScore Int? // 0-100, lower is worse

  countryCode String?
  asnInfo     String? // Autonomous System Number info

  isTor        Boolean @default(false)
  isVpn        Boolean @default(false)
  isProxy      Boolean @default(false)
  isDatacenter Boolean @default(false)

  threatCategories Json? // Array of threat categories

  source String? // Data source (e.g., "ipqualityscore", "maxmind")

  validUntil DateTime // Cache expiry

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ipAddress])
  @@index([signalType])
  @@index([reputationScore])
  @@index([validUntil])
  @@map("api_threat_signals")
}

model ApiFirewallEvent {
  id String @id @default(uuid())

  ipAddress String

  eventType String // "blocked", "rate_limited", "suspicious", "country_mismatch"

  endpoint String
  method   String // HTTP method

  userId    String?
  sessionId String?

  blockReason String?
  riskScore   Int? // Calculated risk score

  requestHeaders Json? // Relevant headers (sanitized)

  actionTaken String @default("logged") // "logged", "blocked", "captcha_required", "rate_limited"

  createdAt DateTime @default(now())

  @@index([ipAddress])
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@map("api_firewall_events")
}

// Content Moderation
enum ModerationStatus {
  pending
  approved
  rejected
  flagged
  escalated
}

enum ModerationType {
  text_profanity
  text_spam
  text_harassment
  image_inappropriate
  image_identity_mismatch
  menu_item_violation
  profile_violation
}

model ModerationFlag {
  id String @id @default(uuid())

  contentType String // "chat_message", "menu_item", "driver_photo", "review"
  contentId   String
  contentText String?
  contentUrl  String?

  moderationType ModerationType
  status         ModerationStatus @default(pending)

  autoDetected        Boolean  @default(true)
  detectionConfidence Decimal? @db.Decimal(3, 2)

  detectedIssues Json? // Array of detected issues

  reportedBy String? // User ID if user-reported

  reviewedBy  String? // Admin who reviewed
  reviewNotes String?
  reviewedAt  DateTime?

  actionTaken String? // "removed", "warned", "banned", "none"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contentType, contentId])
  @@index([status])
  @@index([moderationType])
  @@index([createdAt])
  @@map("moderation_flags")
}

// Global Privacy Compliance
enum PrivacyRequestType {
  data_export // GDPR Article 20 - Data portability
  data_deletion // GDPR Article 17 - Right to erasure
  data_access // GDPR Article 15 - Right of access
  consent_withdrawal // Withdraw consent
  rectification // GDPR Article 16 - Right to rectification
}

enum PrivacyRequestStatus {
  submitted
  in_progress
  pending_verification
  completed
  rejected
  cancelled
}

model PrivacyRequest {
  id String @id @default(uuid())

  userId String
  user   User   @relation("UserPrivacyRequests", fields: [userId], references: [id])

  requestType PrivacyRequestType
  status      PrivacyRequestStatus @default(submitted)

  requestDetails String?

  verificationMethod String? // "email", "sms", "support_call"
  verifiedAt         DateTime?

  exportFileUrl    String? // For data export requests
  exportFileExpiry DateTime?

  processedBy     String? // Admin who processed
  processingNotes String?

  completedAt     DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([requestType])
  @@index([status])
  @@index([createdAt])
  @@map("privacy_requests")
}

model ConsentVersion {
  id String @id @default(uuid())

  consentType String // "privacy_policy", "terms_of_service", "marketing", "data_sharing"

  version     String
  title       String
  contentHash String // Hash of consent document

  effectiveDate DateTime

  isCurrentVersion Boolean @default(false)

  createdAt DateTime @default(now())

  userConsents UserConsent[]

  @@unique([consentType, version])
  @@index([consentType])
  @@index([isCurrentVersion])
  @@map("consent_versions")
}

model UserConsent {
  id String @id @default(uuid())

  userId String
  user   User   @relation("UserConsents", fields: [userId], references: [id])

  consentVersionId String
  consentVersion   ConsentVersion @relation(fields: [consentVersionId], references: [id])

  granted Boolean

  ipAddress String?
  userAgent String?

  grantedAt   DateTime  @default(now())
  withdrawnAt DateTime?

  @@unique([userId, consentVersionId])
  @@index([userId])
  @@index([consentVersionId])
  @@map("user_consents")
}

model AnonymizationJob {
  id String @id @default(uuid())

  userId String

  status String @default("pending") // "pending", "processing", "completed", "failed"

  dataCategories Json // Categories of data to anonymize

  anonymizationRules Json? // Rules applied

  recordsProcessed  Int @default(0)
  recordsAnonymized Int @default(0)

  startedAt   DateTime?
  completedAt DateTime?

  errorMessage String?

  triggeredBy String // "user_request", "retention_policy", "admin"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("anonymization_jobs")
}

// Breach Response System
enum BreachSeverity {
  low
  medium
  high
  critical
}

enum BreachStatus {
  detected
  investigating
  contained
  remediated
  closed
}

model BreachIncident {
  id String @id @default(uuid())

  title       String
  description String

  severity BreachSeverity @default(medium)
  status   BreachStatus   @default(detected)

  detectionMethod String // "automated", "user_report", "audit", "external"

  affectedSystems   Json? // Array of affected systems/tables
  affectedUserCount Int?

  indicators Json? // Indicators of compromise

  containmentActions Json? // Actions taken to contain

  notifiedAuthorities Boolean @default(false)
  notifiedUsers       Boolean @default(false)

  leadInvestigator String?

  detectedAt   DateTime  @default(now())
  containedAt  DateTime?
  remediatedAt DateTime?
  closedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  actions   BreachAction[]
  lockdowns EndpointLockdown[]

  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("breach_incidents")
}

model BreachAction {
  id String @id @default(uuid())

  incidentId String
  incident   BreachIncident @relation(fields: [incidentId], references: [id])

  actionType String // "investigate", "contain", "notify", "remediate", "document"

  description String

  performedBy String

  outcome String?

  createdAt DateTime @default(now())

  @@index([incidentId])
  @@index([actionType])
  @@map("breach_actions")
}

model EndpointLockdown {
  id String @id @default(uuid())

  incidentId String?
  incident   BreachIncident? @relation(fields: [incidentId], references: [id])

  endpointPattern String // Route pattern to lock

  lockdownType String @default("full") // "full", "read_only", "admin_only"

  reason String

  isActive Boolean @default(true)

  activatedBy String
  activatedAt DateTime @default(now())

  deactivatedBy String?
  deactivatedAt DateTime?

  @@index([endpointPattern])
  @@index([isActive])
  @@map("endpoint_lockdowns")
}

// ===================================================
// BANGLADESH EXPANSION - BD-ONLY ROLES (Phase BD-1)
// ===================================================
// These models support BD-only Shop Partners and Ticket/Rental Operators
// US market remains unchanged - these roles are geofenced to countryCode="BD"

// Shop Order Status Flow: placed  accepted  packing  ready_for_pickup  picked_up  on_the_way  delivered
enum ShopOrderStatus {
  placed
  accepted
  packing
  ready_for_pickup
  picked_up
  on_the_way
  delivered
  cancelled_by_customer
  cancelled_by_shop
  cancelled_by_driver
  refunded
}

// Ticket Booking Status Flow: booked  confirmed  completed
enum TicketBookingStatus {
  booked
  confirmed
  completed
  cancelled_by_customer
  cancelled_by_operator
  refunded
  no_show
}

// Rental Booking Status Flow: requested  accepted  vehicle_assigned  in_use  returned  completed
enum RentalBookingStatus {
  requested
  accepted
  vehicle_assigned
  in_use
  returned
  completed
  cancelled_by_customer
  cancelled_by_operator
  refunded
}

enum ShopPartnerVerificationStatus {
  pending
  under_review
  approved
  rejected
  suspended
}

enum TicketOperatorVerificationStatus {
  pending
  under_review
  approved
  rejected
  suspended
}

// Partner Status for staged onboarding (BD Partners)
// Flow: draft  kyc_pending  setup_incomplete  ready_for_review  live | rejected
enum PartnerStatus {
  draft // Stage 1: Basic info submitted
  kyc_pending // Stage 2: KYC submitted, awaiting admin review
  setup_incomplete // KYC approved but setup not complete
  ready_for_review // Setup complete, awaiting final admin review
  live // Approved and visible to customers
  rejected // Rejected by admin (needs resubmission)
}

enum RentalVehicleType {
  car
  micro
  tourist_bus
  suv
  sedan
}

enum ShopType {
  grocery
  electronics
  fashion
  pharmacy
  general_store
  hardware
  beauty
  books
  sports
  other
}

// ===================================================
// SHOP PARTNER MODEL (BD-ONLY)
// ===================================================
model ShopPartner {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Shop Information
  shopName        String
  shopType        ShopType @default(general_store)
  shopDescription String?
  shopAddress     String
  shopLat         Float?
  shopLng         Float?
  shopLogo        String? // URL to shop logo image
  shopBanner      String? // URL to shop banner image

  // BD-Specific KYC Fields (mandatory for BD)
  tradeLicenseNumber String? // Optional trade license
  tradeLicenseImage  String? // URL to trade license image
  nidNumber          String? // National ID number
  nidFrontImage      String? // URL to NID front image
  nidBackImage       String? // URL to NID back image
  ownerName          String?
  fatherName         String? // BD requirement
  dateOfBirth        DateTime?
  presentAddress     String?
  permanentAddress   String?

  // Emergency Contact (BD requirement)
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Stage 1 Light Form Fields
  cityOrArea   String? // City/area for quick start
  contactPhone String? // Contact phone for partner

  // Verification & Partner Status
  verificationStatus ShopPartnerVerificationStatus @default(pending)
  partnerStatus      PartnerStatus                 @default(draft) // Staged onboarding status
  rejectionReason    String?
  kycSubmittedAt     DateTime? // When KYC was submitted
  kycApprovedAt      DateTime? // When KYC was approved
  setupCompletedAt   DateTime? // When setup was completed
  verifiedAt         DateTime?
  verifiedBy         String? // Admin who verified

  // Financial
  commissionRate  Decimal @default(15) @db.Decimal(5, 2) // SafeGo commission %
  walletBalance   Decimal @default(0) @db.Decimal(12, 2)
  negativeBalance Decimal @default(0) @db.Decimal(12, 2) // For cash orders
  totalEarnings   Decimal @default(0) @db.Decimal(12, 2)
  pendingPayout   Decimal @default(0) @db.Decimal(12, 2)

  // Operating Info
  isActive              Boolean  @default(false) // Only true after verification
  isOpen                Boolean  @default(true)
  openingTime           String? // e.g., "09:00"
  closingTime           String? // e.g., "21:00"
  deliveryRadiusKm      Float?   @default(5)
  minOrderAmount        Decimal? @db.Decimal(10, 2)
  avgPreparationMinutes Int?     @default(30)

  // Ratings
  averageRating Float? @default(0)
  totalRatings  Int    @default(0)
  totalOrders   Int    @default(0)

  countryCode String @default("BD") // Always BD for shop partners

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products ShopProduct[]
  orders   ProductOrder[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([partnerStatus])
  @@index([shopType])
  @@index([isActive])
  @@index([countryCode])
  @@map("shop_partners")
}

// ===================================================
// SHOP PRODUCT MODEL
// ===================================================
model ShopProduct {
  id            String      @id @default(uuid())
  shopPartnerId String
  shopPartner   ShopPartner @relation(fields: [shopPartnerId], references: [id], onDelete: Cascade)

  name        String
  description String?
  category    String
  subcategory String?

  price           Decimal  @db.Decimal(10, 2)
  discountPrice   Decimal? @db.Decimal(10, 2)
  discountPercent Int?

  images Json? // Array of image URLs

  // Inventory
  stockQuantity     Int     @default(0)
  isInStock         Boolean @default(true)
  lowStockThreshold Int?    @default(5)

  // Product Details
  weight  Decimal? @db.Decimal(6, 2)
  unit    String? // kg, piece, liter, etc.
  sku     String?
  barcode String?

  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orderItems ProductOrderItem[]

  @@index([shopPartnerId])
  @@index([category])
  @@index([isActive])
  @@index([isInStock])
  @@map("shop_products")
}

// ===================================================
// PRODUCT ORDER MODEL
// ===================================================
model ProductOrder {
  id          String @id @default(uuid())
  orderNumber String @unique // Human-readable order number

  customerId String
  customer   CustomerProfile @relation(fields: [customerId], references: [id])

  shopPartnerId String
  shopPartner   ShopPartner @relation(fields: [shopPartnerId], references: [id])

  driverId String? // Assigned driver for delivery
  driver   DriverProfile? @relation(fields: [driverId], references: [id])

  // Delivery Address
  deliveryAddress      String
  deliveryLat          Float?
  deliveryLng          Float?
  deliveryInstructions String?

  // Order Totals
  subtotal    Decimal  @db.Decimal(12, 2)
  deliveryFee Decimal  @db.Decimal(10, 2)
  serviceFee  Decimal? @db.Decimal(10, 2)
  discount    Decimal? @db.Decimal(10, 2)
  totalAmount Decimal  @db.Decimal(12, 2)

  // Commission & Payouts
  safegoCommission Decimal  @db.Decimal(10, 2)
  shopPayout       Decimal  @db.Decimal(10, 2)
  driverPayout     Decimal? @db.Decimal(10, 2)

  // Payment
  paymentMethod String // cash, bkash, nagad, card
  paymentStatus String @default("pending") // pending, paid, failed, refunded

  // Status
  status        ShopOrderStatus @default(placed)
  statusHistory Json?           @default("[]") // Array of {status, timestamp, actor}

  // Timestamps
  placedAt         DateTime  @default(now())
  acceptedAt       DateTime?
  packingAt        DateTime?
  readyForPickupAt DateTime?
  pickedUpAt       DateTime?
  deliveredAt      DateTime?
  cancelledAt      DateTime?

  // Ratings & Feedback
  customerRating   Int? // 1-5 for shop
  customerFeedback String?
  driverRating     Int? // 1-5 for driver
  driverFeedback   String?

  // Cancellation
  cancellationReason String?
  cancelledBy        String? // customer, shop, driver, admin
  refundAmount       Decimal? @db.Decimal(10, 2)
  refundStatus       String? // pending, processed, failed

  // Tracking
  estimatedDeliveryMinutes Int?
  actualDeliveryMinutes    Int?

  // Bangladesh Tax System (additive only, BD-only fields)
  countryCode        String?  // BD | US
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items ProductOrderItem[]

  @@index([customerId])
  @@index([shopPartnerId])
  @@index([driverId])
  @@index([status])
  @@index([orderNumber])
  @@index([placedAt])
  @@index([countryCode])
  @@map("product_orders")
}

// ===================================================
// PRODUCT ORDER ITEM MODEL
// ===================================================
model ProductOrderItem {
  id String @id @default(uuid())

  orderId String
  order   ProductOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   ShopProduct @relation(fields: [productId], references: [id])

  productName  String // Snapshot at order time
  productPrice Decimal @db.Decimal(10, 2) // Price at order time

  quantity Int
  subtotal Decimal @db.Decimal(10, 2)

  specialInstructions String?

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("product_order_items")
}

// ===================================================
// TICKET & RENTAL OPERATOR MODEL (BD-ONLY)
// ===================================================
model TicketOperator {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Operator Information
  operatorName String // Company/operator name
  operatorType String  @default("both") // ticket, rental, both
  description  String?
  logo         String?

  // Office Information
  officeAddress String
  officeLat     Float?
  officeLng     Float?
  officePhone   String?
  officeEmail   String?

  // BD-Specific KYC Fields
  nidNumber        String?
  nidFrontImage    String?
  nidBackImage     String?
  ownerName        String?
  fatherName       String?
  dateOfBirth      DateTime?
  presentAddress   String?
  permanentAddress String?

  // Route/Vehicle Permits (for ticket operators)
  routePermitNumber String?
  routePermitImage  String?
  routePermitExpiry DateTime?

  // Vehicle Documents (for rental operators)
  vehicleDocuments Json? // Array of document info

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Stage 1 Light Form Fields
  cityOrArea   String? // City/area for quick start
  contactPhone String? // Contact phone for partner

  // Verification & Partner Status
  verificationStatus TicketOperatorVerificationStatus @default(pending)
  partnerStatus      PartnerStatus                    @default(draft) // Staged onboarding status
  rejectionReason    String?
  kycSubmittedAt     DateTime? // When KYC was submitted
  kycApprovedAt      DateTime? // When KYC was approved
  setupCompletedAt   DateTime? // When setup was completed
  verifiedAt         DateTime?
  verifiedBy         String?

  // Financial
  ticketCommissionRate Decimal @default(10) @db.Decimal(5, 2) // For ticket sales
  rentalCommissionRate Decimal @default(12) @db.Decimal(5, 2) // For rentals
  walletBalance        Decimal @default(0) @db.Decimal(12, 2)
  negativeBalance      Decimal @default(0) @db.Decimal(12, 2)
  totalEarnings        Decimal @default(0) @db.Decimal(12, 2)
  pendingPayout        Decimal @default(0) @db.Decimal(12, 2)

  // Operating Info
  isActive Boolean @default(false)

  // Ratings
  averageRating Float? @default(0)
  totalRatings  Int    @default(0)
  totalBookings Int    @default(0)

  countryCode String @default("BD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ticketListings TicketListing[]
  ticketBookings TicketBooking[]
  rentalVehicles RentalVehicle[]
  rentalBookings RentalBooking[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([partnerStatus])
  @@index([operatorType])
  @@index([isActive])
  @@index([countryCode])
  @@map("ticket_operators")
}

// ===================================================
// TICKET LISTING MODEL (Bus/Train Routes)
// ===================================================
model TicketListing {
  id         String         @id @default(uuid())
  operatorId String
  operator   TicketOperator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  // Route Information
  routeName     String // e.g., "Dhaka - Chittagong Express"
  vehicleType   String // bus, coach, ac_bus, train
  vehicleNumber String? // License plate or train number
  vehicleBrand  String? // e.g., "Scania", "Volvo"

  // Origin & Destination
  originCity    String
  originStation String? // Bus stand/station name
  originLat     Float?
  originLng     Float?

  destinationCity    String
  destinationStation String?
  destinationLat     Float?
  destinationLng     Float?

  // Schedule
  departureTime   String // e.g., "08:00"
  arrivalTime     String // e.g., "14:00"
  durationMinutes Int?
  daysOfOperation Json? // Array of days: ["monday", "tuesday", ...]

  // Pricing & Seats
  basePrice      Decimal  @db.Decimal(10, 2)
  discountPrice  Decimal? @db.Decimal(10, 2)
  totalSeats     Int
  availableSeats Int
  seatMap        Json? // Seat layout configuration

  // Amenities
  amenities Json? // ["ac", "wifi", "charging", "toilet"]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings TicketBooking[]

  @@index([operatorId])
  @@index([originCity])
  @@index([destinationCity])
  @@index([isActive])
  @@map("ticket_listings")
}

// ===================================================
// TICKET BOOKING MODEL
// ===================================================
model TicketBooking {
  id            String @id @default(uuid())
  bookingNumber String @unique

  customerId String
  customer   CustomerProfile @relation(fields: [customerId], references: [id])

  operatorId String
  operator   TicketOperator @relation(fields: [operatorId], references: [id])

  listingId String
  listing   TicketListing @relation(fields: [listingId], references: [id])

  // Journey Details
  journeyDate   DateTime
  departureTime String

  // Passenger Info
  passengerName  String
  passengerPhone String
  passengerEmail String?
  passengerNid   String? // Optional NID for verification

  // Seats
  seatNumbers   Json // Array of selected seat numbers
  numberOfSeats Int

  // Pricing
  pricePerSeat     Decimal @db.Decimal(10, 2)
  totalAmount      Decimal @db.Decimal(10, 2)
  safegoCommission Decimal @db.Decimal(10, 2)
  operatorPayout   Decimal @db.Decimal(10, 2)

  // Payment
  paymentMethod String
  paymentStatus String @default("pending")

  // Status
  status        TicketBookingStatus @default(booked)
  statusHistory Json?               @default("[]")

  // Timestamps
  bookedAt    DateTime  @default(now())
  confirmedAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  // Cancellation
  cancellationReason String?
  cancelledBy        String?
  refundAmount       Decimal? @db.Decimal(10, 2)
  refundStatus       String?

  // Rating
  customerRating   Int?
  customerFeedback String?

  // Bangladesh Tax System (additive only, BD-only fields)
  countryCode        String?  // BD | US
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([operatorId])
  @@index([listingId])
  @@index([status])
  @@index([journeyDate])
  @@index([bookingNumber])
  @@index([countryCode])
  @@map("ticket_bookings")
}

// ===================================================
// RENTAL VEHICLE MODEL
// ===================================================
model RentalVehicle {
  id         String         @id @default(uuid())
  operatorId String
  operator   TicketOperator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  // Vehicle Info
  vehicleType RentalVehicleType @default(car)
  brand       String // e.g., "Toyota"
  model       String // e.g., "Corolla"
  year        Int?
  color       String?

  // Registration
  registrationNumber String
  registrationImage  String?
  registrationExpiry DateTime?

  // Capacity
  passengerCapacity Int
  luggageCapacity   Int? // Number of bags

  // Pricing
  pricePerDay     Decimal  @db.Decimal(10, 2)
  pricePerHour    Decimal? @db.Decimal(10, 2)
  pricePerKm      Decimal? @db.Decimal(10, 2)
  securityDeposit Decimal? @db.Decimal(10, 2)

  // Features
  features Json? // ["ac", "driver_included", "gps", "wifi"]
  images   Json? // Array of image URLs

  // Availability
  isAvailable     Boolean @default(true)
  isActive        Boolean @default(true)
  currentLocation String?
  currentLat      Float?
  currentLng      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings RentalBooking[]

  @@index([operatorId])
  @@index([vehicleType])
  @@index([isAvailable])
  @@index([isActive])
  @@map("rental_vehicles")
}

// ===================================================
// RENTAL BOOKING MODEL
// ===================================================
model RentalBooking {
  id            String @id @default(uuid())
  bookingNumber String @unique

  customerId String
  customer   CustomerProfile @relation(fields: [customerId], references: [id])

  operatorId String
  operator   TicketOperator @relation(fields: [operatorId], references: [id])

  vehicleId String
  vehicle   RentalVehicle @relation(fields: [vehicleId], references: [id])

  // Rental Period
  startDate DateTime
  endDate   DateTime
  startTime String? // e.g., "09:00"
  endTime   String?

  // Pickup & Return
  pickupLocation String
  pickupLat      Float?
  pickupLng      Float?
  returnLocation String?
  returnLat      Float?
  returnLng      Float?

  // Customer Info
  renterName          String
  renterPhone         String
  renterEmail         String?
  renterNid           String?
  driverLicenseNumber String? // If self-driving

  // Pricing
  rentalDays            Int
  pricePerDay           Decimal  @db.Decimal(10, 2)
  subtotal              Decimal  @db.Decimal(10, 2)
  securityDeposit       Decimal? @db.Decimal(10, 2)
  additionalCharges     Decimal? @db.Decimal(10, 2)
  additionalChargesNote String?
  totalAmount           Decimal  @db.Decimal(10, 2)

  // Commission & Payouts
  safegoCommission Decimal @db.Decimal(10, 2)
  operatorPayout   Decimal @db.Decimal(10, 2)

  // Payment
  paymentMethod   String
  paymentStatus   String  @default("pending")
  depositPaid     Boolean @default(false)
  depositRefunded Boolean @default(false)

  // Status
  status        RentalBookingStatus @default(requested)
  statusHistory Json?               @default("[]")

  // Driver (if operator provides driver)
  includesDriver      Boolean @default(false)
  assignedDriverName  String?
  assignedDriverPhone String?

  // Timestamps
  requestedAt       DateTime  @default(now())
  acceptedAt        DateTime?
  vehicleAssignedAt DateTime?
  inUseAt           DateTime?
  returnedAt        DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?

  // Mileage (for km-based pricing)
  startMileage Int?
  endMileage   Int?

  // Cancellation
  cancellationReason String?
  cancelledBy        String?
  refundAmount       Decimal? @db.Decimal(10, 2)
  refundStatus       String?

  // Rating
  customerRating   Int?
  customerFeedback String?

  // Bangladesh Tax System (additive only, BD-only fields)
  countryCode        String?  // BD | US
  bdTaxType          String?  // e.g., "vat"
  bdTaxRate          Decimal? @db.Decimal(5, 2) // Tax rate percentage
  bdTaxAmount        Decimal? @db.Decimal(10, 2) // Calculated tax amount
  bdFareBeforeTax    Decimal? @db.Decimal(10, 2) // Fare before tax
  bdFareAfterTax     Decimal? @db.Decimal(10, 2) // Total with tax

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([operatorId])
  @@index([vehicleId])
  @@index([status])
  @@index([startDate])
  @@index([bookingNumber])
  @@index([countryCode])
  @@map("rental_bookings")
}

// ===================================================
// AUTOMATION SYSTEM LOGS
// ===================================================
model AutomationLog {
  id String @id @default(uuid())

  automationType String // auto_assignment, surge_pricing, auto_settlement, recommendation, dynamic_pricing, performance_scoring, cancellation, auto_payout, fraud_detection, payout_risk
  entityType     String // ride, food_order, delivery, shop_order, ticket, rental, driver, restaurant, shop, wallet, zone, customer, batch, admin_action
  entityId       String // ID of the entity being processed

  status String // success, error, pending, flagged, processed, blocked, etc.

  partnerId   String? // For assignment logs, the assigned partner ID
  partnerType String? // driver, restaurant, shop, ticket_operator, rental_operator
  score       Float? // Score value (assignment score, surge multiplier, performance score, etc.)

  metadata Json? // Additional data specific to automation type

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([automationType])
  @@index([entityType])
  @@index([entityId])
  @@index([status])
  @@index([partnerId])
  @@index([createdAt])
  @@index([automationType, entityType])
  @@index([automationType, status])
  @@map("automation_logs")
}

// ===================================================
// AUTOMATION MODULE 1, 2, 14, 15: RISK SCORING SYSTEM
// ===================================================
enum RiskScoreType {
  customer_abuse
  partner_fraud
  payment_risk
  partner_risk_monitor
  order_risk
  driver_fatigue
}

enum RiskLevel {
  low
  medium
  high
  critical
}

model RiskScore {
  id String @id @default(uuid())

  entityType String // customer, restaurant, shop, driver, order
  entityId   String // ID of the scored entity
  scoreType  RiskScoreType // Type of risk being scored

  score     Float // 0-100 risk score
  riskLevel RiskLevel @default(low)

  factors Json? // Detailed breakdown of risk factors
  trend   String? // improving, stable, worsening

  abuseMetrics   Json? // For customer abuse: refund_count, cancel_count, location_manipulation_count
  fraudMetrics   Json? // For partner fraud: fake_orders, self_orders, cancellation_spikes
  paymentMetrics Json? // For payment risk: success_rate, refund_ratio, chargeback_count

  restricted        Boolean   @default(false)
  restrictedAt      DateTime?
  restrictionReason String?
  codRestricted     Boolean   @default(false) // For payment scoring - restrict COD

  calculatedAt DateTime  @default(now())
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId, scoreType])
  @@index([entityType, entityId])
  @@index([scoreType])
  @@index([riskLevel])
  @@index([restricted])
  @@map("risk_scores")
}

// ===================================================
// AUTOMATION MODULE 3: ORDER SUCCESS PREDICTION
// ===================================================
model OrderRiskPrediction {
  id String @id @default(uuid())

  orderType String // ride, food, parcel, shop, ticket, rental
  orderId   String // Reference to the order

  cancellationProbability   Float // 0-1 probability of cancellation
  paymentFailureProbability Float // 0-1 probability of payment failure
  delayProbability          Float // 0-1 probability of delay

  overallRiskLevel RiskLevel @default(low)
  riskScore        Float // 0-100 combined risk score

  riskFactors     Json? // Detailed factors contributing to risk
  recommendations Json? // Suggested actions (e.g., require prepayment)

  dispatchAdjustment    Json? // Adjustments made to dispatch logic
  dispatchPriorityBoost Float? // Priority adjustment for low-risk orders

  predictedAt       DateTime  @default(now())
  actualOutcome     String? // completed, cancelled, payment_failed, delayed
  outcomeRecordedAt DateTime?

  predictionAccuracy Float? // For ML feedback loop

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderType, orderId])
  @@index([overallRiskLevel])
  @@index([predictedAt])
  @@map("order_risk_predictions")
}

// ===================================================
// AUTOMATION MODULE 4: DRIVER FATIGUE DETECTION
// ===================================================
model DriverFatigueLog {
  id String @id @default(uuid())

  driverId String

  sessionStartTime DateTime // When driver started working
  sessionDuration  Int // Minutes of continuous work
  tripCount        Int // Number of trips in session

  fatigueIndex Float // 0-100 fatigue score
  fatigueLevel String @default("normal") // normal, mild, moderate, severe, critical

  indicators       Json? // Response delays, speed changes, etc.
  avgResponseDelay Float? // Average delay in accepting orders (seconds)
  speedVariance    Float? // Variance in driving speed
  hardBrakingCount Int? // Number of hard braking events

  breakRecommended      Boolean   @default(false)
  breakRecommendedAt    DateTime?
  breakNotificationSent Boolean   @default(false)
  breakTaken            Boolean   @default(false)
  breakTakenAt          DateTime?

  forcedOfflineAt DateTime? // If system forced driver offline

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([fatigueLevel])
  @@index([breakRecommended])
  @@index([createdAt])
  @@map("driver_fatigue_logs")
}

// ===================================================
// AUTOMATION MODULE 5: DEMAND SENSING
// ===================================================
model DemandSignal {
  id String @id @default(uuid())

  areaId   String // Zone/area identifier
  areaName String?
  cityCode String?

  latitude  Float?
  longitude Float?
  radiusKm  Float  @default(5)

  serviceType String // ride, food, parcel, shop

  demandLevel    Float // 0-100 demand intensity
  supplyLevel    Float // 0-100 supply (driver/partner availability)
  imbalanceScore Float // Demand-supply gap (-100 to +100)

  activeOrders      Int @default(0)
  activeDrivers     Int @default(0)
  activeRestaurants Int @default(0)
  activeShops       Int @default(0)

  predictedDemand15Min Float? // Predicted demand in 15 minutes
  predictedDemand30Min Float? // Predicted demand in 30 minutes
  predictedDemand60Min Float? // Predicted demand in 60 minutes

  surgeRecommended         Boolean @default(false)
  suggestedSurgeMultiplier Float?

  isHotZone       Boolean @default(false)
  isLowDriverZone Boolean @default(false)
  isHighShopLoad  Boolean @default(false)

  generatedAt DateTime @default(now())
  expiresAt   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([areaId])
  @@index([serviceType])
  @@index([isHotZone])
  @@index([generatedAt])
  @@map("demand_signals")
}

// ===================================================
// AUTOMATION MODULE 6: TRAFFIC & ETA CORRECTION
// ===================================================
model TrafficSnapshot {
  id String @id @default(uuid())

  areaId   String
  areaName String?

  latitude  Float?
  longitude Float?

  avgSpeedKmh     Float? // Average traffic speed
  congestionLevel String @default("normal") // free_flow, light, moderate, heavy, severe
  congestionScore Float // 0-100, higher = more congested

  weatherCondition   String? // clear, rain, fog, storm
  weatherImpactScore Float? // 0-100, weather impact on travel time

  timeOfDay String // morning_rush, midday, evening_rush, night
  dayOfWeek String // monday-sunday
  isHoliday Boolean @default(false)
  isWeekend Boolean @default(false)

  historicalAvgSpeed  Float? // Average speed for this time/day historically
  currentVsHistorical Float? // Ratio of current vs historical speed

  etaMultiplier        Float @default(1.0) // Factor to adjust base ETA
  etaAdjustmentMinutes Int   @default(0) // Fixed minutes to add/subtract

  source     String @default("internal") // internal, google_maps, historical
  confidence Float  @default(0.8) // 0-1 confidence in the snapshot

  observedAt DateTime @default(now())
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([areaId])
  @@index([congestionLevel])
  @@index([observedAt])
  @@map("traffic_snapshots")
}

// ===================================================
// AUTOMATION MODULE 7: INVENTORY FORECASTING
// ===================================================
model InventoryForecast {
  id String @id @default(uuid())

  shopId       String? // For shop products
  restaurantId String? // For restaurant menu items

  itemId   String // Product/menu item ID
  itemName String?
  itemType String // product, menu_item

  currentStock    Int?
  avgDailySales   Float? // Average daily sales
  salesTrend      String @default("stable") // trending_up, stable, trending_down
  trendPercentage Float? // Percentage change in sales trend

  forecastHorizon   Int       @default(7) // Days to forecast
  expectedDepletion DateTime? // When stock will run out
  expectedDemand    Float? // Expected demand in forecast period

  stockoutRisk        RiskLevel @default(low)
  stockoutProbability Float? // 0-1 probability of stockout

  restockRecommendation Int? // Recommended restock quantity
  restockUrgency        String @default("normal") // normal, soon, urgent, critical

  alertSent   Boolean   @default(false)
  alertSentAt DateTime?

  isTrendingItem Boolean @default(false)

  generatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
  @@index([restaurantId])
  @@index([itemId])
  @@index([stockoutRisk])
  @@map("inventory_forecasts")
}

// ===================================================
// AUTOMATION MODULE 8: REPEAT PURCHASE TRIGGER
// ===================================================
model RepeatPurchaseTrigger {
  id String @id @default(uuid())

  customerId String

  segmentKey String // food_regular, grocery_weekly, accessories_monthly
  category   String // food, grocery, accessories, ride, etc.

  lastOrderId    String?
  lastOrderAt    DateTime?
  lastOrderItems Json? // Items from last order

  avgOrderFrequencyDays  Float? // Average days between orders
  predictedNextOrderDate DateTime?

  nextBestAction String? // remind_reorder, suggest_similar, offer_discount
  triggerType    String  @default("reminder") // reminder, suggestion, promotion

  triggerScheduledAt DateTime?
  triggeredAt        DateTime?
  notificationSent   Boolean   @default(false)
  notificationId     String?

  status         String    @default("pending") // pending, triggered, completed, expired
  responseAction String? // ordered, dismissed, ignored
  responseAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([segmentKey])
  @@index([status])
  @@index([triggerScheduledAt])
  @@map("repeat_purchase_triggers")
}

// ===================================================
// AUTOMATION MODULE 9: NEGATIVE REVIEW RECOVERY
// ===================================================
model ReviewRecoveryPlan {
  id String @id @default(uuid())

  reviewId   String @unique
  reviewType String // ride, food_order, shop_order, rental

  entityType String // driver, restaurant, shop, rental_operator
  entityId   String
  customerId String

  rating     Int // 1-5 star rating
  reviewText String?

  severity        String @default("moderate") // mild (3 stars), moderate (2 stars), severe (1 star)
  issueCategories Json? // Categories of issues identified

  recommendedAction String   @default("apology") // apology, coupon, refund, escalate
  couponCode        String?
  couponValue       Decimal? @db.Decimal(10, 2)
  couponType        String? // percentage, fixed_amount

  apologyMessage          String?
  apologyMessageGenerated Boolean @default(false)

  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  status    String  @default("pending") // pending, action_taken, resolved, escalated
  ownerRole String? // admin, partner, support

  partnerNotified   Boolean   @default(false)
  partnerNotifiedAt DateTime?

  followUpAt DateTime?
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([customerId])
  @@index([severity])
  @@index([status])
  @@map("review_recovery_plans")
}

// ===================================================
// AUTOMATION MODULE 10: SEASONAL BUSINESS INTELLIGENCE
// ===================================================
model SeasonalInsight {
  id String @id @default(uuid())

  seasonKey  String // eid, puja, winter, summer, christmas, new_year, ramadan
  seasonName String
  seasonType String // religious, weather, holiday, cultural

  countryCode String?
  cityCode    String?

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  serviceType String? // ride, food, parcel, shop, all

  metrics              Json? // Historical metrics for this season
  demandMultiplier     Float  @default(1.0)
  expectedDemandChange Float? // Percentage change from baseline

  popularCategories Json? // Popular product/service categories
  trendingItems     Json? // Trending items during this season

  recommendedOffers Json? // Suggested partner offers
  suggestedPricing  Json? // Suggested pricing adjustments

  partnerInsights  Json? // Insights for partners
  customerInsights Json? // Insights for marketing

  generatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([seasonKey, countryCode, cityCode])
  @@index([seasonKey])
  @@index([isActive])
  @@index([startDate])
  @@map("seasonal_insights")
}

// ===================================================
// AUTOMATION MODULE 11 & 12: SERVER SCALING & DEVOPS
// ===================================================
enum ScalingPolicyType {
  server_auto_scaling
  deployment_pipeline
  cost_optimization
}

model ScalingPolicy {
  id String @id @default(uuid())

  policyType  ScalingPolicyType
  policyName  String
  description String?

  isActive Boolean @default(true)

  minInstances     Int @default(1)
  maxInstances     Int @default(10)
  desiredInstances Int @default(2)
  currentInstances Int @default(1)

  scaleMetric        String // cpu, memory, requests_per_second, queue_depth
  scaleUpThreshold   Float // e.g., 80% CPU
  scaleDownThreshold Float // e.g., 30% CPU
  cooldownSeconds    Int    @default(300)

  thresholds       Json? // Complex threshold rules
  costOptimization Json? // Off-peak scaling rules

  peakHoursConfig Json? // Peak hours configuration
  offPeakConfig   Json? // Off-peak configuration

  lastEvaluatedAt DateTime?
  lastScaledAt    DateTime?
  lastScaleAction String? // scale_up, scale_down, no_change

  deploymentRuns DeploymentRun[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([policyType])
  @@index([isActive])
  @@map("scaling_policies")
}

model DeploymentRun {
  id String @id @default(uuid())

  policyId String
  policy   ScalingPolicy @relation(fields: [policyId], references: [id])

  runNumber Int

  triggerType String // manual, scheduled, commit, tag
  triggeredBy String? // User ID or system

  stages       Json? // Build, Test, Deploy stages
  currentStage String? // Current stage being executed

  buildStatus  String @default("pending") // pending, running, success, failed
  testStatus   String @default("pending")
  deployStatus String @default("pending")

  status String @default("pending") // pending, running, success, failed, rolled_back

  commitHash String?
  branch     String?
  version    String?

  startedAt         DateTime?
  buildCompletedAt  DateTime?
  testsCompletedAt  DateTime?
  deployCompletedAt DateTime?
  completedAt       DateTime?

  duration Int? // Total duration in seconds

  result Json? // Detailed results
  logs   Json? // Deployment logs
  errors Json? // Any errors encountered

  rollbackAvailable Boolean   @default(false)
  rolledBackAt      DateTime?
  rolledBackBy      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([policyId])
  @@index([status])
  @@index([startedAt])
  @@map("deployment_runs")
}

// ===================================================
// AUTOMATION MODULE 13: EMPLOYEE PRODUCTIVITY
// ===================================================
model EmployeeProductivityMetric {
  id String @id @default(uuid())

  teamId   String?
  teamName String?

  memberId   String // User ID of employee
  memberName String?
  memberRole String? // support, finance, compliance, etc.

  metricKey  String // tickets_resolved, avg_response_time, completion_rate
  metricName String?

  value Float
  unit  String? // count, minutes, percentage

  period      String // daily, weekly, monthly
  periodStart DateTime
  periodEnd   DateTime

  target      Float? // Target value for this metric
  targetMet   Boolean @default(false)
  performance String  @default("average") // below_average, average, above_average, excellent

  tasksAssigned            Int?
  tasksCompleted           Int?
  avgResponseTimeMinutes   Float?
  avgResolutionTimeMinutes Float?

  breakdown Json? // Detailed breakdown of work

  capturedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([teamId])
  @@index([metricKey])
  @@index([period])
  @@index([periodStart])
  @@map("employee_productivity_metrics")
}

// ===================================================
// AUTOMATION MODULE 16: REFUND OPTIMIZATION
// ===================================================
enum RefundDecisionType {
  no_refund
  partial_refund
  full_refund
  credit_only
  replacement
}

enum RefundFaultParty {
  customer
  driver
  restaurant
  shop
  system
  unknown
}

model RefundDecision {
  id String @id @default(uuid())

  orderType String // ride, food, parcel, shop, ticket, rental
  orderId   String

  complaintId      String?
  issueType        String // late_delivery, wrong_item, damaged, not_received, quality_issue
  issueDescription String?

  originalAmount    Decimal  @db.Decimal(10, 2)
  recommendedRefund Decimal  @db.Decimal(10, 2)
  actualRefund      Decimal? @db.Decimal(10, 2)

  decisionType    RefundDecisionType @default(no_refund)
  faultParty      RefundFaultParty   @default(unknown)
  faultConfidence Float? // 0-1 confidence in fault determination

  decisionFactors Json? // Factors that led to decision
  customerHistory Json? // Customer's refund history
  partnerHistory  Json? // Partner's issue history

  autoApproved         Boolean @default(false)
  autoApprovedReason   String?
  requiresManualReview Boolean @default(false)

  adminReviewedBy String?
  adminReviewedAt DateTime?
  adminDecision   String? // approved, modified, rejected
  adminNotes      String?

  customerNotified Boolean @default(false)
  partnerNotified  Boolean @default(false)

  processingStatus  String    @default("pending") // pending, processing, completed, failed
  refundProcessedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderType, orderId])
  @@index([decisionType])
  @@index([faultParty])
  @@index([processingStatus])
  @@map("refund_decisions")
}

// ===================================================
// AUTOMATION MODULE 17: MARKETING BUDGET OPTIMIZATION
// ===================================================
model MarketingBudgetPlan {
  id String @id @default(uuid())

  planName   String
  planPeriod String // daily, weekly, monthly, campaign

  countryCode String?
  cityCode    String?
  areaId      String?

  segmentId   String? // Target customer segment
  segmentName String?

  serviceType  String? // ride, food, parcel, shop, all
  campaignType String? // acquisition, retention, reactivation

  totalBudget     Decimal @db.Decimal(12, 2)
  allocatedBudget Decimal @db.Decimal(12, 2)
  spentBudget     Decimal @default(0) @db.Decimal(12, 2)
  remainingBudget Decimal @db.Decimal(12, 2)

  spendCap Decimal? @db.Decimal(12, 2) // Daily spend cap

  allocationByChannel Json? // Budget split by channel (push, email, sms, ads)
  allocationByTime    Json? // Budget split by time slots
  allocationByArea    Json? // Budget split by areas

  predictedROI Float? // Predicted return on investment
  actualROI    Float? // Actual ROI achieved

  conversionRate       Float? // Current conversion rate
  targetConversionRate Float? // Target conversion rate

  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  activeCampaigns Json? // Active campaign details

  optimizationRecommendations  Json? // AI-suggested optimizations
  budgetReallocationSuggestion Json? // Suggested budget reallocation

  evaluationWindow Int       @default(7) // Days for evaluation
  lastEvaluatedAt  DateTime?
  nextEvaluationAt DateTime?

  status String @default("draft") // draft, active, paused, completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planPeriod])
  @@index([countryCode])
  @@index([serviceType])
  @@index([status])
  @@map("marketing_budget_plans")
}

// ====================================================
// PHASE 1: SAFETY CENTER - Risk Event & Case Models
// ====================================================

// Risk event severity levels
enum RiskEventSeverity {
  low
  medium
  high
  critical
}

// Risk event categories
enum RiskEventCategory {
  fraud
  safety
  abuse
  technical
  payment_risk
  compliance
}

// Risk case status
enum RiskCaseStatus {
  open
  in_review
  resolved
  escalated
}

// Risk events from automation systems
model RiskEvent {
  id String @id @default(uuid())

  userId String // User who triggered the risk (driver/customer/restaurant)
  role   String // customer, driver, restaurant, shop_partner, ticket_operator

  source   String // Automation module: fraud_detection, abuse_detection, fatigue_detection, payment_scoring, etc.
  severity RiskEventSeverity @default(medium)
  category RiskEventCategory

  message String // Short description of the risk event
  details Json? // Additional structured data

  relatedRideId     String? // FK to rides (nullable)
  relatedOrderId    String? // FK to food_orders (nullable)
  relatedDeliveryId String? // FK to deliveries (nullable)

  isAcknowledged Boolean   @default(false)
  acknowledgedBy String? // Admin who acknowledged
  acknowledgedAt DateTime?

  riskCaseId String? // FK to RiskCase if linked
  riskCase   RiskCase? @relation(fields: [riskCaseId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([role])
  @@index([source])
  @@index([severity])
  @@index([category])
  @@index([createdAt])
  @@index([riskCaseId])
  @@map("risk_events")
}

// Risk cases for tracking and resolution
model RiskCase {
  id String @id @default(uuid())

  primaryUserId String // Primary user involved
  role          String // customer, driver, restaurant, shop_partner, ticket_operator

  status   RiskCaseStatus    @default(open)
  severity RiskEventSeverity @default(medium)

  summary     String // Case summary
  description String? // Detailed description

  assignedAdminId String? // FK to AdminProfile

  eventCount  Int      @default(1) // Number of related events
  lastEventAt DateTime @default(now())

  resolutionNotes String?
  actionsTaken    Json? // Array of actions: warning, temporary_suspend, permanent_block, refund_adjustment

  countryCode String? // BD or US

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  // Relations
  riskEvents RiskEvent[]
  caseNotes  RiskCaseNote[]

  @@index([primaryUserId])
  @@index([role])
  @@index([status])
  @@index([severity])
  @@index([assignedAdminId])
  @@index([createdAt])
  @@map("risk_cases")
}

// Notes and comments on risk cases
model RiskCaseNote {
  id String @id @default(uuid())

  riskCaseId String
  riskCase   RiskCase @relation(fields: [riskCaseId], references: [id], onDelete: Cascade)

  adminId    String // Admin who added the note
  adminEmail String

  content    String
  isInternal Boolean @default(true) // Internal admin notes vs. user-visible

  createdAt DateTime @default(now())

  @@index([riskCaseId])
  @@index([createdAt])
  @@map("risk_case_notes")
}

// ====================================================
// PHASE 1: FEATURE FLAGS SYSTEM (Enterprise Edition)
// ====================================================

// Feature flag scopes
enum FeatureFlagScope {
  GLOBAL
  BD
  US
}

// Feature flag categories for grouping
enum FeatureFlagCategory {
  RIDE // Ride-hailing features
  FOOD // Food delivery features
  SHOP // Shop partner features
  TICKET // Ticket operator features
  RENTAL // Rental vehicle features
  SYSTEM // System-wide features
}

// Feature flag environments
enum FeatureFlagEnvironment {
  DEVELOPMENT
  STAGING
  PRODUCTION
  ALL
}

// Feature flags for admin control (Enterprise Version)
model FeatureFlag {
  id String @id @default(uuid())

  key         String @unique // e.g., "new_people_kyc_center", "dynamic_pricing"
  description String // Human-readable description

  isEnabled Boolean @default(false)

  // Grouping & Environment
  category    FeatureFlagCategory    @default(SYSTEM) // For grouped display
  environment FeatureFlagEnvironment @default(ALL) // Environment targeting

  // Targeting scopes
  countryScope     FeatureFlagScope @default(GLOBAL) // GLOBAL, BD, US
  roleScope        String? // customer, driver, restaurant, admin, all (null = all)
  serviceScope     String? // ride, food, parcel, all (null = all)
  partnerTypeScope String? // Specific partner type targeting

  rolloutPercentage Int @default(100) // 0-100 for gradual rollout

  metadata Json? // Additional configuration

  // Audit tracking
  createdByAdminId    String? // FK to AdminProfile
  updatedByAdminId    String?
  lastToggleByAdminId String? // Who last toggled enabled/disabled
  lastToggleAt        DateTime? // When last toggled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isEnabled])
  @@index([countryScope])
  @@index([category])
  @@index([environment])
  @@map("feature_flags")
}

// ====================================================
// PHASE 2: RBAC V3 - ENTERPRISE ADMIN PERMISSION FRAMEWORK
// ====================================================

// Permission bundle types for grouped permissions
enum PermissionBundleType {
  OPS // Operations bundle
  FINANCE // Finance bundle
  SAFETY // Safety & Risk bundle
  LEGAL // Legal & Compliance bundle
  ENGINEERING // Engineering/Dev bundle
  CUSTOM // Custom admin-defined bundle
}

// Permission bundles for easier role management
model AdminPermissionBundle {
  id String @id @default(uuid())

  name        String               @unique // e.g., "Ops Bundle", "Finance Bundle"
  type        PermissionBundleType
  description String?

  permissions String[] // Array of Permission enum values

  isActive       Boolean @default(true)
  isSystemBundle Boolean @default(false) // System bundles can't be deleted

  createdByAdminId String?
  updatedByAdminId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignments AdminBundleAssignment[]

  @@index([type])
  @@index([isActive])
  @@map("admin_permission_bundles")
}

// Bundle assignments to admin profiles
model AdminBundleAssignment {
  id String @id @default(uuid())

  adminProfileId String
  bundleId       String
  bundle         AdminPermissionBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  assignedByAdminId String?
  assignedAt        DateTime @default(now())

  expiresAt DateTime? // Optional expiration

  @@unique([adminProfileId, bundleId])
  @@index([adminProfileId])
  @@index([bundleId])
  @@map("admin_bundle_assignments")
}

// Emergency lockdown status
enum EmergencyLockdownLevel {
  NONE // Normal operations
  PARTIAL // Some features locked
  FULL // Complete lockdown
  MAINTENANCE // Planned maintenance mode
}

// Emergency lockdown scope type
enum LockdownScope {
  GLOBAL // Entire platform
  COUNTRY // Specific country only
  SERVICE // Specific service (rides, food, parcel)
  COUNTRY_SERVICE // Specific country + service combination
}

// Emergency lockdown controls
model EmergencyLockdown {
  id String @id @default(uuid())

  level  EmergencyLockdownLevel @default(NONE)
  scope  LockdownScope          @default(COUNTRY)
  reason String // Reason for lockdown

  lockedFeatures String[] // Features currently locked
  excludedAdmins String[] // Admin IDs exempt from lockdown

  activatedBy      String // Admin ID who activated
  activatedByEmail String
  activatedAt      DateTime @default(now())

  deactivatedBy      String? // Admin ID who deactivated
  deactivatedByEmail String?
  deactivatedAt      DateTime?

  scheduledEndAt   DateTime? // Scheduled end time
  estimatedEndTime DateTime? // Estimated restoration time

  isActive Boolean @default(true)

  countryCode String? // BD, US, or null for global
  serviceType String? // rides, food, parcel, or null for all

  @@index([isActive])
  @@index([level])
  @@index([scope])
  @@index([countryCode])
  @@index([serviceType])
  @@index([activatedAt])
  @@map("emergency_lockdowns")
}

// Admin impersonation session status
enum ImpersonationStatus {
  ACTIVE
  ENDED
  EXPIRED
  REVOKED
}

// Admin impersonation sessions for view-only access
model AdminImpersonationSession {
  id String @id @default(uuid())

  impersonatorId    String // Super admin performing impersonation
  impersonatorEmail String
  impersonatorRole  AdminRole

  targetAdminId    String // Admin being impersonated
  targetAdminEmail String
  targetAdminRole  AdminRole

  status ImpersonationStatus @default(ACTIVE)

  isViewOnly   Boolean @default(true) // View-only mode (safer)
  allowActions Boolean @default(false) // Can perform actions

  reason String // Justification for impersonation

  startedAt DateTime  @default(now())
  endedAt   DateTime?
  expiresAt DateTime // Session expiration

  actionsPerformed Int       @default(0) // Count of actions taken
  lastActionAt     DateTime?

  ipAddress String? // IP where session was initiated
  userAgent String? // Browser/client info

  @@index([impersonatorId])
  @@index([targetAdminId])
  @@index([status])
  @@index([startedAt])
  @@map("admin_impersonation_sessions")
}

// Admin secure messaging status
enum AdminMessageStatus {
  SENT
  DELIVERED
  READ
  DELETED
}

// Admin secure messaging priority
enum AdminMessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Admin secure internal messaging
model AdminSecureMessage {
  id String @id @default(uuid())

  senderId    String // Admin who sent
  senderEmail String
  senderRole  AdminRole

  recipientId    String? // Specific admin (null for broadcast)
  recipientEmail String?
  recipientRole  AdminRole? // For role-based broadcast

  subject     String
  content     String // Encrypted content
  contentHash String? // Hash for integrity verification

  priority AdminMessagePriority @default(NORMAL)
  status   AdminMessageStatus   @default(SENT)

  isEncrypted    Boolean @default(true)
  isConfidential Boolean @default(false) // Extra security

  expiresAt DateTime? // Optional message expiration

  readAt    DateTime?
  deletedAt DateTime?

  attachments Json? // Array of attachment metadata

  threadId  String? // For threaded conversations
  replyToId String? // Parent message for replies

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([recipientId])
  @@index([recipientRole])
  @@index([status])
  @@index([priority])
  @@index([threadId])
  @@index([createdAt])
  @@map("admin_secure_messages")
}

// Admin session activity log
model AdminSessionLog {
  id String @id @default(uuid())

  adminId    String
  adminEmail String
  adminRole  AdminRole

  sessionId String // JWT session identifier

  action String // login, logout, timeout, revoked

  ipAddress         String?
  userAgent         String?
  deviceFingerprint String?

  geoLocation Json? // {country, city, region}

  isSuccess     Boolean @default(true)
  failureReason String?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([sessionId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_session_logs")
}

// ====================================================
// PHASE 2: GLOBAL AUDIT ENGINE V2
// ====================================================

// Audit chain for tamper-proof logging
model AuditEventChain {
  id String @id @default(uuid())

  sequenceNumber Int // Monotonically increasing

  auditLogId String // FK to AuditLog

  previousHash String? // Hash of previous event in chain
  currentHash  String // SHA-256 hash of this event

  timestamp DateTime @default(now())

  traceId      String? // Cross-system trace ID
  spanId       String? // Span within trace
  parentSpanId String? // Parent span for hierarchy

  systemId String @default("safego-main") // Source system

  isVerified Boolean @default(true) // Chain integrity verified

  @@unique([sequenceNumber])
  @@index([auditLogId])
  @@index([traceId])
  @@index([spanId])
  @@index([timestamp])
  @@map("audit_event_chains")
}

// Evidence packet status
enum EvidencePacketStatus {
  GENERATING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
}

// Automatic incident evidence packets
model AuditEvidencePacket {
  id String @id @default(uuid())

  incidentId   String // Related incident/case ID
  incidentType String // risk_case, safety_event, fraud_case, etc.

  status EvidencePacketStatus @default(GENERATING)

  title       String
  description String?

  // Event collection
  eventIds       String[] // Related audit event IDs
  eventCount     Int       @default(0)
  eventStartDate DateTime?
  eventEndDate   DateTime?

  // Users involved
  userIds   String[] // User IDs involved
  userRoles String[] // Roles of involved users

  // Evidence files
  fileUrl  String? // Generated evidence file URL
  fileSize Int? // File size in bytes
  fileHash String? // SHA-256 hash of file

  format String @default("PDF") // PDF, JSON, CSV

  generatedBy String? // Admin who triggered generation
  generatedAt DateTime?

  expiresAt DateTime? // File expiration

  downloadCount    Int       @default(0)
  lastDownloadedAt DateTime?
  lastDownloadedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([incidentId])
  @@index([incidentType])
  @@index([status])
  @@index([createdAt])
  @@map("audit_evidence_packets")
}

// Regulator export status
enum RegulatorExportStatus {
  QUEUED
  PROCESSING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
}

// Regulator export type
enum RegulatorExportType {
  COMPLIANCE_REPORT
  INCIDENT_REPORT
  FINANCIAL_AUDIT
  USER_DATA_EXPORT
  TRANSACTION_HISTORY
  SAFETY_REPORT
  CUSTOM
}

// Regulator export queue
model RegulatorExportQueue {
  id String @id @default(uuid())

  exportType RegulatorExportType
  format     String              @default("PDF") // PDF, CSV, JSON

  status RegulatorExportStatus @default(QUEUED)

  title       String
  description String?

  // Filter criteria
  startDate   DateTime?
  endDate     DateTime?
  countryCode String? // BD, US, or null for all
  userTypes   String[] // customer, driver, restaurant, etc.
  eventTypes  String[] // Specific event types to include

  // Generated file
  fileUrl  String?
  fileSize Int?
  fileHash String? // SHA-256 for integrity

  // Metadata
  recordCount Int? // Number of records
  pageCount   Int? // Number of pages (for PDF)

  requestedBy      String // Admin ID
  requestedByEmail String
  requestedAt      DateTime @default(now())

  processedAt DateTime?
  completedAt DateTime?

  expiresAt DateTime? // File expiration

  downloadCount    Int       @default(0)
  lastDownloadedAt DateTime?

  errorMessage String? // Error if failed

  @@index([exportType])
  @@index([status])
  @@index([requestedBy])
  @@index([requestedAt])
  @@map("regulator_export_queue")
}

// ====================================================
// LEGAL & COMPLIANCE DATA EXPORT CENTER
// ====================================================

enum ComplianceExportStatus {
  QUEUED
  PROCESSING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
  CANCELLED
}

enum ComplianceExportCategory {
  USER_REQUEST
  REGULATOR_COURT
  BULK_ANALYTICS
}

enum ComplianceExportScope {
  SINGLE_USER
  CASE_CENTRIC
  TIME_WINDOW
  CUSTOM
}

enum AnonymizationLevel {
  NONE
  PARTIAL
  FULL
}

model ComplianceDataExport {
  id String @id @default(uuid())

  category ComplianceExportCategory
  scope    ComplianceExportScope
  status   ComplianceExportStatus   @default(QUEUED)

  title       String
  description String?
  reason      String

  countryCode String?

  anonymizationLevel AnonymizationLevel @default(NONE)

  targetUserId    String?
  targetUserEmail String?
  targetUserPhone String?

  caseId   String?
  caseType String?

  startDate DateTime?
  endDate   DateTime?

  includedEntities String[]
  excludedFields   String[]

  fileUrl  String?
  fileSize Int?
  fileHash String?
  manifest Json?

  recordCount Int?

  requestedBy      String
  requestedByEmail String
  requestedByRole  String
  requestedAt      DateTime @default(now())

  approvedBy      String?
  approvedByEmail String?
  approvedAt      DateTime?

  processedAt DateTime?
  completedAt DateTime?
  expiresAt   DateTime?

  downloadCount    Int       @default(0)
  lastDownloadedAt DateTime?
  lastDownloadedBy String?

  errorMessage String?
  retryCount   Int     @default(0)

  auditLogId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessLogs ComplianceExportAccessLog[]

  @@index([category])
  @@index([scope])
  @@index([status])
  @@index([requestedBy])
  @@index([requestedAt])
  @@index([countryCode])
  @@index([targetUserId])
  @@map("compliance_data_exports")
}

model ComplianceExportAccessLog {
  id String @id @default(uuid())

  exportId String
  export   ComplianceDataExport @relation(fields: [exportId], references: [id])

  action String

  accessedBy      String
  accessedByEmail String
  accessedAt      DateTime @default(now())

  ipAddress String?
  userAgent String?

  @@index([exportId])
  @@index([accessedBy])
  @@index([accessedAt])
  @@map("compliance_export_access_logs")
}

model DataRetentionPolicy {
  id String @id @default(uuid())

  countryCode String @unique

  rideDataRetentionDays    Int @default(2555)
  paymentDataRetentionDays Int @default(2555)
  kycDataRetentionDays     Int @default(3650)
  auditLogRetentionDays    Int @default(2555)
  complaintRetentionDays   Int @default(1825)

  allowUserDeletionRequest Boolean @default(true)
  softDeleteOnly           Boolean @default(true)

  archivedDataAccessible Boolean @default(false)

  legalBasis  String?
  lastUpdated DateTime @default(now())
  updatedBy   String?

  @@map("data_retention_policies")
}

// ====================================================
// PHASE 2: PEOPLE & KYC CENTER - ADVANCED FEATURES
// ====================================================

// Risk signal types for identity scoring
enum RiskSignalType {
  DEVICE_ANOMALY // Unusual device patterns
  LOCATION_ANOMALY // Suspicious location patterns
  VELOCITY_CHECK // Too many actions too fast
  DOCUMENT_MISMATCH // Document inconsistencies
  DUPLICATE_IDENTITY // Matching another account
  FRAUD_HISTORY // Prior fraud association
  SUSPICIOUS_PAYMENT // Payment anomalies
  BEHAVIORAL_ANOMALY // Unusual behavior patterns
  BLACKLIST_MATCH // On known bad-actor list
  EXTERNAL_SIGNAL // Third-party fraud signal
}

// Risk signal severity
enum RiskSignalSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Identity risk signals for users
model IdentityRiskSignal {
  id String @id @default(uuid())

  userId   String // User this signal is about
  userRole String // customer, driver, restaurant, etc.

  signalType RiskSignalType
  severity   RiskSignalSeverity @default(MEDIUM)

  score Int @default(0) // 0-100 risk score contribution

  title       String
  description String?

  evidence Json? // Supporting evidence data

  isActive       Boolean   @default(true)
  isAcknowledged Boolean   @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?

  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?

  source     String  @default("system") // system, manual, external
  externalId String? // External system reference

  expiresAt DateTime? // Signal expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userRole])
  @@index([signalType])
  @@index([severity])
  @@index([isActive])
  @@index([createdAt])
  @@map("identity_risk_signals")
}

// Duplicate cluster status
enum DuplicateClusterStatus {
  DETECTED // Just detected
  UNDER_REVIEW // Being reviewed
  CONFIRMED // Confirmed duplicates
  FALSE_POSITIVE // Not actually duplicates
  RESOLVED // Action taken
}

// Duplicate account detection clusters
model DuplicateAccountCluster {
  id String @id @default(uuid())

  status DuplicateClusterStatus @default(DETECTED)

  primaryAccountId   String? // Main account (if determined)
  primaryAccountRole String?

  accountIds   String[] // All accounts in cluster
  accountRoles String[] // Corresponding roles
  accountCount Int      @default(2)

  matchType    String // phone, email, device, document, name
  matchScore   Int    @default(0) // 0-100 confidence
  matchDetails Json? // Details of what matched

  riskLevel RiskSignalSeverity @default(MEDIUM)

  detectedAt DateTime @default(now())
  detectedBy String   @default("system") // system or admin ID

  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  resolvedBy       String?
  resolvedAt       DateTime?
  resolutionAction String? // merge, block_secondary, no_action, etc.

  countryCode String? // BD, US

  @@index([status])
  @@index([primaryAccountId])
  @@index([matchType])
  @@index([riskLevel])
  @@index([detectedAt])
  @@map("duplicate_account_clusters")
}

// KYC review queue status
enum KycQueueStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  ESCALATED
  ON_HOLD
}

// KYC review queue priority
enum KycQueuePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// KYC review queue for workflow management
model KycReviewQueue {
  id String @id @default(uuid())

  userId   String // User awaiting review
  userRole String // customer, driver, restaurant, etc.

  documentId   String? // Specific document if applicable
  documentType String?

  status   KycQueueStatus   @default(PENDING)
  priority KycQueuePriority @default(NORMAL)

  countryCode String // BD, US - determines rules

  riskScore     Int      @default(0) // Calculated risk score
  riskSignalIds String[] // Related risk signals

  assignedAdminId String?
  assignedAt      DateTime?

  submittedAt     DateTime  @default(now())
  reviewStartedAt DateTime?
  completedAt     DateTime?

  slaDeadline DateTime? // SLA deadline for review
  isOverdue   Boolean   @default(false)

  reviewNotes     String?
  rejectionReason String?

  // Escalation tracking
  escalatedTo      String?
  escalatedAt      DateTime?
  escalationReason String?

  previousReviews Int @default(0) // Number of prior reviews

  @@index([userId])
  @@index([userRole])
  @@index([status])
  @@index([priority])
  @@index([countryCode])
  @@index([assignedAdminId])
  @@index([submittedAt])
  @@index([slaDeadline])
  @@map("kyc_review_queue")
}

// Country-specific KYC enforcement rules
model KycEnforcementRule {
  id String @id @default(uuid())

  countryCode String // BD, US
  userRole    String // customer, driver, restaurant, etc.

  ruleName    String
  description String?

  // Document requirements
  requiredDocuments String[] // Array of required document types
  optionalDocuments String[] // Array of optional document types

  // Verification levels
  minVerificationLevel    Int     @default(1) // 1-5 verification level
  requiresLivenessCheck   Boolean @default(false)
  requiresFacialMatch     Boolean @default(false)
  requiresBackgroundCheck Boolean @default(false)

  // Timing rules
  gracePeriodDays   Int @default(0) // Days before enforcement
  expiryWarningDays Int @default(30) // Days before expiry warning

  // Auto-enforcement
  autoRejectUnverified Boolean @default(false)
  autoSuspendExpired   Boolean @default(true)

  isActive Boolean @default(true)

  effectiveFrom  DateTime  @default(now())
  effectiveUntil DateTime?

  createdBy String?
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countryCode, userRole, ruleName])
  @@index([countryCode])
  @@index([userRole])
  @@index([isActive])
  @@map("kyc_enforcement_rules")
}

// Suspicious activity flags
model SuspiciousActivityFlag {
  id String @id @default(uuid())

  userId   String
  userRole String

  flagType String // fraud_attempt, abuse, collusion, policy_violation
  severity RiskSignalSeverity @default(MEDIUM)

  title       String
  description String?
  evidence    Json?

  status String @default("active") // active, investigating, resolved, dismissed

  flaggedBy String   @default("system") // system or admin ID
  flaggedAt DateTime @default(now())

  assignedTo  String?
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  actionTaken   String? // warning, temporary_ban, permanent_ban, no_action
  actionTakenBy String?
  actionTakenAt DateTime?

  relatedCaseId String? // Link to RiskCase if escalated

  countryCode String?

  @@index([userId])
  @@index([userRole])
  @@index([flagType])
  @@index([status])
  @@index([severity])
  @@index([flaggedAt])
  @@map("suspicious_activity_flags")
}

// ====================================================
// PHASE 4: ENTERPRISE ADMIN FEATURES
// ====================================================

// Complaint Resolution System
enum ComplaintStatus {
  new
  reviewed
  needs_more_info
  escalated
  assigned
  in_progress
  resolved
  archived
}

enum ComplaintCategory {
  ride_quality
  driver_behavior
  safety_concern
  billing_issue
  food_quality
  delivery_issue
  app_problem
  fraud_report
  harassment
  discrimination
  vehicle_condition
  other
}

enum ComplaintSeverity {
  low
  medium
  high
  critical
}

model Complaint {
  id String @id @default(uuid())

  ticketCode String @unique // e.g., "SG-CMP-2025-000123"

  category    ComplaintCategory
  severity    ComplaintSeverity @default(medium)
  status      ComplaintStatus   @default(new)
  countryCode String

  customerId String?
  driverId   String?
  rideId     String?
  orderId    String?
  parcelId   String?

  subject     String
  description String   @db.Text
  attachments String[] // Array of file URLs

  triageNotes    String?
  assignedTo     String? // Admin ID
  assignedAt     DateTime?
  assignedBy     String? // Admin ID who assigned

  resolutionNote String?   @db.Text
  resolvedBy     String?
  resolvedAt     DateTime?

  userNotified       Boolean   @default(false)
  userNotifiedAt     DateTime?
  customerSatisfied  Boolean?

  archivedAt DateTime?
  archivedBy String?

  customer CustomerProfile? @relation(fields: [customerId], references: [id])
  driver   DriverProfile?   @relation(fields: [driverId], references: [id])
  ride     Ride?            @relation(fields: [rideId], references: [id])

  auditLogs ComplaintAuditLog[]
  evidence  ComplaintEvidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketCode])
  @@index([category])
  @@index([severity])
  @@index([status])
  @@index([countryCode])
  @@index([customerId])
  @@index([driverId])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("complaints")
}

model ComplaintAuditLog {
  id          String @id @default(uuid())
  complaintId String

  action    String // created, status_changed, assigned, escalated, resolved, archived
  actor     String // Admin ID
  actorRole String
  details   Json?

  previousValue String?
  newValue      String?

  createdAt DateTime @default(now())

  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@index([actor])
  @@index([createdAt])
  @@map("complaint_audit_logs")
}

model ComplaintEvidence {
  id          String @id @default(uuid())
  complaintId String

  fileType    String // image, video, audio, document
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  description String?

  uploadedBy String
  uploadedAt DateTime @default(now())

  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@map("complaint_evidence")
}

// Legal Requests Dashboard
enum LegalRequestStatus {
  received
  verification
  processing
  delivered
  archived
  expired
  rejected
}

enum LegalRequestCountry {
  USA
  BD
}

model LegalRequest {
  id String @id @default(uuid())

  requestCode String             @unique // e.g., "SG-LEG-2025-000001"
  country     LegalRequestCountry
  status      LegalRequestStatus  @default(received)

  // USA-specific fields
  subpoenaId String?
  caseId     String?
  agencyName String?

  // Bangladesh-specific fields
  gdNumber      String? // General Diary Number
  policeStation String?
  ioName        String? // Investigating Officer Name

  // Common fields
  requestType        String // user_data, trip_records, financial_records, communications
  targetUserId       String?
  targetDriverId     String?
  dateRangeStart     DateTime?
  dateRangeEnd       DateTime?
  
  requestingOfficer  String
  requestingAgency   String
  contactEmail       String
  contactPhone       String?

  description String  @db.Text
  attachments String[] // Legal documents

  // Evidence delivery
  evidencePackage   String? // URL to compiled evidence
  evidenceExpiresAt DateTime?
  evidenceDownloads Int     @default(0)

  // Processing
  assignedTo     String?
  assignedAt     DateTime?
  processedBy    String?
  processedAt    DateTime?
  deliveredAt    DateTime?
  deliveryMethod String? // secure_download, email, physical

  // Expiry
  requestExpiresAt DateTime?

  notes String? @db.Text

  auditLogs LegalRequestAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestCode])
  @@index([country])
  @@index([status])
  @@index([targetUserId])
  @@index([targetDriverId])
  @@index([createdAt])
  @@map("legal_requests")
}

model LegalRequestAuditLog {
  id             String @id @default(uuid())
  legalRequestId String

  action    String
  actor     String
  actorRole String
  details   Json?

  ipAddress   String?
  hashChainId String? // For tamper-proof verification

  createdAt DateTime @default(now())

  legalRequest LegalRequest @relation(fields: [legalRequestId], references: [id], onDelete: Cascade)

  @@index([legalRequestId])
  @@index([actor])
  @@index([createdAt])
  @@map("legal_request_audit_logs")
}

// Admin Communication Hub
enum AnnouncementStatus {
  draft
  scheduled
  sending
  sent
  failed
  cancelled
}

enum AnnouncementTargetGroup {
  all
  customers
  drivers
  restaurants
  admins
}

model Announcement {
  id String @id @default(uuid())

  title       String
  messageEn   String @db.Text // English message
  messageBn   String? @db.Text // Bengali message
  imageUrl    String?

  targetGroup  AnnouncementTargetGroup
  countryCode  String?
  cityCode     String?

  channels String[] // push, sms, email, in_app_banner

  status       AnnouncementStatus @default(draft)
  scheduledFor DateTime?
  sentAt       DateTime?

  // Analytics
  totalRecipients  Int @default(0)
  delivered        Int @default(0)
  opened           Int @default(0)
  clicked          Int @default(0)
  failed           Int @default(0)

  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([targetGroup])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("announcements")
}

// Email Template Editor
model EmailTemplate {
  id String @id @default(uuid())

  templateKey String @unique // e.g., "ride_receipt", "refund_notice"
  name        String
  description String?

  subjectEn String
  subjectBn String?
  bodyEn    String @db.Text // HTML content
  bodyBn    String? @db.Text

  variables String[] // Available placeholders like {name}, {amount}

  version   Int      @default(1)
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)

  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions EmailTemplateVersion[]

  @@index([templateKey])
  @@index([isActive])
  @@map("email_templates")
}

model EmailTemplateVersion {
  id         String @id @default(uuid())
  templateId String

  version   Int
  subjectEn String
  subjectBn String?
  bodyEn    String @db.Text
  bodyBn    String? @db.Text

  createdBy String
  createdAt DateTime @default(now())

  template EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([version])
  @@map("email_template_versions")
}

// SMS Template & Automation Engine
model SmsTemplate {
  id String @id @default(uuid())

  templateKey String @unique // e.g., "otp", "ride_status"
  name        String
  description String?

  messageEn String // SMS content
  messageBn String?

  variables String[] // Available placeholders

  // Country-specific routing
  usaTwilioEnabled Boolean @default(true)
  bdRouting        String? // telecom provider preference

  version   Int     @default(1)
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveryLogs SmsDeliveryLog[]

  @@index([templateKey])
  @@index([isActive])
  @@map("sms_templates")
}

model SmsDeliveryLog {
  id         String @id @default(uuid())
  templateId String?

  phoneNumber  String
  countryCode  String
  message      String
  provider     String // twilio, grameenphone, robi, etc.

  status       String // sent, delivered, failed
  errorCode    String?
  errorMessage String?

  externalId String? // Provider's message ID
  cost       Decimal? @db.Decimal(10, 4)

  sentAt      DateTime @default(now())
  deliveredAt DateTime?

  template SmsTemplate? @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([phoneNumber])
  @@index([status])
  @@index([sentAt])
  @@map("sms_delivery_logs")
}

// Internal Admin Chat System
enum AdminChatChannelType {
  department
  private
  announcement
}

model AdminChatChannel {
  id String @id @default(uuid())

  name        String
  description String?
  type        AdminChatChannelType @default(department)
  department  String? // safety, support, finance, ops, legal

  isPrivate Boolean @default(false)

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  AdminChatMember[]
  messages AdminChatMessage[]

  @@index([type])
  @@index([department])
  @@map("admin_chat_channels")
}

model AdminChatMember {
  id        String @id @default(uuid())
  channelId String
  adminId   String

  role          String   @default("member") // owner, admin, member
  joinedAt      DateTime @default(now())
  lastReadAt    DateTime?
  notifications Boolean  @default(true)

  channel AdminChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, adminId])
  @@index([adminId])
  @@map("admin_chat_members")
}

model AdminChatMessage {
  id        String @id @default(uuid())
  channelId String
  senderId  String

  content     String  @db.Text
  attachments String[] // File URLs
  mentions    String[] // @mentioned admin IDs

  isEdited  Boolean   @default(false)
  isDeleted Boolean   @default(false)
  editedAt  DateTime?

  replyToId String?

  createdAt DateTime @default(now())

  channel AdminChatChannel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reads   AdminChatReadReceipt[]

  @@index([channelId])
  @@index([senderId])
  @@index([createdAt])
  @@map("admin_chat_messages")
}

model AdminChatReadReceipt {
  id        String @id @default(uuid())
  messageId String
  adminId   String
  readAt    DateTime @default(now())

  message AdminChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, adminId])
  @@index([adminId])
  @@map("admin_chat_read_receipts")
}

// Safety Incident Replay Tool
model SafetyIncident {
  id String @id @default(uuid())

  incidentCode String @unique // e.g., "SG-INC-2025-000001"

  rideId   String
  driverId String
  customerId String?

  severity String // low, medium, high, critical

  // Event details
  eventType     String // speed_spike, hard_brake, route_deviation, sos_triggered
  eventData     Json?  // Speed, location, timestamps
  gpsSnapshots  Json?  // Array of GPS coordinates with timestamps

  // Timeline
  incidentStart DateTime
  incidentEnd   DateTime?

  // Summary
  summary        String? @db.Text
  adminNotes     String? @db.Text
  aiAnalysis     Json?   // AI-generated analysis

  // Status
  status       String @default("pending") // pending, under_review, resolved, escalated
  reviewedBy   String?
  reviewedAt   DateTime?
  resolution   String?

  // Export
  pdfReportUrl String?
  pdfExportedAt DateTime?
  pdfExportedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ride   Ride          @relation(fields: [rideId], references: [id])
  driver DriverProfile @relation("SafetyIncidentDriver", fields: [driverId], references: [id])

  @@index([incidentCode])
  @@index([rideId])
  @@index([driverId])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("safety_incidents")
}

// Admin Geofence Management
model Geofence {
  id String @id @default(uuid())

  name        String
  description String?
  countryCode String
  cityCode    String?

  // GeoJSON polygon or circle
  geoType   String // polygon, circle
  geoData   Json   // Coordinates for polygon or center+radius for circle

  // Rules
  isActive      Boolean @default(true)
  ruleType      String  // no_service, surge_zone, restricted, airport, hospital
  restrictions  Json?   // Specific restrictions

  // Validity
  validFrom  DateTime?
  validUntil DateTime?

  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  @@index([cityCode])
  @@index([isActive])
  @@index([ruleType])
  @@map("geofences")
}

// Operations Console: Job Run Tracking
enum SystemJobStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
  CANCELLED
}

model SystemJobRun {
  id String @id @default(uuid())

  jobName     String // e.g., "payout_processing", "wallet_reconciliation", "stripe_sync"
  jobCategory String // e.g., "payments", "sync", "cleanup", "analytics"

  // Execution details
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  status      SystemJobStatus @default(RUNNING)
  durationMs  Int?

  // Results
  recordsProcessed Int?
  recordsSucceeded Int?
  recordsFailed    Int?
  errorSummary     String? @db.Text
  errorDetails     Json?

  // Context
  triggeredBy  String? // "scheduler", "manual", "webhook", admin email
  environment  String  @default("development") // dev, staging, production
  metadata     Json?   // Additional context

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobName])
  @@index([jobCategory])
  @@index([status])
  @@index([startedAt])
  @@index([environment])
  @@map("system_job_runs")
}

// Operations Console: System Error Tracking
enum SystemErrorSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

model SystemError {
  id String @id @default(uuid())

  // Error classification
  service       String // e.g., "payment", "kyc", "notification", "maps"
  severity      SystemErrorSeverity
  errorCode     String? // Custom error code
  errorType     String? // Exception type name

  // Error details
  message       String @db.Text
  stackTrace    String? @db.Text
  requestPath   String?
  requestMethod String?

  // Correlation
  correlationId String? // Request/transaction ID
  userId        String?
  driverId      String?
  rideId        String?
  orderId       String?

  // Context
  countryCode   String?
  environment   String @default("development")
  metadata      Json?  // Additional context
  userAgent     String?
  ipAddress     String?

  // Resolution
  isResolved    Boolean @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  resolution    String? @db.Text

  createdAt DateTime @default(now())

  @@index([service])
  @@index([severity])
  @@index([errorCode])
  @@index([correlationId])
  @@index([userId])
  @@index([countryCode])
  @@index([environment])
  @@index([isResolved])
  @@index([createdAt])
  @@map("system_errors")
}

// Operations Console: Service Health Check Results
model ServiceHealthCheck {
  id String @id @default(uuid())

  serviceName   String // e.g., "database", "stripe", "twilio", "google_maps"
  serviceType   String // e.g., "database", "payment", "notification", "maps", "queue"

  // Status
  status        String // OK, DEGRADED, DOWN
  latencyMs     Int?
  lastSuccess   DateTime?
  lastFailure   DateTime?

  // Details
  statusMessage String?
  errorMessage  String?
  metadata      Json?

  // Configuration
  checkInterval Int @default(60) // seconds
  timeout       Int @default(5000) // milliseconds

  checkedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceName])
  @@index([serviceType])
  @@index([status])
  @@index([checkedAt])
  @@map("service_health_checks")
}

// Backup & Disaster Recovery: Backup Snapshots
model BackupSnapshot {
  id String @id @default(uuid())

  createdAt    DateTime @default(now())
  environment  String   // dev, staging, prod
  type         String   // FULL_DB, PARTIAL_ANALYTICS, FILES_ONLY, CONFIG_ONLY
  
  storageLocationLabel String   // Friendly name only, no raw bucket URLs/keys
  sizeMb               Decimal? @db.Decimal(10, 2)
  status               String   // CREATED, VERIFIED, FAILED, IN_PROGRESS
  
  retentionDays   Int      @default(30)
  expiresAt       DateTime?
  
  initiatedBy     String?  // Admin who triggered the backup
  initiatedByName String?  // Admin name for display
  
  verifiedAt      DateTime?
  verifiedBy      String?
  verifiedByName  String?
  
  errorMessage    String?  @db.Text
  metadata        Json?    // Additional context (e.g., tables included, checksums)
  
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  deletedBy       String?

  @@index([environment])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([isDeleted])
  @@map("backup_snapshots")
}

// Backup & Disaster Recovery: Restore Operations
model RestoreOperation {
  id String @id @default(uuid())

  snapshotId         String
  sourceEnvironment  String  // Environment the backup was taken from
  targetEnvironment  String  // Environment being restored to (never prod directly)
  
  status             String  // PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED
  startedAt          DateTime?
  completedAt        DateTime?
  
  initiatedBy        String
  initiatedByName    String?
  
  confirmationToken  String?  // For double-confirmation of dangerous operations
  confirmedAt        DateTime?
  
  errorMessage       String? @db.Text
  rollbackAvailable  Boolean @default(false)
  
  auditLogId         String? // Link to detailed audit log entry
  metadata           Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([snapshotId])
  @@index([status])
  @@index([sourceEnvironment])
  @@index([targetEnvironment])
  @@index([initiatedBy])
  @@index([createdAt])
  @@map("restore_operations")
}

// Backup & Disaster Recovery: DR Configuration
model DRConfiguration {
  id String @id @default(uuid())

  environment       String @unique // dev, staging, prod
  
  rpoTargetMinutes  Int    @default(60)  // Recovery Point Objective
  rtoTargetMinutes  Int    @default(240) // Recovery Time Objective
  
  autoBackupEnabled Boolean @default(true)
  backupFrequency   String  @default("DAILY") // HOURLY, DAILY, WEEKLY
  backupRetentionDays Int   @default(30)
  
  crossRegionEnabled   Boolean @default(false)
  crossRegionLocation  String?
  
  lastBackupAt         DateTime?
  lastVerifiedBackupAt DateTime?
  
  alertsEnabled        Boolean @default(true)
  alertRecipients      String[] @default([])
  
  metadata Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dr_configurations")
}

// ===========================================
// GOVERNANCE: Periodic Access Review System
// ===========================================

// Review Cycle Status
enum ReviewCycleStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Review Decision Types
enum ReviewDecision {
  PENDING
  KEEP
  REVOKE
  CHANGE_ROLE
}

// Access Review Cycle - Periodic review of admin access
model AccessReviewCycle {
  id String @id @default(uuid())

  name        String   // e.g., "Q1 2026 Access Review"
  description String?  @db.Text
  period      String   // e.g., "Q1 2026" or "2026-01-01 to 2026-03-31"
  
  status      ReviewCycleStatus @default(OPEN)
  
  // Scope filters
  countryScope String?  // BD, US, or null for global
  roleScope    String[] @default([]) // Specific roles to review, empty = all
  
  // Dates
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  
  // Creator
  createdByAdminId   String
  createdByAdminName String?
  
  // Completion stats
  totalItems        Int @default(0)
  reviewedItems     Int @default(0)
  keptCount         Int @default(0)
  revokedCount      Int @default(0)
  changedRoleCount  Int @default(0)
  
  // Settings
  requiresTwoPersonRule Boolean @default(false)
  notifyOnComplete      Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  reviewItems AccessReviewItem[]

  @@index([status])
  @@index([countryScope])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@index([dueDate])
  @@map("access_review_cycles")
}

// Access Review Item - Individual admin/role combination to review
model AccessReviewItem {
  id String @id @default(uuid())

  reviewCycleId String
  reviewCycle   AccessReviewCycle @relation(fields: [reviewCycleId], references: [id], onDelete: Cascade)
  
  // Admin being reviewed
  adminId       String
  adminEmail    String
  adminName     String?
  
  // Role being reviewed
  currentRole   String   // AdminRole at time of review
  newRole       String?  // If decision is CHANGE_ROLE
  
  // Team/Department classification
  team          String?  // Support, Finance, Risk, Infra, etc.
  country       String?  // Country code for filtering
  
  // Review decision
  decision        ReviewDecision @default(PENDING)
  justificationText String?      @db.Text
  
  // First reviewer
  decidedByAdminId   String?
  decidedByAdminName String?
  decidedAt          DateTime?
  
  // Two-person rule: second approval
  requiresSecondApproval Boolean @default(false)
  secondApprovalBy       String?
  secondApprovalByName   String?
  secondApprovalAt       DateTime?
  secondApprovalDecision ReviewDecision?
  
  // Enforcement
  isEnforced     Boolean   @default(false)
  enforcedAt     DateTime?
  enforcedBy     String?
  enforcementError String? @db.Text
  
  // Audit trail
  previousRoles  String[]  @default([]) // Roles before any change
  auditLogId     String?   // Link to detailed audit log
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reviewCycleId, adminId, currentRole])
  @@index([reviewCycleId])
  @@index([adminId])
  @@index([decision])
  @@index([team])
  @@index([country])
  @@index([isEnforced])
  @@map("access_review_items")
}

// Access Review Summary - Audit record of completed cycles
model AccessReviewSummary {
  id String @id @default(uuid())

  reviewCycleId String @unique
  cycleName     String
  period        String
  
  // Stats
  totalAdminsReviewed Int
  totalRolesReviewed  Int
  keptCount           Int
  revokedCount        Int
  changedRoleCount    Int
  
  // Reviewers who participated
  reviewerIds   String[]
  reviewerNames String[]
  
  // Timing
  cycleStartedAt   DateTime
  cycleCompletedAt DateTime
  durationDays     Int
  
  // Export info
  exportedAt DateTime?
  exportPath String?
  exportType String?  // CSV, PDF
  
  // Compliance fields
  complianceNotes String? @db.Text
  
  createdAt DateTime @default(now())

  @@index([reviewCycleId])
  @@index([cycleCompletedAt])
  @@map("access_review_summaries")
}

// ============================================
// Environment Promotion & Publish Readiness Console
// ============================================

enum ReleaseEnvironment {
  DEV
  STAGING
  PROD
}

enum ReleaseDeploymentStatus {
  NOT_DEPLOYED
  DEPLOYED
  VERIFIED
  ROLLED_BACK
}

enum ReleaseChecklistStatus {
  PENDING
  PASSED
  FAILED
}

enum ReleaseApprovalStatus {
  NOT_REQUIRED
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

// Release Version - Tracks a software release
model ReleaseVersion {
  id          String   @id @default(uuid())
  versionTag  String   @unique // e.g. "v1.0.3"
  description String?  @db.Text
  
  // Metadata
  releaseNotes    String?  @db.Text
  includedPhases  String[] @default([]) // PHASE2_REPORT, PHASE3_REPORT, etc.
  
  // Creator
  createdByAdminId   String
  createdByAdminName String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  environmentStatuses ReleaseEnvironmentStatus[]
  checklistItems      ReleaseChecklistItem[]
  auditLogs           ReleaseAuditLog[]

  @@index([versionTag])
  @@index([createdAt])
  @@map("release_versions")
}

// Release Environment Status - Tracks deployment status per environment
model ReleaseEnvironmentStatus {
  id String @id @default(uuid())
  
  releaseId   String
  release     ReleaseVersion @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  
  environment      ReleaseEnvironment
  deploymentStatus ReleaseDeploymentStatus @default(NOT_DEPLOYED)
  checklistStatus  ReleaseChecklistStatus  @default(PENDING)
  
  // Two-step approval for production
  approvalStatus     ReleaseApprovalStatus @default(NOT_REQUIRED)
  proposedByAdminId  String?
  proposedByAdminName String?
  proposedAt         DateTime?
  approvedByAdminId  String?
  approvedByAdminName String?
  approvedAt         DateTime?
  rejectionReason    String? @db.Text
  
  // Last update tracking
  lastUpdatedByAdminId   String?
  lastUpdatedByAdminName String?
  lastUpdatedAt          DateTime?
  
  // Deployment timestamps
  deployedAt   DateTime?
  verifiedAt   DateTime?
  rolledBackAt DateTime?
  
  // Warnings and blockers
  hasBlockingIssues Boolean @default(false)
  blockingIssues    String[] @default([])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([releaseId, environment])
  @@index([releaseId])
  @@index([environment])
  @@index([deploymentStatus])
  @@map("release_environment_statuses")
}

// Release Checklist Item - Individual checklist items per environment
model ReleaseChecklistItem {
  id String @id @default(uuid())
  
  releaseId   String
  release     ReleaseVersion @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  
  environment ReleaseEnvironment
  
  // Checklist item definition
  itemKey     String  // e.g. "automated_tests", "security_audit"
  itemLabel   String  // Human readable label
  description String? @db.Text
  isRequired  Boolean @default(true)
  sortOrder   Int     @default(0)
  
  // Completion status
  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  completedByAdminId   String?
  completedByAdminName String?
  
  // Notes and evidence
  notes      String? @db.Text
  evidenceUrl String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([releaseId, environment, itemKey])
  @@index([releaseId])
  @@index([environment])
  @@index([isCompleted])
  @@map("release_checklist_items")
}

// Release Audit Log - History of all state changes
model ReleaseAuditLog {
  id String @id @default(uuid())
  
  releaseId   String
  release     ReleaseVersion @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  
  environment   ReleaseEnvironment?
  
  // Change details
  action        String  // CREATED, STATUS_CHANGED, CHECKLIST_UPDATED, APPROVED, REJECTED, etc.
  oldValue      String? @db.Text
  newValue      String? @db.Text
  
  // Actor
  adminId   String
  adminName String?
  
  // Optional comment
  comment String? @db.Text
  
  // IP and session tracking
  ipAddress String?
  userAgent String? @db.Text
  
  createdAt DateTime @default(now())

  @@index([releaseId])
  @@index([environment])
  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@map("release_audit_logs")
}

// ===========================================
// OBSERVABILITY CENTER: System Metrics & Logs
// ===========================================

// Log Category Types
enum ObservabilityLogCategory {
  API
  AUTH
  FRAUD
  DRIVER
  ERROR
  PAYMENT
  SYSTEM
}

// Log Severity Levels
enum ObservabilityLogSeverity {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

// System Metrics - CPU, memory, connections, etc.
model SystemMetric {
  id String @id @default(uuid())

  metricType    String   // cpu_usage, memory_usage, db_connections, job_queue_depth, websocket_connections
  value         Decimal  @db.Decimal(10, 4)
  unit          String   // percent, count, ms, bytes
  
  // Time window aggregation
  windowStart   DateTime
  windowEnd     DateTime
  windowMinutes Int      @default(1) // 1, 5, or 15 minute windows
  
  // Context
  environment   String   @default("development")
  hostId        String?  // For multi-instance tracking
  
  // Min/Max/Avg for the window
  minValue      Decimal? @db.Decimal(10, 4)
  maxValue      Decimal? @db.Decimal(10, 4)
  avgValue      Decimal? @db.Decimal(10, 4)
  sampleCount   Int      @default(1)
  
  metadata      Json?
  
  createdAt DateTime @default(now())

  @@index([metricType])
  @@index([windowStart])
  @@index([windowMinutes])
  @@index([environment])
  @@map("system_metrics")
}

// Observability Log - Unified log aggregation
model ObservabilityLog {
  id String @id @default(uuid())

  category     ObservabilityLogCategory
  severity     ObservabilityLogSeverity
  
  // Log content
  message      String   @db.Text
  source       String   // e.g., "auth-service", "payment-gateway", "fraud-detection"
  
  // Context
  userId       String?
  adminId      String?
  requestId    String?  // For request tracing
  sessionId    String?
  
  // Request details
  method       String?  // GET, POST, etc.
  path         String?
  statusCode   Int?
  latencyMs    Int?
  
  // Error details
  errorCode    String?
  stackTrace   String?  @db.Text
  
  // Additional context
  ipAddress    String?
  userAgent    String?  @db.Text
  countryCode  String?
  
  metadata     Json?    // Flexible additional data
  
  createdAt DateTime @default(now())

  @@index([category])
  @@index([severity])
  @@index([source])
  @@index([userId])
  @@index([adminId])
  @@index([requestId])
  @@index([createdAt])
  @@index([errorCode])
  @@map("observability_logs")
}

// Event Correlation - Links related events for root cause analysis
model EventCorrelation {
  id String @id @default(uuid())

  // Correlation identification
  correlationId   String   @unique // UUID for grouping related events
  
  // Root event
  rootEventType   String   // incident, fraud_alert, payment_failure, driver_violation
  rootEventId     String   // ID of the triggering event
  rootEventTime   DateTime
  
  // Correlated events (stored as JSON array)
  correlatedEvents Json    // Array of { eventType, eventId, eventTime, confidence }
  
  // Analysis
  suggestedRootCause  String? @db.Text
  confidenceScore     Decimal? @db.Decimal(3, 2) // 0.00 to 1.00
  analysisStatus      String   @default("PENDING") // PENDING, ANALYZED, CONFIRMED, DISMISSED
  
  // Scope
  affectedUserId      String?
  affectedDriverId    String?
  affectedOrderId     String?
  affectedRideId      String?
  
  // Severity and impact
  impactLevel         String?  // LOW, MEDIUM, HIGH, CRITICAL
  estimatedImpact     String?  @db.Text // Description of potential impact
  
  // Resolution tracking
  resolvedAt          DateTime?
  resolvedBy          String?
  resolutionNotes     String?  @db.Text
  
  metadata            Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([correlationId])
  @@index([rootEventType])
  @@index([rootEventId])
  @@index([rootEventTime])
  @@index([analysisStatus])
  @@index([impactLevel])
  @@index([affectedUserId])
  @@index([affectedDriverId])
  @@index([createdAt])
  @@map("event_correlations")
}

// Metric Threshold Alert - For triggering alerts when metrics exceed thresholds
model MetricThresholdAlert {
  id String @id @default(uuid())

  metricType       String   // cpu_usage, memory_usage, etc.
  thresholdType    String   // ABOVE, BELOW, EQUALS
  thresholdValue   Decimal  @db.Decimal(10, 4)
  
  alertSeverity    String   @default("WARNING") // INFO, WARNING, CRITICAL
  alertMessage     String   @db.Text
  
  isEnabled        Boolean  @default(true)
  cooldownMinutes  Int      @default(15) // Prevent alert spam
  
  lastTriggeredAt  DateTime?
  triggerCount     Int      @default(0)
  
  // Notification settings
  notifyWebSocket  Boolean  @default(true)
  notifyEmail      Boolean  @default(false)
  notifyRecipients String[] @default([])
  
  createdBy        String?
  createdByName    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([metricType])
  @@index([isEnabled])
  @@index([alertSeverity])
  @@map("metric_threshold_alerts")
}

// ============================================
// SafePilot: AI-Powered Admin Assistant
// ============================================

enum SafePilotRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SafePilotActionType {
  NAVIGATE
  FILTER
  OPEN_PANEL
  RUN_REPORT
  BULK_ACTION
  SUGGEST_POLICY
}

// SafePilot Interaction - Tracks all admin interactions with SafePilot
model SafePilotInteraction {
  id String @id @default(uuid())

  adminId   String
  admin     User   @relation("SafePilotInteractions", fields: [adminId], references: [id])

  timestamp DateTime @default(now())

  pageKey           String   // e.g., "admin.drivers.list", "admin.rides.details"
  contextEntityType String?  // e.g., "driver", "customer", "ride", "order", "payout"
  contextEntityId   String?

  question        String?  @db.Text
  responseSummary String   @db.Text
  suggestionsJson Json     // Array of suggestions with actionType, label, payload

  selectedActionKey String?  // Which action the admin selected (if any)

  countryCode String?  // BD, US

  riskLevel SafePilotRiskLevel @default(LOW)

  // Performance tracking
  responseTimeMs   Int?
  insightsCount    Int      @default(0)
  suggestionsCount Int      @default(0)

  // Session tracking
  sessionId String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([pageKey])
  @@index([contextEntityType])
  @@index([countryCode])
  @@index([riskLevel])
  @@index([timestamp])
  @@index([sessionId])
  @@map("safepilot_interactions")
}

// SafePilot Config - Configuration for SafePilot rules and thresholds
model SafePilotConfig {
  id String @id @default(uuid())

  key         String  @unique // e.g., "risk_threshold.driver.low_rating", "fraud_pattern.refund_abuse"
  valueJson   Json    // Configuration value (thresholds, rules, etc.)
  description String? @db.Text

  isEnabled Boolean @default(true)

  category   String? // e.g., "risk_scoring", "fraud_detection", "cost_reduction", "safety"
  subcategory String? // e.g., "driver", "customer", "restaurant", "order"

  countryCode String? // BD, US, or null for global

  updatedByAdminId String?
  updatedByAdmin   User?   @relation("SafePilotConfigUpdates", fields: [updatedByAdminId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@index([isEnabled])
  @@index([countryCode])
  @@map("safepilot_configs")
}

// SafePilot Risk Score - Cached risk scores for entities
model SafePilotRiskScore {
  id String @id @default(uuid())

  entityType String // driver, customer, restaurant, ride, order
  entityId   String

  riskScore      Decimal @db.Decimal(5, 4) // 0.0000 to 1.0000
  riskLevel      SafePilotRiskLevel
  riskFactors    Json    // Array of { factor, weight, value, description }

  lastCalculated DateTime @default(now())
  expiresAt      DateTime?

  countryCode String?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([entityId])
  @@index([riskLevel])
  @@index([riskScore])
  @@index([countryCode])
  @@index([lastCalculated])
  @@map("safepilot_risk_scores")
}

// SafePilot Insight - Generated insights for admin review
model SafePilotInsight {
  id String @id @default(uuid())

  insightType String // risk, performance, cost, safety, compliance, fraud
  title       String
  detail      String @db.Text
  metrics     Json?  // Key-value metrics

  severity   SafePilotRiskLevel @default(LOW)
  priority   Int                @default(0) // Higher = more important

  entityType String?
  entityId   String?

  countryCode String?

  isActive    Boolean   @default(true)
  isDismissed Boolean   @default(false)
  dismissedBy String?
  dismissedAt DateTime?

  suggestedActions Json? // Array of actions to take

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([insightType])
  @@index([severity])
  @@index([priority])
  @@index([isActive])
  @@index([countryCode])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("safepilot_insights")
}

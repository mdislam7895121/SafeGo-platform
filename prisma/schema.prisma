generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  COUNTRY_ADMIN
  CITY_ADMIN
  COMPLIANCE_ADMIN
  SUPPORT_ADMIN
  FINANCE_ADMIN
  READONLY_ADMIN
}

enum SecurityStatus {
  normal
  under_observation
  needs_review
}

enum DocumentStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  EXPIRING_SOON
  EXPIRED
  REJECTED
  NEEDS_UPDATE
}

model AdminProfile {
  id                           String    @id @default(uuid())
  userId                       String    @unique
  adminRole                    AdminRole @default(SUPER_ADMIN)
  isActive                     Boolean   @default(true)
  createdAt                    DateTime  @default(now())
  twoFactorEnabled             Boolean   @default(false)
  twoFactorSecret_encrypted    String?
  twoFactorRecoveryCodes_encrypted String?
  pending2FASecret_encrypted   String?
  pending2FAExpiresAt          DateTime?
  country                      String?
  countryCode                  String?
  cityCode                     String?
  user                         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([countryCode])
  @@index([cityCode])
  @@map("admin_profiles")
}

model CustomerProfile {
  id                    String            @id @default(uuid())
  userId                String            @unique
  cityCode              String?
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  verificationStatus    String            @default("pending")
  rejectionReason       String?
  isVerified            Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  isSuspended           Boolean           @default(false)
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  securityStatus        SecurityStatus    @default(normal)
  securityNotes         String?
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  foodOrders            FoodOrder[]
  rides                 Ride[]

  @@index([cityCode])
  @@map("customer_profiles")
}

model Delivery {
  id               String           @id
  customerId       String
  driverId         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  serviceFare      Decimal          @db.Decimal(10, 2)
  safegoCommission Decimal          @db.Decimal(10, 2)
  driverPayout     Decimal          @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  taxBreakdown     Json?
  totalTaxAmount   Decimal?         @db.Decimal(10, 2)
  isDemo           Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  deliveredAt      DateTime?
  customer         CustomerProfile  @relation(fields: [customerId], references: [id])
  driver           DriverProfile?   @relation(fields: [driverId], references: [id])

  @@index([isDemo])
  @@map("deliveries")
}

model DriverComplaint {
  id         String             @id
  driverId   String?
  customerId String?
  rideId     String?
  reason     String
  description String?
  status     String             @default("open")
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime
  restaurantId String?
  type       String             @default("driver")
  customer   CustomerProfile?   @relation(fields: [customerId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ride       Ride?              @relation(fields: [rideId], references: [id])

  @@map("driver_complaints")
}

model DriverProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  nidImageUrl           String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  driverLicenseNumber   String?
  driverLicenseImageUrl String?
  driverLicenseExpiry   DateTime?
  ssnLast4              String?
  ssnCardImageUrl       String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelationship String?
  verificationStatus    String             @default("pending")
  rejectionReason       String?
  isVerified            Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  isSuspended           Boolean            @default(false)
  lastActive            DateTime?
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  backgroundCheckDate   DateTime?
  backgroundCheckStatus String?            @default("pending")
  licenseStateIssued    String?
  ssnEncrypted          String?
  usaCity               String?
  usaFullLegalName      String?
  usaPhoneNumber        String?
  usaState              String?
  usaStreet             String?
  usaZipCode            String?
  dmvLicenseImageUrl    String?
  dmvLicenseFrontUrl    String?
  dmvLicenseBackUrl     String?
  dmvLicenseExpiry      DateTime?
  dmvLicenseNumber      String?
  dmvLicenseNumber_encrypted String?
  firstName             String?
  lastName              String?
  middleName            String?
  profilePhotoUrl       String?
  tlcLicenseImageUrl    String?
  tlcLicenseFrontUrl    String?
  tlcLicenseBackUrl     String?
  tlcLicenseExpiry      DateTime?
  tlcLicenseNumber      String?
  taxClassification     String?            // Individual, Sole proprietor, etc.
  w9Status              String?            // pending, submitted, approved
  w9SubmittedAt         DateTime?
  taxCertificationAccepted Boolean?        // W-9 certification checkbox
  taxCertificationDate  DateTime?          // When driver certified tax info
  tripRevenueTotalYtd   Decimal?           @db.Decimal(12, 2) // 1099-K: Trip revenue
  nonTripIncomeTotalYtd Decimal?           @db.Decimal(12, 2) // 1099-NEC: Bonuses, promos
  taxYear               Int?               // Current tax year being tracked
  securityStatus        SecurityStatus     @default(normal)
  securityNotes         String?
  // Driver Preferences
  preferredNavigationApp String?           @default("google") // google, waze, apple, builtin
  autoAcceptRides       Boolean?           @default(false)
  acceptLongTrips       Boolean?           @default(true)
  acceptSharedRides     Boolean?           @default(true)
  shareLocationHistory  Boolean?           @default(true)
  shareUsageAnalytics   Boolean?           @default(false)
  personalizedExperience Boolean?          @default(true)
  notifyRideRequests    Boolean?           @default(true)
  notifyPromotions      Boolean?           @default(true)
  notifyEarnings        Boolean?           @default(true)
  notifySupport         Boolean?           @default(true)
  notifyEmailWeekly     Boolean?           @default(true)
  notifyEmailTips       Boolean?           @default(false)
  preferredLanguage     String?            @default("en") // en, bn, es, fr, ar
  themePreference       String?            @default("system") // light, dark, system
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverStats           DriverStats?
  driverWallet          DriverWallet?
  driverPoints          DriverPoints?
  foodOrders            FoodOrder[]
  rides                 Ride[]
  vehicleDocuments      VehicleDocument[]
  vehicle               Vehicle?
  blockedRiders         BlockedRider[]

  @@map("driver_profiles")
}

model BlockedRider {
  id         String        @id @default(uuid())
  driverId   String
  customerId String
  reason     String?
  blockedAt  DateTime      @default(now())
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, customerId])
  @@index([driverId])
  @@map("blocked_riders")
}

model DriverStats {
  id         String        @id @default(uuid())
  driverId   String        @unique
  rating     Decimal       @default(5.0) @db.Decimal(3, 2)
  totalTrips Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_stats")
}

model DriverWallet {
  id              String        @id @default(uuid())
  driverId        String        @unique
  balance         Decimal       @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal       @default(0) @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  driver          DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_wallets")
}

model FoodOrder {
  id                 String            @id
  customerId         String
  restaurantId       String
  driverId           String?
  deliveryAddress    String
  deliveryLat        Float?
  deliveryLng        Float?
  pickupAddress      String?           // Restaurant pickup location
  pickupLat          Float?
  pickupLng          Float?
  items              String?           // JSON string of ordered items (nullable for backward compatibility)
  itemsCount         Int?              // Total number of items in order
  serviceFare        Decimal           @db.Decimal(10, 2)
  safegoCommission   Decimal           @db.Decimal(10, 2)
  restaurantPayout   Decimal           @db.Decimal(10, 2)
  driverPayout       Decimal           @db.Decimal(10, 2)
  deliveryPayout     Decimal?          @db.Decimal(10, 2) // Alias for driverPayout for compatibility
  subtotal           Decimal?          @db.Decimal(10, 2) // Items subtotal before fees/taxes
  deliveryFee        Decimal?          @db.Decimal(10, 2) // Delivery fee component
  paymentMethod      String
  status             String
  customerRating     Int?
  customerFeedback   String?
  restaurantRating   Int?
  restaurantFeedback String?
  taxBreakdown       Json?
  totalTaxAmount     Decimal?          @db.Decimal(10, 2)
  orderCode          String?           // Unique searchable order code (e.g., "ORD-12345")
  whoCancelled       String?           // "customer" | "restaurant" | "driver" | "admin"
  cancellationReason String?           @db.Text
  cancelledAt        DateTime?
  acceptedAt         DateTime?         // When restaurant accepted order
  preparingAt        DateTime?         // When restaurant started preparing
  readyAt            DateTime?         // When order ready for pickup
  pickedUpAt         DateTime?         // When driver picked up
  isDemo             Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime
  deliveredAt        DateTime?
  completedAt        DateTime?
  customer           CustomerProfile   @relation(fields: [customerId], references: [id])
  driver             DriverProfile?    @relation(fields: [driverId], references: [id])
  restaurant         RestaurantProfile @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, status])
  @@index([restaurantId, createdAt])
  @@index([orderCode])
  @@index([status])
  @@index([isDemo])
  @@map("food_orders")
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model RestaurantProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  restaurantName        String
  address               String
  cuisineType           String?
  description           String?
  cityCode              String?
  countryCode           String?
  averageRating         Float?             @default(0)
  totalRatings          Int?               @default(0)
  verificationStatus    String             @default("pending")
  rejectionReason       String?
  isVerified            Boolean            @default(false)
  isActive              Boolean            @default(true)
  isDemo                Boolean            @default(false)
  // Country-specific KYC fields (BD - Bangladesh)
  fatherName            String?            // BD: Owner's father name
  presentAddress        String?            // BD: Current address
  permanentAddress      String?            // BD: Permanent address
  nidNumber             String?            // BD: National ID number
  nidFrontImageUrl      String?            // BD: NID front image
  nidBackImageUrl       String?            // BD: NID back image
  // Country-specific KYC fields (US - United States)
  homeAddress           String?            // US: Owner's home address
  governmentIdType      String?            // US: ID type (SSN, Driver License, etc.)
  governmentIdLast4     String?            // US: Last 4 digits of government ID
  // Common KYC fields
  dateOfBirth           DateTime?          // Owner's date of birth
  emergencyContactName  String?            // Emergency contact full name
  emergencyContactPhone String?            // Emergency contact phone
  // Business details
  businessLicenseNumber String?
  businessLicenseUrl    String?
  healthCertificateUrl  String?
  ownerRole             String?            // OWNER | STAFF
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  isSuspended           Boolean            @default(false)
  suspendedAt           DateTime?
  suspensionReason      String?
  securityStatus        SecurityStatus     @default(normal)
  securityNotes         String?
  driverComplaints      DriverComplaint[]
  foodOrders            FoodOrder[]
  menuCategories        MenuCategory[]
  menuItems             MenuItem[]
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantWallet      RestaurantWallet?

  @@index([cityCode])
  @@index([countryCode])
  @@index([isActive])
  @@index([isDemo])
  @@index([verificationStatus])
  @@map("restaurant_profiles")
}

model RestaurantWallet {
  id              String            @id @default(uuid())
  restaurantId    String            @unique
  balance         Decimal           @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  restaurant      RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_wallets")
}

// Menu system for food ordering
model MenuCategory {
  id            String            @id @default(uuid())
  restaurantId  String
  name          String
  description   String?
  displayOrder  Int               @default(0)
  isActive      Boolean           @default(true)
  isDemo        Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  restaurant    RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems     MenuItem[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_categories")
}

model MenuItem {
  id            String            @id @default(uuid())
  restaurantId  String
  categoryId    String
  name          String
  description   String?
  price         Decimal           @db.Decimal(10, 2)
  imageUrl      String?
  isAvailable   Boolean           @default(true)
  isActive      Boolean           @default(true)
  isDemo        Boolean           @default(false)
  displayOrder  Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  restaurant    RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category      MenuCategory      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([isDemo])
  @@map("menu_items")
}

model Ride {
  id               String            @id @default(uuid())
  customerId       String
  driverId         String?
  countryCode      String?
  cityCode         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  serviceFare      Decimal           @db.Decimal(10, 2)
  safegoCommission Decimal           @db.Decimal(10, 2)
  driverPayout     Decimal           @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  driverRating     Int?
  driverFeedback   String?
  taxBreakdown     Json?
  totalTaxAmount   Decimal?          @db.Decimal(10, 2)
  isDemo           Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  completedAt      DateTime?
  driverComplaints DriverComplaint[]
  customer         CustomerProfile   @relation(fields: [customerId], references: [id])
  driver           DriverProfile?    @relation(fields: [driverId], references: [id])

  @@index([countryCode])
  @@index([cityCode])
  @@index([isDemo])
  @@map("rides")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  passwordHash      String
  role              String
  countryCode       String
  isBlocked         Boolean            @default(false)
  isDemo            Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  adminProfile      AdminProfile?
  customerProfile   CustomerProfile?
  driverProfile     DriverProfile?
  notifications     Notification[]
  restaurantProfile RestaurantProfile?
  documents         Document[]
  approvalRequestsCreated ApprovalRequest[] @relation("ApprovalRequester")
  approvalRequestsApproved ApprovalRequest[] @relation("ApprovalApprover")
  adminSessions     AdminSession[] @relation("AdminSessions")

  @@index([isDemo])
  @@map("users")
}

enum DmvInspectionStatus {
  VALID
  EXPIRED
  MISSING

  @@map("dmv_inspection_status")
}

model Document {
  id           String    @id @default(uuid())
  userId       String
  documentType String
  fileUrl      String
  fileName     String?
  fileSize     Int?
  mimeType     String?
  category     String
  status       String    @default("pending_review")
  expiresAt    DateTime?
  uploadedAt   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
  @@index([category])
  @@index([status])
  @@map("documents")
}

model VehicleDocument {
  id           String         @id
  driverId     String
  documentType String
  uploadedAt   DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  description  String?
  expiresAt    DateTime?
  fileUrl      String
  vehicleId    String?
  driver       DriverProfile  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?       @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([vehicleId])
  @@map("vehicle_documents")
}

model Vehicle {
  id                      String            @id
  driverId                String            @unique
  vehicleType             String
  vehicleModel            String
  vehiclePlate            String
  isOnline                Boolean           @default(false)
  totalEarnings           Decimal           @default(0) @db.Decimal(10, 2)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  notes                   String?
  make                    String?
  year                    Int?
  color                   String?
  licensePlate            String?
  registrationDocumentUrl String?
  registrationExpiry      DateTime?
  registrationStatus      DocumentStatus    @default(PENDING)
  registrationLastUpdated DateTime?
  insuranceDocumentUrl    String?
  insuranceExpiry         DateTime?
  insuranceStatus         DocumentStatus    @default(PENDING)
  insuranceLastUpdated    DateTime?
  dmvInspectionType                String?
  dmvInspectionDate                DateTime?
  dmvInspectionExpiry              DateTime?
  dmvInspectionImageUrl            String?
  dmvInspectionFrontImageUrl       String?
  dmvInspectionBackImageUrl        String?
  dmvInspectionVerificationStatus  String?              @default("pending_review")
  dmvInspectionRejectionReason     String?
  dmvInspectionStatus              DmvInspectionStatus?
  inspectionStatus        DocumentStatus    @default(PENDING)
  inspectionLastUpdated   DateTime?
  plateCountry            String?
  plateState              String?
  plateStatus             DocumentStatus    @default(PENDING)
  tlcLicenseNumber        String?
  tlcLicenseStatus        DocumentStatus    @default(PENDING)
  isPrimary                        Boolean              @default(true)
  vehicleDocuments        VehicleDocument[]
  driver                  DriverProfile     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("vehicles")
}

// Driver Loyalty Points Tier System
model DriverTier {
  id               String           @id @default(uuid())
  name             String           @unique
  requiredPoints   Int
  color            String
  description      String?
  displayOrder     Int
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  benefits         TierBenefit[]
  drivers          DriverPoints[]

  @@index([requiredPoints])
  @@index([displayOrder])
  @@map("driver_tiers")
}

model TierBenefit {
  id               String           @id @default(uuid())
  tierId           String
  benefitText      String
  displayOrder     Int              @default(0)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  tier             DriverTier       @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@index([tierId])
  @@index([displayOrder])
  @@map("tier_benefits")
}

model DriverPoints {
  id               String             @id @default(uuid())
  driverId         String             @unique
  currentTierId    String?
  totalPoints      Int                @default(0) // 90-day status points for tier calculation
  lifetimePoints   Int                @default(0) // All-time points for analytics
  cycleStartDate   DateTime?          // Current 90-day cycle start
  cycleEndDate     DateTime?          // Current 90-day cycle end
  lastEarnedAt     DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  driver           DriverProfile      @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tier             DriverTier?        @relation(fields: [currentTierId], references: [id])
  transactions     PointsTransaction[]

  @@index([driverId])
  @@index([currentTierId])
  @@index([totalPoints])
  @@index([cycleEndDate]) // For finding cycles needing reset
  @@map("driver_points")
}

model PointsRule {
  id               String           @id @default(uuid())
  ruleName         String           @unique
  description      String?
  basePoints       Int              @default(10)
  multiplier       Decimal          @default(1.0) @db.Decimal(5, 2)
  countryCode      String?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([countryCode])
  @@index([isActive])
  @@map("points_rules")
}

model PointsTransaction {
  id               String           @id @default(uuid())
  driverPointsId   String
  points           Int
  reason           String
  referenceType    String?
  referenceId      String?
  countryCode      String?
  metadata         Json?
  createdAt        DateTime         @default(now())
  driverPoints     DriverPoints     @relation(fields: [driverPointsId], references: [id], onDelete: Cascade)

  @@index([driverPointsId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
  @@map("points_transactions")
}

model AuditLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  actorId     String?
  actorEmail  String
  actorRole   String
  ipAddress   String?
  actionType  String
  entityType  String
  entityId    String?
  description String
  metadata    Json?
  success     Boolean  @default(true)

  @@index([createdAt])
  @@index([actorEmail])
  @@index([actionType])
  @@index([entityType])
  @@index([success])
  @@map("audit_logs")
}

model AdminNotification {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  type        String
  severity    String
  actorId     String?
  actorEmail  String?
  entityType  String
  entityId    String?
  countryCode String?
  title       String
  message     String
  metadata    Json?
  isRead      Boolean   @default(false)

  @@index([createdAt(sort: Desc)])
  @@index([isRead])
  @@index([type])
  @@index([entityType])
  @@index([countryCode])
  @@index([severity])
  @@map("admin_notifications")
}

model PlatformSettings {
  id                String   @id @default(uuid())
  key               String   @unique
  valueJson         Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedByAdminId  String?

  @@index([key])
  @@map("platform_settings")
}

enum PayoutType {
  mobile_wallet
  bank_account
  stripe_connect
  manual
}

enum PayoutAccountStatus {
  pending_verification
  active
  inactive
}

model PayoutAccount {
  id                 String               @id @default(uuid())
  ownerType          String
  ownerId            String
  countryCode        String
  payoutType         PayoutType
  provider           String?
  displayName        String
  accountHolderName  String
  maskedAccount      String
  encryptedDetails   String
  accountNumber_encrypted String?
  routingNumber_encrypted String?
  isDefault          Boolean              @default(false)
  status             PayoutAccountStatus  @default(pending_verification)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@index([ownerType, ownerId])
  @@index([ownerType, ownerId, isDefault])
  @@map("payout_accounts")
}

enum PaymentMethodStatus {
  active
  inactive
}

model PaymentMethod {
  id                String                @id @default(uuid())
  customerId        String
  provider          String
  providerMethodId  String
  brand             String?
  last4             String
  expMonth          Int?
  expYear           Int?
  isDefault         Boolean               @default(false)
  status            PaymentMethodStatus   @default(active)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@index([customerId])
  @@index([customerId, isDefault])
  @@map("payment_methods")
}

enum SupportSenderType {
  user
  admin
  bot
  system
}

enum SupportMessageType {
  text
  image
  file
}

enum SupportConversationStatus {
  open
  bot
  pending
  assigned
  closed
}

model SupportConversation {
  id                String                      @id @default(uuid())
  userId            String
  userType          String                      // "driver" | "customer" | "restaurant" | "parcel"
  status            SupportConversationStatus   @default(open)
  assignedAdminId   String?                     // Reference to User.id (admin)
  adminLastSeenAt   DateTime?                   // Track when admin last viewed for unread count
  verifiedAt        DateTime?                   // When user confirmed their details
  topic             String?                     // payments | trips | documents | tax | account_settings | other
  entryContext      Json?                       // Device info, channel, etc.
  escalatedAt       DateTime?
  isEscalated       Boolean                     @default(false)
  unresolvedCount   Int                         @default(0) // Track bot failures for auto-escalation
  closedAt          DateTime?                   // When conversation ended
  rating            Int?                        // 1-5 stars rating after end chat
  feedback          String?                     @db.Text // Optional feedback after end chat
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  messages          SupportMessage[]
  attachments       SupportAttachment[]

  @@index([userId, userType, createdAt])
  @@index([assignedAdminId])
  @@index([status, createdAt])
  @@index([userId, userType, status])
  @@index([adminLastSeenAt])
  @@map("support_conversations")
}

model SupportMessage {
  id             String            @id @default(uuid())
  conversationId String
  senderType     SupportSenderType
  messageType    SupportMessageType @default(text)
  body           String?           @db.Text
  attachmentId   String?
  read           Boolean           @default(false)
  createdAt      DateTime          @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("support_messages")
}

model SupportAttachment {
  id             String            @id @default(uuid())
  conversationId String
  fileName       String
  fileType       String
  fileSize       Int
  secureStoragePath String           // Signed document URL path, NOT direct URL
  createdAt      DateTime          @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("support_attachments")
}

enum WalletOwnerType {
  driver
  customer
  restaurant
}

enum WalletTransactionServiceType {
  ride
  food
  parcel
  adjustment
  payout
  commission
  refund
  commission_settlement
  commission_refund
}

enum WalletTransactionDirection {
  credit
  debit
}

enum WalletTransactionReferenceType {
  ride
  food_order
  delivery
  payout
  manual_adjustment
  auto_settlement
  referral_bonus
}

enum PayoutMethod {
  auto_weekly
  manual_request
  manual_admin_settlement
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

model Wallet {
  id               String            @id @default(uuid())
  ownerId          String
  ownerType        WalletOwnerType
  countryCode      String
  availableBalance Decimal           @default(0) @db.Decimal(12, 2)
  negativeBalance  Decimal           @default(0) @db.Decimal(12, 2)
  currency         String
  isDemo           Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  transactions     WalletTransaction[]
  payouts          Payout[]

  @@unique([ownerId, ownerType])
  @@index([ownerType])
  @@index([countryCode])
  @@index([ownerType, countryCode])
  @@index([isDemo])
  @@map("wallets")
}

model WalletTransaction {
  id                      String                           @id @default(uuid())
  walletId                String
  ownerType               WalletOwnerType
  countryCode             String
  serviceType             WalletTransactionServiceType
  direction               WalletTransactionDirection
  amount                  Decimal                          @db.Decimal(12, 2)
  balanceSnapshot         Decimal                          @db.Decimal(12, 2)
  negativeBalanceSnapshot Decimal                          @db.Decimal(12, 2)
  referenceType           WalletTransactionReferenceType
  referenceId             String?
  description             String
  isDemo                  Boolean                          @default(false)
  createdAt               DateTime                         @default(now())
  createdByAdminId        String?
  wallet                  Wallet                           @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([ownerType])
  @@index([serviceType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([walletId, createdAt])
  @@index([isDemo])
  @@map("wallet_transactions")
}

model Payout {
  id                  String        @id @default(uuid())
  walletId            String
  countryCode         String
  ownerType           WalletOwnerType
  ownerId             String
  amount              Decimal       @db.Decimal(12, 2)
  method              PayoutMethod
  status              PayoutStatus  @default(pending)
  failureReason       String?
  scheduledAt         DateTime?
  isDemo              Boolean       @default(false)
  createdAt           DateTime      @default(now())
  createdByAdminId    String?
  processedAt         DateTime?
  externalReferenceId String?
  batchId             String?
  wallet              Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  batch               PayoutBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([ownerType])
  @@index([status])
  @@index([countryCode])
  @@index([createdAt])
  @@index([ownerType, ownerId])
  @@index([batchId])
  @@index([isDemo])
  @@map("payouts")
}

enum PayoutBatchStatus {
  created
  processing
  completed
  partially_failed
  failed
}

model PayoutBatch {
  id                String             @id @default(uuid())
  batchType         WalletOwnerType?
  periodStart       DateTime
  periodEnd         DateTime
  totalPayoutCount  Int                @default(0)
  totalPayoutAmount Decimal            @default(0) @db.Decimal(12, 2)
  status            PayoutBatchStatus  @default(created)
  createdByAdminId  String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payouts           Payout[]

  @@index([status])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("payout_batches")
}

enum ApprovalRequestStatus {
  pending
  approved
  rejected
  expired
}

model ApprovalRequest {
  id            String                 @id @default(uuid())
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  requesterId   String
  approverId    String?
  actionType    String
  payload       Json
  status        ApprovalRequestStatus  @default(pending)
  reason        String?
  executedAt    DateTime?
  expiresAt     DateTime?

  requester     User                   @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver      User?                  @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([status])
  @@index([requesterId])
  @@index([approverId])
  @@index([actionType])
  @@index([createdAt])
  @@map("approval_requests")
}

model AdminSession {
  id             String    @id @default(uuid())
  adminId        String
  createdAt      DateTime  @default(now())
  lastSeenAt     DateTime  @default(now())
  ipAddress      String?
  userAgentHash  String?
  isActive       Boolean   @default(true)
  revokedAt      DateTime?
  revokedReason  String?

  admin          User      @relation("AdminSessions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([isActive])
  @@index([createdAt])
  @@map("admin_sessions")
}

enum ServiceType {
  RIDE
  FOOD
  PARCEL
}

enum TaxType {
  VAT
  SALES_TAX
  GOVERNMENT_SERVICE_FEE
  MARKETPLACE_FACILITATOR_TAX
  TRIP_FEE
  LOCAL_MUNICIPALITY_FEE
  REGULATORY_FEE
}

model TaxRule {
  id           String      @id @default(cuid())
  countryCode  String
  cityCode     String?
  serviceType  ServiceType
  taxType      TaxType
  percentRate  Decimal?    @db.Decimal(5, 2)
  flatFee      Decimal?    @db.Decimal(10, 2)
  isActive     Boolean     @default(true)
  isDemo       Boolean     @default(false)
  createdAt    DateTime    @default(now())

  @@index([countryCode])
  @@index([cityCode])
  @@index([serviceType])
  @@index([taxType])
  @@index([isActive])
  @@index([isDemo])
  @@map("tax_rules")
}

enum ReferralUserType {
  driver
  rider
}

enum ReferralRewardStatus {
  pending
  paid
}

enum OpportunityBonusType {
  trip_boost
  surge_boost
  peak_hour_boost
  per_ride_bonus
}

enum OpportunityRewardStatus {
  pending
  paid
}

model ReferralSetting {
  id                  String             @id @default(uuid())
  countryCode         String
  userType            ReferralUserType
  currency            String
  baseAmount          Decimal            @db.Decimal(10, 2)
  promoAmount         Decimal?           @db.Decimal(10, 2)
  promoMultiplier     Decimal?           @db.Decimal(5, 2)
  promoLabel          String?
  startAt             DateTime?
  endAt               DateTime?
  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  createdByAdminId    String
  updatedByAdminId    String?
  notes               String?
  isDemo              Boolean            @default(false)
  referralRewards     ReferralReward[]

  @@unique([countryCode, userType, isActive])
  @@index([countryCode])
  @@index([userType])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("referral_settings")
}

model ReferralReward {
  id                  String               @id @default(uuid())
  referrerUserId      String
  referredUserId      String
  referralSettingId   String
  rewardAmount        Decimal              @db.Decimal(10, 2)
  currency            String
  countryCode         String
  status              ReferralRewardStatus @default(pending)
  triggeredAt         DateTime             @default(now())
  paidAt              DateTime?
  walletTransactionId String?
  isDemo              Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  referralSetting     ReferralSetting      @relation(fields: [referralSettingId], references: [id])

  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referralSettingId])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("referral_rewards")
}

model OpportunitySetting {
  id                    String                 @id @default(uuid())
  bonusType             OpportunityBonusType
  countryCode           String
  currency              String
  baseAmount            Decimal                @db.Decimal(10, 2)
  promoAmount           Decimal?               @db.Decimal(10, 2)
  promoMultiplier       Decimal?               @db.Decimal(5, 2)
  zoneId                String?
  startAt               DateTime?
  endAt                 DateTime?
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  createdByAdminId      String
  updatedByAdminId      String?
  notes                 String?
  isDemo                Boolean                @default(false)
  opportunityRewards    OpportunityReward[]

  @@unique([bonusType, countryCode, zoneId, isActive])
  @@index([bonusType])
  @@index([countryCode])
  @@index([zoneId])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
  @@index([isDemo])
  @@map("opportunity_settings")
}

model OpportunityReward {
  id                      String                   @id @default(uuid())
  driverId                String
  rideId                  String?
  countryCode             String
  bonusType               OpportunityBonusType
  opportunitySettingId    String
  rewardAmount            Decimal                  @db.Decimal(10, 2)
  currency                String
  status                  OpportunityRewardStatus  @default(pending)
  triggeredAt             DateTime                 @default(now())
  paidAt                  DateTime?
  walletTransactionId     String?
  isDemo                  Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  opportunitySetting      OpportunitySetting       @relation(fields: [opportunitySettingId], references: [id])

  @@index([driverId])
  @@index([rideId])
  @@index([opportunitySettingId])
  @@index([bonusType])
  @@index([status])
  @@index([triggeredAt])
  @@index([isDemo])
  @@map("opportunity_rewards")
}

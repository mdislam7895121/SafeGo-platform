generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  COMPLIANCE_ADMIN
  SUPPORT_ADMIN
  FINANCE_ADMIN
  READONLY_ADMIN
}

model AdminProfile {
  id        String    @id @default(uuid())
  userId    String    @unique
  adminRole AdminRole @default(SUPER_ADMIN)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_profiles")
}

model CustomerProfile {
  id                    String            @id @default(uuid())
  userId                String            @unique
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  verificationStatus    String            @default("pending")
  rejectionReason       String?
  isVerified            Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  isSuspended           Boolean           @default(false)
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  foodOrders            FoodOrder[]
  rides                 Ride[]

  @@map("customer_profiles")
}

model Delivery {
  id               String           @id
  customerId       String
  driverId         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  serviceFare      Decimal          @db.Decimal(10, 2)
  safegoCommission Decimal          @db.Decimal(10, 2)
  driverPayout     Decimal          @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  deliveredAt      DateTime?
  customer         CustomerProfile  @relation(fields: [customerId], references: [id])
  driver           DriverProfile?   @relation(fields: [driverId], references: [id])

  @@map("deliveries")
}

model DriverComplaint {
  id         String             @id
  driverId   String?
  customerId String?
  rideId     String?
  reason     String
  description String?
  status     String             @default("open")
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime
  restaurantId String?
  type       String             @default("driver")
  customer   CustomerProfile?   @relation(fields: [customerId], references: [id])
  driver     DriverProfile?     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  restaurant RestaurantProfile? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ride       Ride?              @relation(fields: [rideId], references: [id])

  @@map("driver_complaints")
}

model DriverProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  fatherName            String?
  presentAddress        String?
  permanentAddress      String?
  nidNumber             String?
  nidFrontImageUrl      String?
  nidBackImageUrl       String?
  homeAddress           String?
  governmentIdType      String?
  governmentIdLast4     String?
  driverLicenseNumber   String?
  driverLicenseImageUrl String?
  driverLicenseExpiry   DateTime?
  ssnLast4              String?
  dateOfBirth           DateTime?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelationship String?
  verificationStatus    String             @default("pending")
  rejectionReason       String?
  isVerified            Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  isSuspended           Boolean            @default(false)
  lastActive            DateTime?
  suspendedAt           DateTime?
  suspensionReason      String?
  district              String?
  fullName              String?
  nidEncrypted          String?
  phoneNumber           String?
  postOffice            String?
  postalCode            String?
  thana                 String?
  village               String?
  backgroundCheckDate   DateTime?
  backgroundCheckStatus String?            @default("pending")
  licenseStateIssued    String?
  ssnEncrypted          String?
  usaCity               String?
  usaFullLegalName      String?
  usaPhoneNumber        String?
  usaState              String?
  usaStreet             String?
  usaZipCode            String?
  dmvLicenseImageUrl    String?
  dmvLicenseFrontUrl    String?
  dmvLicenseBackUrl     String?
  dmvLicenseExpiry      DateTime?
  dmvLicenseNumber      String?
  firstName             String?
  lastName              String?
  middleName            String?
  profilePhotoUrl       String?
  tlcLicenseImageUrl    String?
  tlcLicenseFrontUrl    String?
  tlcLicenseBackUrl     String?
  tlcLicenseExpiry      DateTime?
  tlcLicenseNumber      String?
  deliveries            Delivery[]
  driverComplaints      DriverComplaint[]
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverStats           DriverStats?
  driverWallet          DriverWallet?
  foodOrders            FoodOrder[]
  rides                 Ride[]
  vehicleDocuments      VehicleDocument[]
  vehicle               Vehicle?

  @@map("driver_profiles")
}

model DriverStats {
  id         String        @id @default(uuid())
  driverId   String        @unique
  rating     Decimal       @default(5.0) @db.Decimal(3, 2)
  totalTrips Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_stats")
}

model DriverWallet {
  id              String        @id @default(uuid())
  driverId        String        @unique
  balance         Decimal       @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal       @default(0) @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  driver          DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_wallets")
}

model FoodOrder {
  id                String            @id
  customerId        String
  restaurantId      String
  driverId          String?
  deliveryAddress   String
  deliveryLat       Float?
  deliveryLng       Float?
  serviceFare       Decimal           @db.Decimal(10, 2)
  safegoCommission  Decimal           @db.Decimal(10, 2)
  restaurantPayout  Decimal           @db.Decimal(10, 2)
  driverPayout      Decimal           @db.Decimal(10, 2)
  paymentMethod     String
  status            String
  customerRating    Int?
  customerFeedback  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  deliveredAt       DateTime?
  customer          CustomerProfile   @relation(fields: [customerId], references: [id])
  driver            DriverProfile?    @relation(fields: [driverId], references: [id])
  restaurant        RestaurantProfile @relation(fields: [restaurantId], references: [id])

  @@map("food_orders")
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model RestaurantProfile {
  id                 String             @id @default(uuid())
  userId             String             @unique
  restaurantName     String
  address            String
  verificationStatus String             @default("pending")
  rejectionReason    String?
  isVerified         Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  isSuspended        Boolean            @default(false)
  suspendedAt        DateTime?
  suspensionReason   String?
  driverComplaints   DriverComplaint[]
  foodOrders         FoodOrder[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantWallet   RestaurantWallet?

  @@map("restaurant_profiles")
}

model RestaurantWallet {
  id              String            @id @default(uuid())
  restaurantId    String            @unique
  balance         Decimal           @default(0) @db.Decimal(10, 2)
  negativeBalance Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  restaurant      RestaurantProfile @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_wallets")
}

model Ride {
  id               String            @id
  customerId       String
  driverId         String?
  pickupAddress    String
  pickupLat        Float?
  pickupLng        Float?
  dropoffAddress   String
  dropoffLat       Float?
  dropoffLng       Float?
  serviceFare      Decimal           @db.Decimal(10, 2)
  safegoCommission Decimal           @db.Decimal(10, 2)
  driverPayout     Decimal           @db.Decimal(10, 2)
  paymentMethod    String
  status           String
  customerRating   Int?
  customerFeedback String?
  driverRating     Int?
  driverFeedback   String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  completedAt      DateTime?
  driverComplaints DriverComplaint[]
  customer         CustomerProfile   @relation(fields: [customerId], references: [id])
  driver           DriverProfile?    @relation(fields: [driverId], references: [id])

  @@map("rides")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  passwordHash      String
  role              String
  countryCode       String
  isBlocked         Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  adminProfile      AdminProfile?
  customerProfile   CustomerProfile?
  driverProfile     DriverProfile?
  notifications     Notification[]
  restaurantProfile RestaurantProfile?

  @@map("users")
}

enum DmvInspectionStatus {
  VALID
  EXPIRED
  MISSING

  @@map("dmv_inspection_status")
}

model VehicleDocument {
  id           String         @id
  driverId     String
  documentType String
  uploadedAt   DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  description  String?
  expiresAt    DateTime?
  fileUrl      String
  vehicleId    String?
  driver       DriverProfile  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?       @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([vehicleId])
  @@map("vehicle_documents")
}

model Vehicle {
  id                      String            @id
  driverId                String            @unique
  vehicleType             String
  vehicleModel            String
  vehiclePlate            String
  isOnline                Boolean           @default(false)
  totalEarnings           Decimal           @default(0) @db.Decimal(10, 2)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  notes                   String?
  make                    String?
  year                    Int?
  color                   String?
  licensePlate            String?
  registrationDocumentUrl String?
  registrationExpiry      DateTime?
  insuranceDocumentUrl    String?
  insuranceExpiry         DateTime?
  dmvInspectionType                String?
  dmvInspectionDate                DateTime?
  dmvInspectionExpiry              DateTime?
  dmvInspectionImageUrl            String?
  dmvInspectionFrontImageUrl       String?
  dmvInspectionBackImageUrl        String?
  dmvInspectionVerificationStatus  String?              @default("pending_review")
  dmvInspectionRejectionReason     String?
  dmvInspectionStatus              DmvInspectionStatus?
  isPrimary                        Boolean              @default(true)
  vehicleDocuments        VehicleDocument[]
  driver                  DriverProfile     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("vehicles")
}

model AuditLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  actorId     String?
  actorEmail  String
  actorRole   String
  ipAddress   String?
  actionType  String
  entityType  String
  entityId    String?
  description String
  metadata    Json?
  success     Boolean  @default(true)

  @@index([createdAt])
  @@index([actorEmail])
  @@index([actionType])
  @@index([entityType])
  @@index([success])
  @@map("audit_logs")
}

model AdminNotification {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  type        String
  severity    String
  actorId     String?
  actorEmail  String?
  entityType  String
  entityId    String?
  countryCode String?
  title       String
  message     String
  metadata    Json?
  isRead      Boolean   @default(false)

  @@index([createdAt(sort: Desc)])
  @@index([isRead])
  @@index([type])
  @@index([entityType])
  @@index([countryCode])
  @@index([severity])
  @@map("admin_notifications")
}

model PlatformSettings {
  id                String   @id @default(uuid())
  key               String   @unique
  valueJson         Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedByAdminId  String?

  @@index([key])
  @@map("platform_settings")
}

enum PayoutType {
  mobile_wallet
  bank_account
  stripe_connect
  manual
}

enum PayoutAccountStatus {
  pending_verification
  active
  inactive
}

model PayoutAccount {
  id                 String               @id @default(uuid())
  ownerType          String
  ownerId            String
  countryCode        String
  payoutType         PayoutType
  provider           String?
  displayName        String
  accountHolderName  String
  maskedAccount      String
  encryptedDetails   String
  isDefault          Boolean              @default(false)
  status             PayoutAccountStatus  @default(pending_verification)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@index([ownerType, ownerId])
  @@index([ownerType, ownerId, isDefault])
  @@map("payout_accounts")
}

enum PaymentMethodStatus {
  active
  inactive
}

model PaymentMethod {
  id                String                @id @default(uuid())
  customerId        String
  provider          String
  providerMethodId  String
  brand             String?
  last4             String
  expMonth          Int?
  expYear           Int?
  isDefault         Boolean               @default(false)
  status            PaymentMethodStatus   @default(active)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@index([customerId])
  @@index([customerId, isDefault])
  @@map("payment_methods")
}

enum SupportConversationStatus {
  open
  pending
  resolved
  closed
}

enum SupportChannel {
  driver
  customer
  restaurant
}

enum SupportPriority {
  low
  normal
  high
  urgent
}

enum SupportSenderType {
  user
  admin
  system
}

enum SupportMessageType {
  text
  system
  attachment
}

model SupportConversation {
  id                  String                      @id @default(uuid())
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  status              SupportConversationStatus   @default(open)
  channel             SupportChannel
  subject             String
  priority            SupportPriority             @default(normal)
  lastMessageAt       DateTime                    @default(now())
  lastMessagePreview  String?
  userId              String
  userType            SupportChannel
  countryCode         String
  assignedAdminId     String?
  unreadCountUser     Int                         @default(0)
  unreadCountAdmin    Int                         @default(0)
  metadata            Json?
  messages            SupportMessage[]

  @@index([userId])
  @@index([userType])
  @@index([status])
  @@index([assignedAdminId])
  @@index([lastMessageAt])
  @@index([countryCode])
  @@index([userId, userType])
  @@map("support_conversations")
}

model SupportMessage {
  id              String              @id @default(uuid())
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  conversationId  String
  senderType      SupportSenderType
  senderId        String?
  content         String              @db.Text
  messageType     SupportMessageType  @default(text)
  isReadByUser    Boolean             @default(false)
  isReadByAdmin   Boolean             @default(false)
  metadata        Json?
  conversation    SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attachments     SupportAttachment[]

  @@index([conversationId])
  @@index([createdAt])
  @@map("support_messages")
}

model SupportAttachment {
  id        String         @id @default(uuid())
  createdAt DateTime       @default(now())
  messageId String
  fileUrl   String
  fileType  String
  fileName  String
  fileSize  Int
  isImage   Boolean        @default(false)
  message   SupportMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("support_attachments")
}

enum WalletOwnerType {
  driver
  customer
  restaurant
}

enum WalletTransactionServiceType {
  ride
  food
  parcel
  adjustment
  payout
  commission
  refund
  commission_settlement
  commission_refund
}

enum WalletTransactionDirection {
  credit
  debit
}

enum WalletTransactionReferenceType {
  ride
  food_order
  delivery
  payout
  manual_adjustment
  auto_settlement
}

enum PayoutMethod {
  auto_weekly
  manual_request
  manual_admin_settlement
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

model Wallet {
  id               String            @id @default(uuid())
  ownerId          String
  ownerType        WalletOwnerType
  countryCode      String
  availableBalance Decimal           @default(0) @db.Decimal(12, 2)
  negativeBalance  Decimal           @default(0) @db.Decimal(12, 2)
  currency         String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  transactions     WalletTransaction[]
  payouts          Payout[]

  @@unique([ownerId, ownerType])
  @@index([ownerType])
  @@index([countryCode])
  @@index([ownerType, countryCode])
  @@map("wallets")
}

model WalletTransaction {
  id                      String                           @id @default(uuid())
  walletId                String
  ownerType               WalletOwnerType
  countryCode             String
  serviceType             WalletTransactionServiceType
  direction               WalletTransactionDirection
  amount                  Decimal                          @db.Decimal(12, 2)
  balanceSnapshot         Decimal                          @db.Decimal(12, 2)
  negativeBalanceSnapshot Decimal                          @db.Decimal(12, 2)
  referenceType           WalletTransactionReferenceType
  referenceId             String?
  description             String
  createdAt               DateTime                         @default(now())
  createdByAdminId        String?
  wallet                  Wallet                           @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([ownerType])
  @@index([serviceType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([walletId, createdAt])
  @@map("wallet_transactions")
}

model Payout {
  id                  String        @id @default(uuid())
  walletId            String
  countryCode         String
  ownerType           WalletOwnerType
  ownerId             String
  amount              Decimal       @db.Decimal(12, 2)
  method              PayoutMethod
  status              PayoutStatus  @default(pending)
  failureReason       String?
  scheduledAt         DateTime?
  createdAt           DateTime      @default(now())
  createdByAdminId    String?
  processedAt         DateTime?
  externalReferenceId String?
  batchId             String?
  wallet              Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  batch               PayoutBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([ownerType])
  @@index([status])
  @@index([countryCode])
  @@index([createdAt])
  @@index([ownerType, ownerId])
  @@index([batchId])
  @@map("payouts")
}

enum PayoutBatchStatus {
  created
  processing
  completed
  partially_failed
  failed
}

model PayoutBatch {
  id                String             @id @default(uuid())
  batchType         WalletOwnerType?
  periodStart       DateTime
  periodEnd         DateTime
  totalPayoutCount  Int                @default(0)
  totalPayoutAmount Decimal            @default(0) @db.Decimal(12, 2)
  status            PayoutBatchStatus  @default(created)
  createdByAdminId  String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payouts           Payout[]

  @@index([status])
  @@index([createdByAdminId])
  @@index([createdAt])
  @@map("payout_batches")
}

# SafeGo Global Super-App

## Overview
SafeGo is a production-ready, full-stack multi-service super-app platform designed for global on-demand services such as ride-hailing, food delivery, and parcel delivery. Its primary purpose is to offer a scalable, secure, and feature-rich solution capable of handling multi-role authentication, country-specific KYC, commission tracking, service lifecycle management, unified payment and payout systems, multi-role support, and comprehensive driver identity and profile management.

## User Preferences
Preferred communication style: Simple, everyday language.
Development approach: Full-stack TypeScript with modern tooling, emphasizing code quality, security, and scalability.

## System Architecture

### UI/UX Decisions
The frontend utilizes React 18, TypeScript, Vite 5, shadcn/ui (Radix UI), Tailwind CSS 3, TanStack Query v5, wouter, and React Hook Form with Zod. It features a custom HSL color palette, Inter/Manrope typography, mobile-first responsive design, skeleton loading, toast notifications, error boundaries, and role-based access control. Key UI/UX features include Uber-level profile experiences, multi-step onboarding, country-specific KYC, dedicated Food and Driver Profile Systems, and WCAG 2.1 AA compliance.

### Technical Implementations
The backend is built with Node.js 20+, TypeScript, Express.js 4, and Prisma Client 6 with PostgreSQL 14+, employing a Generic Service Layer with Role Adapters. Core functionalities include:
-   **Admin Capabilities**: Interactive admin panel for dashboards, document management, wallet settlement, and global analytics.
-   **Security & Compliance**: Implements HTTP security headers, rate limiting, 2FA systems (TOTP, OTP), device and session security, multi-channel security alerts, tamper-proof audit logs (SHA-256 hash chain), secure audit routes, and AES-256-GCM field encryption.
-   **Wallet & Earnings System**: Manages earnings, commissions, negative balances, and automated/manual payouts.
-   **Tax & Fees System**: Supports multi-country tax management with city-level overrides.
-   **Multi-Role Multi-Channel Support Center**: AI-first chat with 4-role support and a two-tier escalation system.
-   **Opportunity Bonus Management System**: Admin-managed ride incentives with country-specific and zone-based targeting.
-   **SafeGo Points System**: Gamified loyalty program with three tiers.
-   **Identity Verification System**: Manages country-specific identity documents with AES-256-GCM encryption.
-   **Restaurant Management Systems**: Includes performance insights, review management, media gallery, branding, operational settings, order management, staff management, and promotions.
-   **Customer-Facing Dynamic Pricing Display**: Provides real-time pricing transparency with surge multipliers and breakdowns.
-   **Unified Payout System**: Enterprise-grade management for customer payment methods and payout rails by country, service type, actor type, and KYC level, including automatic weekly scheduling and bank verification.
-   **Driver Systems**: Comprehensive driver profile management (multi-vehicle, encrypted KYC, document upload), earnings & payout dashboard, promotions, in-app training, and a Safety Center. This includes an Uber-style active trip screen (SafeGo Map component, trip status flow, multi-map navigation) and trip accept/decline flow (countdown, customer info, estimated fare, accept/decline actions, online/offline status management). Driver KYC includes E.164 phone validation and age verification.
-   **Rider Ride-Booking Flow**: Complete Uber-style multi-step booking experience using `RideBookingContext` for state management. This 6-step flow (`/rider/ride/new` to `/rider/trip/active`) includes map integration for pickup/dropoff, vehicle tier selection, payment method selection, and real-time trip tracking. It also features multi-route selection with up to 3 unique route alternatives.
-   **Multi-Route Fare Engine**: Enterprise-grade fare calculation system with deterministic 18-step pipeline and real-time per-route pricing. Features include: 5 ride types (SAVER, STANDARD, COMFORT, XL, PREMIUM), polygon-based regulatory zone detection (airports, congestion zones, BCF), toll calculation with segment matching, traffic-based adjustments, surge pricing support, driver payout calculation (fare minus commission minus regulatory fees), and comprehensive fare breakdown UI with transparency into all fee components. **Deterministic Pipeline Order**: Base fare → Short-trip adjustment → Traffic multiplier → Surge multiplier → Time-based surcharges (night/peak) → Long-distance fee → Airport fee → Cross-state surcharge → Cross-city surcharge → Border zone fee → Return deadhead → State regulatory fees → Tolls → Additional fees → Service fee → Fare guards (min/max) → Driver minimum payout → Margin protection. **Conflict Resolution Rules**: Cross-state > cross-city (always suppresses), airport overrides cross-city (configurable), airport does NOT override cross-state, border zone suppressed by cross-state, return deadhead only when cross-state applied. **Fee Suppression Logging**: Full audit trail of fee conflicts with FeeSuppressionLog tracking fee, suppressedBy, reason, and wouldHaveBeenAmount. **Test Coverage**: 45 regression tests covering all pipeline steps, conflict scenarios, and edge cases. API endpoints: `/api/fares/calculate`, `/api/fares/calculate-all`, `/api/fares/ride-types`, `/api/fares/estimate`.
-   **Promo Code System**: User-entered promotional codes with comprehensive validation including: 3 discount types (PERCENTAGE, FIXED_AMOUNT, CAPPED_PERCENTAGE), country/city targeting, ride type restrictions, minimum fare requirements, usage limits (total and per-user), date range validity, first-ride-only and new-user-only conditions, wallet payment requirements. Frontend UI features Uber/Lyft-style responsive design with PromoCodeInput component (loading, success, error states), real-time fare adjustment via RideBookingContext callbacks, zero-clamp protection for negative fares, promo badges on ride cards, and complete discount propagation through booking confirmation (serviceFare, originalFare, promoDiscount, promoCodeId). API endpoints: `/api/promos/code/validate`, `/api/promos/code/apply`, `/api/promos/codes/active`, `/api/promos/admin/codes` (CRUD).
-   **Phase A Ride System Features**: Covers comprehensive ride lifecycle management including customer controls (cancel ride, in-app chat, change destination), a post-trip 5-star rating system, detailed receipt system, and a driver status workflow with audit trails.
-   **Driver Incentive Engine**: Comprehensive incentive system with 5 bonus types that stack additively on driver payouts without affecting rider fares. **Quest Bonus System**: Weekly goal-based bonuses with 3 tiers (Tier 1: 20 rides = $15, Tier 2: 40 rides = $40, Tier 3: 60 rides = $75), automatic Monday-Sunday cycle tracking, real-time progress tracking, and tier completion notifications. **Boost Zone Engine**: Geo-polygon based time-sensitive incentives with 3 boost levels (Normal: +10%, Busy: +20%, Very Busy: +30%), weekday evening (5-7 PM) and weekend (4-11 PM) time windows, highest-boost selection for overlapping zones. **Airport Pickup Bonuses**: Fixed per-ride bonuses for airport pickups (JFK: $4, LGA: $3, EWR: $3), radius-based detection (2 miles for JFK/EWR, 1.5 miles for LGA). **Weather Bonus System**: +$2 per ride for severe weather (heavy_rain, snow, storm) or extreme cold (<30°F). **Late-Night Incentives**: +$3 per ride during 12 AM-3 AM window. **Integration Rules**: Incentives added after fare calculation, never reduce SafeGo commission or rider fare, preserve minimum driver payout, all bonuses independently configurable via flags. **Test Coverage**: 61 comprehensive tests covering all bonus scenarios, stacking, suppression, and edge cases. **UI Components**: DriverBonuses component with collapsible breakdown, quest progress bar, tier visualization, active bonus badges, and total payout display.
-   **AI Marketplace Balancer**: Enterprise-grade real-time marketplace optimization system acting as the "brain" of SafeGo (similar to Uber Marketplace AI). **Core Architecture**: 60-second control loop orchestrator with modular actuator design for surge, commission, incentive, and dispatch optimization. **Real-time Telemetry**: Collects ride request metrics, driver supply data, weather conditions, event calendars, and traffic data across 10 NYC metro zones. **Predictive Models**: Exponential smoothing-based demand/supply forecasting for 10m/30m/60m windows with confidence scoring and factor analysis (time-of-day, day-of-week, weather, events, trends). **Surge Controller**: Automatic surge adjustment (1.00x-1.90x) with competitive advantage logic ensuring SafeGo surge stays below Uber surge, gradual step adjustments, and supply gap severity response. **Commission Controller**: Dynamic commission bands (10-18%) based on demand levels with daily adjustment limits and shortage risk compensation. **Incentive Controller**: Intelligent activation of 5 incentive types (boost zones, weather bonuses, late-night bonuses, airport bonuses, supply boost) only in shortage zones with hourly budget tracking. **Smart Dispatch Optimizer**: Driver scoring based on ETA (30%), acceptance rate (20%), rating (15%), cancellation rate (15%), fatigue (10%), and zone proximity (10%) with premium trip prioritization and cancellation prevention. **Heatmap Generator**: Real-time visualization for demand, supply, surge zones, incentive zones, and predicted 30m/60m forecasts. **Safety Guards**: NEVER-violate constraints including max surge 1.90x, commission 10-18%, min driver payout $5.00, max price increase 100%, incentive budget cap, and marketplace stability thresholds with automatic correction and violation logging. **State Management**: In-memory ring buffers with 60-cycle history, circuit breaker pattern (5 consecutive failures trigger), and idempotent updates. **Admin API**: Comprehensive REST endpoints at `/api/admin/marketplace` for status monitoring, zone management, heatmap access, decision history, manual overrides, and configuration management. **Test Coverage**: 50+ test scenarios covering safety guards, predictive models, surge/commission/incentive controllers, dispatch optimizer, heatmaps, and edge cases.
-   **SafeGo Loyalty Engine**: Comprehensive dual-track loyalty system for riders and drivers with real-time per-ride processing and daily batch updates. **Rider Loyalty Program**: 4 tiers (Bronze → Silver → Gold → Platinum) based on lifetime points, points-per-ride calculation with base fare multiplier plus time/location/distance bonuses, weekly goals (3/5/7 rides for credits), monthly goals (12/20/30 rides with tier multipliers), auto-applied ride credits, birthday rewards ($5-$50 based on tier), off-peak discounts (0%/5%/10%/15% by tier), and referral bonus integration. **Driver Loyalty Program**: 4 tiers (Silver → Gold → Platinum → Diamond) based on lifetime rides, acceptance rate, and cancellation rate, with tier earnings multipliers (0%/5%/10%/15%), acceptance rate bonuses (5%/10%/15% at 95%/98%/100%), cancellation rate bonuses (5%/10%/15% at 3%/1%/0%), streak rewards ($25/$50/$100 for 7/14/30-day streaks), long-distance pickup bonuses ($5 base + $0.50/mile over 10 miles, tier-scaled), weather protection multipliers (1.0x-1.2x by tier), and weekly guaranteed earnings ($500+ with tier bonuses). **Daily Scheduler**: Runs at 2 AM for tier recalculation, goal resets, birthday reward issuance, weekly guarantee payouts, and streak validation. **Integration**: Hooks into trip completion workflow for real-time updates. **API Endpoints**: `/api/loyalty/rider/:riderId`, `/api/loyalty/driver/:driverId`, `/api/loyalty/admin/metrics`, `/api/loyalty/admin/scheduler/*`. **Test Coverage**: 60+ comprehensive tests covering tier progression, bonuses, streaks, goals, and edge cases.
-   **API Design**: Robust API endpoints with enforcement of KYC, ownership validation, UUID format validation, Zod schema validation, atomic transactions, and consistent error handling.

### Database Schema Design
The schema uses UUID primary keys, indexed foreign keys, and decimal types for monetary values. It includes models for wallets, payouts, audit logs, notifications, platform settings, payment/payout accounts, opportunity settings, driver tiers and points, blocked riders, reviews, restaurant branding, media, hours, operational settings, delivery zones, surge settings, country payment/payout configurations, restaurant payout methods, categories, subcategories, menu item categories, promotion usage, multi-role support models, and driver safety incidents. It supports country-specific identity fields with AES-256-GCM encryption and includes flags for demo mode, US tax fields, driver preferences, and enhancements for promotions/coupons and review replies.

## External Dependencies

-   **Backend Core**: `@prisma/client`, `express`, `bcrypt`, `jsonwebtoken`, `@neondatabase/serverless`.
-   **Frontend Core**: `react`, `react-dom`, `wouter`, `@tanstack/react-query`, `react-hook-form`, `zod`.
-   **UI Components**: `@radix-ui/*`, `lucide-react`, `class-variance-authority`, `tailwind-merge`, `clsx`.
-   **Environment Variables**: `DATABASE_URL`, `JWT_SECRET`, `NODE_ENV`, `ENCRYPTION_KEY`, `SESSION_SECRET`.
-   **Optional Integrations**: Twilio (SMS OTP), AgentMail (Email OTP) for communication, which degrade gracefully if not configured.
-   **Google Maps Integration**: Client-side only using `GOOGLE_MAPS_API_KEY` with HTTP referrer restrictions. Utilizes Maps JavaScript API, Places API, Directions API, and Geocoding API.
# SafeGo Global Super-App

## Overview
SafeGo is a production-ready, full-stack multi-service super-app platform designed for global on-demand services such as ride-hailing, food delivery, and parcel delivery. Its primary purpose is to offer a scalable, secure, and feature-rich solution with capabilities including multi-role authentication, country-specific KYC, commission tracking, service lifecycle management, unified payment/payout systems, and comprehensive driver identity management. The project aims to secure a significant market share in the on-demand services sector by delivering a superior and highly adaptable platform.

## User Preferences
Preferred communication style: Simple, everyday language.
Development approach: Full-stack TypeScript with modern tooling, emphasizing code quality, security, and scalability.

## System Architecture

### UI/UX Decisions
The frontend leverages React 18, TypeScript, Vite 5, shadcn/ui, Tailwind CSS 3, TanStack Query v5, wouter, and React Hook Form with Zod. It features a custom HSL color palette, Inter/Manrope typography, mobile-first responsive design, skeleton loading, toast notifications, error boundaries, and role-based access control. Key UI/UX elements include Uber-level profile experiences, multi-step onboarding, country-specific KYC, dedicated Food and Driver Profile Systems, and WCAG 2.1 AA compliance.

### Technical Implementations
The backend is built using Node.js 20+, TypeScript, Express.js 4, and Prisma Client 6 with PostgreSQL 14+, employing a Generic Service Layer with Role Adapters.

**Core Features:**
*   **Admin Capabilities**: Interactive panel for dashboards, document management, wallet settlement, and global analytics.
*   **Security & Compliance**: Implements HTTP security headers, rate limiting, 2FA, device/session security, multi-channel alerts, tamper-proof audit logs, secure audit routes, and AES-256-GCM field encryption. Includes a Customer Account Lockout System with user-initiated lock/unlock and rate limiting.
*   **Wallet & Earnings System**: Manages earnings, commissions, negative balances, and automated/manual payouts.
*   **Tax & Fees System**: Supports multi-country tax management with city-level overrides.
*   **Multi-Role Multi-Channel Support Center**: AI-first chat with 4-role support and a two-tier escalation system.
*   **Opportunity Bonus Management System**: Admin-managed ride incentives with country-specific and zone-based targeting.
*   **SafeGo Points System**: Gamified loyalty program with three tiers.
*   **Identity Verification System**: Manages country-specific identity documents with AES-256-GCM encryption.
*   **Restaurant Management Systems**: Features performance insights, review management, media gallery, branding, operational settings, order management, staff management, and promotions.
*   **Unified Eats Experience (PRIMARY)**: The DoorDash-style customer web experience is now the primary food ordering UI at `/customer/food`. Features demo content auto-seeding (4 restaurants: Bengali Kitchen, Dhaka Delights, American Grill, Bella Italia), hero search, horizontal cuisine category strips, "Popular Near You" and "Top Rated" featured carousels, restaurant discovery grid with skeleton loading, restaurant detail pages with sticky category navigation and menu items, cart drawer with quantity controls and order summary, and full checkout flow. Legacy routes at `/customer/eats` redirect to the new primary routes. Old UI components (FoodRestaurants, FoodRestaurantDetails) are preserved but disconnected from routing. Includes real-time menu stock sync and advanced promo code system.
*   **Menu Item Variants & Add-ons System (Step 44)**: DoorDash/UberEats-style customization with ItemDetailModal for customer-facing variant selection (radio buttons for required choices) and add-on checkboxes (optional multi-select). Features option groups with type-based rendering, price delta calculations, quantity multipliers, and upsell item recommendations. Cart stores modifiers with proper identity comparison for separate line items. Restaurant portal includes dedicated menu-item-options.tsx page with OptionGroupEditor for managing option groups and individual options. Admin oversight includes menu stats (total items, variants, add-ons, availability status) in restaurant details.
*   **Step 44B Food Order Fix**: Fixed "No commission rule found" error that caused 500 errors during checkout. Added default global commission rule (15%) and fallback logic in earningsCommissionService. Enhanced error handling in food-orders route with specific error messages for commission, validation, and stock conflict errors.
*   **Step 45: Restaurant Order Management & Kitchen Flow**: Connects customer food orders to restaurant dashboard with full kitchen workflow. Features: (1) Extended FoodOrder schema with restaurantNotes, restaurantPrepMinutes, customerStatusMessage, restaurantSeenAt fields; (2) Enhanced POST /orders/:id/status endpoint with Zod validation for prep time (1-180 min), notes (1000 chars), customer messages (500 chars), and cancellation reasons; (3) New POST /orders/:id/seen endpoint to track when restaurant views orders; (4) New PATCH /orders/:id/notes endpoint with full Zod validation for updating kitchen notes; (5) Enhanced order-details.tsx UI with Kitchen Notes Card (prep time input, internal notes textarea, customer message textarea, save button), Rejection Reason Card (cancellation reason input), and Quick Actions card showing prep time on accept button; (6) Proper cache invalidation for both ordersKeys.all and ordersKeys.detail to ensure immediate UI updates.
*   **Step 45E: Customer Navigation Fix**: Added consistent Home and Back to Restaurants buttons across all Eats customer screens. Features: (1) Reusable EatsNavigation.tsx component with CustomerHomeButton (→ /customer) and BackToRestaurantsButton (→ /customer/food); (2) CustomerEatsHome shows SafeGo Eats header with Home button on top-right; (3) Restaurant detail pages show both navigation buttons on cover photo overlay and header; (4) Checkout page shows Home button with Back to restaurant; (5) Order tracking shows Home button with Back to order history; (6) Order history shows both buttons. All changes are additive and preserve Step 43 desktop layout.
*   **Step 45F: Responsive Eats Restaurant List**: Implements responsive restaurant listing with mobile list view (≤767px) and tablet/desktop grid/carousel view (≥768px). Features: (1) Configurable breakpoints in eatsBreakpoints.ts (mobileMaxWidth: 767, tabletMinWidth: 768, desktopMinWidth: 1024); (2) RestaurantCardVariants.tsx with shared RestaurantCardList (mobile full-width), RestaurantCardGrid (desktop cards), and RestaurantCardSkeleton components; (3) RestaurantListMobile.tsx renders vertical scrollable list of restaurants; (4) RestaurantGridDesktop.tsx renders "Popular Near You" and "Top Rated" horizontal carousels plus all-restaurants grid; (5) CustomerEatsHome.tsx uses useIsMobile() hook for conditional rendering; (6) All components include proper data-testid attributes. Preserves Step 43 desktop layout while enabling mobile-friendly vertical scrolling.
*   **Step 46: Driver Food Delivery Flow (In Progress)**: Connects restaurant ready_for_pickup orders to drivers for pickup and customer delivery. Features: (1) Extended Prisma schema with DriverAssignmentStatus enum (none, searching_driver, driver_assigned, driver_rejected, no_driver_found) and new FoodOrder fields (deliveryId, driverAssignmentStatus, driverEtaMinutes, driverLastLocationLat/Lng, driverLocationUpdatedAt, deliveryNotesForDriver); (2) Extended Delivery model with serviceType (ride/food/parcel), countryCode, restaurantId, driver tracking fields (ETA, location, timestamps); (3) foodDeliveryDispatchService.ts with driver search/assignment logic, demo mode auto-assignment, and scheduled auto-advance for demo orders; (4) Integration in restaurant.ts POST /orders/:id/status to dispatch driver when order marked ready_for_pickup; (5) New driver-food-delivery.ts route file with GET /pending (available deliveries), GET /active (current deliveries), POST /accept, POST /reject, POST /status (picked_up/on_the_way/delivered), POST /location, GET /history, GET /:deliveryId endpoints.
*   **Food Order Management**: Real-time order tracking with an 8-stage status timeline, live map, driver info, ETA calculations, and comprehensive in-app notifications. Features complete checkout payment validation, multiple delivery address profiles, order cancellation with automatic refunds, and customer-facing dynamic pricing.
*   **Unified Payout System**: Enterprise-grade management for customer payment methods and payout rails by country, service type, actor type, and KYC level, including automatic weekly scheduling and bank verification.
*   **Driver Systems**: Comprehensive driver profile management (multi-vehicle, encrypted KYC, document upload), earnings & payout dashboard, promotions, in-app training, and a Safety Center. Includes an Uber-style active trip screen and trip accept/decline flow.
*   **Rider Ride-Booking Flow**: Complete Uber-style multi-step booking experience with map integration, vehicle tier selection, payment method selection, real-time trip tracking, and multi-route selection.
*   **Multi-Route Fare Engine**: Enterprise-grade fare calculation system with a deterministic 19-step pipeline and real-time per-route pricing (base fare, adjustments, multipliers, surcharges, tolls, comprehensive breakdown).
*   **Multi-Category Vehicle System**: Supports 7 Uber-style vehicle categories with configurable fare multipliers and minimum fares. Includes enhanced rider selection UI, AI category suggestion, admin-only category assignment, vehicle verification status, driver-vehicle binding, driver category preferences, and rider price card discount UI.
*   **Cross-State Fare Engine**: Dedicated Uber-style pricing for interstate trips.
*   **Promo Code System**: User-entered promotional codes with comprehensive validation.
*   **Ride System Features**: Covers ride lifecycle management including customer controls (cancel, chat, change destination), post-trip rating, detailed receipts, and driver status workflow with audit trails.
*   **Driver Incentive Engine**: Comprehensive incentive system with 5 bonus types.
*   **AI Marketplace Balancer**: Enterprise-grade real-time marketplace optimization system with a 60-second control loop orchestrator.
*   **SafeGo Loyalty Engine**: Comprehensive dual-track loyalty system for riders and drivers.
*   **NYC TLC Regulatory Compliance**: Implements NYC Taxi & Limousine Commission regulations including minimum pay enforcement, various fees, surcharges, and comprehensive tolls detection and billing.
*   **TLC Report Generator & Audit Engine**: Monthly reporting system for TLC submissions and a comprehensive audit system for HVFHV compliance verification with an automatic fix engine.
*   **NYC Borough Detection Service**: Polygon-based borough boundary detection using ray-casting.
*   **API Design**: Robust API endpoints with enforcement of KYC, ownership validation, UUID format validation, Zod schema validation, atomic transactions, and consistent error handling.

### Database Schema Design
The schema uses UUID primary keys, indexed foreign keys, and decimal types for monetary values. It includes models for wallets, payouts, audit logs, notifications, platform settings, payment/payout accounts, opportunity settings, driver tiers and points, blocked riders, reviews, restaurant branding, media, hours, operational settings, delivery zones, surge settings, country payment/payout configurations, restaurant payout methods, categories, subcategories, menu item categories, promotion usage, multi-role support models, and driver safety incidents. It supports country-specific identity fields with AES-256-GCM encryption and includes flags for demo mode, US tax fields, driver preferences, and enhancements for promotions/coupons and review replies.

## External Dependencies

*   **Backend Core**: `@prisma/client`, `express`, `bcrypt`, `jsonwebtoken`, `@neondatabase/serverless`.
*   **Frontend Core**: `react`, `react-dom`, `wouter`, `@tanstack/react-query`, `react-hook-form`, `zod`.
*   **UI Components**: `@radix-ui/*`, `lucide-react`, `class-variance-authority`, `tailwind-merge`, `clsx`.
*   **Environment Variables**: `DATABASE_URL`, `JWT_SECRET`, `NODE_ENV`, `ENCRYPTION_KEY`, `SESSION_SECRET`.
*   **Optional Integrations**: Twilio (SMS OTP), AgentMail (Email OTP).
*   **Google Maps Integration**: Client-side only using `GOOGLE_MAPS_API_KEY` for Maps JavaScript API, Places API, Directions API, and Geocoding API.
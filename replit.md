# SafeGo Global Super-App

## Overview
SafeGo is a production-ready, full-stack multi-service super-app platform offering ride-hailing, food delivery, and parcel delivery across multiple countries. Its purpose is to provide a comprehensive, scalable, and secure platform for on-demand services, aiming to become a leading global super-app by integrating urban services. Key capabilities include multi-role authentication, country-specific KYC, commission tracking with negative balance support, and full service lifecycle management.

## User Preferences
**Preferred communication style**: Simple, everyday language.

**Development approach**: Full-stack TypeScript with modern tooling, emphasizing code quality, security, and scalability.

## System Architecture

### UI/UX Decisions
- **Technology Stack**: React 18 with TypeScript, Vite 5, shadcn/ui (Radix UI), Tailwind CSS 3, TanStack Query v5, wouter, React Hook Form with Zod.
- **Design System**: Custom HSL-based color palette (light/dark mode), Inter/Manrope typography, mobile-first responsive design, skeleton loading, toast notifications, error boundaries, protected routes with role-based access control.

### Technical Implementations
- **Frontend Features**: Admin panel for managing users and services, real-time data updates, interactive admin dashboard, customer ride history, optional GPS for ride requests, country-specific identity fields (Bangladesh NID, USA SSN with encryption), driver license and background check tracking, unified Document Center with tabbed interface for reviewing KYC submissions, and an enhanced Wallet Settlement System with overview stats, pending settlements, and transaction history. Includes a comprehensive driver financial analytics dashboard with service and country breakdowns. **Admin Activity Audit Trail** provides comprehensive security and compliance monitoring with searchable, filterable logs of all critical admin actions (login, KYC approvals, account blocks) with automatic IP tracking and sensitive data masking. **Global Admin Notification Center** delivers real-time system alerts with comprehensive filtering (severity, status, country, entity type), pagination, severity badges (critical/warning/info), and unread count tracking. Bell icon with unread count badge displayed in admin header and navigation card for quick access. **Global Admin Settings Panel** provides a centralized configuration interface with 6 tabbed sections (General, KYC Rules, Commission, Settlement, Notifications, Security) for managing platform-wide policies, commission rates, settlement cycles, and security parameters without code changes. All settings updates are protected by RBAC (VIEW_SETTINGS/EDIT_SETTINGS permissions) and automatically logged via audit trail. **Finalized Identity Layouts**: USA driver profiles display Emergency Contact followed by a horizontal divider, then Vehicle Information (including Registration, Insurance, and DMV Inspection sections) within a single consolidated Identity Card. Bangladesh driver profiles display Profile Photo at the top, followed by all identity fields including properly labeled Postal Code. **Payment & Payout Profiles**: Admin-managed driver/restaurant payout accounts with encrypted storage (bKash/Nagad/Rocket for BD, bank accounts/Stripe for US), country-specific validation, set default functionality, and masked account display. Driver details page includes Payout Information section with table of configured accounts, Add Payout Account dialog with conditional fields based on country and payout type, and Set Default action for active accounts.
- **Backend Technology Stack**: Node.js 20+ with TypeScript (ESM), Express.js 4, Prisma Client 6 with PostgreSQL 14+, JWT authentication with bcrypt.
- **Core Backend Features**: Multi-role authentication (customer, driver, restaurant, admin), country-specific KYC with admin approval, service lifecycle management (Ride-hailing, Food, Parcel), commission and wallet system (cash/online payments, negative balance), user notification system, management APIs for CRUD, country-based ride matching with FIFO ordering, centralized Document Center, comprehensive Wallet Settlement System, and **Admin Activity Audit Trail** with automatic logging of critical admin actions, IP address tracking, and graceful failure handling. **Global Admin Notification System** with intelligent de-duplication (document-type-specific for expiry alerts), automatic notification triggers for KYC events (pending/approved/rejected), driver status changes (suspend/unsuspend/block), restaurant status changes (suspend/unsuspend), and document expiry monitoring (configurable warning days for TLC licenses, DMV inspections, vehicle registration, insurance across all countries). Document expiry checker scans all driver documents and creates separate alerts per document type to prevent missed warnings. **Global Admin Settings Service** provides centralized platform configuration with default values, in-memory caching, Zod validation schemas for all 6 settings sections (preventing malformed data like negative commissions or invalid booleans), and automatic cache invalidation. SettingsService exports getSettings, getSection, updateSection with comprehensive validation, GET /api/admin/settings and PUT /api/admin/settings/:sectionKey endpoints with RBAC enforcement and audit logging. **Payout Account Service** provides encrypted payout account management with createPayoutAccount, updatePayoutAccount, setDefaultPayoutAccount, listPayoutAccounts, and getPayoutAccount methods. All operations use SAFE_PAYOUT_ACCOUNT_SELECT to exclude encryptedDetails from database queries, ensuring sensitive data never leaves the database. Country-specific validation enforces BD payout types (mobile_wallet with bkash/nagad/rocket providers, bank_account) and US payout types (bank_account with routing numbers, stripe). Account masking displays last 4 digits only. MANAGE_PAYOUTS permission required for all write operations. All payout operations logged via audit trail with PAYOUT_ACCOUNT_CREATED, PAYOUT_ACCOUNT_UPDATED, PAYOUT_ACCOUNT_SET_DEFAULT action types.
- **Security Architecture**: Environment variable-based JWT secret, bcrypt password hashing, AES-256-GCM encryption for sensitive data (NID, SSN, payout account details), Zod input validation, role-based middleware, CSRF protection, SQL injection prevention via Prisma, admin-only decryption of sensitive data, and **comprehensive audit logging** with automatic sensitive data masking (passwords, SSN/NID, account numbers) and IP address tracking for compliance and security monitoring. **Notification system security**: Metadata sanitization automatically removes passwords, tokens, secrets, full SSN/NID, document URLs before storage; only safe masked versions (ssnLast4, nidLast4) are preserved. Intelligent de-duplication prevents notification spam while allowing multiple document-type-specific alerts per driver (TLC, DMV, registration, insurance) by including documentType in uniqueness check for expiry notifications. **Payout account security**: Uses shared encryption helper (server/utils/encryption.ts) with AES-256-GCM for consistent key handling. Database-level protection via SAFE_PAYOUT_ACCOUNT_SELECT excludes encryptedDetails from all read operations. Only masked account numbers (last 4 digits) exposed in API responses, UI, logs, and audit trail. Account masking algorithm: displays last 4 characters with prefix (e.g., •••• 1234).
- **Admin RBAC System**: Advanced role-based access control with 5 admin roles (SUPER_ADMIN, COMPLIANCE_ADMIN, SUPPORT_ADMIN, FINANCE_ADMIN, READONLY_ADMIN) and 20 granular permissions including MANAGE_PAYOUTS across Dashboard, KYC Management, User Management, Financial Operations, and Audit categories. Deny-by-default security model with permissions loaded from database on each authenticated request for immediate effect when roles change. Inactive admins blocked at login. Permission checks applied to all critical endpoints with 403 responses for unauthorized access. MANAGE_PAYOUTS permission assigned to SUPER_ADMIN and FINANCE_ADMIN roles for payout account write operations. Backward compatible with existing admins automatically assigned SUPER_ADMIN role.
- **Database Schema Design**: UUID primary keys, indexed foreign keys, decimal types for monetary values, `isSuspended` fields, `DriverComplaint` model extended for restaurant complaints, country-specific identity fields, driver profile photos, structured USA driver names, DMV/TLC license images, `VehicleDocument` model for registration and insurance. Includes DMV inspection tracking with `dmvInspectionType`, `dmvInspectionDate`, `dmvInspectionExpiry`, `dmvInspectionImageUrl`, and a computed `dmvInspectionStatus`. **DMV Inspection Verification System**: Supports admin review workflow with `dmvInspectionFrontImageUrl`, `dmvInspectionBackImageUrl`, `dmvInspectionVerificationStatus` (pending_review/approved/rejected), and `dmvInspectionRejectionReason` for tracking inspection approval status. USA-specific vehicle fields like `make`, `model`, `year`, `color`, `licensePlate`, `registrationDocumentUrl`, `registrationExpiry`, `insuranceDocumentUrl`, and `insuranceExpiry` are also part of the schema. **AuditLog model** tracks all critical admin actions with actorId, actorEmail, actorRole, actionType, entityType, entityId, description, metadata (JSON), success flag, ipAddress, userAgent, and createdAt timestamp, with indexes on actorId, actionType, entityType, and createdAt for efficient querying. **AdminNotification model** stores system alerts with id (UUID), type (KYC_PENDING/APPROVED/REJECTED, DOCUMENT_EXPIRING/EXPIRED, DRIVER/RESTAURANT_STATUS_CHANGED, etc.), severity (info/warning/critical), actorId, actorEmail, entityType (driver/customer/restaurant/parcel/wallet/document/kyc), entityId, countryCode, title, message, metadata (JSON with sanitized data), isRead flag, and createdAt timestamp, with indexes on type, entityType, entityId, isRead, and createdAt for efficient filtering and pagination. **PlatformSettings model** stores global configuration with unique key constraint (general/kyc/commission/settlement/notifications/security) and valueJson field for flexible key-value storage, along with updatedByAdminId and updatedAt for audit tracking. **PayoutAccount model** stores encrypted payout account information for drivers and restaurants with id (UUID), ownerType (driver/restaurant), ownerId, countryCode, payoutType (mobile_wallet/bank_account/stripe), provider (bkash/nagad/rocket for mobile wallets), displayName, accountHolderName, maskedAccount (last 4 digits only), encryptedDetails (AES-256-GCM encrypted JSON containing sensitive account numbers/routing numbers/mobile numbers), isDefault (enforces single default per owner), status (pending_verification/active/suspended/rejected), createdAt, updatedAt, with indexes on ownerType+ownerId, countryCode, and isDefault. **PaymentMethod model** stores customer payment method information (read-only for admins) with id, customerId, methodType (credit_card/debit_card/upi/mobile_wallet), provider, maskedIdentifier, isDefault, status, metadata (JSON), createdAt, updatedAt, with index on customerId.

## External Dependencies

- **Backend Core**: `@prisma/client`, `express`, `bcrypt`, `jsonwebtoken`, `@neondatabase/serverless`.
- **Frontend Core**: `react`, `react-dom`, `wouter`, `@tanstack/react-query`, `react-hook-form`, `zod`.
- **UI Components (shadcn/ui)**: `@radix-ui/*`, `lucide-react`, `class-variance-authority`, `tailwind-merge`, `clsx`.
- **Environment Variables**: `DATABASE_URL` (PostgreSQL connection string), `JWT_SECRET`, `NODE_ENV`, `ENCRYPTION_KEY` (for NID and SSN).